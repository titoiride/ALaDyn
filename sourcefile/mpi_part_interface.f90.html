<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>mpi_part_interface.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>mpi_part_interface.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 2.6% of total for source files.">629 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/mpi_part_interface.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">mpi_part_interface.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/mpi_part_interface.html">mpi_part_interface</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/mpi_part_interface.f90.html#src">mpi_part_interface.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~mpi_part_interface.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilempi_part_interfacef90EfferentGraph" width="641pt" height="251pt"
 viewBox="0.00 0.00 641.00 250.75" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph" class="graph" transform="scale(.9118 .9118) rotate(0) translate(4 271)">
<title>sourcefile~~mpi_part_interface.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-271 699,-271 699,4 -4,4"/>
<!-- sourcefile~mpi_part_interface.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~mpi_part_interface.f90</title>
<polygon fill="none" stroke="#000000" points="695,-167 562,-167 562,-143 695,-143 695,-167"/>
<text text-anchor="middle" x="628.5" y="-152.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">mpi_part_interface.f90</text>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="243,-267 162,-267 162,-243 243,-243 243,-267"/>
<text text-anchor="middle" x="202.5" y="-252.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M601.4778,-167.1219C559.0773,-185.5624 473.9082,-220.2803 398,-237 349.5686,-247.6676 293.0382,-252.0237 253.2595,-253.7968"/>
<polygon fill="#ff0000" stroke="#ff0000" points="252.8641,-250.3098 243.0144,-254.2129 253.1482,-257.3041 252.8641,-250.3098"/>
</g>
<!-- sourcefile~parallel.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~parallel.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/parallel.f90.html" xlink:title="parallel.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="518,-178 442,-178 442,-154 518,-154 518,-178"/>
<text text-anchor="middle" x="480" y="-163.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">parallel.F90</text>
</a>
</g>
</g>
<!-- sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~parallel.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~parallel.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M561.6351,-159.953C550.3173,-160.7913 538.7683,-161.6468 528.054,-162.4404"/>
<polygon fill="#ff0000" stroke="#ff0000" points="527.7863,-158.9506 518.0722,-163.1798 528.3034,-165.9315 527.7863,-158.9506"/>
</g>
<!-- sourcefile~grid_param.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~grid_param.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/grid_param.f90.html" xlink:title="grid_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="395.5,-106 301.5,-106 301.5,-82 395.5,-82 395.5,-106"/>
<text text-anchor="middle" x="348.5" y="-91.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~grid_param.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~grid_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M573.181,-142.9484C524.7223,-132.3913 454.582,-117.1107 405.6009,-106.4398"/>
<polygon fill="#ff0000" stroke="#ff0000" points="406.3087,-103.012 395.7928,-104.3031 404.8186,-109.8516 406.3087,-103.012"/>
</g>
<!-- sourcefile~array_alloc.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~array_alloc.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/array_alloc.f90.html" xlink:title="array_alloc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="526,-64 434,-64 434,-40 526,-40 526,-64"/>
<text text-anchor="middle" x="480" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">array_alloc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~array_alloc.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~mpi_part_interface.f90&#45;&gt;sourcefile~array_alloc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M611.1745,-142.983C585.2702,-125.0157 536.2638,-91.0247 506.0373,-70.0596"/>
<polygon fill="#ff0000" stroke="#ff0000" points="507.8871,-67.0831 497.6754,-64.2597 503.8976,-72.835 507.8871,-67.0831"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-147 0,-147 0,-123 106,-123 106,-147"/>
<text text-anchor="middle" x="53" y="-132.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M167.6158,-242.8668C158.8765,-239.0726 149.7813,-234.4304 142,-229 112.1671,-208.1803 84.4771,-176.1058 68.1482,-155.3343"/>
<polygon fill="#ff0000" stroke="#ff0000" points="70.7487,-152.9749 61.8726,-147.19 65.2039,-157.2475 70.7487,-152.9749"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="375.5,-228 321.5,-228 321.5,-204 375.5,-204 375.5,-228"/>
<text text-anchor="middle" x="348.5" y="-213.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M448.1675,-178.1036C429.1801,-185.3231 404.9961,-194.5186 385.2057,-202.0435"/>
<polygon fill="#7fff00" stroke="#7fff00" points="383.7006,-198.8712 375.5974,-205.6968 386.1885,-205.4142 383.7006,-198.8712"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="263,-187 142,-187 142,-163 263,-163 263,-187"/>
<text text-anchor="middle" x="202.5" y="-172.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M441.9967,-167.2325C398.6973,-168.6368 326.9976,-170.9622 273.313,-172.7034"/>
<polygon fill="#7fff00" stroke="#7fff00" points="273.0514,-169.2099 263.1701,-173.0323 273.2783,-176.2062 273.0514,-169.2099"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="386,-148 311,-148 311,-124 386,-124 386,-148"/>
<text text-anchor="middle" x="348.5" y="-133.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M441.9648,-157.3228C427.7896,-154.0889 411.5109,-150.3751 396.5525,-146.9626"/>
<polygon fill="#7fff00" stroke="#7fff00" points="396.9778,-143.4697 386.4498,-144.6577 395.4208,-150.2944 396.9778,-143.4697"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="245,-106 160,-106 160,-82 245,-82 245,-106"/>
<text text-anchor="middle" x="202.5" y="-91.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M301.098,-94C286.4852,-94 270.3055,-94 255.35,-94"/>
<polygon fill="#00ffff" stroke="#00ffff" points="255.2262,-90.5001 245.2261,-94 255.2261,-97.5001 255.2262,-90.5001"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M319.215,-106.0764C290.1794,-117.1213 244.1328,-132.1617 202.5,-135"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M202.5,-135C174.3819,-136.9169 143.2199,-137.2077 116.6551,-136.9069"/>
<polygon fill="#00ffff" stroke="#00ffff" points="116.3865,-133.4028 106.3371,-136.7583 116.2856,-140.402 116.3865,-133.4028"/>
</g>
<!-- sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~pstruct_data.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/pstruct_data.f90.html" xlink:title="pstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="398,-64 299,-64 299,-40 398,-40 398,-64"/>
<text text-anchor="middle" x="348.5" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M433.638,-52C425.4371,-52 416.7942,-52 408.2857,-52"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="408.0125,-48.5001 398.0125,-52 408.0125,-55.5001 408.0125,-48.5001"/>
</g>
<!-- sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~fstruct_data.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/fstruct_data.f90.html" xlink:title="fstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="250.5,-24 154.5,-24 154.5,0 250.5,0 250.5,-24"/>
<text text-anchor="middle" x="202.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M438.1329,-39.956C425.3402,-36.6344 411.1715,-33.3125 398,-31 352.2145,-22.9616 299.7561,-18.0965 260.7137,-15.3045"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="260.8002,-11.8023 250.5828,-14.6049 260.3179,-18.7856 260.8002,-11.8023"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M159.6593,-105.749C143.2143,-110.259 124.2326,-115.4646 106.8817,-120.2231"/>
<polygon fill="#ff0000" stroke="#ff0000" points="105.6039,-116.9442 96.8857,-122.9645 107.4553,-123.6949 105.6039,-116.9442"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M321.3807,-223.2442C302.2726,-228.3484 276.1116,-235.3366 253.1949,-241.4582"/>
<polygon fill="#ffda00" stroke="#ffda00" points="252.0257,-238.1477 243.2677,-244.11 253.8322,-244.9106 252.0257,-238.1477"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M321.4896,-217.5917C281.1282,-219.0498 203.2698,-218.2752 142,-196 116.129,-186.5943 90.6327,-167.8865 73.6059,-153.6554"/>
<polygon fill="#ffda00" stroke="#ffda00" points="75.8291,-150.9511 65.9631,-147.0892 71.2674,-156.2607 75.8291,-150.9511"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M306.6623,-64.0355C290.3205,-68.7366 271.4138,-74.1755 254.2299,-79.1188"/>
<polygon fill="#48ff00" stroke="#48ff00" points="252.9865,-75.8345 244.3439,-81.9627 254.9217,-82.5617 252.9865,-75.8345"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M298.9548,-50.1573C256.1143,-50.157 193.1916,-54.0286 142,-73 115.9001,-82.6725 90.2689,-101.845 73.2665,-116.3225"/>
<polygon fill="#48ff00" stroke="#48ff00" points="70.8682,-113.7703 65.6487,-122.9902 75.4787,-119.0375 70.8682,-113.7703"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M157.6451,-162.9987C142.0467,-158.8252 124.3689,-154.0954 108.042,-149.727"/>
<polygon fill="#00ff91" stroke="#00ff91" points="108.6463,-146.2656 98.0814,-147.0619 106.837,-153.0277 108.6463,-146.2656"/>
</g>
<!-- sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M169.1638,-24.008C159.9496,-28.0746 150.2291,-33.1067 142,-39 111.7937,-60.6325 83.8728,-93.7841 67.6362,-114.9218"/>
<polygon fill="#0091ff" stroke="#0091ff" points="64.8375,-112.82 61.6151,-122.9129 70.4282,-117.0325 64.8375,-112.82"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M310.944,-134.1998C281.4277,-133.1575 239.2957,-132.4915 202.5,-135"/>
</g>
</g>
</svg>
</div><script>var pansourcefilempi_part_interfacef90EfferentGraph = svgPanZoom('#sourcefilempi_part_interfacef90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~mpi_part_interface.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilempi_part_interfacef90AfferentGraph" width="534pt" height="74pt"
 viewBox="0.00 0.00 534.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>sourcefile~~mpi_part_interface.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-70 530,-70 530,4 -4,4"/>
<!-- sourcefile~mpi_part_interface.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~mpi_part_interface.f90</title>
<polygon fill="none" stroke="#000000" points="133,-45 0,-45 0,-21 133,-21 133,-45"/>
<text text-anchor="middle" x="66.5" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">mpi_part_interface.f90</text>
</g>
<!-- sourcefile~window.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~window.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/window.f90.html" xlink:title="window.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="241,-45 169,-45 169,-21 241,-21 241,-45"/>
<text text-anchor="middle" x="205" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">window.f90</text>
</a>
</g>
</g>
<!-- sourcefile~window.f90&#45;&gt;sourcefile~mpi_part_interface.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~window.f90&#45;&gt;sourcefile~mpi_part_interface.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M168.9723,-33C160.9942,-33 152.2452,-33 143.3264,-33"/>
<polygon fill="#ff0000" stroke="#ff0000" points="143.2169,-29.5001 133.2169,-33 143.2168,-36.5001 143.2169,-29.5001"/>
</g>
<!-- sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~pic_evolve_in_time.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/pic_evolve_in_time.f90.html" xlink:title="pic_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="412,-66 279,-66 279,-42 412,-42 412,-66"/>
<text text-anchor="middle" x="345.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~mpi_part_interface.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~mpi_part_interface.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M278.7089,-57.1699C245.6255,-57.9345 205.126,-57.6627 169,-54 154.6757,-52.5477 139.3956,-49.9816 125.1247,-47.1307"/>
<polygon fill="#ff0000" stroke="#ff0000" points="125.4425,-43.6221 114.9398,-45.0162 124.0195,-50.4759 125.4425,-43.6221"/>
</g>
<!-- sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~window.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~window.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M278.9531,-44.0535C269.5729,-42.6515 260.1044,-41.2362 251.2191,-39.9082"/>
<polygon fill="#ff0000" stroke="#ff0000" points="251.5042,-36.412 241.0967,-38.3952 250.4694,-43.3351 251.5042,-36.412"/>
</g>
<!-- sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~env_evolve_in_time.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/env_evolve_in_time.f90.html" xlink:title="env_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="414,-24 277,-24 277,0 414,0 414,-24"/>
<text text-anchor="middle" x="345.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">env_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~mpi_part_interface.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~mpi_part_interface.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M276.6052,-8.7831C243.9186,-8.0785 204.3638,-8.4146 169,-12 154.6757,-13.4523 139.3956,-16.0184 125.1247,-18.8693"/>
<polygon fill="#ff0000" stroke="#ff0000" points="124.0195,-15.5241 114.9398,-20.9838 125.4425,-22.3779 124.0195,-15.5241"/>
</g>
<!-- sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~window.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~window.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M276.8964,-22.2539C268.1782,-23.557 259.4261,-24.8651 251.1778,-26.098"/>
<polygon fill="#ff0000" stroke="#ff0000" points="250.4124,-22.6734 241.0397,-27.6133 251.4472,-29.5965 250.4124,-22.6734"/>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~mpi_part_interface.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="526,-45 450,-45 450,-21 526,-21 526,-45"/>
<text text-anchor="middle" x="488" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge6" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M449.8126,-38.6276C441.1852,-39.899 431.7268,-41.2929 422.1375,-42.7061"/>
<polygon fill="#00ff00" stroke="#00ff00" points="421.5092,-39.2608 412.1264,-44.1814 422.5298,-46.186 421.5092,-39.2608"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~mpi_part_interface.f90~~AfferentGraph_edge7" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M449.8126,-27.3724C441.7861,-26.1895 433.0404,-24.9007 424.1391,-23.5889"/>
<polygon fill="#0000ff" stroke="#0000ff" points="424.4567,-20.098 414.0533,-22.1026 423.4361,-27.0232 424.4567,-20.098"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/mpi_part_interface.html">mpi_part_interface</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/mpi_part_interface.f90.html#src">mpi_part_interface.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2020  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">mpi_part_interface</span>
<a name="ln-23"></a>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">array_alloc</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">grid_param</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">code_util</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">parallel</span>
<a name="ln-28"></a>
<a name="ln-29"></a>  <span class="k">implicit none</span>
<a name="ln-30"></a><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-31"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">sp_aux</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">sp1_aux</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-32"></a>
<a name="ln-33"></a> <span class="k">contains</span>
<a name="ln-34"></a>  <span class="c">!=================</span>
<a name="ln-35"></a>  <span class="k">subroutine </span><span class="n">traffic_size_eval</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">pel</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-36"></a>                               <span class="n">npold</span><span class="p">,</span> <span class="n">nsr</span><span class="p">,</span> <span class="n">npnew</span><span class="p">)</span>
<a name="ln-37"></a>
<a name="ln-38"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-39"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span>
<a name="ln-40"></a>   <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pel</span><span class="p">,</span> <span class="n">per</span>
<a name="ln-41"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">npold</span>
<a name="ln-42"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nsr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-43"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">npnew</span>
<a name="ln-44"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-45"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nl_send</span><span class="p">,</span> <span class="n">nl_recv</span><span class="p">,</span> <span class="n">nr_send</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">,</span> <span class="n">cdir</span>
<a name="ln-46"></a>
<a name="ln-47"></a>   <span class="n">cdir</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-48"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">cdir</span> <span class="o">=</span> <span class="mi">3</span>
<a name="ln-49"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-50"></a>   <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-51"></a>   <span class="n">nr_recv</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-52"></a>   <span class="n">nl_recv</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-53"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-54"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="nb">COUNT</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npold</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-55"></a>    <span class="n">q</span> <span class="o">=</span> <span class="nb">COUNT</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npold</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xl</span><span class="p">)</span>
<a name="ln-56"></a>   <span class="k">end if</span>
<a name="ln-57"></a><span class="k">   </span><span class="n">nr_send</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-58"></a>   <span class="n">nl_send</span> <span class="o">=</span> <span class="n">q</span>
<a name="ln-59"></a>   <span class="k">call </span><span class="n">sr_idata</span><span class="p">(</span><span class="n">nr_send</span><span class="p">,</span> <span class="n">nl_recv</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
<a name="ln-60"></a>   <span class="c">!sends to right nr_send receives from left nl_recv</span>
<a name="ln-61"></a>   <span class="k">call </span><span class="n">sr_idata</span><span class="p">(</span><span class="n">nl_send</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
<a name="ln-62"></a>   <span class="c">!sends to left nl_send  receives from right nr_recv</span>
<a name="ln-63"></a>
<a name="ln-64"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!NOT PERIODIC BD</span>
<a name="ln-65"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="n">nl_recv</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-66"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-67"></a><span class="k">     </span><span class="n">nr_recv</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-68"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nr_send</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-69"></a>    <span class="k">end if</span>
<a name="ln-70"></a><span class="k">   end if</span>
<a name="ln-71"></a><span class="k">   </span><span class="n">npnew</span> <span class="o">=</span> <span class="n">npold</span> <span class="o">+</span> <span class="n">nl_recv</span> <span class="o">+</span> <span class="n">nr_recv</span> <span class="o">-</span> <span class="n">nl_send</span> <span class="o">-</span> <span class="n">nr_send</span>
<a name="ln-72"></a>   <span class="c">!================================</span>
<a name="ln-73"></a>   <span class="c">!if(pel)nl_send=0</span>
<a name="ln-74"></a>   <span class="c">!if(per)nr_send=0</span>
<a name="ln-75"></a>   <span class="n">nsr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nl_send</span>
<a name="ln-76"></a>   <span class="n">nsr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nr_send</span>
<a name="ln-77"></a>   <span class="n">nsr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nl_recv</span>
<a name="ln-78"></a>   <span class="n">nsr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nr_recv</span>
<a name="ln-79"></a>   <span class="c">!================================</span>
<a name="ln-80"></a>  <span class="k">end subroutine</span>
<a name="ln-81"></a>  <span class="c">!======================================</span>
<a name="ln-82"></a>  <span class="k">subroutine </span><span class="n">part_prl_wexchange</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xlmin</span><span class="p">,</span> <span class="n">xrmax</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-83"></a>                                <span class="n">pel</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">old_np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
<a name="ln-84"></a>
<a name="ln-85"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-86"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xlmin</span><span class="p">,</span> <span class="n">xrmax</span>
<a name="ln-87"></a>   <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pel</span><span class="p">,</span> <span class="n">per</span>
<a name="ln-88"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">old_np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-89"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">npt</span>
<a name="ln-90"></a>   <span class="k">type</span><span class="p">(</span><span class="n">index_array</span><span class="p">)</span> <span class="kd">::</span> <span class="n">left_pind</span><span class="p">,</span> <span class="n">right_pind</span>
<a name="ln-91"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span>
<a name="ln-92"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nl_send</span><span class="p">,</span> <span class="n">nr_send</span><span class="p">,</span> <span class="n">nl_recv</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">,</span> <span class="n">vxdir</span>
<a name="ln-93"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">mask</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-94"></a>   <span class="c">!================ dir are cartesian coordinate index (x,y,z)</span>
<a name="ln-95"></a>   <span class="c">!================ cdir are mpi-cartesian index (y,z,x)</span>
<a name="ln-96"></a>
<a name="ln-97"></a>   <span class="n">nl_send</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-98"></a>   <span class="n">nr_send</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-99"></a>   <span class="n">nl_recv</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-100"></a>   <span class="n">nr_recv</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-101"></a>   <span class="n">cdir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-102"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">cdir</span> <span class="o">=</span> <span class="mi">3</span> <span class="c">!for x-direction</span>
<a name="ln-103"></a>   <span class="n">vxdir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">+</span> <span class="n">ndim</span>
<a name="ln-104"></a>   <span class="c">!================== checks memory</span>
<a name="ln-105"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nl_send</span><span class="p">,</span> <span class="n">nr_send</span><span class="p">)</span>
<a name="ln-106"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-107"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">aux1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-108"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">aux1</span><span class="p">)</span>
<a name="ln-109"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">aux1</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="ln-110"></a>     <span class="n">aux1</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-111"></a>    <span class="k">end if</span>
<a name="ln-112"></a><span class="k">   end if</span>
<a name="ln-113"></a><span class="k">   </span><span class="n">q</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nl_recv</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">)</span>
<a name="ln-114"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-115"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">aux2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-116"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">aux2</span><span class="p">)</span>
<a name="ln-117"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">aux2</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
<a name="ln-118"></a>     <span class="n">aux2</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-119"></a>    <span class="k">end if</span>
<a name="ln-120"></a><span class="k">   end if</span>
<a name="ln-121"></a>   <span class="c">!==================== copy remaining part =&gt; ebfp</span>
<a name="ln-122"></a>   <span class="n">right_pind</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-123"></a>   <span class="n">left_pind</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-124"></a>
<a name="ln-125"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-126"></a>   <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-127"></a>   <span class="n">npt</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-128"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!reflecting on the right</span>
<a name="ln-129"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-130"></a><span class="k">     associate</span> <span class="p">(</span><span class="n">xp</span> <span class="o">=&gt;</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">dir</span><span class="p">))</span>
<a name="ln-131"></a>      <span class="k">where</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-132"></a>      <span class="n">xp</span> <span class="o">=</span> <span class="n">xr</span> <span class="o">-</span> <span class="p">(</span><span class="n">xp</span> <span class="o">-</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-133"></a>      <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">vxdir</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">vxdir</span><span class="p">)</span>
<a name="ln-134"></a>      <span class="k">end where</span>
<a name="ln-135"></a><span class="k">     end associate</span>
<a name="ln-136"></a><span class="k">    end if</span>
<a name="ln-137"></a><span class="k">   end if</span>
<a name="ln-138"></a><span class="c">!================== copy in sp_aux particles not to be exchanged</span>
<a name="ln-139"></a>   <span class="k">associate</span> <span class="p">(</span><span class="n">xp</span> <span class="o">=&gt;</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">dir</span><span class="p">))</span>
<a name="ln-140"></a>    <span class="k">call </span><span class="n">right_pind</span><span class="p">%</span><span class="n">find_index</span><span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-141"></a>    <span class="k">call </span><span class="n">left_pind</span><span class="p">%</span><span class="n">find_index</span><span class="p">(</span><span class="n">xp</span> <span class="o">&lt;</span> <span class="n">xl</span><span class="p">)</span>
<a name="ln-142"></a>    <span class="n">mask</span><span class="p">(:)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;=</span> <span class="n">xl</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;=</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-143"></a>    <span class="n">npt</span> <span class="o">=</span> <span class="nb">COUNT</span><span class="p">(</span><span class="n">mask</span><span class="p">(:))</span>
<a name="ln-144"></a>   <span class="k">end associate</span>
<a name="ln-145"></a>
<a name="ln-146"></a><span class="k">   do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-147"></a>    <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">PACK</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">mask</span><span class="p">(:))</span>
<a name="ln-148"></a>   <span class="k">end do</span>
<a name="ln-149"></a>   <span class="c">!=======================</span>
<a name="ln-150"></a>   <span class="n">ns</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">nr_send</span>
<a name="ln-151"></a>   <span class="n">nr</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">nl_recv</span>
<a name="ln-152"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!NON PERIODIC CASE</span>
<a name="ln-153"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-154"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-155"></a>   <span class="k">end if</span>
<a name="ln-156"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-157"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-158"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-159"></a>     <span class="c">!sends to the right only for Periodic boundary</span>
<a name="ln-160"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-161"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-162"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-163"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xlmin</span> <span class="o">-</span> <span class="n">xr</span>
<a name="ln-164"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-165"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-166"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-167"></a>      <span class="k">end do</span>
<a name="ln-168"></a><span class="k">     end do</span>
<a name="ln-169"></a><span class="c">!=============== NON PERIODIC CASE</span>
<a name="ln-170"></a>    <span class="k">else</span>
<a name="ln-171"></a>     <span class="c">!To be checked case ibd == 1</span>
<a name="ln-172"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-173"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-174"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-175"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-176"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-177"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-178"></a>      <span class="k">end do</span>
<a name="ln-179"></a><span class="k">     end do</span>
<a name="ln-180"></a><span class="k">    end if</span>
<a name="ln-181"></a><span class="k">   end if</span>
<a name="ln-182"></a>
<a name="ln-183"></a><span class="k">   if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">sr_pdata</span><span class="p">(</span><span class="n">aux1</span><span class="p">,</span> <span class="n">aux2</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
<a name="ln-184"></a>   <span class="c">! sends ns data to the right</span>
<a name="ln-185"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!receives nr data from left</span>
<a name="ln-186"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-187"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-188"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_recv</span>
<a name="ln-189"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-190"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-191"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-192"></a>      <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-193"></a>     <span class="k">end do</span>
<a name="ln-194"></a><span class="k">    end do</span>
<a name="ln-195"></a><span class="k">    </span><span class="n">npt</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-196"></a>   <span class="k">end if</span>
<a name="ln-197"></a><span class="c">!===================</span>
<a name="ln-198"></a>   <span class="n">ns</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">nl_send</span>
<a name="ln-199"></a>   <span class="n">nr</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">nr_recv</span>
<a name="ln-200"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-201"></a><span class="k">    if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-202"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-203"></a>   <span class="k">end if</span>
<a name="ln-204"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-205"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-206"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="k">then</span> <span class="c">!only for periodic case</span>
<a name="ln-207"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-208"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-209"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-210"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xrmax</span> <span class="o">-</span> <span class="n">xl</span>
<a name="ln-211"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-212"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-213"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-214"></a>      <span class="k">end do</span>
<a name="ln-215"></a><span class="k">     end do</span>
<a name="ln-216"></a><span class="k">    else</span>
<a name="ln-217"></a>     <span class="c">!============ NON PERIODIC EXCHANGE</span>
<a name="ln-218"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-219"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-220"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-221"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-222"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-223"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-224"></a>      <span class="k">end do</span>
<a name="ln-225"></a><span class="k">     end do</span>
<a name="ln-226"></a><span class="k">    end if</span>
<a name="ln-227"></a><span class="k">   end if</span>   <span class="c">!END ns &gt;0</span>
<a name="ln-228"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">sr_pdata</span><span class="p">(</span><span class="n">aux1</span><span class="p">,</span> <span class="n">aux2</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
<a name="ln-229"></a>   <span class="c">! sends ns data to the left recieves nr data from right</span>
<a name="ln-230"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-231"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-232"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-233"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_recv</span>
<a name="ln-234"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-235"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-236"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-237"></a>      <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-238"></a>     <span class="k">end do</span>
<a name="ln-239"></a><span class="k">    end do</span>
<a name="ln-240"></a><span class="k">    </span><span class="n">npt</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-241"></a>   <span class="k">end if</span>
<a name="ln-242"></a>
<a name="ln-243"></a><span class="c">!  EXIT old+new data in sp_aux(:,:)</span>
<a name="ln-244"></a>  <span class="k">end subroutine</span>
<a name="ln-245"></a><span class="c">!==============================================</span>
<a name="ln-246"></a>  <span class="k">subroutine </span><span class="n">part_prl_exchange</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">vstore</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xlmin</span><span class="p">,</span> <span class="n">xrmax</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-247"></a>                               <span class="n">pel</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">old_np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span>
<a name="ln-248"></a>
<a name="ln-249"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-250"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vstore</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-251"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xlmin</span><span class="p">,</span> <span class="n">xrmax</span>
<a name="ln-252"></a>   <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pel</span><span class="p">,</span> <span class="n">per</span>
<a name="ln-253"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ibd</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">old_np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-254"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">npt</span>
<a name="ln-255"></a>   <span class="k">type</span><span class="p">(</span><span class="n">index_array</span><span class="p">)</span> <span class="kd">::</span> <span class="n">left_pind</span><span class="p">,</span> <span class="n">right_pind</span>
<a name="ln-256"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span>
<a name="ln-257"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nl_send</span><span class="p">,</span> <span class="n">nr_send</span><span class="p">,</span> <span class="n">nl_recv</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">,</span> <span class="n">vxdir</span>
<a name="ln-258"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">mask</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-259"></a>   <span class="c">!================ dir are cartesian coordinate index (x,y,z)</span>
<a name="ln-260"></a>   <span class="c">!================ cdir are mpi-cartesian index (y,z,x)</span>
<a name="ln-261"></a>
<a name="ln-262"></a>   <span class="n">nl_send</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-263"></a>   <span class="n">nr_send</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-264"></a>   <span class="n">nl_recv</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-265"></a>   <span class="n">nr_recv</span> <span class="o">=</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-266"></a>   <span class="n">cdir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-267"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">cdir</span> <span class="o">=</span> <span class="mi">3</span> <span class="c">!for x-direction</span>
<a name="ln-268"></a>   <span class="n">vxdir</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">+</span> <span class="n">ndim</span>
<a name="ln-269"></a>   <span class="c">!================== checks memory</span>
<a name="ln-270"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nl_send</span><span class="p">,</span> <span class="n">nr_send</span><span class="p">)</span>
<a name="ln-271"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-272"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">aux1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-273"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">aux1</span><span class="p">)</span>
<a name="ln-274"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">aux1</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="ln-275"></a>     <span class="n">aux1</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-276"></a>    <span class="k">end if</span>
<a name="ln-277"></a><span class="k">   end if</span>
<a name="ln-278"></a><span class="k">   </span><span class="n">q</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nl_recv</span><span class="p">,</span> <span class="n">nr_recv</span><span class="p">)</span>
<a name="ln-279"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-280"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">aux2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-281"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">aux2</span><span class="p">)</span>
<a name="ln-282"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">aux2</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
<a name="ln-283"></a>     <span class="n">aux2</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-284"></a>    <span class="k">end if</span>
<a name="ln-285"></a><span class="k">   end if</span>
<a name="ln-286"></a>   <span class="c">!==================== copy remaining part =&gt; ebfp</span>
<a name="ln-287"></a>   <span class="n">right_pind</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-288"></a>   <span class="n">left_pind</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">(</span><span class="n">old_np</span><span class="p">)</span>
<a name="ln-289"></a>
<a name="ln-290"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-291"></a>   <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-292"></a>   <span class="n">npt</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-293"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!reflecting on the right</span>
<a name="ln-294"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-295"></a><span class="k">     associate</span> <span class="p">(</span><span class="n">xp</span> <span class="o">=&gt;</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">dir</span><span class="p">))</span>
<a name="ln-296"></a>      <span class="k">where</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-297"></a>      <span class="n">xp</span> <span class="o">=</span> <span class="n">xr</span> <span class="o">-</span> <span class="p">(</span><span class="n">xp</span> <span class="o">-</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-298"></a>      <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">vxdir</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">vxdir</span><span class="p">)</span>
<a name="ln-299"></a>      <span class="k">end where</span>
<a name="ln-300"></a><span class="k">     end associate</span>
<a name="ln-301"></a><span class="k">    end if</span>
<a name="ln-302"></a><span class="k">   end if</span>
<a name="ln-303"></a><span class="c">!================== copy in sp_aux particles not to be exchanged</span>
<a name="ln-304"></a>   <span class="k">associate</span> <span class="p">(</span><span class="n">xp</span> <span class="o">=&gt;</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">dir</span><span class="p">))</span>
<a name="ln-305"></a>    <span class="k">call </span><span class="n">right_pind</span><span class="p">%</span><span class="n">find_index</span><span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-306"></a>    <span class="k">call </span><span class="n">left_pind</span><span class="p">%</span><span class="n">find_index</span><span class="p">(</span><span class="n">xp</span> <span class="o">&lt;</span> <span class="n">xl</span><span class="p">)</span>
<a name="ln-307"></a>    <span class="n">mask</span><span class="p">(:)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;=</span> <span class="n">xl</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;=</span> <span class="n">xr</span><span class="p">)</span>
<a name="ln-308"></a>    <span class="n">npt</span> <span class="o">=</span> <span class="nb">COUNT</span><span class="p">(</span><span class="n">mask</span><span class="p">(:))</span>
<a name="ln-309"></a>   <span class="k">end associate</span>
<a name="ln-310"></a>
<a name="ln-311"></a><span class="k">   do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-312"></a>    <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">PACK</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">mask</span><span class="p">(:))</span>
<a name="ln-313"></a>    <span class="n">sp1_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npt</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">PACK</span><span class="p">(</span><span class="n">vstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">old_np</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">mask</span><span class="p">(:))</span>
<a name="ln-314"></a>   <span class="k">end do</span>
<a name="ln-315"></a>   <span class="c">!=======================</span>
<a name="ln-316"></a>   <span class="n">ns</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="n">nr_send</span>
<a name="ln-317"></a>   <span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="n">nl_recv</span>
<a name="ln-318"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!NON PERIODIC CASE</span>
<a name="ln-319"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-320"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-321"></a>   <span class="k">end if</span>
<a name="ln-322"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-323"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-324"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-325"></a>     <span class="c">!sends to the right only for Periodic boundary</span>
<a name="ln-326"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-327"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-328"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-329"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xlmin</span> <span class="o">-</span> <span class="n">xr</span>
<a name="ln-330"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-331"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-332"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-333"></a>      <span class="k">end do</span>
<a name="ln-334"></a><span class="k">     end do</span>
<a name="ln-335"></a>     <span class="c">!adds vstore data</span>
<a name="ln-336"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-337"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-338"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">vstore</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-339"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xlmin</span> <span class="o">-</span> <span class="n">xr</span>
<a name="ln-340"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-341"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-342"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-343"></a>      <span class="k">end do</span>
<a name="ln-344"></a><span class="k">     end do</span>
<a name="ln-345"></a><span class="c">!=============== NON PERIODIC CASE</span>
<a name="ln-346"></a>    <span class="k">else</span>
<a name="ln-347"></a>     <span class="c">!To be checked case ibd == 1</span>
<a name="ln-348"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-349"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-350"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-351"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-352"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-353"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-354"></a>      <span class="k">end do</span>
<a name="ln-355"></a><span class="k">     end do</span>
<a name="ln-356"></a>     <span class="c">!adds vstore data</span>
<a name="ln-357"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_send</span>
<a name="ln-358"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">right_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-359"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">vstore</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-360"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-361"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-362"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-363"></a>      <span class="k">end do</span>
<a name="ln-364"></a><span class="k">     end do</span>
<a name="ln-365"></a><span class="k">    end if</span>
<a name="ln-366"></a><span class="k">   end if</span>
<a name="ln-367"></a>
<a name="ln-368"></a><span class="k">   if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">sr_pdata</span><span class="p">(</span><span class="n">aux1</span><span class="p">,</span> <span class="n">aux2</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
<a name="ln-369"></a>   <span class="c">! sends ns data to the right</span>
<a name="ln-370"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!receives nr data from left</span>
<a name="ln-371"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-372"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-373"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_recv</span>
<a name="ln-374"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-375"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-376"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-377"></a>      <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-378"></a>     <span class="k">end do</span>
<a name="ln-379"></a><span class="k">    end do</span>
<a name="ln-380"></a>    <span class="c">!   adds...</span>
<a name="ln-381"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-382"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_recv</span>
<a name="ln-383"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-384"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-385"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-386"></a>      <span class="n">sp1_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-387"></a>     <span class="k">end do</span>
<a name="ln-388"></a><span class="k">    end do</span>
<a name="ln-389"></a><span class="k">    </span><span class="n">npt</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-390"></a>   <span class="k">end if</span>
<a name="ln-391"></a><span class="c">!===================</span>
<a name="ln-392"></a>   <span class="n">ns</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="n">nl_send</span>
<a name="ln-393"></a>   <span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ndv</span><span class="o">*</span><span class="n">nr_recv</span>
<a name="ln-394"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-395"></a><span class="k">    if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-396"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-397"></a>   <span class="k">end if</span>
<a name="ln-398"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-399"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-400"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pel</span><span class="p">)</span> <span class="k">then</span> <span class="c">!only for periodic case</span>
<a name="ln-401"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-402"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-403"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-404"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xrmax</span> <span class="o">-</span> <span class="n">xl</span>
<a name="ln-405"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-406"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-407"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-408"></a>      <span class="k">end do</span>
<a name="ln-409"></a><span class="k">     end do</span>
<a name="ln-410"></a><span class="c">! adds....</span>
<a name="ln-411"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-412"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-413"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">vstore</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-414"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="n">xrmax</span> <span class="o">-</span> <span class="n">xl</span>
<a name="ln-415"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-416"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-417"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-418"></a>      <span class="k">end do</span>
<a name="ln-419"></a><span class="k">     end do</span>
<a name="ln-420"></a><span class="k">    else</span>
<a name="ln-421"></a>     <span class="c">!============ NON PERIODIC EXCHANGE</span>
<a name="ln-422"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-423"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-424"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-425"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-426"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-427"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-428"></a>      <span class="k">end do</span>
<a name="ln-429"></a><span class="k">     end do</span>
<a name="ln-430"></a><span class="k">     do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nl_send</span>
<a name="ln-431"></a>      <span class="n">n</span> <span class="o">=</span> <span class="n">left_pind</span><span class="p">%</span><span class="n">indices</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-432"></a>      <span class="n">loc_pstore</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">vstore</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-433"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-434"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-435"></a>       <span class="n">aux1</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_pstore</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-436"></a>      <span class="k">end do</span>
<a name="ln-437"></a><span class="k">     end do</span>
<a name="ln-438"></a><span class="k">    end if</span>
<a name="ln-439"></a><span class="k">   end if</span>   <span class="c">!END ns &gt;0</span>
<a name="ln-440"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">sr_pdata</span><span class="p">(</span><span class="n">aux1</span><span class="p">,</span> <span class="n">aux2</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cdir</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
<a name="ln-441"></a>   <span class="c">! sends ns data to the left recieves nr data from right</span>
<a name="ln-442"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-443"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-444"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-445"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_recv</span>
<a name="ln-446"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-447"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-448"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-449"></a>      <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-450"></a>     <span class="k">end do</span>
<a name="ln-451"></a><span class="k">    end do</span>
<a name="ln-452"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">npt</span>
<a name="ln-453"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nr_recv</span>
<a name="ln-454"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-455"></a>     <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-456"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-457"></a>      <span class="n">sp1_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">aux2</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-458"></a>     <span class="k">end do</span>
<a name="ln-459"></a><span class="k">    end do</span>
<a name="ln-460"></a><span class="k">    </span><span class="n">npt</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-461"></a>   <span class="k">end if</span>
<a name="ln-462"></a>
<a name="ln-463"></a><span class="c">!  EXIT old+new data in sp_aux(:,:) and sp1_aux(:,:)</span>
<a name="ln-464"></a>  <span class="k">end subroutine</span>
<a name="ln-465"></a>  <span class="c">!================</span>
<a name="ln-466"></a>  <span class="c">!=============================</span>
<a name="ln-467"></a>  <span class="k">subroutine </span><span class="n">reset_all_part_dist</span><span class="p">(</span><span class="n">loc_sp</span><span class="p">,</span> <span class="n">pstore</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-468"></a>                                 <span class="n">cin</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">mwin</span><span class="p">)</span>
<a name="ln-469"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">loc_sp</span>
<a name="ln-470"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pstore</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-471"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span>
<a name="ln-472"></a>   <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mwin</span>
<a name="ln-473"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ib</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">cin</span>
<a name="ln-474"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_new</span>
<a name="ln-475"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xp</span><span class="p">,</span> <span class="n">dxp</span>
<a name="ln-476"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">pout</span>
<a name="ln-477"></a>   <span class="c">!===========================</span>
<a name="ln-478"></a>   <span class="n">np_new</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-479"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-480"></a>   <span class="n">pout</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-481"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ib</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-482"></a><span class="k">    </span><span class="n">dxp</span> <span class="o">=</span> <span class="n">xr</span> <span class="o">-</span> <span class="n">xl</span>
<a name="ln-483"></a>    <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-484"></a>     <span class="n">xp</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span>
<a name="ln-485"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&lt;</span> <span class="n">xl</span><span class="p">)</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span> <span class="o">=</span> <span class="n">xp</span> <span class="o">+</span> <span class="n">dxp</span>
<a name="ln-486"></a>     <span class="n">xp</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span>
<a name="ln-487"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span> <span class="o">=</span> <span class="n">xp</span> <span class="o">-</span> <span class="n">dxp</span>
<a name="ln-488"></a>    <span class="k">end do</span>
<a name="ln-489"></a><span class="k">    return</span>
<a name="ln-490"></a><span class="k">   end if</span>
<a name="ln-491"></a><span class="k">   do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-492"></a>    <span class="n">xp</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span>
<a name="ln-493"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&lt;=</span> <span class="n">xl</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-494"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-495"></a>   <span class="k">end do</span>
<a name="ln-496"></a><span class="k">   </span><span class="n">pout</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-497"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-498"></a><span class="k">    if</span> <span class="p">(</span><span class="n">mwin</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-499"></a><span class="k">     call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="n">pout</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-500"></a>     <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-501"></a>     <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-502"></a>      <span class="n">xp</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span>
<a name="ln-503"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xl</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;=</span> <span class="n">xr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-504"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-505"></a>       <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-506"></a>      <span class="k">end if</span>
<a name="ln-507"></a><span class="k">     end do</span>
<a name="ln-508"></a><span class="k">    else</span>
<a name="ln-509"></a><span class="k">     call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="n">pout</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-510"></a>     <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="n">pout</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-511"></a>     <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-512"></a>     <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-513"></a>      <span class="n">xp</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cin</span><span class="p">)</span>
<a name="ln-514"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xl</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;=</span> <span class="n">xr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-515"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-516"></a>       <span class="n">sp_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-517"></a>       <span class="n">sp1_aux</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">pstore</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-518"></a>      <span class="k">end if</span>
<a name="ln-519"></a><span class="k">     end do</span>
<a name="ln-520"></a><span class="k">    </span><span class="n">endif</span>
<a name="ln-521"></a>    <span class="n">np_new</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-522"></a>   <span class="k">end if</span>
<a name="ln-523"></a><span class="k">  end subroutine</span>
<a name="ln-524"></a>  <span class="c">!==============</span>
<a name="ln-525"></a>  <span class="k">subroutine </span><span class="n">cell_part_dist</span><span class="p">(</span><span class="n">moving_wind</span><span class="p">)</span>
<a name="ln-526"></a>   <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">moving_wind</span>
<a name="ln-527"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">nspx</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-528"></a>              <span class="n">np_rs</span><span class="p">,</span> <span class="n">np_out</span>
<a name="ln-529"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_sr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-530"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ymm</span><span class="p">,</span> <span class="n">ymx</span><span class="p">,</span> <span class="n">lbd_min</span><span class="p">,</span> <span class="n">rbd_max</span>
<a name="ln-531"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">zmm</span><span class="p">,</span> <span class="n">zmx</span>
<a name="ln-532"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span>
<a name="ln-533"></a>
<a name="ln-534"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-535"></a>   <span class="c">!===================================</span>
<a name="ln-536"></a>   <span class="c">! In traffic_size_eval() Counts numbers of left-right exchanges</span>
<a name="ln-537"></a>   <span class="c">!nsr(1)=nl_send</span>
<a name="ln-538"></a>   <span class="c">!nsr(2)=nr_send</span>
<a name="ln-539"></a>   <span class="c">!nsr(3)=nl_recv</span>
<a name="ln-540"></a>   <span class="c">!nsr(4)=nr_recv</span>
<a name="ln-541"></a>   <span class="c">! ==&gt; new particle number np_new= nl_recv-nl_send+ nr_recv-nr_send</span>
<a name="ln-542"></a>   <span class="c">!      In part_prl_exchange()    exchanges particle data by mpi_send_recv</span>
<a name="ln-543"></a>   <span class="c">!=====================================</span>
<a name="ln-544"></a>   <span class="c">!In moving window box (xmm,xmx) are right shifted</span>
<a name="ln-545"></a>   <span class="c">!all species leaving the computational box at the left</span>
<a name="ln-546"></a>   <span class="c">!x-boundary are removed</span>
<a name="ln-547"></a>   <span class="c">!==========================================</span>
<a name="ln-548"></a>   <span class="c">!=========== mowing window section</span>
<a name="ln-549"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">moving_wind</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-550"></a><span class="k">    </span><span class="n">nspx</span> <span class="o">=</span> <span class="n">nsp</span>
<a name="ln-551"></a>    <span class="n">xmm</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-552"></a>    <span class="n">xmx</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-553"></a>    <span class="n">lbd_min</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-554"></a>    <span class="n">rbd_max</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-555"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">prlx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-556"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspx</span>
<a name="ln-557"></a>      <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-558"></a>      <span class="n">np_new</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-559"></a>      <span class="n">n_sr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-560"></a>      <span class="k">call </span><span class="n">traffic_size_eval</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">pex0</span><span class="p">,</span> <span class="n">pex1</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-561"></a>                             <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_new</span><span class="p">)</span>
<a name="ln-562"></a>      <span class="c">! Allocate the aux array with lenght np + n_recieve</span>
<a name="ln-563"></a>      <span class="c">! because it needs to receive before to send</span>
<a name="ln-564"></a>      <span class="n">np_new_allocate</span> <span class="o">=</span> <span class="n">np_new</span> <span class="o">+</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-565"></a>      <span class="n">np_rs</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-566"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_rs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-567"></a><span class="k">       call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-568"></a>       <span class="k">call </span><span class="n">part_prl_wexchange</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">lbd_min</span><span class="p">,</span> <span class="n">rbd_max</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-569"></a>                               <span class="n">pex0</span><span class="p">,</span> <span class="n">pex1</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_out</span><span class="p">)</span>
<a name="ln-570"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">np_out</span> <span class="o">/=</span> <span class="n">np_new</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-571"></a><span class="k">        write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;error in x-part w-count&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">np_out</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-572"></a>        <span class="n">ier</span> <span class="o">=</span> <span class="mi">99</span>
<a name="ln-573"></a>       <span class="k">end if</span>
<a name="ln-574"></a><span class="k">       call </span><span class="n">p_realloc</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-575"></a>       <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-576"></a>       <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-577"></a>       <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-578"></a>      <span class="k">end if</span>
<a name="ln-579"></a><span class="k">     end do</span>
<a name="ln-580"></a><span class="k">    else</span>
<a name="ln-581"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspx</span>
<a name="ln-582"></a>      <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-583"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-584"></a><span class="k">       call </span><span class="n">reset_all_part_dist</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-585"></a>                                <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">moving_wind</span><span class="p">)</span>
<a name="ln-586"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">np_new</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-587"></a><span class="k">        </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-588"></a>        <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-589"></a>         <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-590"></a>        <span class="k">end do</span>
<a name="ln-591"></a><span class="k">       end if</span>
<a name="ln-592"></a><span class="k">      end if</span>
<a name="ln-593"></a><span class="k">     end do</span>
<a name="ln-594"></a><span class="k">    end if</span>
<a name="ln-595"></a><span class="k">    if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp_aux</span><span class="p">)</span>
<a name="ln-596"></a>    <span class="k">return</span>
<a name="ln-597"></a><span class="k">   </span><span class="n">endif</span>
<a name="ln-598"></a><span class="c">!=========== not mowing window section</span>
<a name="ln-599"></a>   <span class="n">nspx</span> <span class="o">=</span> <span class="n">nsp_run</span>
<a name="ln-600"></a>   <span class="n">xmm</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-601"></a>   <span class="n">xmx</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-602"></a>   <span class="n">lbd_min</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-603"></a>   <span class="n">rbd_max</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-604"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">prlx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-605"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspx</span>
<a name="ln-606"></a>     <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-607"></a>     <span class="n">np_new</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-608"></a>     <span class="n">n_sr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-609"></a>     <span class="k">call </span><span class="n">traffic_size_eval</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">pex0</span><span class="p">,</span> <span class="n">pex1</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-610"></a>                            <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_new</span><span class="p">)</span>
<a name="ln-611"></a>     <span class="c">! Allocate the aux array with lenght np + n_recieve</span>
<a name="ln-612"></a>     <span class="c">! because it needs to recieve before to send</span>
<a name="ln-613"></a>     <span class="n">np_new_allocate</span> <span class="o">=</span> <span class="n">np_new</span> <span class="o">+</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-614"></a>     <span class="n">np_rs</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-615"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np_rs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-616"></a><span class="k">      call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-617"></a>      <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-618"></a>      <span class="k">call </span><span class="n">part_prl_exchange</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">lbd_min</span><span class="p">,</span> <span class="n">rbd_max</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-619"></a>                             <span class="n">pex0</span><span class="p">,</span> <span class="n">pex1</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_out</span><span class="p">)</span>
<a name="ln-620"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_out</span> <span class="o">/=</span> <span class="n">np_new</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-621"></a><span class="k">       write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;error in x-part count&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">np_out</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-622"></a>       <span class="n">ier</span> <span class="o">=</span> <span class="mi">99</span>
<a name="ln-623"></a>      <span class="k">end if</span>
<a name="ln-624"></a><span class="k">      call </span><span class="n">p_realloc</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-625"></a>      <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-626"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-627"></a>      <span class="n">ebfp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np_new</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-628"></a>      <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-629"></a>     <span class="k">end if</span>
<a name="ln-630"></a><span class="k">    end do</span>
<a name="ln-631"></a><span class="k">   else</span>
<a name="ln-632"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspx</span>
<a name="ln-633"></a>     <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-634"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-635"></a><span class="k">      call </span><span class="n">reset_all_part_dist</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">xmm</span><span class="p">,</span> <span class="n">xmx</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-636"></a>                               <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">moving_wind</span><span class="p">)</span>
<a name="ln-637"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_new</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-638"></a><span class="k">       </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-639"></a>       <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-640"></a>        <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-641"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-642"></a>       <span class="k">end do</span>
<a name="ln-643"></a><span class="k">      end if</span>
<a name="ln-644"></a><span class="k">     end if</span>
<a name="ln-645"></a><span class="k">    end do</span>
<a name="ln-646"></a><span class="k">   end if</span>
<a name="ln-647"></a><span class="k">   if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp_aux</span><span class="p">)</span>
<a name="ln-648"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp1_aux</span><span class="p">)</span>
<a name="ln-649"></a><span class="c">!==========================</span>
<a name="ln-650"></a>   <span class="n">ymm</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-651"></a>   <span class="n">ymx</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-652"></a>   <span class="n">lbd_min</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-653"></a>   <span class="n">rbd_max</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-654"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">prly</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-655"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-656"></a>     <span class="n">n_sr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-657"></a>     <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-658"></a>     <span class="n">np_new</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-659"></a>     <span class="k">call </span><span class="n">traffic_size_eval</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ymm</span><span class="p">,</span> <span class="n">ymx</span><span class="p">,</span> <span class="n">pe0y</span><span class="p">,</span> <span class="n">pe1y</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-660"></a>                            <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_new</span><span class="p">)</span>
<a name="ln-661"></a>     <span class="n">np_new_allocate</span> <span class="o">=</span> <span class="n">np_new</span> <span class="o">+</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-662"></a>     <span class="n">np_rs</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-663"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np_rs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-664"></a><span class="k">      call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-665"></a>      <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-666"></a>      <span class="k">call </span><span class="n">part_prl_exchange</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">ymm</span><span class="p">,</span> <span class="n">ymx</span><span class="p">,</span> <span class="n">lbd_min</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-667"></a>                             <span class="n">rbd_max</span><span class="p">,</span> <span class="n">pe0y</span><span class="p">,</span> <span class="n">pe1y</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_out</span><span class="p">)</span>
<a name="ln-668"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_out</span> <span class="o">/=</span> <span class="n">np_new</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-669"></a><span class="k">       write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;error in y-part count&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">np_out</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-670"></a>       <span class="n">ier</span> <span class="o">=</span> <span class="mi">99</span>
<a name="ln-671"></a>      <span class="k">end if</span>
<a name="ln-672"></a><span class="k">      call </span><span class="n">p_realloc</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-673"></a>      <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-674"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-675"></a>       <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-676"></a>       <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-677"></a>      <span class="k">end do</span>
<a name="ln-678"></a><span class="k">      </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-679"></a>     <span class="k">end if</span>
<a name="ln-680"></a><span class="k">    end do</span>
<a name="ln-681"></a><span class="k">   else</span>
<a name="ln-682"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-683"></a>     <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-684"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-685"></a><span class="k">      call </span><span class="n">reset_all_part_dist</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">ymm</span><span class="p">,</span> <span class="n">ymx</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-686"></a>                               <span class="mi">2</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">moving_wind</span><span class="p">)</span>
<a name="ln-687"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_new</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-688"></a><span class="k">       </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-689"></a>       <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-690"></a>        <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-691"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-692"></a>       <span class="k">end do</span>
<a name="ln-693"></a><span class="k">      end if</span>
<a name="ln-694"></a><span class="k">     end if</span>
<a name="ln-695"></a><span class="k">    end do</span>
<a name="ln-696"></a><span class="k">   end if</span>
<a name="ln-697"></a><span class="k">   if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp_aux</span><span class="p">)</span>
<a name="ln-698"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp1_aux</span><span class="p">)</span>
<a name="ln-699"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-700"></a><span class="k">    </span><span class="n">zmm</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-701"></a>    <span class="n">zmx</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-702"></a>    <span class="n">lbd_min</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-703"></a>    <span class="n">rbd_max</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-704"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">prlz</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-705"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-706"></a>      <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-707"></a>      <span class="n">np_new</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-708"></a>      <span class="n">n_sr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-709"></a>      <span class="k">call </span><span class="n">traffic_size_eval</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">zmm</span><span class="p">,</span> <span class="n">zmx</span><span class="p">,</span> <span class="n">pe0z</span><span class="p">,</span> <span class="n">pe1z</span><span class="p">,</span> <span class="n">ibz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-710"></a>                             <span class="n">np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_new</span><span class="p">)</span>
<a name="ln-711"></a>      <span class="n">np_new_allocate</span> <span class="o">=</span> <span class="n">np_new</span> <span class="o">+</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-712"></a>      <span class="n">np_rs</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">n_sr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-713"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np_rs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-714"></a>       <span class="c">!=====================</span>
<a name="ln-715"></a>       <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-716"></a>       <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">,</span> <span class="n">np_new_allocate</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-717"></a>       <span class="c">!================</span>
<a name="ln-718"></a>       <span class="k">call </span><span class="n">part_prl_exchange</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">zmm</span><span class="p">,</span> <span class="n">zmx</span><span class="p">,</span> <span class="n">lbd_min</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-719"></a>                              <span class="n">rbd_max</span><span class="p">,</span> <span class="n">pe0z</span><span class="p">,</span> <span class="n">pe1z</span><span class="p">,</span> <span class="n">ibz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">n_sr</span><span class="p">,</span> <span class="n">np_out</span><span class="p">)</span>
<a name="ln-720"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">np_out</span> <span class="o">/=</span> <span class="n">np_new</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-721"></a><span class="k">        write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;error in z-part count&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">np_out</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-722"></a>        <span class="n">ier</span> <span class="o">=</span> <span class="mi">99</span>
<a name="ln-723"></a>       <span class="k">end if</span>
<a name="ln-724"></a><span class="k">       call </span><span class="n">p_realloc</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-725"></a>       <span class="k">call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">ndv</span><span class="p">)</span>
<a name="ln-726"></a>       <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-727"></a>        <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-728"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-729"></a>       <span class="k">end do</span>
<a name="ln-730"></a><span class="k">       </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-731"></a>      <span class="k">end if</span>
<a name="ln-732"></a><span class="k">     end do</span>
<a name="ln-733"></a><span class="k">    else</span>
<a name="ln-734"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-735"></a>      <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-736"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-737"></a><span class="k">       call </span><span class="n">reset_all_part_dist</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">zmm</span><span class="p">,</span> <span class="n">zmx</span><span class="p">,</span> <span class="n">ibz</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-738"></a>                                <span class="mi">3</span><span class="p">,</span> <span class="n">np_new</span><span class="p">,</span> <span class="n">moving_wind</span><span class="p">)</span>
<a name="ln-739"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">np_new</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-740"></a><span class="k">        </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_new</span>
<a name="ln-741"></a>        <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_new</span>
<a name="ln-742"></a>         <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-743"></a>         <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp1_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">ndv</span><span class="p">)</span>
<a name="ln-744"></a>        <span class="k">end do</span>
<a name="ln-745"></a><span class="k">       end if</span>
<a name="ln-746"></a><span class="k">      end if</span>
<a name="ln-747"></a><span class="k">     end do</span>
<a name="ln-748"></a><span class="k">    end if</span>
<a name="ln-749"></a><span class="k">    if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp_aux</span><span class="p">)</span>
<a name="ln-750"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">sp1_aux</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">sp1_aux</span><span class="p">)</span>
<a name="ln-751"></a>   <span class="k">end if</span>
<a name="ln-752"></a>   <span class="c">!=====================</span>
<a name="ln-753"></a>  <span class="k">end subroutine</span>
<a name="ln-754"></a>  <span class="c">!=========================</span>
<a name="ln-755"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>