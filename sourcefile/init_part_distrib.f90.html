<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>init_part_distrib.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>init_part_distrib.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 8.1% of total for source files.">1994 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/init_part_distrib.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">init_part_distrib.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/init_part_distrib.html">init_part_distrib</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/init_part_distrib.f90.html#src">init_part_distrib.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~init_part_distrib.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefileinit_part_distribf90EfferentGraph" width="641pt" height="255pt"
 viewBox="0.00 0.00 641.00 254.53" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph" class="graph" transform="scale(.9358 .9358) rotate(0) translate(4 268)">
<title>sourcefile~~init_part_distrib.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-268 681,-268 681,4 -4,4"/>
<!-- sourcefile~init_part_distrib.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~init_part_distrib.f90</title>
<polygon fill="none" stroke="#000000" points="677,-164 562,-164 562,-140 677,-140 677,-164"/>
<text text-anchor="middle" x="619.5" y="-149.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">init_part_distrib.f90</text>
</g>
<!-- sourcefile~phys_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~phys_param.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/phys_param.f90.html" xlink:title="phys_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="251.5,-264 153.5,-264 153.5,-240 251.5,-240 251.5,-264"/>
<text text-anchor="middle" x="202.5" y="-249.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">phys_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~phys_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~phys_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M348.5,-252C320.0206,-250.293 288.3602,-250.0871 261.8217,-250.3922"/>
<polygon fill="#ff0000" stroke="#ff0000" points="261.4926,-246.8965 251.5435,-250.5385 261.5923,-253.8958 261.4926,-246.8965"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="507,-224 453,-224 453,-200 507,-200 507,-224"/>
<text text-anchor="middle" x="480" y="-209.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M591.2701,-164.1419C569.7184,-173.4115 539.8515,-186.2574 516.4869,-196.3067"/>
<polygon fill="#ff0000" stroke="#ff0000" points="515.042,-193.1181 507.2385,-200.2845 517.8078,-199.5485 515.042,-193.1181"/>
</g>
<!-- sourcefile~array_alloc.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~array_alloc.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/array_alloc.f90.html" xlink:title="array_alloc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="526,-63 434,-63 434,-39 526,-39 526,-63"/>
<text text-anchor="middle" x="480" y="-48.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">array_alloc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~array_alloc.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~array_alloc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M605.3971,-139.8218C587.491,-124.6013 555.3845,-98.109 526,-78 521.1043,-74.6497 515.7783,-71.2854 510.5438,-68.1239"/>
<polygon fill="#ff0000" stroke="#ff0000" points="512.3046,-65.099 501.9132,-63.033 508.7482,-71.1283 512.3046,-65.099"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="263,-213 142,-213 142,-189 263,-189 263,-213"/>
<text text-anchor="middle" x="202.5" y="-198.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M609.8193,-164.179C594.3333,-182.6688 562.0411,-217.3242 526,-233 453.2443,-264.6445 427.5432,-258.8509 348.5,-252"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M348.5,-252C307.3248,-249.5321 262.9879,-231.6584 234.1136,-217.7587"/>
<polygon fill="#ff0000" stroke="#ff0000" points="235.4568,-214.5185 224.9411,-213.2253 232.3551,-220.7938 235.4568,-214.5185"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="517.5,-144 442.5,-144 442.5,-120 517.5,-120 517.5,-144"/>
<text text-anchor="middle" x="480" y="-129.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M561.9546,-143.7498C550.6932,-142.1352 538.9938,-140.4579 528.0801,-138.8932"/>
<polygon fill="#ff0000" stroke="#ff0000" points="528.2929,-135.388 517.8973,-137.4333 527.2994,-142.3171 528.2929,-135.388"/>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="389,-185 308,-185 308,-161 389,-161 389,-185"/>
<text text-anchor="middle" x="348.5" y="-170.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M561.6961,-156.4793C513.4269,-160.2197 445.2896,-165.4997 399.1373,-169.0761"/>
<polygon fill="#ff0000" stroke="#ff0000" points="398.7608,-165.5947 389.0611,-169.8569 399.3017,-172.5737 398.7608,-165.5947"/>
</g>
<!-- sourcefile~grid_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~grid_param.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/grid_param.f90.html" xlink:title="grid_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="395.5,-105 301.5,-105 301.5,-81 395.5,-81 395.5,-105"/>
<text text-anchor="middle" x="348.5" y="-90.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~grid_param.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~init_part_distrib.f90&#45;&gt;sourcefile~grid_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M597.1638,-139.8279C578.6563,-130.3327 551.37,-117.6718 526,-111 486.6033,-100.6394 440.8385,-96.1734 405.6466,-94.2799"/>
<polygon fill="#ff0000" stroke="#ff0000" points="405.7079,-90.7789 395.5504,-93.7911 405.3694,-97.7707 405.7079,-90.7789"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-143 0,-143 0,-119 106,-119 106,-143"/>
<text text-anchor="middle" x="53" y="-128.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~phys_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~phys_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M173.3554,-239.9799C163.0166,-235.099 151.579,-228.961 142,-222 113.375,-201.1982 85.7392,-170.8165 69.0543,-150.9776"/>
<polygon fill="#ff0000" stroke="#ff0000" points="71.6742,-148.6535 62.6031,-143.1793 66.2805,-153.1155 71.6742,-148.6535"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M452.7531,-203.9192C437.1937,-199.3046 417.1926,-193.3727 398.8773,-187.9408"/>
<polygon fill="#ffda00" stroke="#ffda00" points="399.7837,-184.559 389.2013,-185.0711 397.7933,-191.2701 399.7837,-184.559"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M452.9973,-212.5225C417.0653,-212.5003 351.9129,-209.9429 299,-194 252.5524,-180.0051 250.8475,-146.9686 202.5,-143"/>
</g>
<!-- sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~fstruct_data.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/fstruct_data.f90.html" xlink:title="fstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="250.5,-24 154.5,-24 154.5,0 250.5,0 250.5,-24"/>
<text text-anchor="middle" x="202.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M438.1402,-38.9144C425.3477,-35.5914 411.1773,-32.2791 398,-30 352.2163,-22.0815 299.7577,-17.4922 260.7149,-14.9318"/>
<polygon fill="#48ff00" stroke="#48ff00" points="260.7842,-11.4293 250.5838,-14.2931 260.3437,-18.4155 260.7842,-11.4293"/>
</g>
<!-- sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~pstruct_data.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/pstruct_data.f90.html" xlink:title="pstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="398,-63 299,-63 299,-39 398,-39 398,-63"/>
<text text-anchor="middle" x="348.5" y="-48.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M433.638,-51C425.4371,-51 416.7942,-51 408.2857,-51"/>
<polygon fill="#48ff00" stroke="#48ff00" points="408.0125,-47.5001 398.0125,-51 408.0125,-54.5001 408.0125,-47.5001"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M176.8,-188.9666C152.305,-177.4973 115.2287,-160.1372 88.0348,-147.4042"/>
<polygon fill="#00ff91" stroke="#00ff91" points="89.4055,-144.1814 78.8649,-143.1107 86.4371,-150.5209 89.4055,-144.1814"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M442.2498,-136.2141C388.8141,-141.561 288.0861,-149.3657 202.5,-143"/>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M307.989,-161.7584C278.9053,-154.4074 238.6277,-145.6871 202.5,-143"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="245,-105 160,-105 160,-81 245,-81 245,-105"/>
<text text-anchor="middle" x="202.5" y="-90.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M301.098,-93C286.4852,-93 270.3055,-93 255.35,-93"/>
<polygon fill="#ff00da" stroke="#ff00da" points="255.2262,-89.5001 245.2261,-93 255.2261,-96.5001 255.2262,-89.5001"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M321.5261,-105.109C286.2031,-120.4602 226.0124,-144.7488 202.5,-143"/>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M202.5,-143C174.3039,-140.9028 143.1301,-138.4258 116.5775,-136.2684"/>
<polygon fill="#ff00da" stroke="#ff00da" points="116.5168,-132.7519 106.2655,-135.4278 115.948,-139.7288 116.5168,-132.7519"/>
</g>
<!-- sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M169.2441,-24.1214C160.0312,-28.1897 150.2913,-33.1944 142,-39 112.6916,-59.5219 85.0461,-90.6192 68.5641,-110.8732"/>
<polygon fill="#ff0000" stroke="#ff0000" points="65.7173,-108.8291 62.2115,-118.8271 71.187,-113.1976 65.7173,-108.8291"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M159.6593,-103.8893C144.2969,-107.7941 126.7208,-112.2616 110.3284,-116.4282"/>
<polygon fill="#7fff00" stroke="#7fff00" points="109.1347,-113.1203 100.3051,-118.976 110.8592,-119.9045 109.1347,-113.1203"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M306.6623,-63.0355C290.3205,-67.7366 271.4138,-73.1755 254.2299,-78.1188"/>
<polygon fill="#00ffff" stroke="#00ffff" points="252.9865,-74.8345 244.3439,-80.9627 254.9217,-81.5617 252.9865,-74.8345"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M298.6382,-49.4549C255.8752,-49.6662 193.2373,-53.6806 142,-72 116.8783,-80.982 91.8751,-98.511 74.7963,-112.1387"/>
<polygon fill="#00ffff" stroke="#00ffff" points="72.1373,-109.7933 66.6289,-118.8437 76.5789,-115.2037 72.1373,-109.7933"/>
</g>
</g>
</svg>
</div><script>var pansourcefileinit_part_distribf90EfferentGraph = svgPanZoom('#sourcefileinit_part_distribf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~init_part_distrib.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefileinit_part_distribf90AfferentGraph" width="448pt" height="32pt"
 viewBox="0.00 0.00 448.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~init_part_distrib.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 444,-28 444,4 -4,4"/>
<!-- sourcefile~init_part_distrib.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~init_part_distrib.f90</title>
<polygon fill="none" stroke="#000000" points="115,-24 0,-24 0,0 115,0 115,-24"/>
<text text-anchor="middle" x="57.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">init_part_distrib.f90</text>
</g>
<!-- sourcefile~pic_in.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~pic_in.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/pic_in.f90.html" xlink:title="pic_in.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="215,-24 151,-24 151,0 215,0 215,-24"/>
<text text-anchor="middle" x="183" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_in.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_in.f90&#45;&gt;sourcefile~init_part_distrib.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~pic_in.f90&#45;&gt;sourcefile~init_part_distrib.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M150.6806,-12C142.7655,-12 133.998,-12 125.0997,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="125.0361,-8.5001 115.0361,-12 125.036,-15.5001 125.0361,-8.5001"/>
</g>
<!-- sourcefile~start_all.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~start_all.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/start_all.f90.html" xlink:title="start_all.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="328,-24 251,-24 251,0 328,0 328,-24"/>
<text text-anchor="middle" x="289.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">start_all.F90</text>
</a>
</g>
</g>
<!-- sourcefile~start_all.f90&#45;&gt;sourcefile~pic_in.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~start_all.f90&#45;&gt;sourcefile~pic_in.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M250.7498,-12C242.4624,-12 233.6678,-12 225.2558,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="225.2448,-8.5001 215.2448,-12 225.2448,-15.5001 225.2448,-8.5001"/>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~init_part_distrib.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="440,-24 364,-24 364,0 440,0 440,-24"/>
<text text-anchor="middle" x="402" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90 -->
<g id="sourcefile~~init_part_distrib.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M363.9126,-12C355.7553,-12 347.0272,-12 338.5231,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="338.3146,-8.5001 328.3146,-12 338.3145,-15.5001 338.3146,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/init_part_distrib.html">init_part_distrib</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/init_part_distrib.f90.html#src">init_part_distrib.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2019  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">init_part_distrib</span>
<a name="ln-23"></a>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">common_param</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">util</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">grid_param</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">array_alloc</span>
<a name="ln-28"></a>  <span class="k">use </span><span class="n">mpi_var</span>
<a name="ln-29"></a>  <span class="k">use </span><span class="n">code_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">maxv</span><span class="p">,</span> <span class="n">mem_psize</span>
<a name="ln-30"></a>  <span class="k">use </span><span class="n">phys_param</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">pi</span>
<a name="ln-31"></a>
<a name="ln-32"></a>  <span class="k">implicit none</span>
<a name="ln-33"></a><span class="k">  private</span>
<a name="ln-34"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">part_distribute</span>
<a name="ln-35"></a>
<a name="ln-36"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">loc_imax</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">loc_jmax</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">loc_kmax</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-37"></a>
<a name="ln-38"></a> <span class="k">contains</span>
<a name="ln-39"></a>
<a name="ln-40"></a><span class="k">  subroutine </span><span class="n">set_pgrid_xind</span><span class="p">(</span><span class="n">npx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-41"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">npx</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-42"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-43"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xp</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span>
<a name="ln-44"></a>
<a name="ln-45"></a>   <span class="c">!Defines the the number of particles on each mpi x-domain</span>
<a name="ln-46"></a>   <span class="c">! Enter the total particle number npx and the particle species ic</span>
<a name="ln-47"></a>   <span class="c">! Particle x-distribution is already defined by xpt(nptx,ic)</span>
<a name="ln-48"></a>   <span class="c">! Exit loc_imax(pex,ic) for each pex task</span>
<a name="ln-49"></a>   <span class="c">!=================================================</span>
<a name="ln-50"></a>   <span class="n">loc_imax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-51"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-52"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-53"></a>   <span class="n">x1</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-54"></a>   <span class="n">x2</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="mi">0</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-55"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npx</span>
<a name="ln-56"></a>    <span class="n">xp</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-57"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;=</span> <span class="n">x1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-58"></a>   <span class="k">end do</span>
<a name="ln-59"></a><span class="k">   </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span> <span class="c">!number of grid points in [loc_xmin,loc_xmax]</span>
<a name="ln-60"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npe_xloc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-61"></a><span class="k">    do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-62"></a>     <span class="n">x1</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-63"></a>     <span class="n">x2</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-64"></a>     <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-65"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npx</span>
<a name="ln-66"></a>      <span class="n">xp</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-67"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;=</span> <span class="n">x1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xp</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-68"></a>     <span class="k">end do</span>
<a name="ln-69"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-70"></a>    <span class="k">end do</span>
<a name="ln-71"></a><span class="k">   end if</span>
<a name="ln-72"></a><span class="k">  end subroutine</span>
<a name="ln-73"></a>
<a name="ln-74"></a><span class="k">  subroutine </span><span class="n">set_pgrid_ind</span><span class="p">(</span><span class="n">npy</span><span class="p">,</span> <span class="n">npz</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-75"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">npy</span><span class="p">,</span> <span class="n">npz</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-76"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-77"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">yp</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>
<a name="ln-78"></a>
<a name="ln-79"></a>   <span class="c">! Particles number index on each y-z mpi domain</span>
<a name="ln-80"></a>   <span class="c">! Enter the total particle number npy, npz and the particle species ic</span>
<a name="ln-81"></a>   <span class="c">! Particle y-z-distributions are ypt(npy,ic), zpt(npz,ic)</span>
<a name="ln-82"></a>   <span class="c">! Exit loc_jmax(pey,ic) loc_kmax(pez,ic)for each pey peztask</span>
<a name="ln-83"></a>   <span class="c">!=======================================</span>
<a name="ln-84"></a>   <span class="n">loc_jmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-85"></a>   <span class="n">loc_kmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-86"></a>
<a name="ln-87"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-88"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-89"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npy</span>
<a name="ln-90"></a>    <span class="n">yp</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-91"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="n">ymin_t</span>
<a name="ln-92"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-93"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-94"></a>   <span class="k">end do</span>
<a name="ln-95"></a><span class="k">   </span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span> <span class="c">!number of particle y-positions in [loc_ymin,loc_ymax]</span>
<a name="ln-96"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npe_yloc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-97"></a><span class="k">    do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-98"></a>     <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-99"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npy</span>
<a name="ln-100"></a>      <span class="n">yp</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-101"></a>      <span class="n">y1</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-102"></a>      <span class="n">y2</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-103"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-104"></a>     <span class="k">end do</span>
<a name="ln-105"></a><span class="k">     </span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-106"></a>    <span class="k">end do</span>
<a name="ln-107"></a><span class="k">   end if</span>
<a name="ln-108"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-109"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-110"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npy</span>
<a name="ln-111"></a>    <span class="n">yp</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-112"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-113"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">ymax_t</span>
<a name="ln-114"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-115"></a>   <span class="k">end do</span>
<a name="ln-116"></a><span class="k">   </span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-117"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npz</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-118"></a>
<a name="ln-119"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-120"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-121"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npz</span>
<a name="ln-122"></a>    <span class="n">yp</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-123"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="n">zmin_t</span>
<a name="ln-124"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-125"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-126"></a>   <span class="k">end do</span>
<a name="ln-127"></a><span class="k">   </span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-128"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npe_zloc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-129"></a><span class="k">    do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-130"></a>     <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-131"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npz</span>
<a name="ln-132"></a>      <span class="n">yp</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-133"></a>      <span class="n">y1</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-134"></a>      <span class="n">y2</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-135"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-136"></a>     <span class="k">end do</span>
<a name="ln-137"></a><span class="k">     </span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-138"></a>    <span class="k">end do</span>
<a name="ln-139"></a><span class="k">   end if</span>
<a name="ln-140"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-141"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-142"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npz</span>
<a name="ln-143"></a>    <span class="n">yp</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-144"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">p</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-145"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">zmax_t</span>
<a name="ln-146"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;=</span> <span class="n">y1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">yp</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">)</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-147"></a>   <span class="k">end do</span>
<a name="ln-148"></a><span class="k">   </span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-149"></a>  <span class="k">end subroutine</span>
<a name="ln-150"></a>
<a name="ln-151"></a>  <span class="c">!--------------------------</span>
<a name="ln-152"></a>  <span class="k">subroutine </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">loc_sp</span><span class="p">,</span> <span class="n">t_x</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<a name="ln-153"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">loc_sp</span>
<a name="ln-154"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t_x</span><span class="p">,</span> <span class="n">ch</span>
<a name="ln-155"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">q</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-156"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
<a name="ln-157"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-158"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u</span><span class="p">,</span> <span class="n">whz</span>
<a name="ln-159"></a>
<a name="ln-160"></a>   <span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">mype</span><span class="p">)</span>
<a name="ln-161"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">q</span>
<a name="ln-162"></a>   <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">hp_int</span><span class="p">)</span>
<a name="ln-163"></a>   <span class="n">part_ind</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-164"></a>   <span class="n">k2</span> <span class="o">=</span> <span class="n">loc_nptz</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-165"></a>   <span class="n">j2</span> <span class="o">=</span> <span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-166"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">curr_ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-167"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-168"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-169"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-170"></a>       <span class="n">whz</span> <span class="o">=</span> <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">loc_wghyz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-171"></a>       <span class="n">wgh</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">whz</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-172"></a>       <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-173"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-174"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-175"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_zpt</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-176"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-177"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">*</span><span class="n">u</span>
<a name="ln-178"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-179"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">*</span><span class="n">u</span>
<a name="ln-180"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-181"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">*</span><span class="n">u</span>
<a name="ln-182"></a>       <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-183"></a>      <span class="k">end do</span>
<a name="ln-184"></a><span class="k">     end do</span>
<a name="ln-185"></a><span class="k">    end do</span>
<a name="ln-186"></a><span class="k">    return</span>
<a name="ln-187"></a><span class="k">   end if</span>
<a name="ln-188"></a>
<a name="ln-189"></a><span class="k">   do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-190"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-191"></a>     <span class="n">whz</span> <span class="o">=</span> <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">loc_wghyz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-192"></a>     <span class="n">wgh</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">whz</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-193"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-194"></a>     <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-195"></a>     <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-196"></a>     <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-197"></a>     <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">*</span><span class="n">u</span>
<a name="ln-198"></a>     <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-199"></a>     <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_x</span><span class="o">*</span><span class="n">u</span>
<a name="ln-200"></a>     <span class="n">loc_sp</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-201"></a>    <span class="k">end do</span>
<a name="ln-202"></a><span class="k">   end do</span>
<a name="ln-203"></a><span class="k">  end subroutine</span>
<a name="ln-204"></a>  <span class="c">!==============================</span>
<a name="ln-205"></a>  <span class="k">subroutine </span><span class="n">mpi_x_part_distrib</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
<a name="ln-206"></a>   <span class="c">!Local to imodx distribution</span>
<a name="ln-207"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nc</span>
<a name="ln-208"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ix_min</span>
<a name="ln-209"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x1</span>
<a name="ln-210"></a>
<a name="ln-211"></a>   <span class="n">x1</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-212"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-213"></a>    <span class="n">ix_min</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-214"></a>    <span class="k">do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!the total particle number</span>
<a name="ln-215"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">)</span> <span class="n">ix_min</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-216"></a>    <span class="k">end do</span>
<a name="ln-217"></a><span class="k">    do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!the local particle number</span>
<a name="ln-218"></a>     <span class="n">ix_min</span> <span class="o">=</span> <span class="n">ix_min</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-219"></a>     <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">ix_min</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-220"></a>     <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">ix_min</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-221"></a>    <span class="k">end do</span>
<a name="ln-222"></a><span class="k">   end do</span>
<a name="ln-223"></a><span class="k">  end subroutine</span>
<a name="ln-224"></a>  <span class="c">!=====================================</span>
<a name="ln-225"></a>  <span class="k">subroutine </span><span class="n">mpi_yz_part_distrib</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">ky2_in</span><span class="p">,</span> <span class="n">kz2_in</span><span class="p">,</span> <span class="n">nyc</span><span class="p">,</span> <span class="n">nzc</span><span class="p">,</span> <span class="n">ymt</span><span class="p">,</span> <span class="n">zmt</span><span class="p">,</span> <span class="n">whyz</span><span class="p">)</span>
<a name="ln-226"></a>
<a name="ln-227"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nc</span><span class="p">,</span> <span class="n">ky2_in</span><span class="p">(:),</span> <span class="n">kz2_in</span><span class="p">(:),</span> <span class="n">nyc</span><span class="p">(:),</span> <span class="n">nzc</span><span class="p">(:)</span>
<a name="ln-228"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ymt</span><span class="p">,</span> <span class="n">zmt</span><span class="p">,</span> <span class="n">whyz</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-229"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-230"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">loc_ym</span><span class="p">,</span> <span class="n">loc_zm</span>
<a name="ln-231"></a>
<a name="ln-232"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-233"></a><span class="k">    </span><span class="n">loc_ym</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-234"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">imody</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">loc_ym</span> <span class="o">=</span> <span class="n">ymt</span>
<a name="ln-235"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-236"></a>     <span class="n">k1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-237"></a>     <span class="k">do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-238"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ypt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_ym</span><span class="p">)</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-239"></a>     <span class="k">end do</span>
<a name="ln-240"></a><span class="k">     do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ky2_in</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-241"></a>      <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-242"></a>      <span class="n">loc_ypt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-243"></a>      <span class="n">loc_wghyz</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">whyz</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-244"></a>     <span class="k">end do</span>
<a name="ln-245"></a><span class="k">    end do</span>
<a name="ln-246"></a><span class="k">    </span><span class="n">zpt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-247"></a>    <span class="k">return</span>
<a name="ln-248"></a><span class="k">   end if</span>
<a name="ln-249"></a>   <span class="c">!==========================</span>
<a name="ln-250"></a>   <span class="n">loc_zm</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-251"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">imodz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">loc_zm</span> <span class="o">=</span> <span class="n">zmt</span>
<a name="ln-252"></a>   <span class="n">loc_ym</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-253"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">imody</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">loc_ym</span> <span class="o">=</span> <span class="n">ymt</span>
<a name="ln-254"></a>
<a name="ln-255"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-256"></a>    <span class="n">k1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-257"></a>    <span class="k">do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nzc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-258"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_zm</span><span class="p">)</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-259"></a>    <span class="k">end do</span>
<a name="ln-260"></a><span class="k">    do </span><span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kz2_in</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-261"></a>     <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-262"></a>     <span class="n">loc_zpt</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-263"></a>     <span class="n">j1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-264"></a>     <span class="k">do </span><span class="n">j2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-265"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ypt</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_ym</span><span class="p">)</span> <span class="n">j1</span> <span class="o">=</span> <span class="n">j2</span>
<a name="ln-266"></a>     <span class="k">end do</span>
<a name="ln-267"></a><span class="k">     do </span><span class="n">j2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ky2_in</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-268"></a>      <span class="n">j1</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-269"></a>      <span class="n">loc_ypt</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-270"></a>      <span class="n">loc_wghyz</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">whyz</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-271"></a>     <span class="k">end do</span>
<a name="ln-272"></a><span class="k">    end do</span>
<a name="ln-273"></a><span class="k">   end do</span>
<a name="ln-274"></a><span class="k">  end subroutine</span>
<a name="ln-275"></a>  <span class="c">!--------------------------</span>
<a name="ln-276"></a>  <span class="k">subroutine </span><span class="n">set_uniform_yz_distrib</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-277"></a>
<a name="ln-278"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-279"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-280"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npyc</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">npzc</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-281"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">dxip</span><span class="p">,</span> <span class="n">dpy</span><span class="p">,</span> <span class="n">dpz</span>
<a name="ln-282"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">zp_min</span><span class="p">,</span> <span class="n">zp_max</span><span class="p">,</span> <span class="n">yp_min</span><span class="p">,</span> <span class="n">yp_max</span>
<a name="ln-283"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nyl1</span><span class="p">,</span> <span class="n">nzl1</span>
<a name="ln-284"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">wy</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wz</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wyz</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-285"></a>   <span class="c">!=================</span>
<a name="ln-286"></a>   <span class="c">!========= gridding the transverse target size</span>
<a name="ln-287"></a>   <span class="n">nyl1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nyh_in</span><span class="o">/</span><span class="mi">2</span> <span class="c">!=1 if nyh_in=ny</span>
<a name="ln-288"></a>   <span class="n">nzl1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nz</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nyh_in</span><span class="o">/</span><span class="mi">2</span> <span class="c">!=1 if nyh_in=nz</span>
<a name="ln-289"></a>   <span class="n">yp_min</span> <span class="o">=</span> <span class="n">ymin_t</span>
<a name="ln-290"></a>   <span class="n">yp_max</span> <span class="o">=</span> <span class="n">ymax_t</span>
<a name="ln-291"></a>   <span class="c">!=============================</span>
<a name="ln-292"></a>   <span class="c">! Multispecies</span>
<a name="ln-293"></a>   <span class="c">!=============================</span>
<a name="ln-294"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-295"></a>    <span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-296"></a>   <span class="k">end do</span>
<a name="ln-297"></a><span class="k">   </span><span class="n">npty</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">npyc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-298"></a>   <span class="n">nptz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-299"></a>   <span class="n">zp_min</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-300"></a>   <span class="n">zp_max</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-301"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-302"></a><span class="k">    </span><span class="n">npzc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_zc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span>
<a name="ln-303"></a>    <span class="n">zp_min</span> <span class="o">=</span> <span class="n">zmin_t</span> <span class="c">!-Lz</span>
<a name="ln-304"></a>    <span class="n">zp_max</span> <span class="o">=</span> <span class="n">zmax_t</span> <span class="c">!+Lz</span>
<a name="ln-305"></a>    <span class="n">nptz</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">npzc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-306"></a>   <span class="k">end if</span>
<a name="ln-307"></a><span class="k">   allocate</span> <span class="p">(</span><span class="n">ypt</span><span class="p">(</span><span class="n">npty</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-308"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">nptz</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-309"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wy</span><span class="p">(</span><span class="n">npty</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-310"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wz</span><span class="p">(</span><span class="n">nptz</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-311"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wyz</span><span class="p">(</span><span class="n">npty</span><span class="p">,</span> <span class="n">nptz</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-312"></a>   <span class="n">ypt</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-313"></a>   <span class="n">zpt</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-314"></a>   <span class="n">wyz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-315"></a>   <span class="n">wy</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-316"></a>   <span class="n">wz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-317"></a>   <span class="c">!==================</span>
<a name="ln-318"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_jmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-319"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_kmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-320"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_imax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-321"></a>   <span class="c">!====================</span>
<a name="ln-322"></a>   <span class="c">! Uniform layers along y-z coordinates</span>
<a name="ln-323"></a>   <span class="c">!===============</span>
<a name="ln-324"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-325"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-326"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">npty_ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-327"></a><span class="k">     </span><span class="n">dpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-328"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-329"></a>      <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-330"></a>     <span class="k">end do</span>
<a name="ln-331"></a><span class="k">     if</span> <span class="p">(</span><span class="n">stretch</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-332"></a><span class="k">      </span><span class="n">yy</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span>
<a name="ln-333"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">yy</span> <span class="o">&gt;</span> <span class="n">yp_min</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-334"></a><span class="k">       </span><span class="n">dpy</span> <span class="o">=</span> <span class="n">dyi</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-335"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="p">(</span><span class="n">str_ygrid</span><span class="p">%</span><span class="n">sind</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nyl1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-336"></a>       <span class="n">i2</span> <span class="o">=</span> <span class="n">npty_ne</span> <span class="o">-</span> <span class="n">i1</span>
<a name="ln-337"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i1</span>
<a name="ln-338"></a>        <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-339"></a>        <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-340"></a>        <span class="n">wy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-341"></a>       <span class="k">end do</span>
<a name="ln-342"></a><span class="k">       </span><span class="n">dxip</span> <span class="o">=</span> <span class="n">dy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-343"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-344"></a>        <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">dxip</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-345"></a>       <span class="k">end do</span>
<a name="ln-346"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-347"></a>        <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i2</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-348"></a>        <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smax</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-349"></a>        <span class="n">wy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-350"></a>       <span class="k">end do</span>
<a name="ln-351"></a><span class="k">      end if</span>
<a name="ln-352"></a><span class="k">     end if</span>
<a name="ln-353"></a><span class="k">     do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-354"></a>      <span class="n">wyz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">wz</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-355"></a>     <span class="k">end do</span>
<a name="ln-356"></a><span class="k">    end if</span> <span class="c">! end np_per_yc &gt;0</span>
<a name="ln-357"></a>    <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-358"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-359"></a><span class="k">     </span><span class="n">nptz_ne</span> <span class="o">=</span> <span class="n">npzc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-360"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">nptz_ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-361"></a><span class="k">      </span><span class="n">dpz</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp_max</span> <span class="o">-</span> <span class="n">zp_min</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">nptz_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-362"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-363"></a>       <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">zp_min</span> <span class="o">+</span> <span class="n">dpz</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-364"></a>      <span class="k">end do</span>
<a name="ln-365"></a><span class="k">      if</span> <span class="p">(</span><span class="n">stretch</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-366"></a><span class="k">       </span><span class="n">zz</span> <span class="o">=</span> <span class="n">str_zgrid</span><span class="p">%</span><span class="n">smin</span>
<a name="ln-367"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">zz</span> <span class="o">&gt;</span> <span class="n">zp_min</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-368"></a><span class="k">        </span><span class="n">dpz</span> <span class="o">=</span> <span class="n">dzi</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">np_per_zc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-369"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="p">(</span><span class="n">str_zgrid</span><span class="p">%</span><span class="n">sind</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nzl1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_zc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-370"></a>        <span class="n">i2</span> <span class="o">=</span> <span class="n">nptz_ne</span> <span class="o">-</span> <span class="n">i1</span>
<a name="ln-371"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i1</span>
<a name="ln-372"></a>         <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-373"></a>         <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_zgrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-374"></a>         <span class="n">wz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-375"></a>        <span class="k">end do</span>
<a name="ln-376"></a><span class="k">        </span><span class="n">dxip</span> <span class="o">=</span> <span class="n">dz</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">np_per_zc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-377"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-378"></a>         <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_zgrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">dxip</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-379"></a>        <span class="k">end do</span>
<a name="ln-380"></a><span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-381"></a>         <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i2</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-382"></a>         <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_zgrid</span><span class="p">%</span><span class="n">smax</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-383"></a>         <span class="n">wz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-384"></a>        <span class="k">end do</span>
<a name="ln-385"></a><span class="k">       end if</span>
<a name="ln-386"></a><span class="k">      end if</span>
<a name="ln-387"></a><span class="k">     end if</span>
<a name="ln-388"></a><span class="k">     do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-389"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-390"></a>       <span class="n">wyz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">wz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-391"></a>      <span class="k">end do</span>
<a name="ln-392"></a><span class="k">     end do</span>
<a name="ln-393"></a><span class="k">     if</span> <span class="p">(</span><span class="n">chann_fact</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-394"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-395"></a>       <span class="n">zz</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-396"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-397"></a>        <span class="n">yy</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-398"></a>        <span class="n">wyz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">chann_fact</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span><span class="o">*</span><span class="n">yy</span> <span class="o">+</span> <span class="n">zz</span><span class="o">*</span><span class="n">zz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">w0_y</span><span class="o">*</span><span class="n">w0_y</span><span class="p">)</span>
<a name="ln-399"></a>       <span class="k">end do</span>
<a name="ln-400"></a><span class="k">      end do</span>
<a name="ln-401"></a><span class="k">     end if</span>
<a name="ln-402"></a><span class="k">    end if</span> <span class="c">!end ndim=3</span>
<a name="ln-403"></a>    <span class="k">call </span><span class="n">set_pgrid_ind</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="c">!exit loc_jmax,loc_kmax</span>
<a name="ln-404"></a>   <span class="k">end do</span>
<a name="ln-405"></a>   <span class="c">!===========================</span>
<a name="ln-406"></a>   <span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_jmax</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span>
<a name="ln-407"></a>   <span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_kmax</span><span class="p">(</span><span class="n">imodz</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">)</span>
<a name="ln-408"></a>   <span class="c">!=============================</span>
<a name="ln-409"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-410"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-411"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-412"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nc</span><span class="p">))</span>
<a name="ln-413"></a>   <span class="c">!======================</span>
<a name="ln-414"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghyz</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-415"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_ypt</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-416"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_zpt</span><span class="p">(</span><span class="n">nptz_ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
<a name="ln-417"></a>   <span class="n">loc_wghyz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-418"></a>   <span class="k">call </span><span class="n">mpi_yz_part_distrib</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">loc_npty</span><span class="p">,</span> <span class="n">loc_nptz</span><span class="p">,</span> <span class="n">npyc</span><span class="p">,</span> <span class="n">npzc</span><span class="p">,</span> <span class="n">ymin_t</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-419"></a>                            <span class="n">zmin_t</span><span class="p">,</span> <span class="n">wyz</span><span class="p">)</span>
<a name="ln-420"></a>
<a name="ln-421"></a>   <span class="c">!=EXIT local to mpi (imody,imodz) tasks (loc_ypt,loc_zpt), weights (loc_wghyz)</span>
<a name="ln-422"></a>   <span class="c">! =&gt; set in common in pstruct_data.f90 file/</span>
<a name="ln-423"></a>   <span class="c">! and particle numbers (loc_npty,loc_nptz)</span>
<a name="ln-424"></a>   <span class="c">! =&gt; set in common in grid_and_partices.f90 file/</span>
<a name="ln-425"></a>   <span class="c">!=====================================</span>
<a name="ln-426"></a>   <span class="c">!==================</span>
<a name="ln-427"></a>  <span class="k">end subroutine</span>
<a name="ln-428"></a>  <span class="c">!===========================================</span>
<a name="ln-429"></a>  <span class="k">subroutine </span><span class="n">multi_layer_gas_target</span><span class="p">(</span><span class="n">layer_mod</span><span class="p">,</span> <span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-430"></a>
<a name="ln-431"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">layer_mod</span><span class="p">,</span> <span class="n">nyh_in</span>
<a name="ln-432"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-433"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-434"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_peak</span><span class="p">,</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nxtot</span><span class="p">,</span> <span class="n">len_conc</span>
<a name="ln-435"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uu</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">ramp_prefactor</span>
<a name="ln-436"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">un</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-437"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">conc</span><span class="p">(:)</span>
<a name="ln-438"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-439"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">last_particle_index</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">nptx_alloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-440"></a>   <span class="c">!==========================</span>
<a name="ln-441"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-442"></a>   <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-443"></a>   <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-444"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-445"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-446"></a>   <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-447"></a>   <span class="k">call </span><span class="n">set_uniform_yz_distrib</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">nsp</span><span class="p">)</span>
<a name="ln-448"></a>   <span class="c">!==========================</span>
<a name="ln-449"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-450"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-451"></a>   <span class="c">!==========================</span>
<a name="ln-452"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-453"></a>   <span class="c">!============================</span>
<a name="ln-454"></a>   <span class="c">! Parameters for particle distribution along the x-coordinate</span>
<a name="ln-455"></a>   <span class="c">!============================</span>
<a name="ln-456"></a>   <span class="c">! Layers nxl(1:5) all containing the same ion species</span>
<a name="ln-457"></a>   <span class="n">len_conc</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span>
<a name="ln-458"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">conc</span><span class="p">(</span><span class="n">len_conc</span><span class="p">))</span>
<a name="ln-459"></a>   <span class="n">conc</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">concentration</span><span class="p">(:)</span>
<a name="ln-460"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-461"></a>   <span class="n">nxtot</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-462"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-463"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-464"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-465"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-466"></a>    <span class="n">nxtot</span> <span class="o">=</span> <span class="n">nxtot</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-467"></a>   <span class="k">end do</span>
<a name="ln-468"></a><span class="k">   if</span> <span class="p">(</span><span class="n">xf0</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-469"></a><span class="k">    </span><span class="n">targ_in</span> <span class="o">=</span> <span class="n">xf0</span>
<a name="ln-470"></a>    <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-471"></a>   <span class="k">else</span>
<a name="ln-472"></a><span class="k">    </span><span class="n">targ_in</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-473"></a>    <span class="n">targ_end</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">xf0</span>
<a name="ln-474"></a>   <span class="k">end if</span>
<a name="ln-475"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span>
<a name="ln-476"></a>   <span class="c">!=============================</span>
<a name="ln-477"></a>   <span class="n">loc_nptx</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-478"></a>   <span class="n">loc_nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-479"></a>                     <span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-480"></a>
<a name="ln-481"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-482"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-483"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-484"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-485"></a>   <span class="c">!=============================</span>
<a name="ln-486"></a>   <span class="n">wghpt</span> <span class="o">=</span> <span class="n">one_dp</span>
<a name="ln-487"></a>   <span class="n">un</span> <span class="o">=</span> <span class="n">one_dp</span>
<a name="ln-488"></a>   <span class="n">ramp_prefactor</span> <span class="o">=</span> <span class="n">one_dp</span>
<a name="ln-489"></a>   <span class="c">!===================================</span>
<a name="ln-490"></a>   <span class="c">! WARNING for charge distribution</span>
<a name="ln-491"></a>   <span class="c">!====================================</span>
<a name="ln-492"></a>   <span class="c">! wgh_sp(1:nsp) already set by initial conditions</span>
<a name="ln-493"></a>   <span class="c">!=====================================================</span>
<a name="ln-494"></a>   <span class="c">! Longitudinal distribution</span>
<a name="ln-495"></a>   <span class="n">nptx</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-496"></a>   <span class="c">!Weights for multispecies target</span>
<a name="ln-497"></a>   <span class="c">!wgh_sp(1:3)=j0_norm</span>
<a name="ln-498"></a>   <span class="c">!if(nsp==2)then</span>
<a name="ln-499"></a>   <span class="c">!wgh_sp(2)=1./(real(mp_per_cell(2),dp))</span>
<a name="ln-500"></a>
<a name="ln-501"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">n0_ref</span><span class="o">*</span><span class="n">n_plasma</span>
<a name="ln-502"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-503"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">n0_ref</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-504"></a>    <span class="n">wgh_sp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">conc</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-505"></a>   <span class="k">end do</span>
<a name="ln-506"></a><span class="k">   select case</span> <span class="p">(</span><span class="n">layer_mod</span><span class="p">)</span>
<a name="ln-507"></a>    <span class="c">!================ first uniform layer np1=================</span>
<a name="ln-508"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-509"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-510"></a><span class="k">     </span><span class="n">ramp_prefactor</span> <span class="o">=</span> <span class="n">one_dp</span> <span class="o">-</span> <span class="n">np1</span>
<a name="ln-511"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-512"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-513"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-514"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-515"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-516"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-517"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-518"></a>      <span class="k">end do</span>
<a name="ln-519"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-520"></a>     <span class="k">end do</span>
<a name="ln-521"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-522"></a>    <span class="k">end if</span>
<a name="ln-523"></a>    <span class="c">!================ first CUBIC ramp np1 =&gt; 1 --linear or exponential still available but commented =================</span>
<a name="ln-524"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-525"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-526"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-527"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-528"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-529"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-530"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-531"></a>       <span class="c">!u2=(uu-1.)*(uu-1.)</span>
<a name="ln-532"></a>       <span class="n">u2</span> <span class="o">=</span> <span class="n">uu</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-533"></a>       <span class="n">u3</span> <span class="o">=</span> <span class="n">u2</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-534"></a>       <span class="c">!wghpt(i1,ic)=(np1+exp(-4.5*u2)*(1.-np1))*wgh_sp(ic)</span>
<a name="ln-535"></a>       <span class="c">!wghpt(i1,ic)=exp(-4.5*u2)*wgh_sp(ic)</span>
<a name="ln-536"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">ramp_prefactor</span><span class="o">*</span><span class="n">u3</span> <span class="o">+</span> <span class="mf">3.</span><span class="o">*</span><span class="n">ramp_prefactor</span><span class="o">*</span><span class="n">u2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-537"></a>                        <span class="n">one_dp</span> <span class="o">-</span> <span class="n">ramp_prefactor</span><span class="p">)</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-538"></a>      <span class="k">end do</span>
<a name="ln-539"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-540"></a>     <span class="k">end do</span>
<a name="ln-541"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-542"></a>    <span class="k">end if</span>
<a name="ln-543"></a>    <span class="c">!================ Central layer=================</span>
<a name="ln-544"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-545"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-546"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-547"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-548"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-549"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-550"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-551"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-552"></a>      <span class="k">end do</span>
<a name="ln-553"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-554"></a>     <span class="k">end do</span>
<a name="ln-555"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-556"></a>    <span class="k">end if</span>
<a name="ln-557"></a>    <span class="c">!================ second linear ramp =================</span>
<a name="ln-558"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-559"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-560"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-561"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-562"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-563"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-564"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-565"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">uu</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">np2</span><span class="p">))</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-566"></a>      <span class="k">end do</span>
<a name="ln-567"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-568"></a>     <span class="k">end do</span>
<a name="ln-569"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-570"></a>    <span class="k">end if</span>
<a name="ln-571"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-572"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-573"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-574"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-575"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-576"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-577"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-578"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-579"></a>      <span class="k">end do</span>
<a name="ln-580"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-581"></a>     <span class="k">end do</span>
<a name="ln-582"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-583"></a>    <span class="k">end if</span>
<a name="ln-584"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-585"></a>     <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-586"></a>    <span class="k">end do</span>
<a name="ln-587"></a>    <span class="c">!=========================================</span>
<a name="ln-588"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-589"></a>    <span class="c">!                 two bumps  (n1/n_c, n2/n_c) of length x_1 and x_2</span>
<a name="ln-590"></a>    <span class="c">!                 n_over_nc enters as average n_over nc= (n1* x_1+n2*x_2)/(x_1+x_2)</span>
<a name="ln-591"></a>    <span class="c">!                 weight j0_norm =&gt;&gt; j0_norm*np1 in x_1       =&gt;&gt; j0_norm*np2 in x_2</span>
<a name="ln-592"></a>    <span class="c">!                 particle per cell uniform</span>
<a name="ln-593"></a>    <span class="c">!================================================</span>
<a name="ln-594"></a>    <span class="c">!================ first linear ramp to first plateau n1/n_c =================</span>
<a name="ln-595"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-596"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-597"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-598"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-599"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-600"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-601"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-602"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">uu</span><span class="o">*</span><span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-603"></a>      <span class="k">end do</span>
<a name="ln-604"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-605"></a>     <span class="k">end do</span>
<a name="ln-606"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-607"></a>    <span class="k">end if</span>
<a name="ln-608"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!first plateau</span>
<a name="ln-609"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-610"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-611"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-612"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-613"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-614"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-615"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-616"></a>      <span class="k">end do</span>
<a name="ln-617"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-618"></a>     <span class="k">end do</span>
<a name="ln-619"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-620"></a>    <span class="k">end if</span>
<a name="ln-621"></a>    <span class="c">!================ np1 =&gt; np2 down-ramp =================</span>
<a name="ln-622"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-623"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-624"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-625"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-626"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-627"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-628"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-629"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np1</span> <span class="o">+</span> <span class="n">uu</span><span class="o">*</span><span class="p">(</span><span class="n">np2</span> <span class="o">-</span> <span class="n">np1</span><span class="p">))</span>
<a name="ln-630"></a>      <span class="k">end do</span>
<a name="ln-631"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-632"></a>     <span class="k">end do</span>
<a name="ln-633"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-634"></a>    <span class="k">end if</span>
<a name="ln-635"></a>    <span class="c">!================ second plateau n2/n_c &lt; n1/n_c =================</span>
<a name="ln-636"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-637"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-638"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-639"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-640"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-641"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-642"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-643"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-644"></a>      <span class="k">end do</span>
<a name="ln-645"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-646"></a>     <span class="k">end do</span>
<a name="ln-647"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-648"></a>    <span class="k">end if</span>
<a name="ln-649"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!second down-ramp n2/n_c ==&gt; 0</span>
<a name="ln-650"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-651"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-652"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-653"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-654"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-655"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-656"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">uu</span><span class="p">)</span><span class="o">*</span><span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-657"></a>      <span class="k">end do</span>
<a name="ln-658"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-659"></a>     <span class="k">end do</span>
<a name="ln-660"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-661"></a>    <span class="k">end if</span>
<a name="ln-662"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-663"></a>     <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-664"></a>    <span class="k">end do</span>
<a name="ln-665"></a>    <span class="c">!=====================================</span>
<a name="ln-666"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-667"></a>    <span class="c">!                 three layers</span>
<a name="ln-668"></a>    <span class="c">!                 lpx(1)[ramp]+lpx(2)[plateau]  and lpx(4) plateu lpx(5) downramp n_ion=0 n_e=n_0</span>
<a name="ln-669"></a>    <span class="c">!                 lpx(3)[plateau]  with a (A1-Z1) dopant with % density np1=n1_per_nc/n_per_nc</span>
<a name="ln-670"></a>    <span class="c">!                 and electronic density n_e=n_0+Z1*n_ion  n0=n_H(+)</span>
<a name="ln-671"></a>    <span class="c">!---------------</span>
<a name="ln-672"></a>    <span class="c">!================================================</span>
<a name="ln-673"></a>    <span class="c">!Z1 electrons are accounted for by a larger electron weight</span>
<a name="ln-674"></a>    <span class="n">un</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np1</span>
<a name="ln-675"></a>    <span class="n">un</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span> <span class="c">!float(mp_per_cell(1))/float(mp_per_cell(ic))</span>
<a name="ln-676"></a>
<a name="ln-677"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-678"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-679"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-680"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-681"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-682"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-683"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-684"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">uu</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-685"></a>      <span class="k">end do</span>
<a name="ln-686"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-687"></a>     <span class="k">end do</span>
<a name="ln-688"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-689"></a>    <span class="k">end if</span>
<a name="ln-690"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!first plateau</span>
<a name="ln-691"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-692"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-693"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-694"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-695"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-696"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-697"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-698"></a>      <span class="k">end do</span>
<a name="ln-699"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-700"></a>     <span class="k">end do</span>
<a name="ln-701"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-702"></a>    <span class="k">end if</span>
<a name="ln-703"></a>    <span class="c">!================</span>
<a name="ln-704"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!el+H(+) + dopant un(1:2) correct (electron,Z1) weights</span>
<a name="ln-705"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-706"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-707"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-708"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-709"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-710"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-711"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">un</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-712"></a>      <span class="k">end do</span>
<a name="ln-713"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-714"></a>     <span class="k">end do</span>
<a name="ln-715"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-716"></a>    <span class="k">end if</span>
<a name="ln-717"></a>    <span class="c">!================ second plateau only electrons =================</span>
<a name="ln-718"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-719"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-720"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-721"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-722"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-723"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-724"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-725"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-726"></a>      <span class="k">end do</span>
<a name="ln-727"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-728"></a>     <span class="k">end do</span>
<a name="ln-729"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-730"></a>    <span class="k">end if</span>
<a name="ln-731"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!second down-ramp ==&gt; 0</span>
<a name="ln-732"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp_run</span>
<a name="ln-733"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-734"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-735"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-736"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-737"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-738"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">uu</span><span class="p">)</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-739"></a>      <span class="k">end do</span>
<a name="ln-740"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-741"></a>     <span class="k">end do</span>
<a name="ln-742"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-743"></a>    <span class="k">end if</span>
<a name="ln-744"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-745"></a>     <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-746"></a>    <span class="k">end do</span>
<a name="ln-747"></a>    <span class="c">!===================================</span>
<a name="ln-748"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-749"></a>    <span class="c">!================ cos^2 upramp with peak n0 =================</span>
<a name="ln-750"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-751"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-752"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-753"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-754"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-755"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-756"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-757"></a>        <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-758"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="n">uu</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-759"></a>        <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_dp</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">uu</span><span class="p">))</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">uu</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-760"></a>                        <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-761"></a>       <span class="k">end do</span>
<a name="ln-762"></a><span class="k">      end if</span>
<a name="ln-763"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-764"></a>     <span class="k">end do</span>
<a name="ln-765"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-766"></a>    <span class="k">end if</span>
<a name="ln-767"></a>    <span class="c">!================ uniform layer n0=================</span>
<a name="ln-768"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-769"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-770"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-771"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-772"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-773"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-774"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-775"></a>        <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-776"></a>        <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_dp</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-777"></a>       <span class="k">end do</span>
<a name="ln-778"></a><span class="k">      end if</span>
<a name="ln-779"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-780"></a>     <span class="k">end do</span>
<a name="ln-781"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-782"></a>    <span class="k">end if</span>
<a name="ln-783"></a>    <span class="c">!================ cos^2 downramp to the plateau np1*n0 =================</span>
<a name="ln-784"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-785"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-786"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-787"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-788"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-789"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-790"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-791"></a>        <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-792"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="n">uu</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-793"></a>        <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">np1</span> <span class="o">+</span> <span class="p">(</span><span class="n">one_dp</span> <span class="o">-</span> <span class="n">np1</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">uu</span><span class="p">))</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-794"></a>                                                                   <span class="n">uu</span><span class="p">)))</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-795"></a>       <span class="k">end do</span>
<a name="ln-796"></a><span class="k">      end if</span>
<a name="ln-797"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-798"></a>     <span class="k">end do</span>
<a name="ln-799"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-800"></a>    <span class="k">end if</span>
<a name="ln-801"></a>    <span class="c">!================ Central layer of density np1*n0 =================</span>
<a name="ln-802"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-803"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-804"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-805"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-806"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-807"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-808"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-809"></a>        <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-810"></a>        <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-811"></a>       <span class="k">end do</span>
<a name="ln-812"></a><span class="k">      end if</span>
<a name="ln-813"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-814"></a>     <span class="k">end do</span>
<a name="ln-815"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-816"></a>    <span class="k">end if</span>
<a name="ln-817"></a>    <span class="c">!================ cos^2 downramp to second plateau np2*n0 =================</span>
<a name="ln-818"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-819"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-820"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-821"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-822"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-823"></a>        <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-824"></a>        <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-825"></a>        <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-826"></a>        <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">np2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np1</span> <span class="o">-</span> <span class="n">np2</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">uu</span><span class="p">))</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-827"></a>                                                                <span class="n">uu</span><span class="p">)))</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-828"></a>       <span class="k">end do</span>
<a name="ln-829"></a><span class="k">      end if</span>
<a name="ln-830"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-831"></a>     <span class="k">end do</span>
<a name="ln-832"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-833"></a>    <span class="k">end if</span>
<a name="ln-834"></a>    <span class="c">!================ Second plateau of density np2*n0 =================</span>
<a name="ln-835"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-836"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-837"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-838"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-839"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-840"></a>       <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<a name="ln-841"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-842"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-843"></a>      <span class="k">end do</span>
<a name="ln-844"></a><span class="k">      </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_peak</span>
<a name="ln-845"></a>     <span class="k">end do</span>
<a name="ln-846"></a><span class="k">     </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-847"></a>    <span class="k">end if</span>
<a name="ln-848"></a>
<a name="ln-849"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-850"></a>     <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-851"></a>    <span class="k">end do</span>
<a name="ln-852"></a>    <span class="c">!=========================================</span>
<a name="ln-853"></a>   <span class="k">end select</span>
<a name="ln-854"></a><span class="k">   if</span> <span class="p">(</span><span class="n">xf0</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-855"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-856"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-857"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tot part number&#39;</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-858"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-859"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xmin</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-860"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-861"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-862"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-863"></a>      <span class="k">end if</span>
<a name="ln-864"></a><span class="k">     end do</span>
<a name="ln-865"></a><span class="k">     </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-866"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;new tot part number&#39;</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-867"></a>    <span class="k">end do</span>
<a name="ln-868"></a><span class="k">   end if</span>
<a name="ln-869"></a>   <span class="c">!=============================</span>
<a name="ln-870"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-871"></a>    <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-872"></a>   <span class="k">end do</span>
<a name="ln-873"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-874"></a>    <span class="n">sptx_max</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-875"></a>   <span class="k">end do</span>
<a name="ln-876"></a>   <span class="c">!================================</span>
<a name="ln-877"></a>   <span class="c">! END of section setting global coordinates</span>
<a name="ln-878"></a>   <span class="c">!=================================</span>
<a name="ln-879"></a>   <span class="c">! Restricts to the computational box</span>
<a name="ln-880"></a>   <span class="c">!=================================</span>
<a name="ln-881"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-882"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;Initial_gas_target_x-profiles&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-883"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-884"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="n">sptx_max</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-885"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;species &#39;</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="s1">&#39;max x-coordinate&#39;</span><span class="p">,</span> <span class="n">i1</span>
<a name="ln-886"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;particle x-coordinate&#39;</span>
<a name="ln-887"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;(6e11.4)&#39;</span><span class="p">)</span> <span class="n">xpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-888"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;particle weight&#39;</span>
<a name="ln-889"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;(6e11.4)&#39;</span><span class="p">)</span> <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-890"></a>    <span class="k">end do</span>
<a name="ln-891"></a><span class="k">    close</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-892"></a>   <span class="k">end if</span>
<a name="ln-893"></a>   <span class="c">!================================</span>
<a name="ln-894"></a>   <span class="c">! END of section setting global coordinates</span>
<a name="ln-895"></a>   <span class="c">!=================================</span>
<a name="ln-896"></a>   <span class="c">!Resets nptx(ic)=last particle coordinate inside the computational box</span>
<a name="ln-897"></a>   <span class="c">!in the initial condition: for t&gt;0  nptx(ic) updated by mowing window</span>
<a name="ln-898"></a>   <span class="c">!==============================</span>
<a name="ln-899"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-900"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-901"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-902"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xmax</span><span class="p">)</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-903"></a>    <span class="k">end do</span>
<a name="ln-904"></a><span class="k">    </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-905"></a>   <span class="k">end do</span>
<a name="ln-906"></a>   <span class="c">!=========== Local x-distribution</span>
<a name="ln-907"></a>   <span class="c">!Local to the x-cordinate MPI domain particle number</span>
<a name="ln-908"></a>   <span class="c">!==================</span>
<a name="ln-909"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghx</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-910"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-911"></a>    <span class="k">call </span><span class="n">set_pgrid_xind</span><span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-912"></a>   <span class="k">end do</span>
<a name="ln-913"></a><span class="k">   </span><span class="n">loc_nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-914"></a>   <span class="c">! Alocation using a large buffer npt_max=mp_per_cell(1)*nx_loc*ny_loc*nz_loc</span>
<a name="ln-915"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-916"></a>    <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx_loc</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-917"></a>   <span class="k">end do</span>
<a name="ln-918"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-919"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_alloc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">imodz</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-920"></a>   <span class="k">end do</span>
<a name="ln-921"></a><span class="k">   </span><span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-922"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-923"></a>   <span class="c">!==================================</span>
<a name="ln-924"></a>   <span class="c">!==================== Local distribution of nptx particles==================</span>
<a name="ln-925"></a>   <span class="k">call </span><span class="n">mpi_x_part_distrib</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-926"></a>   <span class="c">!===========================</span>
<a name="ln-927"></a>   <span class="n">last_particle_index</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-928"></a>   <span class="c">!============</span>
<a name="ln-929"></a>   <span class="c">!Particles are distributed according to the local</span>
<a name="ln-930"></a>   <span class="c">![loc_xpt,loc_ypt,loc_zpt] coordinates</span>
<a name="ln-931"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-932"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-933"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-934"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">i2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-935"></a>                                         <span class="n">unit_charge</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">last_particle_index</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-936"></a>    <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">last_particle_index</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-937"></a>   <span class="k">end do</span>
<a name="ln-938"></a><span class="k">  end subroutine</span>
<a name="ln-939"></a>  <span class="c">!=============================</span>
<a name="ln-940"></a>  <span class="c">!===============================</span>
<a name="ln-941"></a>  <span class="k">subroutine </span><span class="n">preplasma_multisp</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-942"></a>
<a name="ln-943"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span>
<a name="ln-944"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-945"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-946"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-947"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_peak</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-948"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-949"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uu</span><span class="p">,</span> <span class="n">np1_loc</span>
<a name="ln-950"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span>
<a name="ln-951"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">l_inv</span>
<a name="ln-952"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-953"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip_ion</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">,</span> <span class="n">ip_pr</span>
<a name="ln-954"></a>   <span class="c">!=================</span>
<a name="ln-955"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-956"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-957"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-958"></a>   <span class="c">!========== uniform y-z distribution of El-Ion layers</span>
<a name="ln-959"></a>   <span class="k">call </span><span class="n">set_uniform_yz_distrib</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-960"></a>   <span class="c">!===============</span>
<a name="ln-961"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-962"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-963"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-964"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-965"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-966"></a>   <span class="k">end do</span>
<a name="ln-967"></a><span class="k">   </span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!attached coating</span>
<a name="ln-968"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nsp</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-969"></a><span class="k">    </span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-970"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-971"></a><span class="k">     write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-972"></a>      <span class="s1">&#39;Warning : for nsp=2 nxl(5) forced to zero =&gt; NO coating layer&#39;</span>
<a name="ln-973"></a>    <span class="k">end if</span>
<a name="ln-974"></a><span class="k">   end if</span>
<a name="ln-975"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-976"></a>   <span class="n">targ_in</span> <span class="o">=</span> <span class="n">xfsh</span>
<a name="ln-977"></a>   <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-978"></a>   <span class="c">!               nsp=4 species x-distribution</span>
<a name="ln-979"></a>   <span class="c">!               preplasma</span>
<a name="ln-980"></a>   <span class="c">!==================================</span>
<a name="ln-981"></a>   <span class="c">!            lx(2:3) (Z1-A1+El) central target</span>
<a name="ln-982"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-983"></a>   <span class="c">!            lx(1) (Z1-A1-El) uniform with np1 density pre-plasma</span>
<a name="ln-984"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-985"></a>   <span class="c">!            lx(5) (Z2-A2+El) ) uniform with np2 density coating</span>
<a name="ln-986"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-987"></a>   <span class="c">!========================</span>
<a name="ln-988"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">!electrons</span>
<a name="ln-989"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Z1-A1 species</span>
<a name="ln-990"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">!Z1-A1 species</span>
<a name="ln-991"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">!Z2-A2  species nlx(5)</span>
<a name="ln-992"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-993"></a>   <span class="c">!=======================</span>
<a name="ln-994"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-995"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-996"></a>
<a name="ln-997"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-998"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghx</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-999"></a>   <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_dp</span>
<a name="ln-1000"></a>   <span class="c">!=============================</span>
<a name="ln-1001"></a>   <span class="c">! first layer: electrons and Z1 ions</span>
<a name="ln-1002"></a>   <span class="c">!x distribution</span>
<a name="ln-1003"></a>   <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1004"></a>   <span class="n">nps_loc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1005"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1006"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1007"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1008"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1009"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1010"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1011"></a>     <span class="k">end do</span>
<a name="ln-1012"></a><span class="k">    end do</span>
<a name="ln-1013"></a><span class="k">    </span><span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">j0_norm</span>
<a name="ln-1014"></a>    <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">j0_norm</span>
<a name="ln-1015"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1016"></a><span class="k">     </span><span class="n">uu</span> <span class="o">=</span> <span class="n">ratio_mpc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">!float(mp_per_cell(1))/float(mp_per_cell(3))</span>
<a name="ln-1017"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1018"></a>     <span class="n">uu</span> <span class="o">=</span> <span class="n">ratio_mpc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!float(mp_per_cell(1))/float(mp_per_cell(4))</span>
<a name="ln-1019"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1020"></a>    <span class="k">end if</span>
<a name="ln-1021"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1022"></a>    <span class="c">!=========== Distributes on x-MPI tasks the first layer</span>
<a name="ln-1023"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1024"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1025"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1026"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1027"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1028"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1029"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1030"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1031"></a>      <span class="k">end if</span>
<a name="ln-1032"></a><span class="k">     end do</span>
<a name="ln-1033"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1034"></a>    <span class="k">end do</span>
<a name="ln-1035"></a>    <span class="c">!========================</span>
<a name="ln-1036"></a>    <span class="c">!========================</span>
<a name="ln-1037"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1038"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1039"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1040"></a>    <span class="c">! Counts particles in first layer</span>
<a name="ln-1041"></a>
<a name="ln-1042"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1043"></a>                                                                     <span class="mi">3</span><span class="p">)</span>
<a name="ln-1044"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1045"></a>                                                                     <span class="mi">4</span><span class="p">)</span>
<a name="ln-1046"></a>
<a name="ln-1047"></a>   <span class="k">end if</span>
<a name="ln-1048"></a>   <span class="c">!------------------------------</span>
<a name="ln-1049"></a>   <span class="c">! Electrons and Z1_ions : central layer</span>
<a name="ln-1050"></a>   <span class="c">! x distribution</span>
<a name="ln-1051"></a>   <span class="c">!====================</span>
<a name="ln-1052"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1053"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1054"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1055"></a>     <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1056"></a>                                                                    <span class="n">dp</span><span class="p">)</span>
<a name="ln-1057"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span>
<a name="ln-1058"></a>    <span class="k">end do</span>
<a name="ln-1059"></a><span class="k">   end do</span>
<a name="ln-1060"></a><span class="k">   </span><span class="n">uu</span> <span class="o">=</span> <span class="n">ratio_mpc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1061"></a>   <span class="n">ic</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-1062"></a>   <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1063"></a>   <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1064"></a>   <span class="c">!================================</span>
<a name="ln-1065"></a>   <span class="c">! Electrons and Z1 ions have the same weight if uu=1</span>
<a name="ln-1066"></a>   <span class="c">!=================================</span>
<a name="ln-1067"></a>   <span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1068"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1069"></a><span class="k">    </span><span class="n">np1_loc</span> <span class="o">=</span> <span class="n">np1</span>
<a name="ln-1070"></a>   <span class="k">else</span>
<a name="ln-1071"></a><span class="k">    </span><span class="n">np1_loc</span> <span class="o">=</span> <span class="mf">0.005</span>
<a name="ln-1072"></a>   <span class="k">end if</span>
<a name="ln-1073"></a>   <span class="c">!======== a preplasma rump</span>
<a name="ln-1074"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1075"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1076"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1077"></a>     <span class="n">l_inv</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np1_loc</span><span class="p">)</span>
<a name="ln-1078"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1079"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1080"></a>      <span class="c">! rampa esponenziale v1</span>
<a name="ln-1081"></a>      <span class="c">! wghpt(i,ic)=wghpt(i,ic)*exp(-5.*(1.-uu))</span>
<a name="ln-1082"></a>      <span class="c">! rampa esponenziale v2</span>
<a name="ln-1083"></a>      <span class="c">! Same species as later 2 (electrons+Z1-ions)</span>
<a name="ln-1084"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">np1_loc</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="n">uu</span><span class="o">*</span><span class="n">l_inv</span><span class="p">)</span>
<a name="ln-1085"></a>      <span class="c">! rampa lineare</span>
<a name="ln-1086"></a>      <span class="c">! wghpt(i,ic)=wghpt(i,ic)*uu</span>
<a name="ln-1087"></a>     <span class="k">end do</span>
<a name="ln-1088"></a><span class="k">    end do</span>
<a name="ln-1089"></a><span class="k">   end if</span>
<a name="ln-1090"></a>   <span class="c">!=========== Distributes on x-MPI tasks</span>
<a name="ln-1091"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1092"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1093"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1094"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1095"></a>         <span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1096"></a><span class="k">      </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1097"></a>      <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1098"></a>      <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1099"></a>     <span class="k">end if</span>
<a name="ln-1100"></a><span class="k">    end do</span>
<a name="ln-1101"></a><span class="k">    </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1102"></a>   <span class="k">end do</span>
<a name="ln-1103"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1104"></a>   <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1105"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1106"></a>
<a name="ln-1107"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1108"></a>                                                                    <span class="mi">1</span><span class="p">)</span>
<a name="ln-1109"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1110"></a>                                                                    <span class="mi">2</span><span class="p">)</span>
<a name="ln-1111"></a>   <span class="c">!============================</span>
<a name="ln-1112"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1113"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1114"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1115"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1116"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1117"></a>     <span class="k">end do</span>
<a name="ln-1118"></a><span class="k">     </span><span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">j0_norm</span>
<a name="ln-1119"></a>    <span class="k">end do</span>
<a name="ln-1120"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1121"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1122"></a><span class="k">      </span><span class="n">uu</span> <span class="o">=</span> <span class="n">ratio_mpc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!float(mp_per_cell(1))/float(mp_per_cell(ic))</span>
<a name="ln-1123"></a>      <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1124"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1125"></a>     <span class="k">end if</span>
<a name="ln-1126"></a><span class="k">    end do</span>
<a name="ln-1127"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1128"></a>    <span class="c">!===============================</span>
<a name="ln-1129"></a>    <span class="c">! Warning : holds for Z2_ion= H(+)</span>
<a name="ln-1130"></a>    <span class="c">!===============================</span>
<a name="ln-1131"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1132"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1133"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1134"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1135"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1136"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1137"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1138"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1139"></a>      <span class="k">end if</span>
<a name="ln-1140"></a><span class="k">     end do</span>
<a name="ln-1141"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1142"></a>    <span class="k">end do</span>
<a name="ln-1143"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1144"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1145"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1146"></a>
<a name="ln-1147"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1148"></a>                                                                     <span class="mi">5</span><span class="p">)</span>
<a name="ln-1149"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1150"></a>                                                                     <span class="mi">6</span><span class="p">)</span>
<a name="ln-1151"></a>
<a name="ln-1152"></a>   <span class="k">end if</span>
<a name="ln-1153"></a>   <span class="c">!======================</span>
<a name="ln-1154"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-1155"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1156"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-1157"></a>   <span class="c">!===========================</span>
<a name="ln-1158"></a>   <span class="n">ip_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1159"></a>   <span class="n">ip_pr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1160"></a>   <span class="n">ip_ion</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1161"></a>   <span class="c">!============</span>
<a name="ln-1162"></a>   <span class="c">! The first electron-proton(or C) foam layer</span>
<a name="ln-1163"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1164"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1165"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1166"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1167"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1168"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1169"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1170"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1171"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-1172"></a>   <span class="k">end if</span>
<a name="ln-1173"></a>   <span class="c">!=========================</span>
<a name="ln-1174"></a>   <span class="c">! The second electron-ion solid electron-Z1 layer</span>
<a name="ln-1175"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1176"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1177"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1178"></a>                            <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1179"></a>
<a name="ln-1180"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">ip_ion</span>
<a name="ln-1181"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1182"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1183"></a>                            <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-1184"></a>   <span class="c">!============</span>
<a name="ln-1185"></a>   <span class="c">! The third electron-proton layer</span>
<a name="ln-1186"></a>   <span class="c">!=========================</span>
<a name="ln-1187"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1188"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1189"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1190"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1191"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1192"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1193"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-1194"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1195"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_pr</span><span class="p">)</span>
<a name="ln-1196"></a>   <span class="k">end if</span>
<a name="ln-1197"></a>
<a name="ln-1198"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-1199"></a>    <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1200"></a>   <span class="k">end do</span>
<a name="ln-1201"></a>
<a name="ln-1202"></a>   <span class="c">!============</span>
<a name="ln-1203"></a>  <span class="k">end subroutine</span>
<a name="ln-1204"></a>  <span class="c">!=====================</span>
<a name="ln-1205"></a>  <span class="k">subroutine </span><span class="n">multi_layer_twosp_target</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-1206"></a>
<a name="ln-1207"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span>
<a name="ln-1208"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-1209"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">n_peak</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1210"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1211"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">l_inv</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">np1_loc</span><span class="p">,</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span>
<a name="ln-1212"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1213"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1214"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip_ion</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">,</span> <span class="n">ip_pr</span>
<a name="ln-1215"></a>   <span class="c">!=================</span>
<a name="ln-1216"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-1217"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-1218"></a>   <span class="k">call </span><span class="n">set_uniform_yz_distrib</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-1219"></a>   <span class="c">!==============================</span>
<a name="ln-1220"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1221"></a>   <span class="c">!x- distribution</span>
<a name="ln-1222"></a>
<a name="ln-1223"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1224"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-1225"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-1226"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-1227"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-1228"></a>   <span class="k">end do</span>
<a name="ln-1229"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1230"></a>   <span class="n">targ_in</span> <span class="o">=</span> <span class="n">xfsh</span>
<a name="ln-1231"></a>   <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-1232"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nsp</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1233"></a><span class="k">    </span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1234"></a>    <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1235"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1236"></a><span class="k">     write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Warning : for nsp=2 nxl(1) and nxl(5) forced to zero&#39;</span>
<a name="ln-1237"></a>    <span class="k">end if</span>
<a name="ln-1238"></a><span class="k">   end if</span>
<a name="ln-1239"></a>   <span class="c">! Species x-distribution</span>
<a name="ln-1240"></a>   <span class="c">!=========np_per_xc(1:2) electrons and Z1-ions in   ramp +  central layer</span>
<a name="ln-1241"></a>   <span class="c">!sizes lpx(2)+lpx(3)</span>
<a name="ln-1242"></a>   <span class="c">!========= np_per_xc(3:4) electrons and Z2-ions in layer 1</span>
<a name="ln-1243"></a>   <span class="c">!size lpx(1)</span>
<a name="ln-1244"></a>   <span class="c">!========= np_per_xc(5:6) electrons and Z3-ions in layer 3 +ramp</span>
<a name="ln-1245"></a>   <span class="c">!                                                  sizes lpx(4)+lpx(5)</span>
<a name="ln-1246"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Z1 ions</span>
<a name="ln-1247"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="c">!Z2 ions</span>
<a name="ln-1248"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="c">!Z3 ions</span>
<a name="ln-1249"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">!electrons</span>
<a name="ln-1250"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Z1-A1 species</span>
<a name="ln-1251"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">!Z2-A2  species nxl(1)+nlx(4)</span>
<a name="ln-1252"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-1253"></a>   <span class="c">!=======================</span>
<a name="ln-1254"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-1255"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-1256"></a>
<a name="ln-1257"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-1258"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghx</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a name="ln-1259"></a>   <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1260"></a>   <span class="c">!==================</span>
<a name="ln-1261"></a>   <span class="c">! nsp=1-4 ordering: electrons+ Z1 ions + Z2 ions +Z3 ions</span>
<a name="ln-1262"></a>   <span class="c">!Weights for multilayer multisp targets</span>
<a name="ln-1263"></a>   <span class="c">! first layer: electrons and Z2 (protons) ions</span>
<a name="ln-1264"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1265"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">dp</span><span class="p">))</span>
<a name="ln-1266"></a>   <span class="c">! central layer: electrons and Z1 ions</span>
<a name="ln-1267"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span>
<a name="ln-1268"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_ion</span> <span class="c">!ion spec 1 (ionizable)</span>
<a name="ln-1269"></a>   <span class="c">! coiating layer: electrons and Z3 (H+)</span>
<a name="ln-1270"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1271"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">dp</span><span class="p">))</span>
<a name="ln-1272"></a>   <span class="c">!================================================</span>
<a name="ln-1273"></a>   <span class="c">!x distribution</span>
<a name="ln-1274"></a>   <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1275"></a>   <span class="n">nps_loc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1276"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1277"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1278"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1279"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1280"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1281"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1282"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1283"></a>     <span class="k">end do</span>
<a name="ln-1284"></a><span class="k">    end do</span>
<a name="ln-1285"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1286"></a>    <span class="c">!=========== Distributes on x-MPI tasks</span>
<a name="ln-1287"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1288"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1289"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1290"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1291"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1292"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1293"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1294"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1295"></a>      <span class="k">end if</span>
<a name="ln-1296"></a><span class="k">     end do</span>
<a name="ln-1297"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1298"></a>    <span class="k">end do</span>
<a name="ln-1299"></a>    <span class="c">!========================</span>
<a name="ln-1300"></a>    <span class="c">!========================</span>
<a name="ln-1301"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1302"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1303"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1304"></a>    <span class="c">! Counts particles (e+Z2 ions)</span>
<a name="ln-1305"></a>
<a name="ln-1306"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1307"></a>                                                                     <span class="mi">3</span><span class="p">)</span>
<a name="ln-1308"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1309"></a>                                                                     <span class="mi">4</span><span class="p">)</span>
<a name="ln-1310"></a>   <span class="k">end if</span>
<a name="ln-1311"></a>   <span class="c">!------------------------------</span>
<a name="ln-1312"></a>   <span class="c">! Electrons and Z1_ions : central layer</span>
<a name="ln-1313"></a>   <span class="c">! x distribution</span>
<a name="ln-1314"></a>   <span class="c">!====================</span>
<a name="ln-1315"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1316"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1317"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span><span class="p">)</span>
<a name="ln-1318"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1319"></a>     <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1320"></a>                                                                    <span class="n">dp</span><span class="p">)</span>
<a name="ln-1321"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1322"></a>    <span class="k">end do</span>
<a name="ln-1323"></a><span class="k">   end do</span>
<a name="ln-1324"></a>   <span class="c">!================================</span>
<a name="ln-1325"></a>   <span class="c">! WARNING : electrons and Z1 ions have the same weight</span>
<a name="ln-1326"></a>   <span class="c">! if mp_per_cell(1)=Z1*mp_per_cell(2)</span>
<a name="ln-1327"></a>   <span class="c">!=================================</span>
<a name="ln-1328"></a>   <span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1329"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1330"></a><span class="k">    </span><span class="n">np1_loc</span> <span class="o">=</span> <span class="n">np1</span>
<a name="ln-1331"></a>   <span class="k">else</span>
<a name="ln-1332"></a><span class="k">    </span><span class="n">np1_loc</span> <span class="o">=</span> <span class="mf">0.005</span>
<a name="ln-1333"></a>   <span class="k">end if</span>
<a name="ln-1334"></a>   <span class="c">!======== a preplasma rump</span>
<a name="ln-1335"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1336"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1337"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1338"></a>     <span class="n">l_inv</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np1_loc</span><span class="p">)</span>
<a name="ln-1339"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1340"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1341"></a>      <span class="c">! rampa esponenziale v1</span>
<a name="ln-1342"></a>      <span class="c">! wghpt(i,ic)=wghpt(i,ic)*exp(-5.*(1.-uu))</span>
<a name="ln-1343"></a>      <span class="c">! rampa esponenziale v2</span>
<a name="ln-1344"></a>      <span class="c">! Same species as later 2 (electrons+Z1-ions)</span>
<a name="ln-1345"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">np1_loc</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="n">uu</span><span class="o">*</span><span class="n">l_inv</span><span class="p">)</span>
<a name="ln-1346"></a>      <span class="c">! rampa lineare</span>
<a name="ln-1347"></a>      <span class="c">! wghpt(i,ic)=wghpt(i,ic)*uu</span>
<a name="ln-1348"></a>     <span class="k">end do</span>
<a name="ln-1349"></a><span class="k">    end do</span>
<a name="ln-1350"></a><span class="k">   end if</span>
<a name="ln-1351"></a>   <span class="c">!=========== Distributes on x-MPI tasks</span>
<a name="ln-1352"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1353"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1354"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1355"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1356"></a>         <span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1357"></a><span class="k">      </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1358"></a>      <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1359"></a>      <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1360"></a>     <span class="k">end if</span>
<a name="ln-1361"></a><span class="k">    end do</span>
<a name="ln-1362"></a><span class="k">    </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1363"></a>   <span class="k">end do</span>
<a name="ln-1364"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1365"></a>   <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1366"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1367"></a>
<a name="ln-1368"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1369"></a>                                                                    <span class="mi">1</span><span class="p">)</span>
<a name="ln-1370"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1371"></a>                                                                    <span class="mi">2</span><span class="p">)</span>
<a name="ln-1372"></a>   <span class="c">!============================</span>
<a name="ln-1373"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1374"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1375"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1376"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1377"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1378"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1379"></a>     <span class="k">end do</span>
<a name="ln-1380"></a><span class="k">    end do</span>
<a name="ln-1381"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1382"></a>    <span class="c">!===================================</span>
<a name="ln-1383"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1384"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1385"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1386"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1387"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1388"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1389"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1390"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1391"></a>      <span class="k">end if</span>
<a name="ln-1392"></a><span class="k">     end do</span>
<a name="ln-1393"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1394"></a>    <span class="k">end do</span>
<a name="ln-1395"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1396"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1397"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1398"></a>
<a name="ln-1399"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1400"></a>                                                                     <span class="mi">5</span><span class="p">)</span>
<a name="ln-1401"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1402"></a>                                                                     <span class="mi">6</span><span class="p">)</span>
<a name="ln-1403"></a>
<a name="ln-1404"></a>   <span class="k">end if</span>
<a name="ln-1405"></a>   <span class="c">!======================</span>
<a name="ln-1406"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-1407"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1408"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-1409"></a>   <span class="c">!===========================</span>
<a name="ln-1410"></a>   <span class="n">ip_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1411"></a>   <span class="n">ip_pr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1412"></a>   <span class="n">ip_ion</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1413"></a>   <span class="c">!============</span>
<a name="ln-1414"></a>   <span class="c">! The first electron-proton(or C) foam layer</span>
<a name="ln-1415"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1416"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1417"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1418"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1419"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1420"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1421"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1422"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1423"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_pr</span><span class="p">)</span>
<a name="ln-1424"></a>   <span class="k">end if</span>
<a name="ln-1425"></a>   <span class="c">!=========================</span>
<a name="ln-1426"></a>   <span class="c">! The second electron-ion solid electron-Z1 layer</span>
<a name="ln-1427"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1428"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1429"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1430"></a>                            <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1431"></a>
<a name="ln-1432"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1433"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1434"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1435"></a>                            <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-1436"></a>   <span class="c">!============</span>
<a name="ln-1437"></a>   <span class="c">! The third electron-proton layer</span>
<a name="ln-1438"></a>   <span class="c">!=========================</span>
<a name="ln-1439"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1440"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1441"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1442"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1443"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-1444"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">ip_pr</span>
<a name="ln-1445"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-1446"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1447"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-1448"></a>   <span class="k">end if</span>
<a name="ln-1449"></a>
<a name="ln-1450"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-1451"></a>    <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1452"></a>   <span class="k">end do</span>
<a name="ln-1453"></a>
<a name="ln-1454"></a>   <span class="c">!============</span>
<a name="ln-1455"></a>  <span class="k">end subroutine</span>
<a name="ln-1456"></a>  <span class="c">!=======================</span>
<a name="ln-1457"></a>  <span class="k">subroutine </span><span class="n">multi_layer_threesp_target</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-1458"></a>
<a name="ln-1459"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span>
<a name="ln-1460"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-1461"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-1462"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-1463"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_peak</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1464"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1465"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uu</span><span class="p">,</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span><span class="p">,</span> <span class="n">np1_loc</span>
<a name="ln-1466"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">l_inv</span><span class="p">,</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1467"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1468"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip_ion</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">,</span> <span class="n">ip_pr</span>
<a name="ln-1469"></a>   <span class="c">!=================</span>
<a name="ln-1470"></a>   <span class="k">call </span><span class="n">set_uniform_yz_distrib</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-1471"></a>   <span class="c">!===========================</span>
<a name="ln-1472"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-1473"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-1474"></a>   <span class="c">!=============</span>
<a name="ln-1475"></a>   <span class="c">! weights in central layer are wgh_sp(1:3)</span>
<a name="ln-1476"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1477"></a>   <span class="c">!=============================</span>
<a name="ln-1478"></a>   <span class="c">! Multispecies  designed for nsp &gt;2</span>
<a name="ln-1479"></a>   <span class="c">! Particles distribution np_per_yc(1:3) and np_per_xc(1:3) central target</span>
<a name="ln-1480"></a>   <span class="c">! (El+Z1+ Z2</span>
<a name="ln-1481"></a>   <span class="c">!                        np_per_yc(5:6) and np_per_xc(5:6)</span>
<a name="ln-1482"></a>   <span class="c">!                        contaminants (El+Z3) in front and rear layers</span>
<a name="ln-1483"></a>   <span class="c">!                        if contaminants: nsp=4(Z3/= Z2) if nps=3 Z3=Z2</span>
<a name="ln-1484"></a>   <span class="c">!=============================================</span>
<a name="ln-1485"></a>   <span class="c">!WARNING  nm_per_cell(1:3) and mp_per_cell(5:6) have to be set in a way global</span>
<a name="ln-1486"></a>   <span class="c">!zero charge per cell is assured</span>
<a name="ln-1487"></a>   <span class="c">! In central layer:</span>
<a name="ln-1488"></a>   <span class="c">! Electron number mp_per_cell(1)= Z1*mp_per_cell(2) +Z2*mp_per_cell(3)</span>
<a name="ln-1489"></a>   <span class="c">!=============================</span>
<a name="ln-1490"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1491"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-1492"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-1493"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-1494"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-1495"></a>   <span class="k">end do</span>
<a name="ln-1496"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1497"></a>   <span class="n">targ_in</span> <span class="o">=</span> <span class="n">xfsh</span>
<a name="ln-1498"></a>   <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-1499"></a>   <span class="c">! Species x-distribution</span>
<a name="ln-1500"></a>   <span class="c">!=  np_per_xc(1:3) electrons, Z1 and Z2 ions in central layer lpx(2)+lpx(3)</span>
<a name="ln-1501"></a>   <span class="c">!=  np_per_xc(5:6) electrons and Z3-ions front and rear side contaminants (same</span>
<a name="ln-1502"></a>   <span class="c">!composition) If nsp=3 Z3=Z2</span>
<a name="ln-1503"></a>   <span class="c">!======================================</span>
<a name="ln-1504"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1505"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1506"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1507"></a>   <span class="c">!============ nptx(nsp)  distribution</span>
<a name="ln-1508"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">!electrons</span>
<a name="ln-1509"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Z1-A1 species</span>
<a name="ln-1510"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">!Z2-A2 species</span>
<a name="ln-1511"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c">!Z3-A3  species in nxl(1) and nxl(5) layer</span>
<a name="ln-1512"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-1513"></a>   <span class="c">!=======================</span>
<a name="ln-1514"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a name="ln-1515"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a name="ln-1516"></a>
<a name="ln-1517"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a name="ln-1518"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghx</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a name="ln-1519"></a>   <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1520"></a>   <span class="c">!=============================</span>
<a name="ln-1521"></a>   <span class="c">! nsp ordering: electrons+ Z1 ions + Z2 ions</span>
<a name="ln-1522"></a>   <span class="c">! first and last layers: electrons and Z3 (protons) ions</span>
<a name="ln-1523"></a>   <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1524"></a>   <span class="n">nps_loc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1525"></a>   <span class="c">!==========================================</span>
<a name="ln-1526"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">ratio_mpc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1527"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">ratio_mpc</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">ion_min</span><span class="p">(</span><span class="n">nsp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1528"></a>   <span class="n">wgh_sp</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span>
<a name="ln-1529"></a>   <span class="c">!===================================</span>
<a name="ln-1530"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!first contaminant layer El+Z(nsp-1)</span>
<a name="ln-1531"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-1532"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1533"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1534"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1535"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1536"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!pp weights using mp_per_cell(5:6)</span>
<a name="ln-1537"></a>     <span class="k">end do</span>
<a name="ln-1538"></a><span class="k">    end do</span>
<a name="ln-1539"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1540"></a>    <span class="c">!=========== Distributes on x-MPI tasks</span>
<a name="ln-1541"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-1542"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1543"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1544"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1545"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1546"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1547"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1548"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1549"></a>      <span class="k">end if</span>
<a name="ln-1550"></a><span class="k">     end do</span>
<a name="ln-1551"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1552"></a>    <span class="k">end do</span>
<a name="ln-1553"></a>    <span class="c">!========================</span>
<a name="ln-1554"></a>    <span class="c">!========================</span>
<a name="ln-1555"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1556"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1557"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1558"></a>    <span class="c">! Counts particles (e+Z3 ions)</span>
<a name="ln-1559"></a>
<a name="ln-1560"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1561"></a>                                                                     <span class="mi">4</span><span class="p">)</span>
<a name="ln-1562"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span> <span class="p">&amp;</span>
<a name="ln-1563"></a>                   <span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1564"></a>
<a name="ln-1565"></a>   <span class="k">end if</span>
<a name="ln-1566"></a>   <span class="c">!====================</span>
<a name="ln-1567"></a>   <span class="c">! Electrons and (Z1+Z2)_ions : central layer with lpx(2) preplasma</span>
<a name="ln-1568"></a>   <span class="c">! x distribution</span>
<a name="ln-1569"></a>   <span class="c">!====================</span>
<a name="ln-1570"></a>   <span class="n">np1_loc</span> <span class="o">=</span> <span class="mf">0.005</span>
<a name="ln-1571"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">np1_loc</span> <span class="o">=</span> <span class="n">np1</span>
<a name="ln-1572"></a>   <span class="n">l_inv</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np1_loc</span><span class="p">)</span>
<a name="ln-1573"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
<a name="ln-1574"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!central target</span>
<a name="ln-1575"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1576"></a>     <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1577"></a>     <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1578"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!weights usig mp_per_cell(1:3)  (El, Z1, Z2) ions</span>
<a name="ln-1579"></a>    <span class="k">end do</span>
<a name="ln-1580"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1581"></a><span class="k">     </span><span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!preplasma</span>
<a name="ln-1582"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1583"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1584"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">np1_loc</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="n">uu</span><span class="o">*</span><span class="n">l_inv</span><span class="p">)</span>
<a name="ln-1585"></a>     <span class="k">end do</span>
<a name="ln-1586"></a><span class="k">    end if</span>
<a name="ln-1587"></a><span class="k">   end do</span>
<a name="ln-1588"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1589"></a>   <span class="c">!=============================</span>
<a name="ln-1590"></a>   <span class="c">! Charge equilibria mp_per_cell(4)*Z1 +mp_per_cell(5)*Z3= mp_per_cell(1)</span>
<a name="ln-1591"></a>   <span class="c">!==========================</span>
<a name="ln-1592"></a>   <span class="c">!=========== Distributes on x-MPI tasks</span>
<a name="ln-1593"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
<a name="ln-1594"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1595"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1596"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1597"></a>         <span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1598"></a><span class="k">      </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1599"></a>      <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1600"></a>      <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1601"></a>     <span class="k">end if</span>
<a name="ln-1602"></a><span class="k">    end do</span>
<a name="ln-1603"></a><span class="k">    </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1604"></a>   <span class="k">end do</span>
<a name="ln-1605"></a><span class="k">   </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1606"></a>   <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1607"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1608"></a>
<a name="ln-1609"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1610"></a>                                                                    <span class="mi">1</span><span class="p">)</span>
<a name="ln-1611"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1612"></a>                                                                    <span class="mi">2</span><span class="p">)</span>
<a name="ln-1613"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1614"></a>                                                                    <span class="mi">3</span><span class="p">)</span>
<a name="ln-1615"></a>   <span class="c">!============================</span>
<a name="ln-1616"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1617"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span>
<a name="ln-1618"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1619"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1620"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1621"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np2</span><span class="o">*</span><span class="n">wgh_sp</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="c">!weights using mp_per_cell(5:6) as in layer lpx(1)</span>
<a name="ln-1622"></a>     <span class="k">end do</span>
<a name="ln-1623"></a><span class="k">    end do</span>
<a name="ln-1624"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1625"></a>    <span class="c">!===============================</span>
<a name="ln-1626"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span>
<a name="ln-1627"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1628"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1629"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-1630"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1631"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1632"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1633"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1634"></a>      <span class="k">end if</span>
<a name="ln-1635"></a><span class="k">     end do</span>
<a name="ln-1636"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1637"></a>    <span class="k">end do</span>
<a name="ln-1638"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-1639"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-1640"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-1641"></a>
<a name="ln-1642"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1643"></a>                                                                     <span class="mi">6</span><span class="p">)</span>
<a name="ln-1644"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span> <span class="p">&amp;</span>
<a name="ln-1645"></a>                   <span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-1646"></a>
<a name="ln-1647"></a>   <span class="k">end if</span>
<a name="ln-1648"></a>   <span class="c">!======================</span>
<a name="ln-1649"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-1650"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1651"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-1652"></a>   <span class="c">!===========================</span>
<a name="ln-1653"></a>   <span class="n">ip_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1654"></a>   <span class="n">ip_pr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1655"></a>   <span class="n">ip_ion</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1656"></a>   <span class="c">!============</span>
<a name="ln-1657"></a>   <span class="c">! The first electron-Z3 layer</span>
<a name="ln-1658"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1659"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1660"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1661"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1662"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1663"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1664"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1665"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1666"></a>                             <span class="mi">5</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ip_pr</span><span class="p">)</span>
<a name="ln-1667"></a>    <span class="c">!Z3 for nsp=4  Z3=Z2 for nsp=3</span>
<a name="ln-1668"></a>   <span class="k">end if</span>
<a name="ln-1669"></a>   <span class="c">!=========================</span>
<a name="ln-1670"></a>   <span class="c">! The second solid electron-Z1-Z2 layer</span>
<a name="ln-1671"></a>   <span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1672"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1673"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1674"></a>                            <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-1675"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1676"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1677"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1678"></a>                            <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-1679"></a>   <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1680"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nsp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ip_pr</span>
<a name="ln-1681"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1682"></a>   <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1683"></a>                            <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-1684"></a>   <span class="c">!============</span>
<a name="ln-1685"></a>   <span class="c">! The third electron-proton layer</span>
<a name="ln-1686"></a>   <span class="c">!=========================</span>
<a name="ln-1687"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1688"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-1689"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-1690"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1691"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-1692"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">ip_pr</span>
<a name="ln-1693"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nsp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ip_ion</span>
<a name="ln-1694"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-1695"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1696"></a>                             <span class="mi">7</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-1697"></a>   <span class="k">end if</span>
<a name="ln-1698"></a>
<a name="ln-1699"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-1700"></a>    <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1701"></a>   <span class="k">end do</span>
<a name="ln-1702"></a>
<a name="ln-1703"></a>   <span class="c">!============</span>
<a name="ln-1704"></a>  <span class="k">end subroutine</span>
<a name="ln-1705"></a>  <span class="c">!=====================</span>
<a name="ln-1706"></a>  <span class="k">subroutine </span><span class="n">one_layer_nano_wires</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-1707"></a>
<a name="ln-1708"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span>
<a name="ln-1709"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-1710"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-1711"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-1712"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">n_peak</span>
<a name="ln-1713"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1714"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npty_layer</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">npyc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-1715"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1716"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uu</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">dxip</span><span class="p">,</span> <span class="n">dpy</span>
<a name="ln-1717"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">zp_min</span><span class="p">,</span> <span class="n">zp_max</span><span class="p">,</span> <span class="n">yp_min</span><span class="p">,</span> <span class="n">yp_max</span><span class="p">,</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span>
<a name="ln-1718"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">dlpy</span><span class="p">,</span> <span class="n">tot_lpy</span><span class="p">,</span> <span class="n">loc_ymp</span>
<a name="ln-1719"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">z2</span><span class="p">,</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">nyl1</span><span class="p">,</span> <span class="n">nlpy</span><span class="p">,</span> <span class="n">nholes</span>
<a name="ln-1720"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip_ion</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">,</span> <span class="n">ip_pr</span><span class="p">,</span> <span class="n">nwires</span>
<a name="ln-1721"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">wy</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wz</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wyz</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1722"></a>   <span class="c">!=================</span>
<a name="ln-1723"></a>   <span class="c">!++++++++++++++++ WARNING</span>
<a name="ln-1724"></a>   <span class="c">! ONLY layers (3) and (4) n_over_nc, np2*n_over_nc layer (5)</span>
<a name="ln-1725"></a>   <span class="c">!============================</span>
<a name="ln-1726"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-1727"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-1728"></a>   <span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1729"></a>   <span class="c">!============================</span>
<a name="ln-1730"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1731"></a>   <span class="n">z2</span> <span class="o">=</span> <span class="n">ion_min</span><span class="p">(</span><span class="n">nsp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1732"></a>   <span class="c">!========= gridding the transverese target size</span>
<a name="ln-1733"></a>   <span class="n">nyl1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nyh_in</span><span class="o">/</span><span class="mi">2</span> <span class="c">!=1 if nyh_in=ny</span>
<a name="ln-1734"></a>   <span class="n">yp_min</span> <span class="o">=</span> <span class="n">ymin_t</span>
<a name="ln-1735"></a>   <span class="n">yp_max</span> <span class="o">=</span> <span class="n">ymax_t</span>
<a name="ln-1736"></a>
<a name="ln-1737"></a>   <span class="n">dlpy</span> <span class="o">=</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!nanowire (y,z) thickness</span>
<a name="ln-1738"></a>   <span class="n">tot_lpy</span> <span class="o">=</span> <span class="n">dlpy</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!distance among elements (void+nanowire)`</span>
<a name="ln-1739"></a>   <span class="n">nwires</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span><span class="p">)</span><span class="o">/</span><span class="n">tot_lpy</span><span class="p">)</span> <span class="c">!numbers of lpy elements</span>
<a name="ln-1740"></a>   <span class="n">nlpy</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dy_inv</span><span class="o">*</span><span class="n">dlpy</span><span class="p">)</span> <span class="c">! cell numbers in dlpy</span>
<a name="ln-1741"></a>   <span class="n">nholes</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dy_inv</span><span class="o">*</span><span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="c">! cell number in the lpy(2) interwire region</span>
<a name="ln-1742"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1743"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a18,i6)&#39;</span><span class="p">)</span> <span class="s1">&#39; Nanowires number &#39;</span><span class="p">,</span> <span class="n">nwires</span>
<a name="ln-1744"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a23,i6)&#39;</span><span class="p">)</span> <span class="s1">&#39; Grid-points per nanow &#39;</span><span class="p">,</span> <span class="n">nlpy</span>
<a name="ln-1745"></a>   <span class="k">end if</span>
<a name="ln-1746"></a>   <span class="c">!=============================</span>
<a name="ln-1747"></a>   <span class="c">! Multispecies</span>
<a name="ln-1748"></a>   <span class="c">!=============================</span>
<a name="ln-1749"></a>   <span class="n">npty</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">np_per_yc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-1750"></a>   <span class="n">npty</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">npty</span>
<a name="ln-1751"></a>   <span class="n">nptz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1752"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1753"></a><span class="k">    </span><span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_yc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1754"></a>    <span class="n">zp_min</span> <span class="o">=</span> <span class="n">zmin_t</span> <span class="c">!-Lz</span>
<a name="ln-1755"></a>    <span class="n">zp_max</span> <span class="o">=</span> <span class="n">zmax_t</span> <span class="c">!+Lz</span>
<a name="ln-1756"></a>    <span class="n">nptz</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">np_per_zc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-1757"></a>    <span class="n">nptz</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">nptz</span>
<a name="ln-1758"></a>   <span class="k">end if</span>
<a name="ln-1759"></a><span class="k">   allocate</span> <span class="p">(</span><span class="n">ypt</span><span class="p">(</span><span class="n">npty</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1760"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">nptz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1761"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wy</span><span class="p">(</span><span class="n">npty</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1762"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wz</span><span class="p">(</span><span class="n">nptz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1763"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wyz</span><span class="p">(</span><span class="n">npty</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1764"></a>   <span class="n">ypt</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1765"></a>   <span class="n">zpt</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1766"></a>   <span class="n">wy</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1767"></a>   <span class="n">wz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1768"></a>   <span class="n">wyz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1769"></a>   <span class="c">!==================</span>
<a name="ln-1770"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_jmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1771"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_kmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1772"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_imax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1773"></a>   <span class="c">!====================</span>
<a name="ln-1774"></a>   <span class="c">!layers in y-z transverse coordinates</span>
<a name="ln-1775"></a>   <span class="c">!====================================</span>
<a name="ln-1776"></a>   <span class="n">npyc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_yc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">!layer of nano_wires electron+Z1_ion</span>
<a name="ln-1777"></a>   <span class="n">npyc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_yc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">!layer of inter wire plasma of np1 density layer[1:4] of x-length=lpx(3)</span>
<a name="ln-1778"></a>   <span class="n">npyc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_yc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="c">!bulk of electron-Z1_ion      x-length lpx(4)</span>
<a name="ln-1779"></a>   <span class="n">npyc</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_yc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="c">! coating of electron-Z2_ion      x-length lpx(5)</span>
<a name="ln-1780"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1781"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nwires</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1782"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1783"></a>     <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nlpy</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a dlpy layer</span>
<a name="ln-1784"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1785"></a>     <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1786"></a>     <span class="k">do </span><span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nwires</span> <span class="c">!layers of lpy=dlpy(1+rat) length</span>
<a name="ln-1787"></a>      <span class="n">dpy</span> <span class="o">=</span> <span class="n">dlpy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1788"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1789"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1790"></a>      <span class="k">end do</span>
<a name="ln-1791"></a><span class="k">      </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1792"></a>      <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">tot_lpy</span>
<a name="ln-1793"></a>     <span class="k">end do</span>
<a name="ln-1794"></a><span class="k">     </span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-1795"></a>    <span class="k">end do</span>
<a name="ln-1796"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1797"></a>     <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nholes</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a lpy(2) layer</span>
<a name="ln-1798"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1799"></a>     <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">yp_min</span>
<a name="ln-1800"></a>     <span class="k">do </span><span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nwires</span>
<a name="ln-1801"></a>      <span class="n">dpy</span> <span class="o">=</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1802"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1803"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1804"></a>      <span class="k">end do</span>
<a name="ln-1805"></a><span class="k">      </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1806"></a>      <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">tot_lpy</span>
<a name="ln-1807"></a>     <span class="k">end do</span>
<a name="ln-1808"></a><span class="k">     </span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-1809"></a>     <span class="c">!===========================</span>
<a name="ln-1810"></a>    <span class="k">end do</span>
<a name="ln-1811"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1812"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-1813"></a>      <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nlpy</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a dlpy layer</span>
<a name="ln-1814"></a>      <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1815"></a>      <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1816"></a>      <span class="k">do </span><span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nwires</span> <span class="c">!layers of lpy=dlpy(1+rat) length</span>
<a name="ln-1817"></a>       <span class="n">dpy</span> <span class="o">=</span> <span class="n">dlpy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1818"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1819"></a>        <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1820"></a>       <span class="k">end do</span>
<a name="ln-1821"></a><span class="k">       </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1822"></a>       <span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">tot_lpy</span>
<a name="ln-1823"></a>      <span class="k">end do</span>
<a name="ln-1824"></a><span class="k">      </span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-1825"></a>     <span class="k">end do</span>
<a name="ln-1826"></a><span class="k">    end if</span>
<a name="ln-1827"></a><span class="k">   else</span> <span class="c">!two nanowires filled with n1_over_nc (el+Z1) plasma</span>
<a name="ln-1828"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1829"></a>     <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nlpy</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a dlpy layer</span>
<a name="ln-1830"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1831"></a>     <span class="n">loc_ymp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">tot_lpy</span>
<a name="ln-1832"></a>     <span class="n">dpy</span> <span class="o">=</span> <span class="n">dlpy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1833"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1834"></a>      <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1835"></a>     <span class="k">end do</span>
<a name="ln-1836"></a><span class="k">     </span><span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!first layer</span>
<a name="ln-1837"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1838"></a>     <span class="c">!===========================</span>
<a name="ln-1839"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1840"></a>      <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1841"></a>     <span class="k">end do</span>
<a name="ln-1842"></a><span class="k">     </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1843"></a>     <span class="c">!====================</span>
<a name="ln-1844"></a>     <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-1845"></a>    <span class="k">end do</span>
<a name="ln-1846"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-1847"></a>     <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nholes</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a lpy(2) layer</span>
<a name="ln-1848"></a>     <span class="n">loc_ymp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1849"></a>     <span class="n">dpy</span> <span class="o">=</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1850"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1851"></a>      <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1852"></a>     <span class="k">end do</span>
<a name="ln-1853"></a><span class="k">     </span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">npty_ne</span>
<a name="ln-1854"></a>     <span class="c">!===========================</span>
<a name="ln-1855"></a>    <span class="k">end do</span>
<a name="ln-1856"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1857"></a><span class="k">     do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-1858"></a>      <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nlpy</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in a dlpy layer</span>
<a name="ln-1859"></a>      <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1860"></a>      <span class="n">loc_ymp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">tot_lpy</span>
<a name="ln-1861"></a>      <span class="n">dpy</span> <span class="o">=</span> <span class="n">dlpy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1862"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1863"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1864"></a>      <span class="k">end do</span>
<a name="ln-1865"></a><span class="k">      </span><span class="n">loc_ymp</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!first layer</span>
<a name="ln-1866"></a>      <span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1867"></a>      <span class="c">!===========================</span>
<a name="ln-1868"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1869"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ymp</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
<a name="ln-1870"></a>      <span class="k">end do</span>
<a name="ln-1871"></a><span class="k">      </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">npty_ne</span>
<a name="ln-1872"></a>      <span class="c">!====================</span>
<a name="ln-1873"></a>      <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-1874"></a>     <span class="k">end do</span>
<a name="ln-1875"></a><span class="k">    end if</span>
<a name="ln-1876"></a><span class="k">   end if</span>
<a name="ln-1877"></a>   <span class="c">!============= Uniform y-z distribution in layers [5-8]</span>
<a name="ln-1878"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-1879"></a>    <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1880"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1881"></a>    <span class="n">dpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1882"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1883"></a>     <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-1884"></a>    <span class="k">end do</span>
<a name="ln-1885"></a><span class="k">   end do</span>
<a name="ln-1886"></a><span class="k">   if</span> <span class="p">(</span><span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1887"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-1888"></a>     <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1889"></a>     <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1890"></a>     <span class="n">dpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1891"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1892"></a>      <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-1893"></a>     <span class="k">end do</span>
<a name="ln-1894"></a><span class="k">    end do</span>
<a name="ln-1895"></a><span class="k">   end if</span>
<a name="ln-1896"></a>   <span class="c">!========= For all (y,z) coordinates</span>
<a name="ln-1897"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-1898"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1899"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">stretch</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1900"></a><span class="k">     </span><span class="n">yy</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span>
<a name="ln-1901"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">yy</span> <span class="o">&gt;</span> <span class="n">yp_min</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1902"></a><span class="k">      </span><span class="n">dpy</span> <span class="o">=</span> <span class="n">dyi</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1903"></a>      <span class="n">i1</span> <span class="o">=</span> <span class="p">(</span><span class="n">str_ygrid</span><span class="p">%</span><span class="n">sind</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nyl1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1904"></a>      <span class="n">i2</span> <span class="o">=</span> <span class="n">npty_ne</span> <span class="o">-</span> <span class="n">i1</span>
<a name="ln-1905"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i1</span>
<a name="ln-1906"></a>       <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-1907"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-1908"></a>       <span class="n">wy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-1909"></a>      <span class="k">end do</span>
<a name="ln-1910"></a><span class="k">      </span><span class="n">dxip</span> <span class="o">=</span> <span class="n">dy</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npyc</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1911"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-1912"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smin</span> <span class="o">+</span> <span class="n">dxip</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-1913"></a>      <span class="k">end do</span>
<a name="ln-1914"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-1915"></a>       <span class="n">dxip</span> <span class="o">=</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">i2</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-1916"></a>       <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_ygrid</span><span class="p">%</span><span class="n">smax</span> <span class="o">+</span> <span class="n">l_s</span><span class="o">*</span><span class="nb">tan</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span>
<a name="ln-1917"></a>       <span class="n">wy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">dxip</span><span class="p">))</span>
<a name="ln-1918"></a>      <span class="k">end do</span>
<a name="ln-1919"></a><span class="k">     end if</span>
<a name="ln-1920"></a><span class="k">    end if</span>
<a name="ln-1921"></a>    <span class="c">!============= end stretching correction</span>
<a name="ln-1922"></a>    <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1923"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1924"></a><span class="k">     </span><span class="n">zpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1925"></a>     <span class="n">wz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wy</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1926"></a>     <span class="n">nptz_ne</span> <span class="o">=</span> <span class="n">npty_ne</span>
<a name="ln-1927"></a>    <span class="k">end if</span>
<a name="ln-1928"></a><span class="k">    call </span><span class="n">set_pgrid_ind</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1929"></a>   <span class="k">end do</span>
<a name="ln-1930"></a>   <span class="c">!=================== y-z data on local arrays</span>
<a name="ln-1931"></a>   <span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_jmax</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1932"></a>   <span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_kmax</span><span class="p">(</span><span class="n">imodz</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1933"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1934"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1935"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1936"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1937"></a>   <span class="c">!======================</span>
<a name="ln-1938"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghyz</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1939"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_ypt</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1940"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_zpt</span><span class="p">(</span><span class="n">nptz_ne</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1941"></a>   <span class="n">loc_wghyz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1942"></a>   <span class="k">call </span><span class="n">mpi_yz_part_distrib</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc_npty</span><span class="p">,</span> <span class="n">loc_nptz</span><span class="p">,</span> <span class="n">npty_layer</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1943"></a>                            <span class="n">npty_layer</span><span class="p">,</span> <span class="n">ymin_t</span><span class="p">,</span> <span class="n">zmin_t</span><span class="p">,</span> <span class="n">wyz</span><span class="p">)</span>
<a name="ln-1944"></a>   <span class="c">!=======================</span>
<a name="ln-1945"></a>   <span class="c">!Longitudinal layer distribution</span>
<a name="ln-1946"></a>   <span class="c">!===========================</span>
<a name="ln-1947"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1948"></a>   <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">!only layers 3-4-5</span>
<a name="ln-1949"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
<a name="ln-1950"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-1951"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-1952"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-1953"></a>   <span class="k">end do</span>
<a name="ln-1954"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span>
<a name="ln-1955"></a>   <span class="n">targ_in</span> <span class="o">=</span> <span class="n">xfsh</span>
<a name="ln-1956"></a>   <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-1957"></a>   <span class="c">! Input particles</span>
<a name="ln-1958"></a>   <span class="c">!====np_per_xc(1:2) electrons and Z1 ions in the nanowires target +</span>
<a name="ln-1959"></a>   <span class="c">!internanow-plasma =&gt; lpx(3)</span>
<a name="ln-1960"></a>   <span class="c">!====np_per_xc(3:4) electrons and Z1 ions in bulk layer</span>
<a name="ln-1961"></a>   <span class="c">!=== np_per_xc(5:6) electrons and Z2=proton in contaminant layer</span>
<a name="ln-1962"></a>   <span class="c">!  Particles grid ordering</span>
<a name="ln-1963"></a>   <span class="c">!  only nxl(3) nxl(4) and nxl(5) layers activated</span>
<a name="ln-1964"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">!inter-wire  electrons+Z1-ion plasma</span>
<a name="ln-1965"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">!nanowires electron-Z1 ions</span>
<a name="ln-1966"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="c">!bulk layer electrons +Z1 ions</span>
<a name="ln-1967"></a>   <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="c">!contaminant electrons +Z2 ions (proton)</span>
<a name="ln-1968"></a>
<a name="ln-1969"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-1970"></a>   <span class="c">!=======================</span>
<a name="ln-1971"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1972"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1973"></a>
<a name="ln-1974"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1975"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghx</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a name="ln-1976"></a>   <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nptx_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1977"></a>   <span class="c">!=================</span>
<a name="ln-1978"></a>   <span class="c">!========================</span>
<a name="ln-1979"></a>   <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1980"></a>   <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1981"></a>   <span class="c">! Nanowires x-layer: electrons and Z1-ions</span>
<a name="ln-1982"></a>   <span class="c">! nanowires density is the reference density</span>
<a name="ln-1983"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1984"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-1985"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-1986"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1987"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-1988"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-1989"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-1990"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ratio_mpc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">j0_norm</span>
<a name="ln-1991"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1992"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">np1</span><span class="o">*</span><span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="c">!inter-wire plasma (or vacuum)</span>
<a name="ln-1993"></a>      <span class="k">end do</span>
<a name="ln-1994"></a><span class="k">     end if</span>
<a name="ln-1995"></a>     <span class="c">!========================= np1&gt;0 a low density  interwire plasma</span>
<a name="ln-1996"></a>    <span class="k">end do</span>
<a name="ln-1997"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1998"></a>    <span class="c">!============= first x-layer distributed on locx mpi tasks</span>
<a name="ln-1999"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-2000"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2001"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2002"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-2003"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2004"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2005"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2006"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2007"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-2008"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-2009"></a>      <span class="k">end if</span>
<a name="ln-2010"></a><span class="k">     end do</span>
<a name="ln-2011"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-2012"></a>     <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-2013"></a>    <span class="k">end do</span>
<a name="ln-2014"></a>    <span class="c">!========================</span>
<a name="ln-2015"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-2016"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-2017"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-2018"></a>    <span class="n">nps_loc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2019"></a>    <span class="c">! Counts particles</span>
<a name="ln-2020"></a>
<a name="ln-2021"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2022"></a>                                                                     <span class="mi">1</span><span class="p">)</span>
<a name="ln-2023"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2024"></a>                                                                     <span class="mi">2</span><span class="p">)</span>
<a name="ln-2025"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">np1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2026"></a><span class="k">     </span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span> <span class="p">&amp;</span>
<a name="ln-2027"></a>                                                                      <span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-2028"></a>     <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span> <span class="p">&amp;</span>
<a name="ln-2029"></a>                                                                      <span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-2030"></a>    <span class="k">end if</span>
<a name="ln-2031"></a><span class="k">   end if</span>
<a name="ln-2032"></a>   <span class="c">!------------------------------</span>
<a name="ln-2033"></a>   <span class="c">!  Electrons and Z1_ions: bulk layer</span>
<a name="ln-2034"></a>   <span class="c">!     x distribution. Density given by the particle density mpc(3:4)</span>
<a name="ln-2035"></a>   <span class="c">!====================</span>
<a name="ln-2036"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2037"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-2038"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2039"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2040"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-2041"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2042"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">ratio_mpc</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-2043"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">uu</span>
<a name="ln-2044"></a>      <span class="k">end do</span>
<a name="ln-2045"></a><span class="k">     end if</span>
<a name="ln-2046"></a><span class="k">    end do</span>
<a name="ln-2047"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2048"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-2049"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2050"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2051"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-2052"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2053"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2054"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2055"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2056"></a>      <span class="k">end if</span>
<a name="ln-2057"></a><span class="k">     end do</span>
<a name="ln-2058"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-2059"></a>    <span class="k">end do</span>
<a name="ln-2060"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-2061"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-2062"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-2063"></a>
<a name="ln-2064"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2065"></a>                                                                     <span class="mi">5</span><span class="p">)</span>
<a name="ln-2066"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2067"></a>                                                                     <span class="mi">6</span><span class="p">)</span>
<a name="ln-2068"></a>   <span class="k">end if</span>
<a name="ln-2069"></a>   <span class="c">!  Electrons and Z3_ions contaminants</span>
<a name="ln-2070"></a>   <span class="c">!     x distribution density given by np2</span>
<a name="ln-2071"></a>   <span class="c">!====================</span>
<a name="ln-2072"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2073"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-2074"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2075"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">n_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2076"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-2077"></a>       <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2078"></a>       <span class="n">uu</span> <span class="o">=</span> <span class="n">j0_norm</span><span class="o">*</span><span class="n">ratio_mpc</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-2079"></a>       <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">uu</span><span class="o">*</span><span class="n">np2</span>
<a name="ln-2080"></a>      <span class="k">end do</span>
<a name="ln-2081"></a><span class="k">     end if</span>
<a name="ln-2082"></a><span class="k">    end do</span>
<a name="ln-2083"></a><span class="k">    </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">8</span>
<a name="ln-2084"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2085"></a>    <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">ion_min</span><span class="p">(</span><span class="n">nsp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2086"></a>    <span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2087"></a>    <span class="c">!===============</span>
<a name="ln-2088"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
<a name="ln-2089"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2090"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2091"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">&amp;</span>
<a name="ln-2092"></a>          <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2093"></a><span class="k">       </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2094"></a>       <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2095"></a>       <span class="n">loc_wghx</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2096"></a>      <span class="k">end if</span>
<a name="ln-2097"></a><span class="k">     end do</span>
<a name="ln-2098"></a><span class="k">     </span><span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2099"></a>    <span class="k">end do</span>
<a name="ln-2100"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">imodx</span>
<a name="ln-2101"></a>    <span class="n">l</span> <span class="o">=</span> <span class="n">imody</span>
<a name="ln-2102"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="n">imodz</span>
<a name="ln-2103"></a>
<a name="ln-2104"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2105"></a>                                                                     <span class="mi">7</span><span class="p">)</span>
<a name="ln-2106"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">loc_jmax</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">loc_kmax</span> <span class="p">&amp;</span>
<a name="ln-2107"></a>                   <span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a name="ln-2108"></a>   <span class="k">end if</span>
<a name="ln-2109"></a>   <span class="c">!==============END target x-distribution</span>
<a name="ln-2110"></a>   <span class="c">!==============</span>
<a name="ln-2111"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-2112"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-2113"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-2114"></a>   <span class="c">!===========================</span>
<a name="ln-2115"></a>   <span class="n">ip_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2116"></a>   <span class="n">ip_pr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2117"></a>   <span class="n">ip_ion</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2118"></a>   <span class="c">! The first electron-Z1-ions nanowires layer</span>
<a name="ln-2119"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2120"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2121"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-2122"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2123"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-2124"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2125"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-2126"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2127"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-2128"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">np1</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2129"></a><span class="k">     </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-2130"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-2131"></a>     <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2132"></a>                              <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-2133"></a>     <span class="n">p</span> <span class="o">=</span> <span class="n">ip_ion</span>
<a name="ln-2134"></a>     <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-2135"></a>     <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2136"></a>                              <span class="n">i2</span><span class="p">,</span> <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-2137"></a>    <span class="k">end if</span>
<a name="ln-2138"></a><span class="k">   end if</span>
<a name="ln-2139"></a>   <span class="c">!=========================</span>
<a name="ln-2140"></a>   <span class="c">! The second electron-ion solid layer with Z1 A1 ion element</span>
<a name="ln-2141"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2142"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-2143"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-2144"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2145"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-2146"></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">ip_ion</span>
<a name="ln-2147"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-2148"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2149"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-2150"></a>   <span class="k">end if</span>
<a name="ln-2151"></a>   <span class="c">!============</span>
<a name="ln-2152"></a>   <span class="c">! The contaminant electron-ion solid layer Z3=proton ion element</span>
<a name="ln-2153"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2154"></a><span class="k">    </span><span class="n">p</span> <span class="o">=</span> <span class="n">ip_el</span>
<a name="ln-2155"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-2156"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2157"></a>                             <span class="n">i2</span><span class="p">,</span> <span class="n">ip_el</span><span class="p">)</span>
<a name="ln-2158"></a>
<a name="ln-2159"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2160"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_imax</span><span class="p">(</span><span class="n">imodx</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a name="ln-2161"></a>    <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="n">nsp</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2162"></a>                             <span class="mi">8</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ip_ion</span><span class="p">)</span>
<a name="ln-2163"></a>   <span class="k">end if</span>
<a name="ln-2164"></a><span class="k">   do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2165"></a>    <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2166"></a>   <span class="k">end do</span>
<a name="ln-2167"></a>
<a name="ln-2168"></a><span class="k">  end subroutine</span>
<a name="ln-2169"></a>  <span class="c">!============</span>
<a name="ln-2170"></a>  <span class="k">subroutine </span><span class="n">one_layer_nano_tubes</span><span class="p">(</span><span class="n">nyh_in</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2171"></a>
<a name="ln-2172"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nyh_in</span>
<a name="ln-2173"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-2174"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span>
<a name="ln-2175"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-2176"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">n_peak</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2177"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-2178"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npmax</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2179"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uu</span><span class="p">,</span> <span class="n">dpy</span><span class="p">,</span> <span class="n">dlpy</span><span class="p">,</span> <span class="n">rat</span>
<a name="ln-2180"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">zp_min</span><span class="p">,</span> <span class="n">zp_max</span><span class="p">,</span> <span class="n">yp_min</span><span class="p">,</span> <span class="n">yp_max</span><span class="p">,</span> <span class="n">xp_min</span><span class="p">,</span> <span class="n">xp_max</span>
<a name="ln-2181"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">loc_ym</span><span class="p">,</span> <span class="n">loc_ymx</span><span class="p">,</span> <span class="n">loc_zm</span><span class="p">,</span> <span class="n">loc_zmx</span>
<a name="ln-2182"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xfsh</span><span class="p">,</span> <span class="n">r_int</span><span class="p">,</span> <span class="n">r_ext</span><span class="p">,</span> <span class="n">ffactor</span>
<a name="ln-2183"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">npt_nano</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2184"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nlpy</span>
<a name="ln-2185"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">npty_layer</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">nptz_layer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2186"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">wy</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wz</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">wyz</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-2187"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">yc</span><span class="p">(:),</span> <span class="n">ypt_nano</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">zpt_nano</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-2188"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">locy_nano</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">locz_nano</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-2189"></a>   <span class="c">!=================</span>
<a name="ln-2190"></a>   <span class="n">xp_min</span> <span class="o">=</span> <span class="n">xmin</span>
<a name="ln-2191"></a>   <span class="n">xp_max</span> <span class="o">=</span> <span class="n">xmax</span>
<a name="ln-2192"></a>   <span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2193"></a>   <span class="c">!============================</span>
<a name="ln-2194"></a>   <span class="n">nxl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2195"></a>   <span class="c">!========= gridding the transverese target size</span>
<a name="ln-2196"></a>   <span class="n">yp_min</span> <span class="o">=</span> <span class="n">ymin_t</span>
<a name="ln-2197"></a>   <span class="n">yp_max</span> <span class="o">=</span> <span class="n">ymax_t</span>
<a name="ln-2198"></a>   <span class="c">!===============================</span>
<a name="ln-2199"></a>   <span class="c">! Geometry |--s/2--|======v=====|---s/2--|</span>
<a name="ln-2200"></a>   <span class="c">! total size L=s+v=s*(1+v/s)=s(1+rat)</span>
<a name="ln-2201"></a>   <span class="c">! Filling factor f=(1-(v/L)^2)</span>
<a name="ln-2202"></a>   <span class="c">!===========================</span>
<a name="ln-2203"></a>   <span class="c">! Two-species Electrons + Z ions</span>
<a name="ln-2204"></a>   <span class="c">!=============================</span>
<a name="ln-2205"></a>
<a name="ln-2206"></a>   <span class="n">npty</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">np_per_yc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2207"></a>   <span class="n">npty</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">npty</span> <span class="c">!particles number in 3 nlpy slabs</span>
<a name="ln-2208"></a>   <span class="n">nptz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2209"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2210"></a><span class="k">    </span><span class="n">np_per_zcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_per_zc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2211"></a>    <span class="n">zp_min</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="c">!-Lz</span>
<a name="ln-2212"></a>    <span class="n">zp_max</span> <span class="o">=</span> <span class="n">yp_max</span> <span class="c">!+Lz</span>
<a name="ln-2213"></a>    <span class="n">nptz</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">np_per_zc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2214"></a>    <span class="n">nptz</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">nptz</span>
<a name="ln-2215"></a>   <span class="k">end if</span>
<a name="ln-2216"></a><span class="k">   allocate</span> <span class="p">(</span><span class="n">ypt</span><span class="p">(</span><span class="n">npty</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2217"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wy</span><span class="p">(</span><span class="n">npty</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2218"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">nptz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2219"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wz</span><span class="p">(</span><span class="n">nptz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2220"></a>   <span class="n">wy</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-2221"></a>   <span class="n">wz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-2222"></a>   <span class="c">!==================</span>
<a name="ln-2223"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_jmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2224"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_kmax</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2225"></a>   <span class="c">!====================</span>
<a name="ln-2226"></a>   <span class="c">! Uniform yp grid of size npty_ne</span>
<a name="ln-2227"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-2228"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in 2*ymax size</span>
<a name="ln-2229"></a>    <span class="n">dpy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2230"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-2231"></a>     <span class="n">ypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="n">dpy</span><span class="o">*</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a name="ln-2232"></a>    <span class="k">end do</span>
<a name="ln-2233"></a><span class="k">    </span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">npty_ne</span>
<a name="ln-2234"></a>    <span class="n">nptz_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2235"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2236"></a><span class="k">     </span><span class="n">i2</span> <span class="o">=</span> <span class="n">npty_ne</span>
<a name="ln-2237"></a>     <span class="n">zpt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2238"></a>     <span class="n">wz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wy</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2239"></a>     <span class="n">nptz_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i2</span>
<a name="ln-2240"></a>    <span class="k">end if</span>
<a name="ln-2241"></a><span class="k">    call </span><span class="n">set_pgrid_ind</span><span class="p">(</span><span class="n">npty_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">nptz_layer</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2242"></a>   <span class="k">end do</span>
<a name="ln-2243"></a>   <span class="c">!===========================</span>
<a name="ln-2244"></a>   <span class="c">! Layer lpx(3) for nanotubes lpx(4) for target</span>
<a name="ln-2245"></a>   <span class="n">xtot</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2246"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<a name="ln-2247"></a>    <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-2248"></a>    <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<a name="ln-2249"></a>    <span class="n">xtot</span> <span class="o">=</span> <span class="n">xtot</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-2250"></a>   <span class="k">end do</span>
<a name="ln-2251"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xf0</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2252"></a>   <span class="n">targ_in</span> <span class="o">=</span> <span class="n">xfsh</span>
<a name="ln-2253"></a>   <span class="n">targ_end</span> <span class="o">=</span> <span class="n">targ_in</span> <span class="o">+</span> <span class="n">xtot</span>
<a name="ln-2254"></a>   <span class="c">!=======================</span>
<a name="ln-2255"></a>   <span class="c">! Only layers 3 and 4 in x</span>
<a name="ln-2256"></a>   <span class="n">loc_nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2257"></a>   <span class="n">loc_nptx</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2258"></a>   <span class="n">nptx_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-2259"></a>
<a name="ln-2260"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2261"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_xpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2262"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">nptx_max</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2263"></a>   <span class="c">!======================================</span>
<a name="ln-2264"></a>   <span class="c">! Uses the yp,zp=yp for ic=1,2 uniform p-grid</span>
<a name="ln-2265"></a>   <span class="c">! to select a three-layer array of circular nanotubes</span>
<a name="ln-2266"></a>   <span class="c">!===============</span>
<a name="ln-2267"></a>   <span class="n">dlpy</span> <span class="o">=</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!2*dr  lpy(2)=2*r_int</span>
<a name="ln-2268"></a>   <span class="n">nlpy</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dy_inv</span><span class="o">*</span><span class="n">dlpy</span><span class="p">)</span> <span class="c">! cell numbers in [dlpy layer]</span>
<a name="ln-2269"></a>   <span class="n">rat</span> <span class="o">=</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">dlpy</span>
<a name="ln-2270"></a>   <span class="n">r_int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2271"></a>   <span class="n">r_ext</span> <span class="o">=</span> <span class="n">r_int</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dlpy</span>
<a name="ln-2272"></a>
<a name="ln-2273"></a>   <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp_max</span> <span class="o">-</span> <span class="n">yp_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dlpy</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">dlpy</span><span class="p">)</span>
<a name="ln-2274"></a>   <span class="n">ntubes</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span>
<a name="ln-2275"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">yc</span><span class="p">(</span><span class="n">ntubes</span><span class="p">))</span>
<a name="ln-2276"></a>   <span class="c">!=========================</span>
<a name="ln-2277"></a>   <span class="n">yc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">yp_min</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dlpy</span> <span class="o">+</span> <span class="n">r_ext</span>
<a name="ln-2278"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2279"></a>    <span class="n">yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">yc</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">dlpy</span>
<a name="ln-2280"></a>   <span class="k">end do</span>
<a name="ln-2281"></a>   <span class="c">!========= filling factor</span>
<a name="ln-2282"></a>   <span class="n">ffactor</span> <span class="o">=</span> <span class="nb">acos</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">r_ext</span><span class="o">*</span><span class="n">r_ext</span> <span class="o">-</span> <span class="n">r_int</span><span class="o">*</span><span class="n">r_int</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">lpy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">dlpy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2283"></a>   <span class="c">!=============================</span>
<a name="ln-2284"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-2285"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in Ly=2*ymax size</span>
<a name="ln-2286"></a>    <span class="n">nptz_ne</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_zc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of zp points in Lz=2*zmax size</span>
<a name="ln-2287"></a>    <span class="n">npt_nano</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2288"></a>    <span class="k">do </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2289"></a>     <span class="k">do </span><span class="n">k2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2290"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-2291"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-2292"></a>        <span class="n">dpy</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">yc</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">yc</span><span class="p">(</span><span class="n">k1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2293"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dpy</span> <span class="o">&gt;=</span> <span class="n">r_int</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">dpy</span> <span class="o">&lt;</span> <span class="n">r_ext</span><span class="p">)</span> <span class="n">npt_nano</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">npt_nano</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2294"></a>       <span class="k">end do</span>
<a name="ln-2295"></a><span class="k">      end do</span>
<a name="ln-2296"></a><span class="k">     end do</span>
<a name="ln-2297"></a><span class="k">    end do</span>
<a name="ln-2298"></a><span class="k">   end do</span>
<a name="ln-2299"></a>   <span class="c">! npt_nano(ic) nanotubes section</span>
<a name="ln-2300"></a>   <span class="c">!====================</span>
<a name="ln-2301"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">npt_nano</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2302"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">ypt_nano</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nsp</span><span class="p">),</span> <span class="n">zpt_nano</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2303"></a>   <span class="n">loc_ym</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-2304"></a>   <span class="n">loc_ymx</span> <span class="o">=</span> <span class="n">loc_ygrid</span><span class="p">(</span><span class="n">imody</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-2305"></a>   <span class="n">loc_zm</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-2306"></a>   <span class="n">loc_zmx</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">gmax</span>
<a name="ln-2307"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-2308"></a>    <span class="n">npty_ne</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_yc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in 2*ymax size</span>
<a name="ln-2309"></a>    <span class="n">nptz_ne</span> <span class="o">=</span> <span class="n">nyh_in</span><span class="o">*</span><span class="n">np_per_zc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!number of yp points in 2*ymax size</span>
<a name="ln-2310"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2311"></a>    <span class="k">do </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2312"></a>     <span class="k">do </span><span class="n">k2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntubes</span>
<a name="ln-2313"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptz_ne</span>
<a name="ln-2314"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npty_ne</span>
<a name="ln-2315"></a>        <span class="n">dpy</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">yc</span><span class="p">(</span><span class="n">k2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">yc</span><span class="p">(</span><span class="n">k1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2316"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dpy</span> <span class="o">&gt;=</span> <span class="n">r_int</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">dpy</span> <span class="o">&lt;</span> <span class="n">r_ext</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2317"></a><span class="k">         </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2318"></a>         <span class="n">ypt_nano</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2319"></a>         <span class="n">zpt_nano</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">zpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2320"></a>        <span class="k">end if</span>
<a name="ln-2321"></a><span class="k">       end do</span>
<a name="ln-2322"></a><span class="k">      end do</span>
<a name="ln-2323"></a><span class="k">     end do</span>
<a name="ln-2324"></a><span class="k">    end do</span>
<a name="ln-2325"></a><span class="k">    </span><span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2326"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-2327"></a>     <span class="n">uu</span> <span class="o">=</span> <span class="n">ypt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2328"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">uu</span> <span class="o">&gt;=</span> <span class="n">loc_ym</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">loc_ymx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2329"></a><span class="k">      </span><span class="n">uu</span> <span class="o">=</span> <span class="n">zpt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2330"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">uu</span> <span class="o">&gt;=</span> <span class="n">loc_zm</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">loc_zmx</span><span class="p">)</span> <span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2331"></a>     <span class="k">end if</span>
<a name="ln-2332"></a><span class="k">    end do</span>
<a name="ln-2333"></a><span class="k">   end do</span>
<a name="ln-2334"></a><span class="k">   </span><span class="n">npty_ne</span> <span class="o">=</span> <span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2335"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="n">npty_ne</span>
<a name="ln-2336"></a>   <span class="c">!==========================</span>
<a name="ln-2337"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">npty_ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2338"></a><span class="k">    allocate</span> <span class="p">(</span><span class="n">locy_nano</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2339"></a>    <span class="k">allocate</span> <span class="p">(</span><span class="n">locz_nano</span><span class="p">(</span><span class="n">nptz_ne</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-2340"></a>   <span class="k">end if</span>
<a name="ln-2341"></a>   <span class="c">!==========================</span>
<a name="ln-2342"></a>   <span class="c">!========== Nanotubes layer</span>
<a name="ln-2343"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-2344"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2345"></a><span class="k">     </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2346"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npt_nano</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2347"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="n">ypt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2348"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">uu</span> <span class="o">&gt;=</span> <span class="n">loc_ym</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">loc_ymx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2349"></a><span class="k">       </span><span class="n">uu</span> <span class="o">=</span> <span class="n">zpt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2350"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">uu</span> <span class="o">&gt;=</span> <span class="n">loc_zm</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">uu</span> <span class="o">&lt;</span> <span class="n">loc_zmx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2351"></a><span class="k">        </span><span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2352"></a>        <span class="n">locy_nano</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ypt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2353"></a>        <span class="n">locz_nano</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">zpt_nano</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2354"></a>       <span class="k">end if</span>
<a name="ln-2355"></a><span class="k">      end if</span>
<a name="ln-2356"></a><span class="k">     end do</span>
<a name="ln-2357"></a><span class="k">     </span><span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">k1</span>
<a name="ln-2358"></a>    <span class="k">end if</span>
<a name="ln-2359"></a><span class="k">   end do</span>
<a name="ln-2360"></a>   <span class="c">!============================ Flat target</span>
<a name="ln-2361"></a>   <span class="c">!====================================</span>
<a name="ln-2362"></a>   <span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_jmax</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-2363"></a>   <span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_kmax</span><span class="p">(</span><span class="n">imodz</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-2364"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2365"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2366"></a>   <span class="n">npty_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_npty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-2367"></a>   <span class="n">nptz_ne</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">loc_nptz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-2368"></a>   <span class="c">!======================</span>
<a name="ln-2369"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_wghyz</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nptz_ne</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2370"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_ypt</span><span class="p">(</span><span class="n">npty_ne</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2371"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">loc_zpt</span><span class="p">(</span><span class="n">nptz_ne</span><span class="p">,</span> <span class="n">nsp</span><span class="p">))</span>
<a name="ln-2372"></a>   <span class="n">loc_wghyz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-2373"></a>   <span class="c">!============================ Uniform target</span>
<a name="ln-2374"></a>   <span class="k">call </span><span class="n">mpi_yz_part_distrib</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc_npty</span><span class="p">,</span> <span class="n">loc_nptz</span><span class="p">,</span> <span class="n">npty_layer</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2375"></a>                            <span class="n">nptz_layer</span><span class="p">,</span> <span class="n">ymin_t</span><span class="p">,</span> <span class="n">zmin_t</span><span class="p">,</span> <span class="n">wyz</span><span class="p">)</span>
<a name="ln-2376"></a>   <span class="c">!==========================</span>
<a name="ln-2377"></a>   <span class="n">nptx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2378"></a>   <span class="c">!========================</span>
<a name="ln-2379"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2380"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2381"></a>    <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2382"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-2383"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2384"></a>     <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2385"></a>     <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-2386"></a>     <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span>
<a name="ln-2387"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">ic</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">wgh_ion</span>
<a name="ln-2388"></a>     <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2389"></a>    <span class="k">end do</span>
<a name="ln-2390"></a><span class="k">    </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-2391"></a>   <span class="k">end do</span>
<a name="ln-2392"></a><span class="k">   </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2393"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!a bulk</span>
<a name="ln-2394"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2395"></a>     <span class="n">i1</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2396"></a>     <span class="n">n_peak</span> <span class="o">=</span> <span class="n">nxl</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np_per_xc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2397"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peak</span>
<a name="ln-2398"></a>      <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2399"></a>      <span class="n">uu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_peak</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-2400"></a>      <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-2401"></a>      <span class="n">wghpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">j0_norm</span>
<a name="ln-2402"></a>      <span class="n">loc_xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2403"></a>     <span class="k">end do</span>
<a name="ln-2404"></a><span class="k">     </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-2405"></a>    <span class="k">end do</span>
<a name="ln-2406"></a><span class="k">    </span><span class="n">xfsh</span> <span class="o">=</span> <span class="n">xfsh</span> <span class="o">+</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2407"></a>   <span class="k">end if</span>
<a name="ln-2408"></a>   <span class="c">!=================== on index ic=2 are ions with charge Z_i=npc_e/npc_i</span>
<a name="ln-2409"></a>   <span class="c">!======================</span>
<a name="ln-2410"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2411"></a>    <span class="n">j</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2412"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2413"></a><span class="k">     </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2414"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx_max</span>
<a name="ln-2415"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">i</span> <span class="c">!inside the box xpt[1:nptx(ic)]</span>
<a name="ln-2416"></a>     <span class="k">end do</span>
<a name="ln-2417"></a><span class="k">     </span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span>
<a name="ln-2418"></a>    <span class="k">end if</span>
<a name="ln-2419"></a><span class="k">   end do</span>
<a name="ln-2420"></a>   <span class="c">!============ count partuckes of nano-tubes</span>
<a name="ln-2421"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2422"></a>    <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2423"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2424"></a>    <span class="k">do </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2425"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-2426"></a>      <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2427"></a>     <span class="k">end do</span>
<a name="ln-2428"></a><span class="k">    end do</span>
<a name="ln-2429"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2430"></a><span class="k">     do </span><span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc_kmax</span><span class="p">(</span><span class="n">imodz</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2431"></a>      <span class="k">do </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc_jmax</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2432"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2433"></a>        <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2434"></a>       <span class="k">end do</span>
<a name="ln-2435"></a><span class="k">      end do</span>
<a name="ln-2436"></a><span class="k">     end do</span>
<a name="ln-2437"></a><span class="k">    end if</span>
<a name="ln-2438"></a><span class="k">   end do</span>
<a name="ln-2439"></a><span class="k">   </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span> <span class="o">=</span> <span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">)</span>
<a name="ln-2440"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">nps_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-2441"></a>   <span class="n">npmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-2442"></a>   <span class="k">call </span><span class="n">p_alloc</span><span class="p">(</span><span class="n">npmax</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nps_loc</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mem_psize</span><span class="p">)</span>
<a name="ln-2443"></a>   <span class="c">!===========================</span>
<a name="ln-2444"></a>   <span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">mype</span><span class="p">)</span>
<a name="ln-2445"></a>   <span class="c">!============</span>
<a name="ln-2446"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-2447"></a>    <span class="n">i2</span> <span class="o">=</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2448"></a>    <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unit_charge</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span>
<a name="ln-2449"></a>    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2450"></a>    <span class="k">do </span><span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc_npty</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2451"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-2452"></a>      <span class="n">wgh</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">wghpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-2453"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2454"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">xpt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2455"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">locy_nano</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2456"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">locz_nano</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-2457"></a>      <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span>
<a name="ln-2458"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-2459"></a>      <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span>
<a name="ln-2460"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-2461"></a>      <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span>
<a name="ln-2462"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">uu</span>
<a name="ln-2463"></a>      <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-2464"></a>     <span class="k">end do</span>
<a name="ln-2465"></a><span class="k">    end do</span>
<a name="ln-2466"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2467"></a><span class="k">     </span><span class="n">i2</span> <span class="o">=</span> <span class="n">nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">loc_nptx</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
<a name="ln-2468"></a>     <span class="k">call </span><span class="n">pspecies_distribute</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">t0_pl</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">unit_charge</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2469"></a>                              <span class="n">ic</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
<a name="ln-2470"></a>    <span class="k">end if</span>
<a name="ln-2471"></a><span class="k">   end do</span>
<a name="ln-2472"></a>   <span class="c">!============</span>
<a name="ln-2473"></a>  <span class="k">end subroutine</span>
<a name="ln-2474"></a>  <span class="c">!====================================</span>
<a name="ln-2475"></a>  <span class="k">subroutine </span><span class="n">part_distribute</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2476"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">id</span>
<a name="ln-2477"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xf0</span>
<a name="ln-2478"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span>
<a name="ln-2479"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">tot_nploc</span><span class="p">(</span><span class="n">npe</span><span class="p">)</span>
<a name="ln-2480"></a>   <span class="c">!=================</span>
<a name="ln-2481"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2482"></a>    <span class="c">!nps_run =1</span>
<a name="ln-2483"></a>    <span class="c">!if nsp &gt; 1 ions active only for ionization</span>
<a name="ln-2484"></a>    <span class="k">call </span><span class="n">multi_layer_gas_target</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2485"></a>    <span class="c">!======================</span>
<a name="ln-2486"></a>    <span class="c">!model id=1</span>
<a name="ln-2487"></a>    <span class="c">!lpx(1) first plateau np1 density</span>
<a name="ln-2488"></a>    <span class="c">!ramp lpx(2)+ plateau lpx(3) + downramp lpx(4)] density 1</span>
<a name="ln-2489"></a>    <span class="c">!lpx(5) last plateau np2 density</span>
<a name="ln-2490"></a>    <span class="c">!all densities normalized to n_0=n_over_nc</span>
<a name="ln-2491"></a>    <span class="c">!====================================</span>
<a name="ln-2492"></a>    <span class="c">!model id=2  target with two central plateau (for shocked gas-jet)</span>
<a name="ln-2493"></a>    <span class="c">!lpx(1) first ramp up to lpx(2) first plateau at density np1</span>
<a name="ln-2494"></a>    <span class="c">!lpx(3) downramp to</span>
<a name="ln-2495"></a>    <span class="c">!lpx(4) second plateau density np2 and to final downramp lpx(5)</span>
<a name="ln-2496"></a>    <span class="c">!n_0=n_over_nc can be an average, or n0_=n1_over_nc or n0_=n2_over_nc</span>
<a name="ln-2497"></a>    <span class="c">!Multispecies implementation</span>
<a name="ln-2498"></a>    <span class="c">! target in models id=1 and id=2 contain (implicitely) an ion species id_sp=1</span>
<a name="ln-2499"></a>    <span class="c">!as a neutralizing background. If ionization is on, nsp=2 and ionizing species</span>
<a name="ln-2500"></a>    <span class="c">!is loaded and activated for ionization.</span>
<a name="ln-2501"></a>    <span class="c">!====================================</span>
<a name="ln-2502"></a>    <span class="c">!model id=3 as id=2, with two ion species, one as local dopant and the other</span>
<a name="ln-2503"></a>    <span class="c">!as a neutralizing background:</span>
<a name="ln-2504"></a>    <span class="c">! layer(1) + layer(2) only electrons and H+ with ne=n0=n_over_nc</span>
<a name="ln-2505"></a>    <span class="c">! layer(3) is a plateau with an added dopant (A1,Z1) with density</span>
<a name="ln-2506"></a>    <span class="c">! np1=n1_over_n/n0 (few %)</span>
<a name="ln-2507"></a>    <span class="c">! layer(4)+layer(5) as layer(1)+layer(2)</span>
<a name="ln-2508"></a>    <span class="c">!----------</span>
<a name="ln-2509"></a>   <span class="k">else</span>
<a name="ln-2510"></a>    <span class="c">!SOLID MULTISPECIES TARGETS</span>
<a name="ln-2511"></a>    <span class="c">!flag id=1,2 allowed not even implemented</span>
<a name="ln-2512"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<a name="ln-2513"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2514"></a>     <span class="k">call </span><span class="n">preplasma_multisp</span><span class="p">(</span><span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2515"></a>     <span class="c">! (e+Z1) preplasma and central target</span>
<a name="ln-2516"></a>     <span class="c">!+ (e+Z2)coating</span>
<a name="ln-2517"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2518"></a>     <span class="k">call </span><span class="n">multi_layer_twosp_target</span><span class="p">(</span><span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2519"></a>     <span class="c">!(e+Z2) foam</span>
<a name="ln-2520"></a>     <span class="c">!(e+Z1) central layer</span>
<a name="ln-2521"></a>     <span class="c">!(e+Z2)coating</span>
<a name="ln-2522"></a>     <span class="c">!============warning exponential ramp (in layer 2) always using (e+Z1) species</span>
<a name="ln-2523"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2524"></a>     <span class="k">call </span><span class="n">multi_layer_threesp_target</span><span class="p">(</span><span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2525"></a>     <span class="c">!(e+Z3) coating</span>
<a name="ln-2526"></a>     <span class="c">!(e+Z1+Z2) central multispecies layer with lpx(2) preplasma</span>
<a name="ln-2527"></a>     <span class="c">!+ (e+Z3)coating</span>
<a name="ln-2528"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2529"></a>     <span class="k">call </span><span class="n">one_layer_nano_wires</span><span class="p">(</span><span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2530"></a>     <span class="c">!e+Z1 wires, e+Z2 bulk. interwire low density (e+Z1) plasma allowed</span>
<a name="ln-2531"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2532"></a>     <span class="k">call </span><span class="n">one_layer_nano_tubes</span><span class="p">(</span><span class="n">ny_targ</span><span class="p">,</span> <span class="n">xf0</span><span class="p">)</span>
<a name="ln-2533"></a>    <span class="k">end select</span>
<a name="ln-2534"></a><span class="k">   end if</span>
<a name="ln-2535"></a>   <span class="c">!===================Data for all models===============</span>
<a name="ln-2536"></a>   <span class="n">tot_nploc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2537"></a>   <span class="n">pp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2538"></a>   <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2539"></a>    <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2540"></a>     <span class="k">do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2541"></a>      <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2542"></a>      <span class="n">tot_nploc</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loc_npart</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nsp</span><span class="p">))</span>
<a name="ln-2543"></a>     <span class="k">end do</span>
<a name="ln-2544"></a><span class="k">    end do</span>
<a name="ln-2545"></a><span class="k">   end do</span>
<a name="ln-2546"></a><span class="k">   </span><span class="n">np_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">tot_nploc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-2547"></a>   <span class="n">np_min</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">tot_nploc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-2548"></a>   <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe</span>
<a name="ln-2549"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">tot_nploc</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="n">np_max</span><span class="p">)</span> <span class="n">pe_npmax</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2550"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">tot_nploc</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">==</span> <span class="n">np_min</span><span class="p">)</span> <span class="n">pe_npmin</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-2551"></a>   <span class="k">end do</span>
<a name="ln-2552"></a>   <span class="c">!===============</span>
<a name="ln-2553"></a>  <span class="k">end subroutine</span>
<a name="ln-2554"></a><span class="k">  subroutine </span><span class="n">clean_field</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">lp1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-2555"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-2556"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lp1</span>
<a name="ln-2557"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-2558"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ilp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-2559"></a>
<a name="ln-2560"></a>   <span class="n">ilp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">lp1</span><span class="p">)</span>
<a name="ln-2561"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-2562"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-2563"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-2564"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">ilp</span>
<a name="ln-2565"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2566"></a>      <span class="k">end do</span>
<a name="ln-2567"></a><span class="k">     end do</span>
<a name="ln-2568"></a><span class="k">    end do</span>
<a name="ln-2569"></a><span class="k">   end do</span>
<a name="ln-2570"></a><span class="k">  end subroutine</span>
<a name="ln-2571"></a>  <span class="c">!=========================</span>
<a name="ln-2572"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>