<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>grid_fields.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>grid_fields.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 5.5% of total for source files.">1348 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/grid_fields.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">grid_fields.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/grid_fields.html">grid_fields</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/grid_fields.f90.html#src">grid_fields.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~grid_fields.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilegrid_fieldsf90EfferentGraph" width="641pt" height="150pt"
 viewBox="0.00 0.00 641.00 150.04" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~grid_fields.f90~~EfferentGraph" class="graph" transform="scale(.9496 .9496) rotate(0) translate(4 154)">
<title>sourcefile~~grid_fields.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-154 671,-154 671,4 -4,4"/>
<!-- sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~grid_fields.f90</title>
<polygon fill="none" stroke="#000000" points="667,-87 579,-87 579,-63 667,-63 667,-87"/>
<text text-anchor="middle" x="623" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">grid_fields.f90</text>
</g>
<!-- sourcefile~grid_field_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~grid_field_param.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/grid_field_param.f90.html" xlink:title="grid_field_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="543,-66 420,-66 420,-42 543,-42 543,-66"/>
<text text-anchor="middle" x="481.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_field_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_fields.f90&#45;&gt;sourcefile~grid_field_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~grid_fields.f90&#45;&gt;sourcefile~grid_field_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M578.6168,-68.4131C570.5194,-67.2114 561.8844,-65.9298 553.2297,-64.6454"/>
<polygon fill="#ff0000" stroke="#ff0000" points="553.4976,-61.1469 543.0921,-63.1409 552.4699,-68.0711 553.4976,-61.1469"/>
</g>
<!-- sourcefile~parallel.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~parallel.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/parallel.f90.html" xlink:title="parallel.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="519.5,-108 443.5,-108 443.5,-84 519.5,-84 519.5,-108"/>
<text text-anchor="middle" x="481.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">parallel.F90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_fields.f90&#45;&gt;sourcefile~parallel.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~grid_fields.f90&#45;&gt;sourcefile~parallel.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M578.6168,-81.5869C563.0591,-83.8958 545.5164,-86.4993 529.6639,-88.852"/>
<polygon fill="#ff0000" stroke="#ff0000" points="528.9063,-85.426 519.5284,-90.3562 529.9339,-92.3502 528.9063,-85.426"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="361,-108 286,-108 286,-84 361,-84 361,-108"/>
<text text-anchor="middle" x="323.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_field_param.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~grid_field_param.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M436.2235,-66.0355C415.7702,-71.4725 391.604,-77.8964 370.9033,-83.3991"/>
<polygon fill="#ff0000" stroke="#ff0000" points="369.8162,-80.0665 361.051,-86.0181 371.6146,-86.8315 369.8162,-80.0665"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="384,-66 263,-66 263,-42 384,-42 384,-66"/>
<text text-anchor="middle" x="323.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_field_param.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~grid_field_param.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M419.9607,-54C411.4908,-54 402.7391,-54 394.1219,-54"/>
<polygon fill="#ff0000" stroke="#ff0000" points="394.0928,-50.5001 384.0927,-54 394.0927,-57.5001 394.0928,-50.5001"/>
</g>
<!-- sourcefile~grid_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~grid_param.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/grid_param.f90.html" xlink:title="grid_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="370.5,-24 276.5,-24 276.5,0 370.5,0 370.5,-24"/>
<text text-anchor="middle" x="323.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_field_param.f90&#45;&gt;sourcefile~grid_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~grid_field_param.f90&#45;&gt;sourcefile~grid_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M436.2235,-41.9645C418.2907,-37.1975 397.5037,-31.6719 378.7007,-26.6736"/>
<polygon fill="#ff0000" stroke="#ff0000" points="379.3466,-23.2238 368.7831,-24.0373 377.5483,-29.9889 379.3466,-23.2238"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="350.5,-150 296.5,-150 296.5,-126 350.5,-126 350.5,-150"/>
<text text-anchor="middle" x="323.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M443.2526,-106.167C418.0479,-112.867 385.2219,-121.5929 360.3136,-128.2141"/>
<polygon fill="#00ffff" stroke="#00ffff" points="359.2749,-124.8686 350.5097,-130.8202 361.0732,-131.6337 359.2749,-124.8686"/>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M443.2526,-96C421.6311,-96 394.4013,-96 371.3723,-96"/>
<polygon fill="#00ffff" stroke="#00ffff" points="371.1223,-92.5001 361.1223,-96 371.1222,-99.5001 371.1223,-92.5001"/>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M443.2526,-85.833C423.8573,-80.6773 399.949,-74.3219 378.6084,-68.6491"/>
<polygon fill="#00ffff" stroke="#00ffff" points="379.2541,-65.1992 368.6905,-66.0127 377.4557,-71.9643 379.2541,-65.1992"/>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="225,-109 144,-109 144,-85 225,-85 225,-109"/>
<text text-anchor="middle" x="184.5" y="-94.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M296.3694,-129.9975C278.9089,-124.8472 255.6789,-117.9952 234.9133,-111.8701"/>
<polygon fill="#ff0000" stroke="#ff0000" points="235.8471,-108.4965 225.2654,-109.0243 233.8666,-115.2105 235.8471,-108.4965"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-88 0,-88 0,-64 106,-64 106,-88"/>
<text text-anchor="middle" x="53" y="-73.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M296.2127,-137.7824C260.2267,-136.8686 195.2349,-133.0395 142,-118 121.1907,-112.1211 99.2039,-101.7896 82.2901,-92.845"/>
<polygon fill="#ff0000" stroke="#ff0000" points="83.9145,-89.7444 73.4551,-88.0555 80.5784,-95.8983 83.9145,-89.7444"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M286.8661,-83.996C249.251,-71.9067 194.7917,-55.1473 184.5,-56"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M262.8614,-53.0783C238.4746,-53.1752 210.1154,-53.8778 184.5,-56"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="227,-27 142,-27 142,-3 227,-3 227,-27"/>
<text text-anchor="middle" x="184.5" y="-12.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M276.4409,-13.0157C263.8874,-13.2866 250.2396,-13.5812 237.3954,-13.8584"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="237.2253,-10.3611 227.3032,-14.0762 237.3764,-17.3595 237.2253,-10.3611"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M288.2611,-24.0546C250.64,-36.7794 195.0002,-55.1301 184.5,-56"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M184.5,-56C162.1494,-57.8517 137.8314,-61.1769 116.2554,-64.5911"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="115.5414,-61.1611 106.2294,-66.2144 116.6602,-68.0711 115.5414,-61.1611"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M158.5198,-27.0516C138.3478,-36.409 110.176,-49.4773 88.0149,-59.7573"/>
<polygon fill="#ff0000" stroke="#ff0000" points="86.5249,-56.5902 78.9262,-63.9734 89.4706,-62.9403 86.5249,-56.5902"/>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~grid_fields.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M143.9727,-90.528C135.2164,-89.1296 125.7567,-87.6189 116.3621,-86.1187"/>
<polygon fill="#00ff00" stroke="#00ff00" points="116.6567,-82.6214 106.2299,-84.5006 115.5528,-89.5339 116.6567,-82.6214"/>
</g>
</g>
</svg>
</div><script>var pansourcefilegrid_fieldsf90EfferentGraph = svgPanZoom('#sourcefilegrid_fieldsf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~grid_fields.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilegrid_fieldsf90AfferentGraph" width="641pt" height="175pt"
 viewBox="0.00 0.00 641.00 174.90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~grid_fields.f90~~AfferentGraph" class="graph" transform="scale(.8745 .8745) rotate(0) translate(4 196)">
<title>sourcefile~~grid_fields.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-196 729,-196 729,4 -4,4"/>
<!-- sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~grid_fields.f90</title>
<polygon fill="none" stroke="#000000" points="88,-149 0,-149 0,-125 88,-125 88,-149"/>
<text text-anchor="middle" x="44" y="-134.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">grid_fields.f90</text>
</g>
<!-- sourcefile~init_laser_field.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~init_laser_field.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/init_laser_field.f90.html" xlink:title="init_laser_field.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="233,-180 124,-180 124,-156 233,-156 233,-180"/>
<text text-anchor="middle" x="178.5" y="-165.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">init_laser_field.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_laser_field.f90&#45;&gt;sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~init_laser_field.f90&#45;&gt;sourcefile~grid_fields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M126.1137,-155.9258C116.9051,-153.8034 107.3052,-151.5908 98.0523,-149.4581"/>
<polygon fill="#ff0000" stroke="#ff0000" points="98.7136,-146.0189 88.1829,-147.1834 97.1414,-152.84 98.7136,-146.0189"/>
</g>
<!-- sourcefile~fluid_density_momenta.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~fluid_density_momenta.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/fluid_density_momenta.f90.html" xlink:title="fluid_density_momenta.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="426,-150 269,-150 269,-126 426,-126 426,-150"/>
<text text-anchor="middle" x="347.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fluid_density_momenta.f90</text>
</a>
</g>
</g>
<!-- sourcefile~fluid_density_momenta.f90&#45;&gt;sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~fluid_density_momenta.f90&#45;&gt;sourcefile~grid_fields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M302.2716,-125.9959C268.2145,-118.506 220.391,-111.2836 178.5,-117"/>
</g>
<!-- sourcefile~curr_and_fields_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~curr_and_fields_util.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/curr_and_fields_util.f90.html" xlink:title="curr_and_fields_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="415.5,-108 279.5,-108 279.5,-84 415.5,-84 415.5,-108"/>
<text text-anchor="middle" x="347.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">curr_and_fields_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~curr_and_fields_util.f90&#45;&gt;sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~curr_and_fields_util.f90&#45;&gt;sourcefile~grid_fields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M279.2013,-104.1088C248.4098,-107.8618 211.6027,-112.4828 178.5,-117"/>
</g>
<!-- sourcefile~psolve.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~psolve.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/psolve.f90.html" xlink:title="psolve.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="381,-66 314,-66 314,-42 381,-42 381,-66"/>
<text text-anchor="middle" x="347.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">psolve.f90</text>
</a>
</g>
</g>
<!-- sourcefile~psolve.f90&#45;&gt;sourcefile~grid_fields.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~psolve.f90&#45;&gt;sourcefile~grid_fields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M313.8744,-61.6342C299.8329,-65.1713 283.4559,-69.7567 269,-75 227.3147,-90.1196 222.4355,-111.0046 178.5,-117"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M178.5,-117C152.0978,-120.6028 122.83,-124.9167 98.3565,-128.6142"/>
<polygon fill="#ff0000" stroke="#ff0000" points="97.5457,-125.1971 88.1837,-130.1573 98.5955,-132.1179 97.5457,-125.1971"/>
</g>
<!-- sourcefile~pic_in.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node6" class="node">
<title>sourcefile~pic_in.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node6"><a xlink:href=".././sourcefile/pic_in.f90.html" xlink:title="pic_in.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="379.5,-192 315.5,-192 315.5,-168 379.5,-168 379.5,-192"/>
<text text-anchor="middle" x="347.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_in.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_in.f90&#45;&gt;sourcefile~init_laser_field.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~pic_in.f90&#45;&gt;sourcefile~init_laser_field.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M315.3146,-177.7146C294.945,-176.2683 267.8886,-174.3471 243.2163,-172.5952"/>
<polygon fill="#ff0000" stroke="#ff0000" points="243.4008,-169.0996 233.178,-171.8825 242.9049,-176.082 243.4008,-169.0996"/>
</g>
<!-- sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node7" class="node">
<title>sourcefile~pic_evolve_in_time.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node7"><a xlink:href=".././sourcefile/pic_evolve_in_time.f90.html" xlink:title="pic_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="604,-108 471,-108 471,-84 604,-84 604,-108"/>
<text text-anchor="middle" x="537.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~fluid_density_momenta.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge6" class="edge">
<title>sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~fluid_density_momenta.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M483.0536,-108.0355C460.8925,-112.9343 435.1069,-118.6343 412.0107,-123.7398"/>
<polygon fill="#7fff00" stroke="#7fff00" points="410.9631,-120.3867 401.9543,-125.9627 412.4741,-127.2217 410.9631,-120.3867"/>
</g>
<!-- sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~curr_and_fields_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge8" class="edge">
<title>sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~curr_and_fields_util.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M470.7803,-96C456.2716,-96 440.7947,-96 425.8816,-96"/>
<polygon fill="#00ffff" stroke="#00ffff" points="425.6662,-92.5001 415.6661,-96 425.6661,-99.5001 425.6662,-92.5001"/>
</g>
<!-- sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node8" class="node">
<title>sourcefile~env_evolve_in_time.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node8"><a xlink:href=".././sourcefile/env_evolve_in_time.f90.html" xlink:title="env_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="606,-150 469,-150 469,-126 606,-126 606,-150"/>
<text text-anchor="middle" x="537.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">env_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~fluid_density_momenta.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge7" class="edge">
<title>sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~fluid_density_momenta.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M468.9056,-138C458.3259,-138 447.2716,-138 436.327,-138"/>
<polygon fill="#7fff00" stroke="#7fff00" points="436.3235,-134.5001 426.3235,-138 436.3234,-141.5001 436.3235,-134.5001"/>
</g>
<!-- sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~curr_and_fields_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge9" class="edge">
<title>sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~curr_and_fields_util.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M483.0536,-125.9645C460.8925,-121.0657 435.1069,-115.3657 412.0107,-110.2602"/>
<polygon fill="#00ffff" stroke="#00ffff" points="412.4741,-106.7783 401.9543,-108.0373 410.9631,-113.6133 412.4741,-106.7783"/>
</g>
<!-- sourcefile~pic_out_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node9" class="node">
<title>sourcefile~pic_out_util.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node9"><a xlink:href=".././sourcefile/pic_out_util.f90.html" xlink:title="pic_out_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="584,-24 491,-24 491,0 584,0 584,-24"/>
<text text-anchor="middle" x="537.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_out_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out_util.f90&#45;&gt;sourcefile~psolve.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge10" class="edge">
<title>sourcefile~pic_out_util.f90&#45;&gt;sourcefile~psolve.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M490.5337,-22.382C460.1586,-29.0965 420.8927,-37.7763 391.1887,-44.3425"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="390.1198,-40.9942 381.111,-46.5702 391.6307,-47.8292 390.1198,-40.9942"/>
</g>
<!-- sourcefile~init_beam_part_distrib.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node10" class="node">
<title>sourcefile~init_beam_part_distrib.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node10"><a xlink:href=".././sourcefile/init_beam_part_distrib.f90.html" xlink:title="init_beam_part_distrib.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="613,-66 462,-66 462,-42 613,-42 613,-66"/>
<text text-anchor="middle" x="537.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">init_beam_part_distrib.f90</text>
</a>
</g>
</g>
<!-- sourcefile~init_beam_part_distrib.f90&#45;&gt;sourcefile~psolve.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge11" class="edge">
<title>sourcefile~init_beam_part_distrib.f90&#45;&gt;sourcefile~psolve.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M461.861,-54C437.9582,-54 412.3476,-54 391.4346,-54"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="391.2681,-50.5001 381.2681,-54 391.268,-57.5001 391.2681,-50.5001"/>
</g>
<!-- sourcefile~start_all.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node11" class="node">
<title>sourcefile~start_all.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node11"><a xlink:href=".././sourcefile/start_all.f90.html" xlink:title="start_all.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="576,-192 499,-192 499,-168 576,-168 576,-192"/>
<text text-anchor="middle" x="537.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">start_all.F90</text>
</a>
</g>
</g>
<!-- sourcefile~start_all.f90&#45;&gt;sourcefile~pic_in.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge12" class="edge">
<title>sourcefile~start_all.f90&#45;&gt;sourcefile~pic_in.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M498.5922,-180C466.9492,-180 422.3708,-180 389.8378,-180"/>
<polygon fill="#ff0000" stroke="#ff0000" points="389.7301,-176.5001 379.7301,-180 389.73,-183.5001 389.7301,-176.5001"/>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_node12" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~grid_fields.f90~~AfferentGraph_node12"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="725,-108 649,-108 649,-84 725,-84 725,-108"/>
<text text-anchor="middle" x="687" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge13" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M648.888,-96C638.2094,-96 626.2055,-96 614.136,-96"/>
<polygon fill="#cbff00" stroke="#cbff00" points="614.0099,-92.5001 604.0099,-96 614.0098,-99.5001 614.0099,-92.5001"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge14" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M648.9846,-106.8293C637.432,-110.1091 624.6996,-113.7128 613,-117 605.8053,-119.0214 598.2221,-121.1423 590.7483,-123.2267"/>
<polygon fill="#00ff66" stroke="#00ff66" points="589.7221,-119.8792 581.0283,-125.9346 591.6008,-126.6225 589.7221,-119.8792"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_out_util.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge15" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_out_util.f90</title>
<path fill="none" stroke="#0066ff" stroke-dasharray="5,2" d="M675.6533,-83.4988C662.0795,-69.2737 638.0332,-46.2973 613,-33 607.0261,-29.8268 600.5249,-27.094 593.9265,-24.7503"/>
<polygon fill="#0066ff" stroke="#0066ff" points="594.832,-21.3642 584.2396,-21.589 592.6602,-28.0188 594.832,-21.3642"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~init_beam_part_distrib.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge16" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~init_beam_part_distrib.f90</title>
<path fill="none" stroke="#cc00ff" stroke-dasharray="5,2" d="M648.9846,-85.1707C637.432,-81.8909 624.6996,-78.2872 613,-75 605.8053,-72.9786 598.2221,-70.8577 590.7483,-68.7733"/>
<polygon fill="#cc00ff" stroke="#cc00ff" points="591.6008,-65.3775 581.0283,-66.0654 589.7221,-72.1208 591.6008,-65.3775"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90 -->
<g id="sourcefile~~grid_fields.f90~~AfferentGraph_edge17" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M675.6533,-108.5012C662.0795,-122.7263 638.0332,-145.7027 613,-159 604.7057,-163.4058 595.3947,-166.9625 586.2185,-169.8077"/>
<polygon fill="#ff0000" stroke="#ff0000" points="585.0222,-166.5094 576.3687,-172.6222 586.9455,-173.24 585.0222,-166.5094"/>
</g>
</g>
</svg>
</div><script>var pansourcefilegrid_fieldsf90AfferentGraph = svgPanZoom('#sourcefilegrid_fieldsf90AfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/grid_fields.html">grid_fields</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/grid_fields.f90.html#src">grid_fields.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2020  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">grid_fields</span>
<a name="ln-23"></a>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">grid_field_param</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">parallel</span>
<a name="ln-26"></a>
<a name="ln-27"></a>  <span class="k">implicit none</span>
<a name="ln-28"></a><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">x_parity</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a name="ln-29"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">y_parity</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a name="ln-30"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">z_parity</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="ln-31"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="k">protected</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">COEFF_2</span>
<a name="ln-32"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="k">protected</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">COEFF_1</span>
<a name="ln-33"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">protected</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">COEFF_0</span>
<a name="ln-34"></a>
<a name="ln-35"></a> <span class="k">contains</span>
<a name="ln-36"></a>
<a name="ln-37"></a><span class="k">  subroutine </span><span class="n">trid_der1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">,</span> <span class="n">ord</span><span class="p">)</span>
<a name="ln-38"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span>
<a name="ln-39"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">,</span> <span class="n">ord</span>
<a name="ln-40"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-41"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">bet</span>
<a name="ln-42"></a>   <span class="c">!==========================</span>
<a name="ln-43"></a>   <span class="c">! Solves</span>
<a name="ln-44"></a>   <span class="c">! a*ww(i-1)+b*ww(i)+c*ww(i+1)=u(i), i=2,3,..,n-1</span>
<a name="ln-45"></a>   <span class="c">! at the first row b1*ww(1)+c1*ww(2)=u(1)</span>
<a name="ln-46"></a>   <span class="c">! at the n-last row an*ww(n-1)+bn*ww(n)=u(n)</span>
<a name="ln-47"></a>   <span class="c">! first order boundary clusure</span>
<a name="ln-48"></a>   <span class="c">!===============================</span>
<a name="ln-49"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-50"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-51"></a>     <span class="n">ww0</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">ww0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-52"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">ww0</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-53"></a>    <span class="k">end do</span>
<a name="ln-54"></a><span class="k">   end if</span>
<a name="ln-55"></a>   <span class="c">!===================</span>
<a name="ln-56"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-57"></a>    <span class="n">ww1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-58"></a>    <span class="n">bet</span> <span class="o">=</span> <span class="n">b1</span>
<a name="ln-59"></a>    <span class="n">ww0</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-60"></a>    <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-61"></a>    <span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-62"></a>    <span class="n">bet</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-63"></a>    <span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-64"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-65"></a>     <span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-66"></a>     <span class="n">bet</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-67"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-68"></a>    <span class="k">end do</span>
<a name="ln-69"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-70"></a>    <span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-71"></a>    <span class="n">bet</span> <span class="o">=</span> <span class="n">bn</span> <span class="o">-</span> <span class="n">an</span><span class="o">*</span><span class="n">ww1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-72"></a>    <span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">an</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span><span class="o">/</span><span class="n">bet</span>
<a name="ln-73"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-74"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">ww1</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-75"></a>    <span class="k">end do</span>
<a name="ln-76"></a><span class="k">   end do</span>
<a name="ln-77"></a><span class="k">  end subroutine</span>
<a name="ln-78"></a><span class="c">!=================================</span>
<a name="ln-79"></a>  <span class="k">subroutine </span><span class="n">unif_to_str_field_interp</span><span class="p">(</span><span class="n">unif_field</span><span class="p">,</span> <span class="n">str_field</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-80"></a>
<a name="ln-81"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">unif_field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-82"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">str_field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-83"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic</span>
<a name="ln-84"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shz</span><span class="p">,</span> <span class="n">shy2</span><span class="p">,</span> <span class="n">shz2</span>
<a name="ln-85"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-86"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">jsize</span><span class="p">,</span> <span class="n">ksize</span>
<a name="ln-87"></a>   <span class="c">!=======================================</span>
<a name="ln-88"></a>   <span class="n">jsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">unif_field</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-89"></a>   <span class="n">ksize</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">unif_field</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-90"></a><span class="c">!=====================</span>
<a name="ln-91"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
<a name="ln-92"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-93"></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-94"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-95"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-96"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">yft_ind</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-97"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="n">dy_inv</span><span class="o">*</span><span class="p">(</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span> <span class="o">-</span> <span class="n">loc_yft</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">imody</span><span class="p">))</span>
<a name="ln-98"></a>     <span class="n">shy2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shy</span><span class="o">*</span><span class="n">shy</span>
<a name="ln-99"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shy</span>
<a name="ln-100"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-101"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-102"></a>      <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-103"></a>                               <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">-</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-104"></a>                               <span class="n">shy2</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">+</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">))</span>
<a name="ln-105"></a>     <span class="k">end do</span>
<a name="ln-106"></a><span class="k">    end do</span>
<a name="ln-107"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-108"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-109"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">zft_ind</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-110"></a>     <span class="n">shz</span> <span class="o">=</span> <span class="n">dz_inv</span><span class="o">*</span><span class="p">(</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span> <span class="o">-</span> <span class="n">loc_zft</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">imodz</span><span class="p">))</span>
<a name="ln-111"></a>     <span class="n">shz2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shz</span><span class="o">*</span><span class="n">shz</span>
<a name="ln-112"></a>     <span class="n">shz</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shz</span>
<a name="ln-113"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-114"></a>      <span class="n">jj</span> <span class="o">=</span> <span class="n">yft_ind</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-115"></a>      <span class="n">shy</span> <span class="o">=</span> <span class="n">dy_inv</span><span class="o">*</span><span class="p">(</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span> <span class="o">-</span> <span class="n">loc_yft</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">imody</span><span class="p">))</span>
<a name="ln-116"></a>      <span class="n">shy2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shy</span><span class="o">*</span><span class="n">shy</span>
<a name="ln-117"></a>      <span class="n">shy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">shy</span>
<a name="ln-118"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-119"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-120"></a>       <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-121"></a>                                <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">-</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-122"></a>                                <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-123"></a>       <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-124"></a>                                <span class="n">shy2</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">+</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">))</span>
<a name="ln-125"></a>       <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">str_field</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-126"></a>                                <span class="n">shz2</span><span class="o">*</span><span class="p">(</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">unif_field</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">))</span>
<a name="ln-127"></a>      <span class="k">end do</span>
<a name="ln-128"></a><span class="k">     end do</span>
<a name="ln-129"></a><span class="k">    end do</span>
<a name="ln-130"></a><span class="k">   end select</span>
<a name="ln-131"></a>
<a name="ln-132"></a><span class="k">  end subroutine</span>
<a name="ln-133"></a>
<a name="ln-134"></a><span class="k">  subroutine </span><span class="n">enforce_continuity</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
<a name="ln-135"></a>
<a name="ln-136"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-137"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shz</span>
<a name="ln-138"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">j01</span><span class="p">,</span> <span class="n">k01</span>
<a name="ln-139"></a>   <span class="c">!===================== 3D Cartesian</span>
<a name="ln-140"></a>   <span class="c">!Solves DJ_x/Dx =-[DJ_y/Dy+DJ_z/Dz +[Rho^{n+1}-Rho^n]/Dt]=</span>
<a name="ln-141"></a>   <span class="c">! Eneter curr(1)= Drho, curr(2)=J_y*Dt  curr(3)= J_z*Dt</span>
<a name="ln-142"></a>   <span class="c">!=======================================</span>
<a name="ln-143"></a>   <span class="n">aphy</span> <span class="o">=</span> <span class="n">dy_inv</span>
<a name="ln-144"></a>   <span class="n">aphz</span> <span class="o">=</span> <span class="n">dz_inv</span>
<a name="ln-145"></a>   <span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-146"></a>   <span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-147"></a>   <span class="c">!shy(3)=Dxi/Dy centered on node y_j</span>
<a name="ln-148"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-149"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0y</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-150"></a><span class="k">    </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-151"></a>    <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-152"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-153"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-154"></a>      <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-155"></a>                                                                             <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-156"></a>     <span class="k">end do</span>
<a name="ln-157"></a><span class="k">    end do</span>
<a name="ln-158"></a><span class="k">    </span><span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-159"></a>   <span class="k">end if</span>
<a name="ln-160"></a><span class="k">   do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-161"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-162"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-163"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-164"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-165"></a>      <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-166"></a>                                                                         <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-167"></a>     <span class="k">end do</span>
<a name="ln-168"></a><span class="k">    end do</span>
<a name="ln-169"></a><span class="k">   end do</span>
<a name="ln-170"></a>   <span class="c">!================ ndim &gt;2</span>
<a name="ln-171"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-172"></a><span class="k">    if</span> <span class="p">(</span><span class="n">pe0z</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-173"></a><span class="k">     </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-174"></a>     <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">aphz</span>
<a name="ln-175"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-176"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-177"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="p">&amp;</span>
<a name="ln-178"></a>                                                                              <span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a name="ln-179"></a>      <span class="k">end do</span>
<a name="ln-180"></a><span class="k">     end do</span>
<a name="ln-181"></a><span class="k">     </span><span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-182"></a>    <span class="k">end if</span>
<a name="ln-183"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-184"></a>     <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">aphz</span>
<a name="ln-185"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-186"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-187"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="p">&amp;</span>
<a name="ln-188"></a>                                                                          <span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a name="ln-189"></a>      <span class="k">end do</span>
<a name="ln-190"></a><span class="k">     end do</span>
<a name="ln-191"></a><span class="k">    end do</span>
<a name="ln-192"></a><span class="k">   end if</span>
<a name="ln-193"></a>   <span class="c">!=============== 1D invertion of first derivative</span>
<a name="ln-194"></a>   <span class="n">ww0</span><span class="p">(:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-195"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-196"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-197"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix2</span><span class="p">,</span> <span class="n">ix1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-198"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-199"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-200"></a>     <span class="k">end do</span>
<a name="ln-201"></a><span class="k">     do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-202"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-203"></a>      <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-204"></a>     <span class="k">end do</span>
<a name="ln-205"></a><span class="k">    end do</span>
<a name="ln-206"></a><span class="k">   end do</span>
<a name="ln-207"></a>
<a name="ln-208"></a><span class="k">  end subroutine</span>
<a name="ln-209"></a>
<a name="ln-210"></a><span class="k">  subroutine </span><span class="n">field_xadvect</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">dth</span><span class="p">,</span> <span class="n">v_adv</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">,</span> <span class="n">isch</span><span class="p">)</span>
<a name="ln-211"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-212"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dth</span><span class="p">,</span> <span class="n">v_adv</span>
<a name="ln-213"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">,</span> <span class="n">isch</span>
<a name="ln-214"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">ind</span>
<a name="ln-215"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphx_exp</span><span class="p">,</span> <span class="n">aphx_impl</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span>
<a name="ln-216"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">RDER</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">]</span>
<a name="ln-217"></a>   <span class="c">!=====================</span>
<a name="ln-218"></a>   <span class="c">! APPLIES also for prlx=.true. (MPI x decomposition)</span>
<a name="ln-219"></a>   <span class="c">!=============================================</span>
<a name="ln-220"></a>   <span class="c">! Solves Df/Dt=-v_adv*Df/Dx    Df/Dx =[f_{i+1}-f_{i-1}]/(2Dx)</span>
<a name="ln-221"></a>   <span class="c">! forward advection for v_adv &gt; 0</span>
<a name="ln-222"></a>   <span class="c">! backward advection for v_adv &lt;0</span>
<a name="ln-223"></a>   <span class="c">! In comoving system in the Maxwell eqs. enters v_adv &lt;0</span>
<a name="ln-224"></a>   <span class="c">!==================</span>
<a name="ln-225"></a>   <span class="c">!Explicit first order advection scheme</span>
<a name="ln-226"></a>   <span class="c">!          E^{n+1}=(1-aphx_exp*D_x)E^n</span>
<a name="ln-227"></a>   <span class="c">!Semi-implicit advection scheme in x-coordinate</span>
<a name="ln-228"></a>   <span class="c">!          E^n+1=E^n-aphx_impl*[D_xE^n+D_xE^{n+1}]</span>
<a name="ln-229"></a>   <span class="c">!          (1+aphx_impl*D_x)E^{n+1}=(1-aphx_impl*D_x)E^n</span>
<a name="ln-230"></a>   <span class="c">!Fully-implicit advection scheme in x-coordinate</span>
<a name="ln-231"></a>   <span class="c">!          (1+aphx_exp*D_x)E^{n+1}=E^n</span>
<a name="ln-232"></a>   <span class="c">!================================</span>
<a name="ln-233"></a>   <span class="n">aphx</span> <span class="o">=</span> <span class="n">dth</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-234"></a>   <span class="n">aphx_exp</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">v_adv</span><span class="o">*</span><span class="n">aphx</span> <span class="c">!v_adv*dt/2Dx</span>
<a name="ln-235"></a>   <span class="n">aphx_impl</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">aphx_exp</span> <span class="c">!v_adv*(dt/2Dx)/2</span>
<a name="ln-236"></a>
<a name="ln-237"></a>   <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-238"></a>   <span class="n">b1</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-239"></a>   <span class="n">c1</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-240"></a>   <span class="n">bn</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-241"></a>   <span class="n">an</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-242"></a>   <span class="c">!bn = 1.-2.*aphx_adv</span>
<a name="ln-243"></a>   <span class="c">!cn = 2.*aphx_adv</span>
<a name="ln-244"></a>   <span class="c">!=====================</span>
<a name="ln-245"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-246"></a>   <span class="n">n1p</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-247"></a>   <span class="c">!=========================</span>
<a name="ln-248"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0x</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-249"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-250"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-251"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-252"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-253"></a>      <span class="k">end do</span>
<a name="ln-254"></a><span class="k">     end do</span>
<a name="ln-255"></a><span class="k">    end do</span>
<a name="ln-256"></a><span class="k">   end if</span>
<a name="ln-257"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe1x</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-258"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-259"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-260"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-261"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">n1p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">n1p</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-262"></a>      <span class="k">end do</span>
<a name="ln-263"></a><span class="k">     end do</span>
<a name="ln-264"></a><span class="k">    end do</span>
<a name="ln-265"></a><span class="k">   end if</span>
<a name="ln-266"></a>   <span class="c">!===============================</span>
<a name="ln-267"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">isch</span><span class="p">)</span>
<a name="ln-268"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c">!pure explicit</span>
<a name="ln-269"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-270"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-271"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-272"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-273"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-274"></a>        <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">aphx_exp</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="p">&amp;</span>
<a name="ln-275"></a>                                                                          <span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-276"></a>       <span class="k">end do</span>
<a name="ln-277"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-278"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-279"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-280"></a>       <span class="k">end do</span>
<a name="ln-281"></a><span class="k">      end do</span>
<a name="ln-282"></a><span class="k">     end do</span>
<a name="ln-283"></a><span class="k">    end do</span>
<a name="ln-284"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!semi-implicit</span>
<a name="ln-285"></a>    <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">aphx_impl</span>
<a name="ln-286"></a>    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-287"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>
<a name="ln-288"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-289"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-290"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-291"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-292"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-293"></a>        <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">aphx_impl</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-294"></a>                                                                           <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-295"></a>       <span class="k">end do</span>
<a name="ln-296"></a><span class="k">       call </span><span class="n">trid_der1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="ln-297"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-298"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-299"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-300"></a>       <span class="k">end do</span>
<a name="ln-301"></a><span class="k">      end do</span>
<a name="ln-302"></a><span class="k">     end do</span>
<a name="ln-303"></a><span class="k">    end do</span>
<a name="ln-304"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!fully implicit (1+aphx_exp)*Dx]ef=ef</span>
<a name="ln-305"></a>    <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">aphx_exp</span>
<a name="ln-306"></a>    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-307"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>
<a name="ln-308"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-309"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-310"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-311"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-312"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-313"></a>        <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-314"></a>       <span class="k">end do</span>
<a name="ln-315"></a><span class="k">       call </span><span class="n">trid_der1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="ln-316"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">n1p</span>
<a name="ln-317"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-318"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-319"></a>       <span class="k">end do</span>
<a name="ln-320"></a><span class="k">      end do</span>
<a name="ln-321"></a><span class="k">     end do</span>
<a name="ln-322"></a><span class="k">    end do</span>
<a name="ln-323"></a><span class="k">   end select</span>
<a name="ln-324"></a><span class="k">  end subroutine</span>
<a name="ln-325"></a>  <span class="c">!==================================</span>
<a name="ln-326"></a>  <span class="k">subroutine </span><span class="n">pp_lapl</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">)</span>
<a name="ln-327"></a>
<a name="ln-328"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">av</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-329"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">source</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-330"></a>
<a name="ln-331"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-332"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span><span class="p">,</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span><span class="p">,</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-333"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dy2_inv</span><span class="p">,</span> <span class="n">dz2_inv</span><span class="p">,</span> <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shz</span><span class="p">,</span> <span class="n">sphy</span><span class="p">,</span> <span class="n">smhy</span><span class="p">,</span> <span class="n">sphz</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-334"></a>               <span class="n">smhz</span>
<a name="ln-335"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dy4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dz4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-336"></a>   <span class="c">!==========================</span>
<a name="ln-337"></a>   <span class="c">! is=1 adds  is=-1 subtracts the laaplacian term</span>
<a name="ln-338"></a>   <span class="c">!==========================</span>
<a name="ln-339"></a>   <span class="n">dy2_inv</span> <span class="o">=</span> <span class="n">dy_inv</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-340"></a>   <span class="n">dz2_inv</span> <span class="o">=</span> <span class="n">dz_inv</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-341"></a>   <span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-342"></a>   <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">.</span><span class="mi">0</span>
<a name="ln-343"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-344"></a><span class="k">    </span><span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span> <span class="c">!1-8*hord_der2/3</span>
<a name="ln-345"></a>    <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.</span> <span class="c">!2*(2*hord_der2-1)</span>
<a name="ln-346"></a>   <span class="k">end if</span>
<a name="ln-347"></a><span class="k">   </span><span class="n">dy4_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dy2_inv</span>
<a name="ln-348"></a>   <span class="n">dy4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dy2_inv</span>
<a name="ln-349"></a>   <span class="n">dz4_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dz2_inv</span>
<a name="ln-350"></a>   <span class="n">dz4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dz2_inv</span>
<a name="ln-351"></a>   <span class="c">!===========================</span>
<a name="ln-352"></a>   <span class="c">!Second order derivative. At boundaries D^3[av]=0</span>
<a name="ln-353"></a>   <span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-354"></a>   <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-355"></a>   <span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-356"></a>   <span class="n">j02</span> <span class="o">=</span> <span class="n">jy2</span>
<a name="ln-357"></a>   <span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-358"></a>   <span class="n">k02</span> <span class="o">=</span> <span class="n">kz2</span>
<a name="ln-359"></a>
<a name="ln-360"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-361"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-362"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-363"></a>      <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-364"></a>      <span class="n">shy</span> <span class="o">=</span> <span class="n">dy4_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-365"></a>      <span class="n">sphy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-366"></a>      <span class="n">smhy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-367"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-368"></a>       <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">sphy</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-369"></a>                                                        <span class="n">smhy</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-370"></a>      <span class="k">end do</span>
<a name="ln-371"></a><span class="k">     end do</span>
<a name="ln-372"></a><span class="k">    end do</span>
<a name="ln-373"></a><span class="k">   end do</span>
<a name="ln-374"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-375"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-376"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-377"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-378"></a>       <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-379"></a>       <span class="n">shy</span> <span class="o">=</span> <span class="n">dy4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-380"></a>       <span class="n">sphy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-381"></a>       <span class="n">smhy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-382"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-383"></a>        <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">sphy</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-384"></a>                                                         <span class="n">smhy</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-385"></a>       <span class="k">end do</span>
<a name="ln-386"></a><span class="k">      end do</span>
<a name="ln-387"></a><span class="k">     end do</span>
<a name="ln-388"></a><span class="k">    end do</span>
<a name="ln-389"></a><span class="k">   end if</span>
<a name="ln-390"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-391"></a>   <span class="c">!====================</span>
<a name="ln-392"></a>
<a name="ln-393"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-394"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-395"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-396"></a>     <span class="n">shz</span> <span class="o">=</span> <span class="n">dz4_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-397"></a>     <span class="n">sphz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-398"></a>     <span class="n">smhz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-399"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-400"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-401"></a>       <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">sphz</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-402"></a>                                                        <span class="n">smhz</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-403"></a>      <span class="k">end do</span>
<a name="ln-404"></a><span class="k">     end do</span>
<a name="ln-405"></a><span class="k">    end do</span>
<a name="ln-406"></a><span class="k">   end do</span>
<a name="ln-407"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-408"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-409"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-410"></a>      <span class="n">jj</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-411"></a>      <span class="n">shz</span> <span class="o">=</span> <span class="n">dz4_inv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-412"></a>      <span class="n">sphz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-413"></a>      <span class="n">smhz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-414"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-415"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-416"></a>        <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">sphz</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-417"></a>                                                         <span class="n">smhz</span><span class="o">*</span><span class="p">(</span><span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-418"></a>       <span class="k">end do</span>
<a name="ln-419"></a><span class="k">      end do</span>
<a name="ln-420"></a><span class="k">     end do</span>
<a name="ln-421"></a><span class="k">    end do</span>
<a name="ln-422"></a><span class="k">   end if</span>
<a name="ln-423"></a>   <span class="c">!======================================</span>
<a name="ln-424"></a>  <span class="k">end subroutine</span>
<a name="ln-425"></a>  <span class="c">!========================</span>
<a name="ln-426"></a>  <span class="k">subroutine </span><span class="n">env_grad</span><span class="p">(</span><span class="n">envg</span><span class="p">)</span>
<a name="ln-427"></a>
<a name="ln-428"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">envg</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-429"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span><span class="p">,</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span><span class="p">,</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-430"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ay1</span><span class="p">,</span> <span class="n">ay2</span><span class="p">,</span> <span class="n">az1</span><span class="p">,</span> <span class="n">az2</span><span class="p">,</span> <span class="n">shz</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shp</span><span class="p">,</span> <span class="n">shm</span>
<a name="ln-431"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">a_hcd</span> <span class="o">=</span> <span class="mi">1</span><span class="mf">3.</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.</span><span class="p">,</span> <span class="n">b_hcd</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span>
<a name="ln-432"></a>   <span class="c">!=== second or fourth order central flux derivatives</span>
<a name="ln-433"></a>   <span class="c">!==========================</span>
<a name="ln-434"></a>   <span class="c">! Enters envg(1)= |A|^2/2 exit grad|A|^2/2</span>
<a name="ln-435"></a>
<a name="ln-436"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-437"></a><span class="k">    </span><span class="n">ax1</span> <span class="o">=</span> <span class="n">dx_inv</span>
<a name="ln-438"></a>    <span class="n">ay1</span> <span class="o">=</span> <span class="n">dy_inv</span>
<a name="ln-439"></a>    <span class="n">az1</span> <span class="o">=</span> <span class="n">dz_inv</span>
<a name="ln-440"></a>    <span class="n">ax2</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-441"></a>    <span class="n">ay2</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-442"></a>    <span class="n">az2</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-443"></a>   <span class="k">else</span>
<a name="ln-444"></a><span class="k">    </span><span class="n">ax1</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="n">a_hcd</span>
<a name="ln-445"></a>    <span class="n">ay1</span> <span class="o">=</span> <span class="n">dy_inv</span><span class="o">*</span><span class="n">a_hcd</span>
<a name="ln-446"></a>    <span class="n">az1</span> <span class="o">=</span> <span class="n">dz_inv</span><span class="o">*</span><span class="n">a_hcd</span>
<a name="ln-447"></a>    <span class="n">ax2</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="n">b_hcd</span>
<a name="ln-448"></a>    <span class="n">ay2</span> <span class="o">=</span> <span class="n">dy_inv</span><span class="o">*</span><span class="n">b_hcd</span>
<a name="ln-449"></a>    <span class="n">az2</span> <span class="o">=</span> <span class="n">dz_inv</span><span class="o">*</span><span class="n">b_hcd</span>
<a name="ln-450"></a>   <span class="k">end if</span>
<a name="ln-451"></a><span class="k">   </span><span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-452"></a>   <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-453"></a>   <span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-454"></a>   <span class="n">j02</span> <span class="o">=</span> <span class="n">jy2</span>
<a name="ln-455"></a>   <span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-456"></a>   <span class="n">k02</span> <span class="o">=</span> <span class="n">kz2</span>
<a name="ln-457"></a>   <span class="c">!================</span>
<a name="ln-458"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-459"></a><span class="k">    </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-460"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-461"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-462"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c">!at i+1/2</span>
<a name="ln-463"></a>     <span class="k">end do</span>
<a name="ln-464"></a><span class="k">    end do</span>
<a name="ln-465"></a><span class="k">    </span><span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-466"></a>   <span class="n">endif</span>
<a name="ln-467"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-468"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-469"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-470"></a>      <span class="n">i</span> <span class="o">=</span> <span class="n">ix2</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-471"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-472"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-473"></a>                                     <span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-474"></a>     <span class="k">end do</span>
<a name="ln-475"></a><span class="k">    end do</span>
<a name="ln-476"></a><span class="k">    </span><span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-477"></a>   <span class="n">endif</span>
<a name="ln-478"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-479"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-480"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-481"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c">!at i+1/2</span>
<a name="ln-482"></a>     <span class="k">end do</span>
<a name="ln-483"></a><span class="k">    end do</span>
<a name="ln-484"></a><span class="k">   end do</span>
<a name="ln-485"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-486"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-487"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-488"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-489"></a>       <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ax2</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-490"></a>                                                  <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-491"></a>      <span class="k">end do</span>
<a name="ln-492"></a><span class="k">     end do</span>
<a name="ln-493"></a><span class="k">    end do</span>
<a name="ln-494"></a><span class="k">   end if</span>
<a name="ln-495"></a><span class="k">   if</span> <span class="p">(</span><span class="n">yr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-496"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-497"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">jy2</span>
<a name="ln-498"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-499"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-500"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span> <span class="p">&amp;</span>
<a name="ln-501"></a>                                                                                   <span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-502"></a>     <span class="k">end do</span>
<a name="ln-503"></a><span class="k">     </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy2</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-504"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-505"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-506"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-507"></a>     <span class="k">end do</span>
<a name="ln-508"></a><span class="k">    end do</span>
<a name="ln-509"></a><span class="k">    </span><span class="n">j02</span> <span class="o">=</span> <span class="n">jy2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-510"></a>   <span class="k">end if</span>
<a name="ln-511"></a>   <span class="c">!===================</span>
<a name="ln-512"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">yl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-513"></a><span class="k">    </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-514"></a>    <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-515"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-516"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-517"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-518"></a>     <span class="k">end do</span>
<a name="ln-519"></a><span class="k">    end do</span>
<a name="ln-520"></a><span class="k">    </span><span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-521"></a>   <span class="k">end if</span>
<a name="ln-522"></a><span class="k">   do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-523"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-524"></a>     <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">ay1</span>
<a name="ln-525"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-526"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">shy</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-527"></a>     <span class="k">end do</span>
<a name="ln-528"></a><span class="k">    end do</span>
<a name="ln-529"></a><span class="k">   end do</span>
<a name="ln-530"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-531"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-532"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-533"></a>      <span class="n">shp</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">ay2</span>
<a name="ln-534"></a>      <span class="n">shm</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">ay2</span>
<a name="ln-535"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-536"></a>       <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">shp</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-537"></a>                          <span class="n">shm</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-538"></a>      <span class="k">end do</span>
<a name="ln-539"></a><span class="k">     end do</span>
<a name="ln-540"></a><span class="k">    end do</span>
<a name="ln-541"></a><span class="k">   end if</span>
<a name="ln-542"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-543"></a><span class="k">   if</span> <span class="p">(</span><span class="n">zr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-544"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz2</span>
<a name="ln-545"></a>    <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-546"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-547"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-548"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-549"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-550"></a>     <span class="k">end do</span>
<a name="ln-551"></a><span class="k">    end do</span>
<a name="ln-552"></a><span class="k">    </span><span class="n">k02</span> <span class="o">=</span> <span class="n">kz2</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-553"></a>   <span class="k">end if</span>
<a name="ln-554"></a><span class="k">   if</span> <span class="p">(</span><span class="n">zl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-555"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-556"></a>    <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-557"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-558"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-559"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-560"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-561"></a>     <span class="k">end do</span>
<a name="ln-562"></a><span class="k">    end do</span>
<a name="ln-563"></a><span class="k">    </span><span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-564"></a>   <span class="k">end if</span>
<a name="ln-565"></a>   <span class="c">!==================</span>
<a name="ln-566"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-567"></a>    <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">az1</span>
<a name="ln-568"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-569"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-570"></a>      <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">shz</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-571"></a>     <span class="k">end do</span>
<a name="ln-572"></a><span class="k">    end do</span>
<a name="ln-573"></a><span class="k">   end do</span>
<a name="ln-574"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-575"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-576"></a>     <span class="n">shp</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">az2</span>
<a name="ln-577"></a>     <span class="n">shm</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">az2</span>
<a name="ln-578"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-579"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-580"></a>       <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">shp</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-581"></a>                          <span class="n">shm</span><span class="o">*</span><span class="p">(</span><span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">envg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-582"></a>      <span class="k">end do</span>
<a name="ln-583"></a><span class="k">     end do</span>
<a name="ln-584"></a><span class="k">    end do</span>
<a name="ln-585"></a><span class="k">   end if</span>
<a name="ln-586"></a><span class="k">  end subroutine</span>
<a name="ln-587"></a>  <span class="c">!====================================</span>
<a name="ln-588"></a>  <span class="k">subroutine </span><span class="n">env_maxw_solve</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">evf</span><span class="p">,</span> <span class="n">om0</span><span class="p">,</span> <span class="n">dtl</span><span class="p">)</span>
<a name="ln-589"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">evf</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-590"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">om0</span><span class="p">,</span> <span class="n">dtl</span>
<a name="ln-591"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-592"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dt2</span><span class="p">,</span> <span class="n">dx1_inv</span><span class="p">,</span> <span class="n">dhx1_inv</span><span class="p">,</span> <span class="n">aph_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-593"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">kfact</span><span class="p">,</span> <span class="n">k2_fact</span><span class="p">,</span> <span class="n">skfact</span>
<a name="ln-594"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">LDER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
<a name="ln-595"></a>   <span class="c">!==========================</span>
<a name="ln-596"></a>   <span class="c">! EXPLICIT INTEGRATION of Maxwell ENVELOPE EVOLUTION EQUATION</span>
<a name="ln-597"></a>   <span class="c">! See: D.Terzani P. Londrillo &quot; A fast and accurate numerical</span>
<a name="ln-598"></a>   <span class="c">! implementation of the envelope model for laser–plasma dynamics &quot;</span>
<a name="ln-599"></a>   <span class="c">!         CPC 2019</span>
<a name="ln-600"></a>   <span class="c">!============================</span>
<a name="ln-601"></a>   <span class="n">dt2</span> <span class="o">=</span> <span class="n">dtl</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-602"></a>   <span class="c">!khfact=2.*sin(0.5*om0*dt_loc)/dt_loc</span>
<a name="ln-603"></a>   <span class="c">!kh2_fact=khfact*khfact</span>
<a name="ln-604"></a>   <span class="c">!khfact=2.*dhx*sin(0.5*om0*dx)</span>
<a name="ln-605"></a>   <span class="c">!kh2_sfact=khfact*khfact</span>
<a name="ln-606"></a>
<a name="ln-607"></a>   <span class="c">!kfact=sin(om0*dt_loc)</span>
<a name="ln-608"></a>   <span class="n">kfact</span> <span class="o">=</span> <span class="n">om0</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-609"></a>   <span class="n">k2_fact</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">kfact</span><span class="o">*</span><span class="n">kfact</span><span class="p">)</span>
<a name="ln-610"></a>   <span class="n">skfact</span> <span class="o">=</span> <span class="n">om0</span>
<a name="ln-611"></a>   <span class="c">!skfact=dhx*sin(om0*dx)</span>
<a name="ln-612"></a>   <span class="n">dx1_inv</span> <span class="o">=</span> <span class="n">skfact</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-613"></a>   <span class="n">dhx1_inv</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dx1_inv</span>
<a name="ln-614"></a>   <span class="n">aph_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-615"></a>   <span class="n">aph_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-616"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-617"></a><span class="k">    </span><span class="n">aph_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="n">opt_der1</span>
<a name="ln-618"></a>    <span class="n">aph_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">opt_der1</span><span class="p">)</span>
<a name="ln-619"></a>   <span class="k">end if</span>
<a name="ln-620"></a><span class="k">   </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-621"></a>   <span class="c">!========Enter  jc(1:2)= - omp2*&lt;q^2*chi*env(1:2)</span>
<a name="ln-622"></a>   <span class="c">!                        chi &lt;q^2*wgh*n/gam_p&gt; &gt;0</span>
<a name="ln-623"></a>   <span class="c">! Computes the full Laplacian of A^{n}=env(1:2) components</span>
<a name="ln-624"></a>   <span class="c">!========and adds to  jc(1:2)</span>
<a name="ln-625"></a>   <span class="k">call </span><span class="n">potential_lapl</span><span class="p">(</span><span class="n">evf</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-626"></a>   <span class="c">!=====================</span>
<a name="ln-627"></a>   <span class="c">! =&gt;   jc(1:2)=[D^2-omp^2*chi]A= S(A);</span>
<a name="ln-628"></a>   <span class="c">!=================</span>
<a name="ln-629"></a>   <span class="c">!  Computes D_{x} centered first derivatives of A and adds to S(A)</span>
<a name="ln-630"></a>   <span class="k">call </span><span class="n">first_ader</span>
<a name="ln-631"></a>   <span class="c">!S_R =&gt; S_R -2*k0[D_xA_I]</span>
<a name="ln-632"></a>   <span class="c">!S_I =&gt; S_I +2*k0[D_xA_R]</span>
<a name="ln-633"></a>   <span class="c">!</span>
<a name="ln-634"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-635"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-636"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-637"></a>      <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-638"></a>                         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">kfact</span><span class="o">*</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-639"></a>      <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-640"></a>                         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">kfact</span><span class="o">*</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-641"></a>     <span class="k">end do</span>
<a name="ln-642"></a><span class="k">    end do</span>
<a name="ln-643"></a><span class="k">   end do</span>
<a name="ln-644"></a>
<a name="ln-645"></a>   <span class="c">!====================</span>
<a name="ln-646"></a>   <span class="c">!curr(1)=F_R=dt2*S_R+2*A_R^n-A_R^{n-1}-kfact*A_I^{n-1}</span>
<a name="ln-647"></a>   <span class="c">!curr(2)=F_I=dt2*S_I+2*A_I^n-A_I^{n-1}+kfact*A_R^{n-1}</span>
<a name="ln-648"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-649"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-650"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-651"></a>      <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">!A^{n}=&gt; A^{n-1}</span>
<a name="ln-652"></a>      <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-653"></a>      <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">k2_fact</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">kfact</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-654"></a>      <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">k2_fact</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">kfact</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-655"></a>     <span class="k">end do</span>
<a name="ln-656"></a><span class="k">    end do</span>
<a name="ln-657"></a><span class="k">   end do</span>
<a name="ln-658"></a><span class="k">  contains</span>
<a name="ln-659"></a><span class="k">   subroutine </span><span class="n">first_ader</span>
<a name="ln-660"></a>    <span class="c">!============</span>
<a name="ln-661"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-662"></a>    <span class="c">! explicit second order [-2isin(k0dx)*Dx]A and add to S(A)</span>
<a name="ln-663"></a>    <span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-664"></a>    <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-665"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-666"></a><span class="k">     do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-667"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-668"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-669"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-670"></a>                                                       <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-671"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-672"></a>                                                       <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-673"></a>       <span class="k">end do</span>
<a name="ln-674"></a><span class="k">      end do</span>
<a name="ln-675"></a><span class="k">     end do</span>
<a name="ln-676"></a><span class="k">    else</span>
<a name="ln-677"></a><span class="k">     do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-678"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-679"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-680"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">aph_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-681"></a>                                                          <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-682"></a>                           <span class="n">aph_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-683"></a>                                       <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-684"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">aph_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-685"></a>                                                          <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-686"></a>                           <span class="n">aph_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-687"></a>                                       <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-688"></a>       <span class="k">end do</span>
<a name="ln-689"></a><span class="k">      end do</span>
<a name="ln-690"></a><span class="k">     end do</span>
<a name="ln-691"></a><span class="k">    end if</span>
<a name="ln-692"></a><span class="k">   end subroutine</span>
<a name="ln-693"></a>
<a name="ln-694"></a><span class="k">  end subroutine</span>
<a name="ln-695"></a>  <span class="c">!==================================</span>
<a name="ln-696"></a>  <span class="k">subroutine </span><span class="n">env_lpf_solve</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">evf</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">om0</span><span class="p">,</span> <span class="n">dtl</span><span class="p">)</span>
<a name="ln-697"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">curr</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">evf</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-698"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ib</span>
<a name="ln-699"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">om0</span><span class="p">,</span> <span class="n">dtl</span>
<a name="ln-700"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">n1</span>
<a name="ln-701"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dhx</span><span class="p">,</span> <span class="n">dx1_inv</span><span class="p">,</span> <span class="n">om2</span><span class="p">,</span> <span class="n">aph1</span><span class="p">,</span> <span class="n">dx_norm</span><span class="p">,</span> <span class="n">dx2_norm</span>
<a name="ln-702"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">adv</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">der2_norm</span>
<a name="ln-703"></a>   <span class="c">!==========================</span>
<a name="ln-704"></a>   <span class="c">! EXPLICIT INTEGRATION of REDUCED ENVELOPE FIELD SOLVER</span>
<a name="ln-705"></a>   <span class="c">!============================</span>
<a name="ln-706"></a>   <span class="c">! Fourth order first derivative</span>
<a name="ln-707"></a>   <span class="c">! D_xu= 2/3[u_{i+1}-u_{i-1}]- [u_{i+2}-u_{i-2}]/12</span>
<a name="ln-708"></a>   <span class="c">!====================</span>
<a name="ln-709"></a>   <span class="n">dhx</span> <span class="o">=</span> <span class="n">dx_inv</span>
<a name="ln-710"></a>   <span class="n">om2</span> <span class="o">=</span> <span class="n">om0</span><span class="o">*</span><span class="n">om0</span>
<a name="ln-711"></a>   <span class="n">dx1_inv</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-712"></a>   <span class="n">aph1</span> <span class="o">=</span> <span class="n">dx1_inv</span>
<a name="ln-713"></a>   <span class="n">n1</span> <span class="o">=</span> <span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ix1</span>
<a name="ln-714"></a>   <span class="n">dx_norm</span> <span class="o">=</span> <span class="n">dhx</span><span class="o">/</span><span class="n">om0</span>
<a name="ln-715"></a>   <span class="n">dx2_norm</span> <span class="o">=</span> <span class="n">dx_norm</span><span class="o">*</span><span class="n">dx_norm</span>
<a name="ln-716"></a>   <span class="n">der2_norm</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">dx2_norm</span>
<a name="ln-717"></a>   <span class="c">!========Enter  jc(1:2)= -om2*&lt;q^2*chi*env(1:2)</span>
<a name="ln-718"></a>   <span class="c">!        chi &lt;q^2*wgh*n/gam_p&gt; &gt;0</span>
<a name="ln-719"></a>   <span class="c">! Computes the transverse Laplacian of A^{n}=env(1:2) components</span>
<a name="ln-720"></a>   <span class="c">!========and adds to jc(1:2)</span>
<a name="ln-721"></a>   <span class="n">ic</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-722"></a>   <span class="k">call </span><span class="n">pp_lapl</span><span class="p">(</span><span class="n">evf</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-723"></a>   <span class="c">!=====================</span>
<a name="ln-724"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-725"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-726"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy1</span>
<a name="ln-727"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-728"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">dtl</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-729"></a>      <span class="k">end do</span>
<a name="ln-730"></a><span class="k">     end do</span>
<a name="ln-731"></a><span class="k">    end do</span>
<a name="ln-732"></a><span class="k">   end do</span>
<a name="ln-733"></a>   <span class="c">!=======================================================</span>
<a name="ln-734"></a>   <span class="c">! =&gt;   jc(1:2)=2*Delta t*S(A)=-dt*[D^2_{pp}-omp^2*chi]A;</span>
<a name="ln-735"></a>   <span class="c">!=================</span>
<a name="ln-736"></a>   <span class="c">!  Computes D_{xi} centered first derivatives of S(A)</span>
<a name="ln-737"></a>   <span class="c">!      ww0(1)= k0*S(A_I) + D_xi[A_R]= F_R</span>
<a name="ln-738"></a>   <span class="c">!      ww0(2)= -k0*S(A_R) + D_xi[A_I]= F_I</span>
<a name="ln-739"></a>   <span class="c">!====================</span>
<a name="ln-740"></a>   <span class="k">call </span><span class="n">first_der</span>
<a name="ln-741"></a>   <span class="c">!curr(1)=F^R</span>
<a name="ln-742"></a>   <span class="c">!curr(2)=F^I</span>
<a name="ln-743"></a>   <span class="c">!==================</span>
<a name="ln-744"></a>   <span class="c">! The M operator M=[k0*k0+D_xD_x]X = F   X=DA/Dtau</span>
<a name="ln-745"></a>
<a name="ln-746"></a>   <span class="c">!   Explicit inversion</span>
<a name="ln-747"></a>   <span class="c">!M^{-1}=([1-Dx_norm^2]F)/k0*k0</span>
<a name="ln-748"></a>   <span class="c">!===============</span>
<a name="ln-749"></a>   <span class="k">call </span><span class="n">explicit_mat_inv</span>
<a name="ln-750"></a>   <span class="c">!curr=M^{-1}F</span>
<a name="ln-751"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ib</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed coordinate system (x,t)</span>
<a name="ln-752"></a>    <span class="c">!=======================</span>
<a name="ln-753"></a>    <span class="c">!(1+Dt*D_x)A^{n+1}=(1-Dt*D_x)A^{n-1}+ M^{-1}F</span>
<a name="ln-754"></a>    <span class="c">!==================================</span>
<a name="ln-755"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="c">!ib=der-1</span>
<a name="ln-756"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-757"></a>     <span class="c">!================= Explicit second order</span>
<a name="ln-758"></a>     <span class="n">adv</span> <span class="o">=</span> <span class="n">dtl</span><span class="o">*</span><span class="n">dhx</span> <span class="c">!cfl=dt/dx</span>
<a name="ln-759"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-760"></a>      <span class="n">ic1</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-761"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-762"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-763"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-764"></a>         <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-765"></a>                             <span class="n">adv</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-766"></a>        <span class="k">end do</span>
<a name="ln-767"></a><span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-768"></a>         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="o">=</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-769"></a>         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-770"></a>        <span class="k">end do</span>
<a name="ln-771"></a><span class="k">       end do</span>
<a name="ln-772"></a><span class="k">      end do</span>
<a name="ln-773"></a><span class="k">     end do</span>
<a name="ln-774"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Explicit  optimized</span>
<a name="ln-775"></a>     <span class="c">!=======================</span>
<a name="ln-776"></a>     <span class="c">! u^{n+1}=u^{n-1}+adv*(u_{i+1}-u_{i-1})+0.5*adv*(</span>
<a name="ln-777"></a>     <span class="c">!adv=dt_loc*dhx     !cfl=dt/dx</span>
<a name="ln-778"></a>     <span class="c">!========================================</span>
<a name="ln-779"></a>     <span class="n">adv</span> <span class="o">=</span> <span class="n">dtl</span><span class="o">*</span><span class="n">dhx</span>
<a name="ln-780"></a>     <span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="n">adv</span><span class="o">*</span><span class="n">adv</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span>
<a name="ln-781"></a>     <span class="n">bn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">adv</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">an</span><span class="p">)</span>
<a name="ln-782"></a>     <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="o">*</span><span class="n">adv</span>
<a name="ln-783"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-784"></a>      <span class="n">ic1</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-785"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-786"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-787"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-788"></a>         <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-789"></a>                             <span class="n">an</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-790"></a>                             <span class="n">bn</span><span class="o">*</span><span class="p">(</span><span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-791"></a>        <span class="k">end do</span>
<a name="ln-792"></a><span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-793"></a>         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="o">=</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-794"></a>         <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-795"></a>        <span class="k">end do</span>
<a name="ln-796"></a><span class="k">       end do</span>
<a name="ln-797"></a><span class="k">      end do</span>
<a name="ln-798"></a><span class="k">     end do</span>
<a name="ln-799"></a><span class="k">    end select</span>
<a name="ln-800"></a><span class="k">   else</span> <span class="c">!ib=0 comoving coordinate system</span>
<a name="ln-801"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-802"></a>     <span class="n">ic1</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-803"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-804"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-805"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-806"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="c">!Curr=A^{n-1}+curr</span>
<a name="ln-807"></a>        <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic1</span><span class="p">)</span> <span class="o">=</span> <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="c">!A^{n-1}=&gt; A^n</span>
<a name="ln-808"></a>        <span class="n">evf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="c">!A^{n+1}=curr</span>
<a name="ln-809"></a>       <span class="k">end do</span>
<a name="ln-810"></a><span class="k">      end do</span>
<a name="ln-811"></a><span class="k">     end do</span>
<a name="ln-812"></a><span class="k">    end do</span>
<a name="ln-813"></a><span class="k">   end if</span>
<a name="ln-814"></a><span class="k">  contains</span>
<a name="ln-815"></a><span class="k">   subroutine </span><span class="n">first_der</span>
<a name="ln-816"></a>    <span class="c">!============</span>
<a name="ln-817"></a>    <span class="c">! explicit second order</span>
<a name="ln-818"></a>
<a name="ln-819"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-820"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-821"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-822"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-823"></a>       <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">om0</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">curr</span> <span class="p">&amp;</span>
<a name="ln-824"></a>                                                    <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-825"></a>       <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">om0</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx1_inv</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-826"></a>                                                     <span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-827"></a>      <span class="k">end do</span>
<a name="ln-828"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-829"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-830"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-831"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-832"></a>      <span class="k">end do</span>
<a name="ln-833"></a><span class="k">     end do</span>
<a name="ln-834"></a><span class="k">    end do</span>
<a name="ln-835"></a><span class="k">   end subroutine</span>
<a name="ln-836"></a>
<a name="ln-837"></a>   <span class="c">!============================</span>
<a name="ln-838"></a>   <span class="k">subroutine </span><span class="n">explicit_mat_inv</span>
<a name="ln-839"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">iic</span>
<a name="ln-840"></a>    <span class="c">!================== Uses three-point numerical secon derivative</span>
<a name="ln-841"></a>    <span class="k">do </span><span class="n">iic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<a name="ln-842"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-843"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-844"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-845"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-846"></a>        <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx2_norm</span><span class="o">*</span><span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">+</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span> <span class="p">&amp;</span>
<a name="ln-847"></a>                                                                                     <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-848"></a>       <span class="k">end do</span>
<a name="ln-849"></a><span class="k">       do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-850"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-851"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">om2</span>
<a name="ln-852"></a>       <span class="k">end do</span>
<a name="ln-853"></a><span class="k">      end do</span>
<a name="ln-854"></a><span class="k">     end do</span>
<a name="ln-855"></a><span class="k">    end do</span>
<a name="ln-856"></a><span class="k">   end subroutine</span>
<a name="ln-857"></a>   <span class="c">!=======================</span>
<a name="ln-858"></a>  <span class="k">end subroutine</span>
<a name="ln-859"></a>  <span class="c">!========================</span>
<a name="ln-860"></a>  <span class="c">! END ENV SECTION</span>
<a name="ln-861"></a>  <span class="c">!========== LASER FIELDS SECTION</span>
<a name="ln-862"></a>  <span class="c">!            (E,B) BC in open boundaries (lowest order Yee method</span>
<a name="ln-863"></a>  <span class="c">!==========================================</span>
<a name="ln-864"></a>  <span class="k">subroutine </span><span class="n">env_bds</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">ptrght</span><span class="p">,</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">init_ic</span><span class="p">,</span> <span class="n">end_ic</span><span class="p">)</span>
<a name="ln-865"></a>   <span class="c">!! Boundary conditions for the envelope field.</span>
<a name="ln-866"></a>   <span class="c">!! Empirically set to be continuous with continuous first derivative.</span>
<a name="ln-867"></a>
<a name="ln-868"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-869"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">ptrght</span>
<a name="ln-870"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">init_ic</span><span class="p">,</span> <span class="n">end_ic</span>
<a name="ln-871"></a>
<a name="ln-872"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shz</span><span class="p">,</span> <span class="n">smy</span><span class="p">,</span> <span class="n">smz</span><span class="p">,</span> <span class="n">alpha</span>
<a name="ln-873"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">point</span>
<a name="ln-874"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-875"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="kd">::</span> <span class="n">COEFF</span>
<a name="ln-876"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">stenc</span>
<a name="ln-877"></a>
<a name="ln-878"></a>   <span class="n">COEFF_2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a name="ln-879"></a>   <span class="n">COEFF_2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a name="ln-880"></a>   <span class="n">COEFF_1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="ln-881"></a>   <span class="n">COEFF_1</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a name="ln-882"></a>   <span class="n">COEFF_0</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-883"></a>   <span class="n">COEFF_0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-884"></a>
<a name="ln-885"></a>   <span class="n">comp1</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-886"></a>   <span class="n">comp2</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-887"></a>
<a name="ln-888"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">init_ic</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-889"></a><span class="k">    </span><span class="n">comp1</span> <span class="o">=</span> <span class="n">init_ic</span>
<a name="ln-890"></a>   <span class="n">endif</span>
<a name="ln-891"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">end_ic</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-892"></a><span class="k">    </span><span class="n">comp2</span> <span class="o">=</span> <span class="n">end_ic</span>
<a name="ln-893"></a>   <span class="n">endif</span>
<a name="ln-894"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-895"></a>   <span class="n">j2</span> <span class="o">=</span> <span class="n">jy2</span>
<a name="ln-896"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-897"></a>   <span class="n">k2</span> <span class="o">=</span> <span class="n">kz2</span>
<a name="ln-898"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-899"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-900"></a>
<a name="ln-901"></a>   <span class="n">shx</span> <span class="o">=</span> <span class="n">dx_inv</span>
<a name="ln-902"></a>   <span class="n">stenc</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-903"></a>   <span class="n">COEFF</span> <span class="o">=</span> <span class="nb">TRANSPOSE</span><span class="p">(</span><span class="n">COEFF_0</span><span class="p">)</span>
<a name="ln-904"></a>
<a name="ln-905"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-906"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-907"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-908"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-909"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-910"></a>        <span class="k">do </span><span class="n">point</span> <span class="o">=</span> <span class="n">ptlft</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-911"></a>         <span class="n">i</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">-</span> <span class="n">point</span>
<a name="ln-912"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">COEFF</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">stenc</span><span class="p">,</span> <span class="n">point</span><span class="p">),</span> <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:(</span><span class="n">i1</span> <span class="o">+</span> <span class="n">stenc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-913"></a>        <span class="k">end do</span>
<a name="ln-914"></a><span class="k">       end do</span>
<a name="ln-915"></a><span class="k">      end do</span>
<a name="ln-916"></a><span class="k">     end do</span>
<a name="ln-917"></a><span class="k">    end if</span>
<a name="ln-918"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-919"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-920"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-921"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-922"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">-</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">i1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-923"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i1</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-924"></a>        <span class="k">end do</span>
<a name="ln-925"></a><span class="k">       end do</span>
<a name="ln-926"></a><span class="k">      end do</span>
<a name="ln-927"></a><span class="k">     end do</span>
<a name="ln-928"></a><span class="k">    end if</span>
<a name="ln-929"></a><span class="k">    </span><span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">-</span> <span class="n">ptlft</span>
<a name="ln-930"></a>   <span class="k">end if</span>
<a name="ln-931"></a>
<a name="ln-932"></a><span class="k">   if</span> <span class="p">(</span><span class="n">xr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-933"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-934"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-935"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-936"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-937"></a>        <span class="k">do </span><span class="n">point</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ptrght</span>
<a name="ln-938"></a>         <span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">point</span>
<a name="ln-939"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">COEFF</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">stenc</span><span class="p">,</span> <span class="n">point</span><span class="p">),</span> <span class="n">ef</span><span class="p">(</span><span class="n">i2</span><span class="p">:(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">stenc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-940"></a>        <span class="k">end do</span>
<a name="ln-941"></a><span class="k">       end do</span>
<a name="ln-942"></a><span class="k">      end do</span>
<a name="ln-943"></a><span class="k">     end do</span>
<a name="ln-944"></a><span class="k">    end if</span>
<a name="ln-945"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-946"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-947"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-948"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-949"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-950"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">x_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i2</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-951"></a>        <span class="k">end do</span>
<a name="ln-952"></a><span class="k">       end do</span>
<a name="ln-953"></a><span class="k">      end do</span>
<a name="ln-954"></a><span class="k">     end do</span>
<a name="ln-955"></a><span class="k">    end if</span>
<a name="ln-956"></a><span class="k">    </span><span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-957"></a>   <span class="k">end if</span>
<a name="ln-958"></a>
<a name="ln-959"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-960"></a>
<a name="ln-961"></a><span class="k">   if</span> <span class="p">(</span><span class="n">yl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-962"></a><span class="k">    if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-963"></a><span class="k">     do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">-</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">j1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-964"></a>      <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-965"></a>      <span class="n">smy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-966"></a>      <span class="n">alpha</span> <span class="o">=</span> <span class="n">shy</span><span class="o">/</span><span class="n">smy</span>
<a name="ln-967"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-968"></a>                                                <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-969"></a>                                         <span class="mi">2</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-970"></a>                                         <span class="mi">3</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span>
<a name="ln-971"></a>     <span class="k">end do</span>
<a name="ln-972"></a><span class="k">    end if</span>
<a name="ln-973"></a><span class="k">    if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-974"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-975"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-976"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">-</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">j1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-977"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-978"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">y_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">j1</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-979"></a>        <span class="k">end do</span>
<a name="ln-980"></a><span class="k">       end do</span>
<a name="ln-981"></a><span class="k">      end do</span>
<a name="ln-982"></a><span class="k">     end do</span>
<a name="ln-983"></a><span class="k">    end if</span>
<a name="ln-984"></a><span class="k">    </span><span class="n">j1</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">-</span> <span class="n">ptlft</span>
<a name="ln-985"></a>   <span class="k">end if</span>
<a name="ln-986"></a>
<a name="ln-987"></a><span class="k">   if</span> <span class="p">(</span><span class="n">yr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-988"></a><span class="k">    if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-989"></a><span class="k">     do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-990"></a>      <span class="n">shy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-991"></a>      <span class="n">smy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-992"></a>      <span class="n">alpha</span> <span class="o">=</span> <span class="n">shy</span><span class="o">/</span><span class="n">smy</span>
<a name="ln-993"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-994"></a>                                                <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-995"></a>                                         <span class="mi">2</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-996"></a>                                         <span class="mi">3</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span>
<a name="ln-997"></a>     <span class="k">end do</span>
<a name="ln-998"></a><span class="k">    end if</span>
<a name="ln-999"></a><span class="k">    if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1000"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-1001"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span>
<a name="ln-1002"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-1003"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-1004"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">y_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">j2</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1005"></a>        <span class="k">end do</span>
<a name="ln-1006"></a><span class="k">       end do</span>
<a name="ln-1007"></a><span class="k">      end do</span>
<a name="ln-1008"></a><span class="k">     end do</span>
<a name="ln-1009"></a><span class="k">    end if</span>
<a name="ln-1010"></a><span class="k">    </span><span class="n">j2</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-1011"></a>   <span class="k">end if</span>
<a name="ln-1012"></a>
<a name="ln-1013"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1014"></a>
<a name="ln-1015"></a><span class="k">   if</span> <span class="p">(</span><span class="n">zl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1016"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1017"></a><span class="k">     do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">-</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">k1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1018"></a>      <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1019"></a>      <span class="n">smz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1020"></a>      <span class="n">alpha</span> <span class="o">=</span> <span class="n">shz</span><span class="o">/</span><span class="n">smz</span>
<a name="ln-1021"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1022"></a>                                                <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1023"></a>                                         <span class="mi">2</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1024"></a>                                         <span class="mi">3</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span>
<a name="ln-1025"></a>     <span class="k">end do</span>
<a name="ln-1026"></a><span class="k">    end if</span>
<a name="ln-1027"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1028"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-1029"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">-</span> <span class="n">ptlft</span><span class="p">,</span> <span class="n">k1</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1030"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-1031"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-1032"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">z_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">k1</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1033"></a>        <span class="k">end do</span>
<a name="ln-1034"></a><span class="k">       end do</span>
<a name="ln-1035"></a><span class="k">      end do</span>
<a name="ln-1036"></a><span class="k">     end do</span>
<a name="ln-1037"></a><span class="k">    end if</span>
<a name="ln-1038"></a><span class="k">    </span><span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">-</span> <span class="n">ptlft</span>
<a name="ln-1039"></a>   <span class="k">end if</span>
<a name="ln-1040"></a>
<a name="ln-1041"></a><span class="k">   if</span> <span class="p">(</span><span class="n">zr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1042"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1043"></a><span class="k">     do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-1044"></a>      <span class="n">shz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1045"></a>      <span class="n">smz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1046"></a>      <span class="n">alpha</span> <span class="o">=</span> <span class="n">shz</span><span class="o">/</span><span class="n">smz</span>
<a name="ln-1047"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1048"></a>                                                <span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1049"></a>                                         <span class="mi">2</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1050"></a>                                         <span class="mi">3</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">comp1</span><span class="p">:</span><span class="n">comp2</span><span class="p">)</span>
<a name="ln-1051"></a>     <span class="k">end do</span>
<a name="ln-1052"></a><span class="k">    end if</span>
<a name="ln-1053"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1054"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span>
<a name="ln-1055"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-1056"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span>
<a name="ln-1057"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-1058"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">z_parity</span><span class="p">(</span><span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">k2</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1059"></a>        <span class="k">end do</span>
<a name="ln-1060"></a><span class="k">       end do</span>
<a name="ln-1061"></a><span class="k">      end do</span>
<a name="ln-1062"></a><span class="k">     end do</span>
<a name="ln-1063"></a><span class="k">    end if</span>
<a name="ln-1064"></a><span class="k">    </span><span class="n">k2</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="n">ptrght</span>
<a name="ln-1065"></a>   <span class="k">end if</span>
<a name="ln-1066"></a>
<a name="ln-1067"></a><span class="k">  end subroutine</span>
<a name="ln-1068"></a>
<a name="ln-1069"></a><span class="k">  subroutine </span><span class="n">bf_bds</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">dtl</span><span class="p">,</span> <span class="n">imbd</span><span class="p">)</span>
<a name="ln-1070"></a>
<a name="ln-1071"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1072"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">imbd</span>
<a name="ln-1073"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dtl</span>
<a name="ln-1074"></a>
<a name="ln-1075"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-1076"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span>
<a name="ln-1077"></a>
<a name="ln-1078"></a>   <span class="c">!=================</span>
<a name="ln-1079"></a>   <span class="c">! Enter bf(4:6)=[Bx,By,Bz]</span>
<a name="ln-1080"></a>   <span class="c">!============================</span>
<a name="ln-1081"></a>   <span class="c">!========= Engquist-Majda ABC (=&gt;&gt; Mur) =====================</span>
<a name="ln-1082"></a>   <span class="c">!===============</span>
<a name="ln-1083"></a>   <span class="c">! Ey+Bz are right-moving</span>
<a name="ln-1084"></a>   <span class="c">!at x=0 minim. reflection (d/dt-d/dx)^{p-1}(Ey+Bz)=0</span>
<a name="ln-1085"></a>   <span class="c">! first order p=1 Bz=-Ey at x=0 and equal time</span>
<a name="ln-1086"></a>   <span class="c">! Ey-Bz are left-moving</span>
<a name="ln-1087"></a>   <span class="c">!at x=L minim. reflection (d/dt+d/dx)^{p-1}(Ey-Bz)=0</span>
<a name="ln-1088"></a>   <span class="c">! first order p=1 Bz=Ey at x=L and equal time</span>
<a name="ln-1089"></a>   <span class="c">!============================</span>
<a name="ln-1090"></a>   <span class="c">! B[i1,n1p]=&gt; extended to [i1-1,n1p]</span>
<a name="ln-1091"></a>   <span class="c">! boundaries for E_t=rotB</span>
<a name="ln-1092"></a>   <span class="c">!========================</span>
<a name="ln-1093"></a>   <span class="c">! aphx centered as Ey at ii=1</span>
<a name="ln-1094"></a>   <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1095"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1096"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1097"></a><span class="k">     </span><span class="n">aphx</span> <span class="o">=</span> <span class="n">loc_xg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span><span class="o">*</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1098"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1099"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1100"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">ix1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphx</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="p">&amp;</span>
<a name="ln-1101"></a>                                                                        <span class="p">,</span> <span class="n">nfield</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphx</span><span class="p">)</span>
<a name="ln-1102"></a>      <span class="k">end do</span>
<a name="ln-1103"></a><span class="k">     end do</span>
<a name="ln-1104"></a><span class="k">     if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1105"></a>      <span class="c">!==========================</span>
<a name="ln-1106"></a>      <span class="c">!at x=0 minim. reflection (d/dt-d/dx)^{p-1}(Ez-By)=0</span>
<a name="ln-1107"></a>      <span class="c">! first order p=1 By=Ez at x=0 and equal time</span>
<a name="ln-1108"></a>      <span class="c">!==========================</span>
<a name="ln-1109"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1110"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1111"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">ix1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphx</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">/</span> <span class="p">&amp;</span>
<a name="ln-1112"></a>                               <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphx</span><span class="p">)</span>
<a name="ln-1113"></a>       <span class="k">end do</span>
<a name="ln-1114"></a><span class="k">      end do</span>
<a name="ln-1115"></a><span class="k">     end if</span>
<a name="ln-1116"></a><span class="k">    end if</span>
<a name="ln-1117"></a><span class="k">   end if</span>
<a name="ln-1118"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1119"></a>   <span class="c">!------------------------------------</span>
<a name="ln-1120"></a>   <span class="c">!++++++++++++++++++++++++++++++++++++++ (Bz,Ex)</span>
<a name="ln-1121"></a>   <span class="c">!at y=-Ly minim. reflection (d/dt-d/dy)^{p-1}(Ex-Bz)=0</span>
<a name="ln-1122"></a>   <span class="c">! first order p=1 Bz=Ex at y=-Ly and equal time</span>
<a name="ln-1123"></a>   <span class="c">!========================</span>
<a name="ln-1124"></a>   <span class="c">!==============================</span>
<a name="ln-1125"></a>   <span class="c">! aphy centered as Ex j=1 (the Bz derivative)</span>
<a name="ln-1126"></a>   <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1127"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1128"></a><span class="k">    if</span> <span class="p">(</span><span class="n">yl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1129"></a><span class="k">     select case</span> <span class="p">(</span><span class="n">imbd</span><span class="p">)</span>
<a name="ln-1130"></a>     <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1131"></a>      <span class="n">aphy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">dy_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1132"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1133"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1134"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1135"></a>                                    <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphy</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span>
<a name="ln-1136"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphy</span><span class="p">)</span>
<a name="ln-1137"></a>       <span class="k">end do</span>
<a name="ln-1138"></a><span class="k">      end do</span>
<a name="ln-1139"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1140"></a>       <span class="c">!================================== (Bx,Ez)</span>
<a name="ln-1141"></a>       <span class="c">!at y=-Ly minim. reflection (d/dt-d/dy)^{p-1}(Ez+Bx)=0</span>
<a name="ln-1142"></a>       <span class="c">! first order p=1 Bx=-Ez at y=-Ly and equal time</span>
<a name="ln-1143"></a>       <span class="c">!==========================================</span>
<a name="ln-1144"></a>       <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1145"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1146"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1147"></a>                                <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphy</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1148"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphy</span><span class="p">)</span>
<a name="ln-1149"></a>        <span class="k">end do</span>
<a name="ln-1150"></a><span class="k">       end do</span>
<a name="ln-1151"></a><span class="k">      end if</span>
<a name="ln-1152"></a><span class="k">     case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!symmetric bds for (Bz,Bx) at ymin</span>
<a name="ln-1153"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1154"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1155"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span>
<a name="ln-1156"></a>        <span class="c">!ef(i,j1-1,k,nfield)=2.*ef(i,j1,k,nfield)-ef(i,j1+1,k,nfield)</span>
<a name="ln-1157"></a>       <span class="k">end do</span>
<a name="ln-1158"></a><span class="k">      end do</span>
<a name="ln-1159"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1160"></a><span class="k">       do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1161"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1162"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1163"></a>         <span class="c">!ef(i,j1-1,k,4)=2.*ef(i,j1,k,4)-ef(i,j1+1,k,4)</span>
<a name="ln-1164"></a>        <span class="k">end do</span>
<a name="ln-1165"></a><span class="k">       end do</span>
<a name="ln-1166"></a><span class="k">      end if</span>
<a name="ln-1167"></a><span class="k">     end select</span>
<a name="ln-1168"></a><span class="k">    end if</span>
<a name="ln-1169"></a><span class="k">   end if</span>
<a name="ln-1170"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1171"></a>   <span class="c">!at z=-Lz minim. reflection (d/dt-d/dz)^{p-1}(Bx-Ey)=0</span>
<a name="ln-1172"></a>   <span class="c">! first order p=1 Bx=Ey at z=-Lz and equal time</span>
<a name="ln-1173"></a>   <span class="c">!at z=-Lz minim. reflection (d/dt-d/dz)^{p-1}(By+Ex)=0</span>
<a name="ln-1174"></a>   <span class="c">! first order p=1 By=-Ex at z=-Lz and equal time</span>
<a name="ln-1175"></a>   <span class="c">!==============================</span>
<a name="ln-1176"></a>   <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1177"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1178"></a><span class="k">    if</span> <span class="p">(</span><span class="n">zl_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1179"></a><span class="k">     select case</span> <span class="p">(</span><span class="n">imbd</span><span class="p">)</span>
<a name="ln-1180"></a>     <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1181"></a>      <span class="n">aphz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">dz_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1182"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1183"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1184"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1185"></a>                               <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphz</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1186"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphz</span><span class="p">)</span>
<a name="ln-1187"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1188"></a>                               <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphz</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1189"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphz</span><span class="p">)</span>
<a name="ln-1190"></a>       <span class="k">end do</span>
<a name="ln-1191"></a><span class="k">      end do</span>
<a name="ln-1192"></a><span class="k">     case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!symmetric bds for (Nx,By) at zmin</span>
<a name="ln-1193"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1194"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1195"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-1196"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-1197"></a>       <span class="k">end do</span>
<a name="ln-1198"></a><span class="k">      end do</span>
<a name="ln-1199"></a><span class="k">     end select</span>
<a name="ln-1200"></a><span class="k">    end if</span>
<a name="ln-1201"></a><span class="k">   end if</span>
<a name="ln-1202"></a><span class="k">  end subroutine</span>
<a name="ln-1203"></a>  <span class="c">!====================================</span>
<a name="ln-1204"></a>  <span class="k">subroutine </span><span class="n">ef_bds</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">dtl</span><span class="p">,</span> <span class="n">imbd</span><span class="p">)</span>
<a name="ln-1205"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1206"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">imbd</span>
<a name="ln-1207"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dtl</span>
<a name="ln-1208"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-1209"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span>
<a name="ln-1210"></a>
<a name="ln-1211"></a>   <span class="n">aphx</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1212"></a>   <span class="n">aphy</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1213"></a>   <span class="n">aphz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1214"></a>
<a name="ln-1215"></a>   <span class="c">! Enter ebf(1:3)=[Ex,Ey,Ez]</span>
<a name="ln-1216"></a>   <span class="c">! DATA: ef[1:n1p][1:n2p+1][1:n3p+1] bds are on the right</span>
<a name="ln-1217"></a>   <span class="c">!===============</span>
<a name="ln-1218"></a>   <span class="c">! to be used to advance B_t=-rot(E)</span>
<a name="ln-1219"></a>   <span class="c">!========= Engquist-Majda ABC (=&gt;&gt; Mur) =====================</span>
<a name="ln-1220"></a>   <span class="c">!===============</span>
<a name="ln-1221"></a>   <span class="c">! Ey+Bz are right-moving, Ey-Bz left-moving</span>
<a name="ln-1222"></a>   <span class="c">!at x=0 minim. reflection (d/dt-d/dx)^{p-1}(Ey+Bz)=0</span>
<a name="ln-1223"></a>   <span class="c">! first order p=1 Ey=-Bz at x=0</span>
<a name="ln-1224"></a>   <span class="c">!at x=Lx minim. reflection (d/dt+d/dx)^{p-1}(Ey-Bz)=0</span>
<a name="ln-1225"></a>   <span class="c">! first order p=1 Ey=Bz at x=L and equal time level</span>
<a name="ln-1226"></a>   <span class="c">!=====================</span>
<a name="ln-1227"></a>   <span class="c">! aphx centered as Bz nx+1/2</span>
<a name="ln-1228"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1229"></a><span class="k">    if</span> <span class="p">(</span><span class="n">xr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1230"></a><span class="k">     </span><span class="n">ii</span> <span class="o">=</span> <span class="n">ix2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1231"></a>     <span class="k">select case</span> <span class="p">(</span><span class="n">ibx</span><span class="p">)</span>
<a name="ln-1232"></a>     <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1233"></a>      <span class="n">aphx</span> <span class="o">=</span> <span class="n">loc_xg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span><span class="o">*</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1234"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1235"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1236"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphx</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="p">&amp;</span>
<a name="ln-1237"></a>                                                                        <span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphx</span><span class="p">)</span>
<a name="ln-1238"></a>       <span class="k">end do</span>
<a name="ln-1239"></a><span class="k">      end do</span>
<a name="ln-1240"></a><span class="k">     case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!reflecting  only on the right boundary: (Ey,Ez, By,Bz) symmetric (continuous)</span>
<a name="ln-1241"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1242"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1243"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1244"></a>       <span class="k">end do</span>
<a name="ln-1245"></a><span class="k">      end do</span>
<a name="ln-1246"></a><span class="k">     end select</span>
<a name="ln-1247"></a><span class="k">     if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1248"></a>      <span class="c">!====================</span>
<a name="ln-1249"></a>      <span class="c">!at x=Lx minim. reflection (d/dt+d/dx)^{p-1}(Ez+By)=0</span>
<a name="ln-1250"></a>      <span class="c">! first order p=1 Ez=-Bz at x=L and equal time level</span>
<a name="ln-1251"></a>      <span class="c">!===========================</span>
<a name="ln-1252"></a>      <span class="k">select case</span> <span class="p">(</span><span class="n">ibx</span><span class="p">)</span>
<a name="ln-1253"></a>      <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1254"></a>       <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1255"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1256"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphx</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1257"></a>                                  <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphx</span><span class="p">)</span>
<a name="ln-1258"></a>        <span class="k">end do</span>
<a name="ln-1259"></a><span class="k">       end do</span>
<a name="ln-1260"></a><span class="k">      case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!reflecting</span>
<a name="ln-1261"></a>       <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1262"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1263"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1264"></a>        <span class="k">end do</span>
<a name="ln-1265"></a><span class="k">       end do</span>
<a name="ln-1266"></a><span class="k">      end select</span>
<a name="ln-1267"></a><span class="k">     end if</span>
<a name="ln-1268"></a><span class="k">    end if</span>
<a name="ln-1269"></a><span class="k">   end if</span>
<a name="ln-1270"></a>   <span class="c">!===========================</span>
<a name="ln-1271"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1272"></a>   <span class="c">!=========================== (Bz,Ex)</span>
<a name="ln-1273"></a>   <span class="c">!at y=Ly minim. reflection (d/dt+d/dy)^{p-1}(Ex+Bz)=0</span>
<a name="ln-1274"></a>   <span class="c">! first order p=1 Ex=-Bz at y=Ly and equal time level</span>
<a name="ln-1275"></a>   <span class="c">!========================</span>
<a name="ln-1276"></a>   <span class="c">! aphy centered as Bz field ny+1/2</span>
<a name="ln-1277"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">iby</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1278"></a><span class="k">    if</span> <span class="p">(</span><span class="n">yr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1279"></a><span class="k">     select case</span> <span class="p">(</span><span class="n">imbd</span><span class="p">)</span>
<a name="ln-1280"></a>     <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1281"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">jy2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1282"></a>      <span class="n">aphy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">dy_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1283"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1284"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1285"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphy</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1286"></a>                                                                         <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphy</span><span class="p">)</span>
<a name="ln-1287"></a>       <span class="k">end do</span>
<a name="ln-1288"></a><span class="k">      end do</span>
<a name="ln-1289"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1290"></a>       <span class="c">!====================== (Bz,Ex)</span>
<a name="ln-1291"></a>       <span class="c">!at y=Ly minim. reflection (d/dt+d/dy)^{p-1}(Ez-Bx)=0</span>
<a name="ln-1292"></a>       <span class="c">! first order p=1 Ez=Bx at y=Ly and equal time level</span>
<a name="ln-1293"></a>       <span class="c">!================================</span>
<a name="ln-1294"></a>       <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1295"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1296"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphy</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jy2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1297"></a>                                <span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphy</span><span class="p">)</span>
<a name="ln-1298"></a>        <span class="k">end do</span>
<a name="ln-1299"></a><span class="k">       end do</span>
<a name="ln-1300"></a><span class="k">      end if</span>
<a name="ln-1301"></a><span class="k">     case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!symmetric bds for (Ex,Ez) at ymax boundary</span>
<a name="ln-1302"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1303"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1304"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ix2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1305"></a>        <span class="c">!ef(i,n2p+1,k,1)=2.*ef(i,n2p,k,1)-ef(i,n2p-1,k,1)</span>
<a name="ln-1306"></a>       <span class="k">end do</span>
<a name="ln-1307"></a><span class="k">      end do</span>
<a name="ln-1308"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1309"></a><span class="k">       do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1310"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1311"></a>         <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ix2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ix2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1312"></a>         <span class="c">!ef(i,n2p+1,k,3)=2.*ef(i,n2p,k,3)-ef(i,n2p-1,k,3)</span>
<a name="ln-1313"></a>        <span class="k">end do</span>
<a name="ln-1314"></a><span class="k">       end do</span>
<a name="ln-1315"></a><span class="k">      end if</span>
<a name="ln-1316"></a><span class="k">     end select</span>
<a name="ln-1317"></a><span class="k">    end if</span>
<a name="ln-1318"></a><span class="k">   end if</span>
<a name="ln-1319"></a>   <span class="c">!==============================</span>
<a name="ln-1320"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1321"></a>   <span class="c">!==============================</span>
<a name="ln-1322"></a>   <span class="c">!at z=Lz minim. reflection</span>
<a name="ln-1323"></a>   <span class="c">! (d/dt+d/dz)^{p-1}(Ex-By)=0</span>
<a name="ln-1324"></a>   <span class="c">! first order p=1 Ex=By at z=Lz and equal time level</span>
<a name="ln-1325"></a>   <span class="c">! (d/dt+d/dz)^{p-1}(Ey+Bx)=0</span>
<a name="ln-1326"></a>   <span class="c">! first order p=1 Ey=-Bx at z=Lz and equal time level</span>
<a name="ln-1327"></a>   <span class="c">!================================</span>
<a name="ln-1328"></a>   <span class="c">!========================================</span>
<a name="ln-1329"></a>   <span class="c">! aphz centered as Bx,By at nz+1/2</span>
<a name="ln-1330"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ibz</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1331"></a><span class="k">    if</span> <span class="p">(</span><span class="n">zr_bd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1332"></a><span class="k">     select case</span> <span class="p">(</span><span class="n">imbd</span><span class="p">)</span>
<a name="ln-1333"></a>     <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1334"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">loc_zgrid</span><span class="p">(</span><span class="n">imodz</span><span class="p">)%</span><span class="n">ng</span> <span class="c">!= kz2-2</span>
<a name="ln-1335"></a>      <span class="n">aphz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">dz_inv</span><span class="o">*</span><span class="n">dtl</span>
<a name="ln-1336"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1337"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1338"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphz</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span> <span class="p">&amp;</span>
<a name="ln-1339"></a>                               <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphz</span><span class="p">)</span>
<a name="ln-1340"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">aphz</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1341"></a>                               <span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">aphz</span><span class="p">)</span>
<a name="ln-1342"></a>       <span class="k">end do</span>
<a name="ln-1343"></a><span class="k">      end do</span>
<a name="ln-1344"></a><span class="k">     case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!symmetric bds for (Ex,Ey) at zmax boundary</span>
<a name="ln-1345"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1346"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1347"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1348"></a>        <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kz2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1349"></a>       <span class="k">end do</span>
<a name="ln-1350"></a><span class="k">      end do</span>
<a name="ln-1351"></a><span class="k">     end select</span>
<a name="ln-1352"></a><span class="k">    end if</span>
<a name="ln-1353"></a><span class="k">   end if</span>
<a name="ln-1354"></a><span class="k">  end subroutine</span>
<a name="ln-1355"></a>  <span class="c">!=========================================</span>
<a name="ln-1356"></a>  <span class="k">subroutine </span><span class="n">potential_lapl</span><span class="p">(</span><span class="n">apf</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">)</span>
<a name="ln-1357"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">apf</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">curr</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1358"></a>
<a name="ln-1359"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-1360"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-1361"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dx2</span><span class="p">,</span> <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dx4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1362"></a>   <span class="c">!Computes the Laplacian(apf) and accumulates on the source array curr</span>
<a name="ln-1363"></a>   <span class="c">!                 curr=laplcian(apf)+curr</span>
<a name="ln-1364"></a>   <span class="c">!========================================</span>
<a name="ln-1365"></a>   <span class="n">dx2</span> <span class="o">=</span> <span class="n">dx_inv</span><span class="o">*</span><span class="n">dx_inv</span> <span class="c">!1/(dx*dx)</span>
<a name="ln-1366"></a>   <span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-1367"></a>   <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-1368"></a>   <span class="c">!============= ALL FIELDS ic=ic1,ic2</span>
<a name="ln-1369"></a>   <span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1370"></a>   <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1371"></a>   <span class="c">! Holds opt-second order or fourth order</span>
<a name="ln-1372"></a>   <span class="c">! for second derivative with:</span>
<a name="ln-1373"></a>   <span class="c">! dord=3  hord_der2=-(1-nu*nu)/12  dord=4 hord_der2=-1/12</span>
<a name="ln-1374"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1375"></a><span class="k">    </span><span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">hord_der2</span>
<a name="ln-1376"></a>    <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">hord_der2</span>
<a name="ln-1377"></a>   <span class="k">end if</span>
<a name="ln-1378"></a><span class="k">   </span><span class="n">dx4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx2</span>
<a name="ln-1379"></a>   <span class="n">dx4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dx2</span>
<a name="ln-1380"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-1381"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1382"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1383"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-1384"></a>       <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">apf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1385"></a>                                                       <span class="n">apf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">apf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-1386"></a>      <span class="k">end do</span>
<a name="ln-1387"></a><span class="k">     end do</span>
<a name="ln-1388"></a><span class="k">    end do</span>
<a name="ln-1389"></a><span class="k">   end do</span>
<a name="ln-1390"></a><span class="k">   if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1391"></a><span class="k">    do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span>
<a name="ln-1392"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1393"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1394"></a>       <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-1395"></a>        <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">curr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">apf</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1396"></a>                                                        <span class="n">apf</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">apf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-1397"></a>       <span class="k">end do</span>
<a name="ln-1398"></a><span class="k">      end do</span>
<a name="ln-1399"></a><span class="k">     end do</span>
<a name="ln-1400"></a><span class="k">    end do</span>
<a name="ln-1401"></a><span class="k">   end if</span>
<a name="ln-1402"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">call </span><span class="n">pp_lapl</span><span class="p">(</span><span class="n">apf</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">ic1</span><span class="p">,</span> <span class="n">ic2</span><span class="p">)</span>
<a name="ln-1403"></a>  <span class="k">end subroutine</span>
<a name="ln-1404"></a>  <span class="c">!===========================</span>
<a name="ln-1405"></a>  <span class="k">subroutine </span><span class="n">rote</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">dtf</span><span class="p">)</span>
<a name="ln-1406"></a>
<a name="ln-1407"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1408"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dtf</span>
<a name="ln-1409"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span>
<a name="ln-1410"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sdhy</span><span class="p">,</span> <span class="n">sdhz</span>
<a name="ln-1411"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-1412"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aph1</span><span class="p">,</span> <span class="n">aph2</span>
<a name="ln-1413"></a>
<a name="ln-1414"></a>   <span class="c">! Enter ef(1:3)=[Ex,Ey,Ez], ef(4:6)=[Bx,By,Bz]</span>
<a name="ln-1415"></a>   <span class="c">! SOLVES B=B-DT*rot[E]</span>
<a name="ln-1416"></a>   <span class="c">! enter boundary fields</span>
<a name="ln-1417"></a>   <span class="c">!==================== B=B-dt*rot(E) interior domain==========</span>
<a name="ln-1418"></a>   <span class="n">aphx</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-1419"></a>   <span class="n">aphy</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-1420"></a>   <span class="n">aphz</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-1421"></a>   <span class="n">aph1</span> <span class="o">=</span> <span class="n">aphx</span><span class="o">*</span><span class="n">se_coeff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1422"></a>   <span class="n">aph2</span> <span class="o">=</span> <span class="n">aphx</span><span class="o">*</span><span class="n">se_coeff</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1423"></a>   <span class="c">!============================</span>
<a name="ln-1424"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1425"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1426"></a>    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1427"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1428"></a>     <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1429"></a>                           <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1430"></a>                           <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-1431"></a>    <span class="k">end do</span>
<a name="ln-1432"></a><span class="k">    return</span>
<a name="ln-1433"></a><span class="k">   end if</span>
<a name="ln-1434"></a>   <span class="c">!=================================</span>
<a name="ln-1435"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1436"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1437"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1438"></a>     <span class="n">sdhy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-1439"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1440"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1441"></a>                            <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1442"></a>                            <span class="n">sdhy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1443"></a>                            <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-1444"></a>     <span class="k">end do</span>
<a name="ln-1445"></a><span class="k">    end do</span>
<a name="ln-1446"></a><span class="k">   end do</span>
<a name="ln-1447"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1448"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1449"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1450"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1451"></a>     <span class="n">sdhz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span><span class="o">*</span><span class="n">aphz</span>
<a name="ln-1452"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1453"></a>      <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1454"></a>      <span class="n">sdhy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-1455"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1456"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">sdhy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1457"></a>                                               <span class="p">)</span> <span class="o">+</span> <span class="n">sdhz</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-1458"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1459"></a>                        <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1460"></a>                        <span class="n">sdhz</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1461"></a>                        <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a name="ln-1462"></a>      <span class="k">end do</span>
<a name="ln-1463"></a><span class="k">     end do</span>
<a name="ln-1464"></a><span class="k">    end do</span>
<a name="ln-1465"></a><span class="k">   else</span>
<a name="ln-1466"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1467"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1468"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1469"></a>     <span class="n">sdhy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-1470"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1471"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">sdhy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a name="ln-1472"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1473"></a>                       <span class="o">+</span> <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<a name="ln-1474"></a>     <span class="k">end do</span>
<a name="ln-1475"></a><span class="k">    end do</span>
<a name="ln-1476"></a><span class="k">   end if</span>
<a name="ln-1477"></a>   <span class="c">!================== interior domains</span>
<a name="ln-1478"></a>  <span class="k">end subroutine</span>
<a name="ln-1479"></a>  <span class="c">!===============================</span>
<a name="ln-1480"></a>  <span class="k">subroutine </span><span class="n">rotb</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">dtf</span><span class="p">)</span>
<a name="ln-1481"></a>
<a name="ln-1482"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1483"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dtf</span>
<a name="ln-1484"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sdy</span><span class="p">,</span> <span class="n">sdz</span><span class="p">,</span> <span class="n">aph1</span><span class="p">,</span> <span class="n">aph2</span>
<a name="ln-1485"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span>
<a name="ln-1486"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-1487"></a>   <span class="c">! E=E+DT*rot[B]          Two-point Second order derivatives</span>
<a name="ln-1488"></a>   <span class="c">!==================== B=B-dt*rot(E) interior domain==========</span>
<a name="ln-1489"></a>   <span class="c">! enter boundary fields</span>
<a name="ln-1490"></a>   <span class="c">!=================== interior domains</span>
<a name="ln-1491"></a>   <span class="n">aphx</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-1492"></a>   <span class="n">aphy</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-1493"></a>   <span class="n">aphz</span> <span class="o">=</span> <span class="n">dtf</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-1494"></a>   <span class="n">aph1</span> <span class="o">=</span> <span class="n">aphx</span><span class="o">*</span><span class="n">se_coeff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1495"></a>   <span class="n">aph2</span> <span class="o">=</span> <span class="n">aphx</span><span class="o">*</span><span class="n">se_coeff</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1496"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1497"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1498"></a>    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1499"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1500"></a>     <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">aphx</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="p">&amp;</span>
<a name="ln-1501"></a>                                                                      <span class="p">,</span> <span class="n">nfield</span><span class="p">))</span>
<a name="ln-1502"></a>    <span class="k">end do</span>
<a name="ln-1503"></a><span class="k">   end if</span>
<a name="ln-1504"></a>   <span class="c">!=========================== NDIM &gt; 1</span>
<a name="ln-1505"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1506"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1507"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1508"></a>     <span class="n">sdy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span><span class="o">*</span><span class="n">aphy</span>
<a name="ln-1509"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1510"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1511"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="p">&amp;</span>
<a name="ln-1512"></a>                                                                      <span class="p">,</span> <span class="n">nfield</span><span class="p">))</span>
<a name="ln-1513"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1514"></a>                       <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1515"></a>                       <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nfield</span><span class="p">))</span>
<a name="ln-1516"></a>     <span class="k">end do</span>
<a name="ln-1517"></a><span class="k">    end do</span>
<a name="ln-1518"></a><span class="k">   end do</span>
<a name="ln-1519"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1520"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1521"></a><span class="k">    do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1522"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1523"></a>     <span class="n">sdz</span> <span class="o">=</span> <span class="n">aphz</span><span class="o">*</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1524"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1525"></a>      <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1526"></a>      <span class="n">sdy</span> <span class="o">=</span> <span class="n">aphy</span><span class="o">*</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-1527"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1528"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1529"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">sdz</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a name="ln-1530"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdz</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a name="ln-1531"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1532"></a>                        <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1533"></a>                        <span class="n">sdy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1534"></a>                        <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a name="ln-1535"></a>      <span class="k">end do</span>
<a name="ln-1536"></a><span class="k">     end do</span>
<a name="ln-1537"></a><span class="k">    end do</span>
<a name="ln-1538"></a><span class="k">   else</span>
<a name="ln-1539"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1540"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1541"></a>     <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1542"></a>     <span class="n">sdy</span> <span class="o">=</span> <span class="n">aphy</span><span class="o">*</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-1543"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1544"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1545"></a>      <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1546"></a>                       <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1547"></a>                       <span class="n">sdy</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1548"></a>                       <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a name="ln-1549"></a>     <span class="k">end do</span>
<a name="ln-1550"></a><span class="k">    end do</span>
<a name="ln-1551"></a><span class="k">   end if</span>
<a name="ln-1552"></a><span class="k">  end subroutine</span>
<a name="ln-1553"></a>  <span class="c">!=====================================</span>
<a name="ln-1554"></a>  <span class="c">!=================================</span>
<a name="ln-1555"></a>  <span class="k">subroutine </span><span class="n">nc_fluid_density_momenta</span><span class="p">(</span><span class="n">flx</span><span class="p">,</span> <span class="n">ef</span><span class="p">,</span> <span class="n">dt_step</span><span class="p">,</span> <span class="n">fcomp</span><span class="p">)</span>
<a name="ln-1556"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flx</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1557"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1558"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dt_step</span>
<a name="ln-1559"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fcomp</span>
<a name="ln-1560"></a>
<a name="ln-1561"></a>   <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flux_ind</span>
<a name="ln-1562"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aphx</span><span class="p">,</span> <span class="n">aphy</span><span class="p">,</span> <span class="n">aphz</span>
<a name="ln-1563"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span><span class="p">,</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span><span class="p">,</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span><span class="p">,</span> <span class="n">fcomp_tot</span>
<a name="ln-1564"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shz</span>
<a name="ln-1565"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dw</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">sl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">sr</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">omgl</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">vv</span><span class="p">,</span> <span class="n">s0</span>
<a name="ln-1566"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">EPS</span> <span class="o">=</span> <span class="mf">1.e-06</span>
<a name="ln-1567"></a>
<a name="ln-1568"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">W03</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">]</span>
<a name="ln-1569"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">LDER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
<a name="ln-1570"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">RDER</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]</span>
<a name="ln-1571"></a>
<a name="ln-1572"></a>   <span class="c">! Fourth order derivatives</span>
<a name="ln-1573"></a>   <span class="c">!real(dp), dimension(4), parameter :: LDER4 = [ 1./6., -1., 0.5, &amp;</span>
<a name="ln-1574"></a>   <span class="c">!  1./3. ] ![i-2,i+1] stencil</span>
<a name="ln-1575"></a>   <span class="c">!real(dp), dimension(4), parameter :: RDER4 = [ -1./3., -0.5, 1., &amp;</span>
<a name="ln-1576"></a>   <span class="c">!  -1./6. ] ![i-1,i+2] stencil</span>
<a name="ln-1577"></a>   <span class="c">!=========================</span>
<a name="ln-1578"></a>   <span class="c">! Enter primitive variables in flux array flx(Px,Py,Pz,den,vx,vy,vz)</span>
<a name="ln-1579"></a>   <span class="c">! fcomp=curr_ndim+1 components</span>
<a name="ln-1580"></a>   <span class="n">flux_ind</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">!=1 for pure upwind</span>
<a name="ln-1581"></a>   <span class="c">!=2 for LxF fluxin density equation</span>
<a name="ln-1582"></a>   <span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-1583"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xl_bd</span><span class="p">)</span> <span class="n">i01</span> <span class="o">=</span> <span class="n">ix1</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1584"></a>   <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span>
<a name="ln-1585"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">xr_bd</span><span class="p">)</span> <span class="n">i02</span> <span class="o">=</span> <span class="n">ix2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1586"></a>   <span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-1587"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">yl_bd</span><span class="p">)</span> <span class="n">j01</span> <span class="o">=</span> <span class="n">jy1</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1588"></a>   <span class="n">j02</span> <span class="o">=</span> <span class="n">jy2</span>
<a name="ln-1589"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">yr_bd</span><span class="p">)</span> <span class="n">j02</span> <span class="o">=</span> <span class="n">jy2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1590"></a>   <span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-1591"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">zl_bd</span><span class="p">)</span> <span class="n">k01</span> <span class="o">=</span> <span class="n">kz1</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1592"></a>   <span class="n">k02</span> <span class="o">=</span> <span class="n">kz2</span>
<a name="ln-1593"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">zr_bd</span><span class="p">)</span> <span class="n">k02</span> <span class="o">=</span> <span class="n">kz2</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1594"></a>
<a name="ln-1595"></a>   <span class="n">aphx</span> <span class="o">=</span> <span class="n">dt_step</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-1596"></a>   <span class="n">aphy</span> <span class="o">=</span> <span class="n">dt_step</span><span class="o">*</span><span class="n">dy_inv</span>
<a name="ln-1597"></a>   <span class="n">aphz</span> <span class="o">=</span> <span class="n">dt_step</span><span class="o">*</span><span class="n">dz_inv</span>
<a name="ln-1598"></a>   <span class="c">!===========================</span>
<a name="ln-1599"></a>   <span class="c">! momenta-density</span>
<a name="ln-1600"></a>   <span class="n">fcomp_tot</span> <span class="o">=</span> <span class="n">fcomp</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1601"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1602"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1603"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp_tot</span>
<a name="ln-1604"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i02</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1605"></a>       <span class="n">var</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">flx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1606"></a>      <span class="k">end do</span>
<a name="ln-1607"></a><span class="k">     end do</span>
<a name="ln-1608"></a><span class="k">     call </span><span class="n">weno3_nc</span><span class="p">(</span><span class="n">fcomp_tot</span><span class="p">,</span> <span class="n">i01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i02</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xl_bd</span><span class="p">,</span> <span class="n">xr_bd</span><span class="p">)</span>
<a name="ln-1609"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp</span> <span class="c">!var=momenta</span>
<a name="ln-1610"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-1611"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">aphx</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1612"></a>      <span class="k">end do</span>
<a name="ln-1613"></a><span class="k">     end do</span>
<a name="ln-1614"></a><span class="k">    end do</span>
<a name="ln-1615"></a><span class="k">   end do</span>
<a name="ln-1616"></a>   <span class="c">!====================</span>
<a name="ln-1617"></a>   <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kz1</span><span class="p">,</span> <span class="n">kz2</span>
<a name="ln-1618"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1619"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp</span>
<a name="ln-1620"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j02</span> <span class="o">+</span> <span class="mi">2</span> <span class="c">!Extended range[j1-2,n2p+2] in interior domains</span>
<a name="ln-1621"></a>       <span class="n">var</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">flx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1622"></a>      <span class="k">end do</span>
<a name="ln-1623"></a><span class="k">     end do</span>
<a name="ln-1624"></a><span class="k">     do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j02</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1625"></a>      <span class="n">var</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">fcomp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">flx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fcomp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1626"></a>     <span class="k">end do</span>
<a name="ln-1627"></a><span class="k">     call </span><span class="n">weno3_nc</span><span class="p">(</span><span class="n">fcomp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j02</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yl_bd</span><span class="p">,</span> <span class="n">yr_bd</span><span class="p">)</span> <span class="c">!rec[flux][j01-1,j02+1]</span>
<a name="ln-1628"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp</span>
<a name="ln-1629"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">j01</span><span class="p">,</span> <span class="n">j02</span>
<a name="ln-1630"></a>       <span class="n">shy</span> <span class="o">=</span> <span class="n">aphy</span><span class="o">*</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-1631"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">shy</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1632"></a>      <span class="k">end do</span>
<a name="ln-1633"></a><span class="k">     end do</span>
<a name="ln-1634"></a><span class="k">    end do</span>
<a name="ln-1635"></a><span class="k">   end do</span>
<a name="ln-1636"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-1637"></a><span class="k">   do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jy1</span><span class="p">,</span> <span class="n">jy2</span>
<a name="ln-1638"></a>    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">ix2</span>
<a name="ln-1639"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp</span>
<a name="ln-1640"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k02</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1641"></a>       <span class="n">var</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">flx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1642"></a>      <span class="k">end do</span>
<a name="ln-1643"></a><span class="k">     end do</span>
<a name="ln-1644"></a><span class="k">     </span><span class="n">ic</span> <span class="o">=</span> <span class="n">fcomp</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1645"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k02</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1646"></a>      <span class="n">var</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">flx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fcomp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1647"></a>     <span class="k">end do</span>
<a name="ln-1648"></a><span class="k">     call </span><span class="n">weno3_nc</span><span class="p">(</span><span class="n">fcomp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k01</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k02</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zl_bd</span><span class="p">,</span> <span class="n">zr_bd</span><span class="p">)</span>
<a name="ln-1649"></a>     <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcomp</span>
<a name="ln-1650"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">k01</span><span class="p">,</span> <span class="n">k02</span>
<a name="ln-1651"></a>       <span class="n">shz</span> <span class="o">=</span> <span class="n">aphz</span><span class="o">*</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-1652"></a>       <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">shz</span><span class="o">*</span><span class="n">ww0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-1653"></a>      <span class="k">end do</span>
<a name="ln-1654"></a><span class="k">     end do</span>
<a name="ln-1655"></a><span class="k">    end do</span>
<a name="ln-1656"></a><span class="k">   end do</span>
<a name="ln-1657"></a>   <span class="c">!=================================</span>
<a name="ln-1658"></a>  <span class="k">contains</span>
<a name="ln-1659"></a><span class="k">   subroutine </span><span class="n">weno3_nc</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">lbd</span><span class="p">,</span> <span class="n">rbd</span><span class="p">)</span>
<a name="ln-1660"></a>    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nc</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-1661"></a>    <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lbd</span><span class="p">,</span> <span class="n">rbd</span>
<a name="ln-1662"></a>    <span class="c">!  enter data [i1,np]</span>
<a name="ln-1663"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ii</span><span class="p">,</span> <span class="n">iic</span>
<a name="ln-1664"></a>
<a name="ln-1665"></a>    <span class="c">!=======ENTER DATA [i1,np]</span>
<a name="ln-1666"></a>    <span class="c">!wl_{i+1/2}  uses stencil [i-1,i,i+1] in range [i=i1+1,np-1]</span>
<a name="ln-1667"></a>    <span class="c">!wr_{i+1/2}  uses stencil [i,i+1,i+2] in range [i=i1,np-2]</span>
<a name="ln-1668"></a>    <span class="c">!            common interior points [i1+1,np-2</span>
<a name="ln-1669"></a>    <span class="c">!            Dw first derivative in range[i1+2,np-2]</span>
<a name="ln-1670"></a>    <span class="c">!            L-Boundary    Dw^r[i1+1] uses the [i1:i1+3] stencil for v&lt;0</span>
<a name="ln-1671"></a>    <span class="c">!            R-Boundary    Dw^L[np-1] uses the [np-3:np1] stencil</span>
<a name="ln-1672"></a>    <span class="c">!===========================================</span>
<a name="ln-1673"></a>
<a name="ln-1674"></a>    <span class="n">iic</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1675"></a>    <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-1676"></a>     <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span><span class="o">*</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span> <span class="c">!in den array var(nc+1) =&gt; den*v</span>
<a name="ln-1677"></a>    <span class="k">end do</span>
<a name="ln-1678"></a>    <span class="c">!================= reconstruct nc primitives (Px,Py,Pz,Den,V)</span>
<a name="ln-1679"></a>    <span class="k">do </span><span class="n">iic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span>
<a name="ln-1680"></a>     <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1681"></a>      <span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="c">!DW_{i-1/2}</span>
<a name="ln-1682"></a>      <span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="c">!DW_{i+1/2}</span>
<a name="ln-1683"></a>      <span class="n">omgl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">)</span>
<a name="ln-1684"></a>      <span class="n">omgl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">)</span>
<a name="ln-1685"></a>      <span class="n">omgl</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">omgl</span><span class="p">(:)</span><span class="o">*</span><span class="n">omgl</span><span class="p">(:)</span>
<a name="ln-1686"></a>      <span class="n">sl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">W03</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">omgl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1687"></a>      <span class="n">sl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">W03</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">omgl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1688"></a>      <span class="n">sr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">W03</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">omgl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1689"></a>      <span class="n">sr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">W03</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">omgl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1690"></a>      <span class="n">s0</span> <span class="o">=</span> <span class="n">sl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1691"></a>      <span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sl</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">s0</span>
<a name="ln-1692"></a>      <span class="n">s0</span> <span class="o">=</span> <span class="n">sr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1693"></a>      <span class="n">wr</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">sr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sr</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">s0</span>
<a name="ln-1694"></a>     <span class="k">end do</span>
<a name="ln-1695"></a><span class="k">    end do</span>
<a name="ln-1696"></a>    <span class="c">!===================================</span>
<a name="ln-1697"></a>    <span class="c">!upwind boundary derivatives</span>
<a name="ln-1698"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lbd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1699"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1700"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1701"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1702"></a>      <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1703"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1704"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1705"></a>      <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1706"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1707"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">RDER</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1708"></a>     <span class="k">end do</span>
<a name="ln-1709"></a><span class="k">     </span><span class="n">iic</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1710"></a>     <span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span>
<a name="ln-1711"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1712"></a>     <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1713"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1714"></a>     <span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1715"></a>     <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1716"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1717"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">RDER</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-1718"></a>    <span class="k">end if</span>
<a name="ln-1719"></a><span class="k">    if</span> <span class="p">(</span><span class="n">rbd</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1720"></a><span class="k">     do </span><span class="n">iic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1721"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1722"></a>      <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1723"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1724"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">LDER</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1725"></a>      <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-1726"></a>      <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1727"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1728"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1729"></a>     <span class="k">end do</span>
<a name="ln-1730"></a><span class="k">     </span><span class="n">iic</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1731"></a>     <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1732"></a>     <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1733"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1734"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">LDER</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-1735"></a>     <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span>
<a name="ln-1736"></a>     <span class="n">vv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1737"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1738"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1739"></a>    <span class="k">end if</span>
<a name="ln-1740"></a>    <span class="c">!===================================</span>
<a name="ln-1741"></a>    <span class="c">!   UPWINDING at interior points</span>
<a name="ln-1742"></a>    <span class="c">!          Momenta</span>
<a name="ln-1743"></a>    <span class="k">do </span><span class="n">iic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1744"></a>     <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1745"></a>      <span class="n">vv</span> <span class="o">=</span> <span class="n">wr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span> <span class="o">+</span> <span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1746"></a>      <span class="n">s0</span> <span class="o">=</span> <span class="nb">sign</span><span class="p">(</span><span class="n">one_dp</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="c">!s0=1*sign(vv)</span>
<a name="ln-1747"></a>      <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span><span class="o">*</span><span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span><span class="o">*</span><span class="n">wr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1748"></a>     <span class="k">end do</span>
<a name="ln-1749"></a><span class="k">     do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1750"></a>      <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1751"></a>     <span class="k">end do</span>
<a name="ln-1752"></a><span class="k">    end do</span>
<a name="ln-1753"></a>    <span class="c">! LxF flux for density variable</span>
<a name="ln-1754"></a>    <span class="c">!   F=nv=&gt; 1/2(F_L+F_R)-|V_{max}|(den_R-den_L)]</span>
<a name="ln-1755"></a>    <span class="n">iic</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1756"></a>    <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1757"></a>     <span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1758"></a>     <span class="n">dw</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1759"></a>     <span class="n">dw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
<a name="ln-1760"></a>     <span class="n">vv</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-1761"></a>     <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">wr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">+</span> <span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span><span class="o">*</span><span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1762"></a>                    <span class="n">vv</span><span class="o">*</span><span class="p">(</span><span class="n">wr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">))</span>
<a name="ln-1763"></a>     <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1764"></a>    <span class="k">end do</span>
<a name="ln-1765"></a><span class="k">    do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-1766"></a>     <span class="n">ww0</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span> <span class="o">-</span> <span class="n">var</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iic</span><span class="p">)</span>
<a name="ln-1767"></a>    <span class="k">end do</span>
<a name="ln-1768"></a><span class="k">   end subroutine</span>
<a name="ln-1769"></a><span class="k">  end subroutine</span>
<a name="ln-1770"></a><span class="c">!====================================</span>
<a name="ln-1771"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>