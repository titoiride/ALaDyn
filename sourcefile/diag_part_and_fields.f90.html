<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>diag_part_and_fields.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>diag_part_and_fields.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 4.6% of total for source files.">1141 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/diag_part_and_fields.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">diag_part_and_fields.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/diag_part_and_fields.html">diag_part_and_fields</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/diag_part_and_fields.f90.html#src">diag_part_and_fields.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~diag_part_and_fields.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilediag_part_and_fieldsf90EfferentGraph" width="641pt" height="264pt"
 viewBox="0.00 0.00 641.00 264.49" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph" class="graph" transform="scale(.8423 .8423) rotate(0) translate(4 310)">
<title>sourcefile~~diag_part_and_fields.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-310 757,-310 757,4 -4,4"/>
<!-- sourcefile~diag_part_and_fields.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~diag_part_and_fields.f90</title>
<polygon fill="none" stroke="#000000" points="753,-224 611,-224 611,-200 753,-200 753,-224"/>
<text text-anchor="middle" x="682" y="-209.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">diag_part_and_fields.f90</text>
</g>
<!-- sourcefile~phys_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~phys_param.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/phys_param.f90.html" xlink:title="phys_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="251.5,-306 153.5,-306 153.5,-282 251.5,-282 251.5,-306"/>
<text text-anchor="middle" x="202.5" y="-291.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">phys_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~phys_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~phys_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M666.815,-224.1926C647.027,-239.2782 610.7201,-264.2804 575,-275 468.2281,-307.0421 336.607,-304.5815 261.8417,-299.5324"/>
<polygon fill="#ff0000" stroke="#ff0000" points="261.9019,-296.0279 251.6779,-298.8061 261.4029,-303.0101 261.9019,-296.0279"/>
</g>
<!-- sourcefile~control_bunch_input.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~control_bunch_input.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/control_bunch_input.f90.html" xlink:title="control_bunch_input.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="575,-266 434,-266 434,-242 575,-242 575,-266"/>
<text text-anchor="middle" x="504.5" y="-251.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">control_bunch_input.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~control_bunch_input.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~control_bunch_input.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M631.1356,-224.0355C610.6182,-228.8903 586.7751,-234.5321 565.3477,-239.6022"/>
<polygon fill="#ff0000" stroke="#ff0000" points="564.2972,-236.2541 555.3718,-241.9627 565.909,-243.066 564.2972,-236.2541"/>
</g>
<!-- sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~pstruct_data.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/pstruct_data.f90.html" xlink:title="pstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="398,-226 299,-226 299,-202 398,-202 398,-226"/>
<text text-anchor="middle" x="348.5" y="-211.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~pstruct_data.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M504.5,-172C482.8082,-169.633 429.8559,-185.6588 391.6564,-198.5936"/>
<polygon fill="#ff0000" stroke="#ff0000" points="390.1265,-195.4181 381.802,-201.9719 392.3966,-202.0398 390.1265,-195.4181"/>
</g>
<!-- sourcefile~parallel.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~parallel.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/parallel.f90.html" xlink:title="parallel.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="542.5,-84 466.5,-84 466.5,-60 542.5,-60 542.5,-84"/>
<text text-anchor="middle" x="504.5" y="-69.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">parallel.F90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~parallel.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~parallel.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M666.5585,-199.8208C635.4026,-175.2471 564.8503,-119.6002 527.964,-90.5068"/>
<polygon fill="#ff0000" stroke="#ff0000" points="529.7986,-87.4961 519.7794,-84.0513 525.4635,-92.9923 529.7986,-87.4961"/>
</g>
<!-- sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~fstruct_data.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/fstruct_data.f90.html" xlink:title="fstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="552.5,-224 456.5,-224 456.5,-200 552.5,-200 552.5,-224"/>
<text text-anchor="middle" x="504.5" y="-209.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~fstruct_data.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M610.8267,-212C594.9187,-212 578.2258,-212 562.9045,-212"/>
<polygon fill="#ff0000" stroke="#ff0000" points="562.5432,-208.5001 552.5432,-212 562.5432,-215.5001 562.5432,-208.5001"/>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="243,-144 162,-144 162,-120 243,-120 243,-144"/>
<text text-anchor="middle" x="202.5" y="-129.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M640.8444,-199.9439C605.1522,-190.161 551.9176,-177.1741 504.5,-172"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M504.5,-172C456.5399,-166.7667 445.733,-158.0084 398,-151 349.065,-143.8151 292.8258,-138.6727 253.2665,-135.5648"/>
<polygon fill="#ff0000" stroke="#ff0000" points="253.3172,-132.0584 243.0779,-134.7803 252.7797,-139.0377 253.3172,-132.0584"/>
</g>
<!-- sourcefile~grid_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~grid_param.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/grid_param.f90.html" xlink:title="grid_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="395.5,-184 301.5,-184 301.5,-160 395.5,-160 395.5,-184"/>
<text text-anchor="middle" x="348.5" y="-169.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~grid_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~diag_part_and_fields.f90&#45;&gt;sourcefile~grid_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M504.5,-172C471.9867,-168.4522 435.4342,-168.2516 405.8883,-169.0297"/>
<polygon fill="#ff0000" stroke="#ff0000" points="405.6355,-165.5357 395.7479,-169.3419 405.8509,-172.5324 405.6355,-165.5357"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node13" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node13"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-164 0,-164 0,-140 106,-140 106,-164"/>
<text text-anchor="middle" x="53" y="-149.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~phys_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~phys_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M166.2681,-281.993C157.8342,-278.2605 149.2189,-273.6156 142,-268 107.7123,-241.3275 79.4937,-198.4764 64.5528,-172.9973"/>
<polygon fill="#ff0000" stroke="#ff0000" points="67.4962,-171.0939 59.4917,-164.1528 61.4206,-174.5706 67.4962,-171.0939"/>
</g>
<!-- sourcefile~control_bunch_input.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~control_bunch_input.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ffda00" stroke-dasharray="5,2" d="M433.7647,-252.0015C407.023,-251.7708 376.3334,-252.135 348.5,-254"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="245,-224 160,-224 160,-200 245,-200 245,-224"/>
<text text-anchor="middle" x="202.5" y="-209.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M298.6634,-213.3173C284.704,-213.1261 269.484,-212.9176 255.356,-212.7241"/>
<polygon fill="#48ff00" stroke="#48ff00" points="255.3423,-209.2236 245.2953,-212.5862 255.2464,-216.223 255.3423,-209.2236"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M318.1352,-226.0046C282.1671,-239.5734 224.3721,-259.1511 202.5,-254"/>
<path fill="none" stroke="#48ff00" stroke-dasharray="5,2" d="M202.5,-254C174.7953,-247.4753 166.4676,-247.5417 142,-233 113.9655,-216.3384 87.0298,-189.8808 70.2757,-171.7678"/>
<polygon fill="#48ff00" stroke="#48ff00" points="72.6349,-169.1589 63.3269,-164.0979 67.4472,-173.8588 72.6349,-169.1589"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="375.5,-104 321.5,-104 321.5,-80 375.5,-80 375.5,-104"/>
<text text-anchor="middle" x="348.5" y="-89.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M466.3381,-76.8926C441.7129,-80.0496 409.8461,-84.1351 385.4613,-87.2614"/>
<polygon fill="#00ff91" stroke="#00ff91" points="384.9854,-83.7936 375.5117,-88.537 385.8756,-90.7368 384.9854,-83.7936"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="263,-64 142,-64 142,-40 263,-40 263,-64"/>
<text text-anchor="middle" x="202.5" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M466.2515,-69.467C417.864,-66.2625 333.5883,-60.6813 273.3181,-56.6899"/>
<polygon fill="#00ff91" stroke="#00ff91" points="273.3201,-53.1825 263.1106,-56.0139 272.8575,-60.1672 273.3201,-53.1825"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="386,-24 311,-24 311,0 386,0 386,-24"/>
<text text-anchor="middle" x="348.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M472.9311,-59.8581C448.8528,-50.5972 415.4934,-37.7667 389.3761,-27.7216"/>
<polygon fill="#00ff91" stroke="#00ff91" points="390.3453,-24.3444 379.7554,-24.0213 387.8324,-30.8779 390.3453,-24.3444"/>
</g>
<!-- sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M462.9842,-224.0763C420.7693,-236.2106 359.9738,-253.2312 348.5,-254"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M348.5,-254C283.7563,-258.3382 265.6609,-268.8751 202.5,-254"/>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M161.6485,-137.4651C147.6065,-139.3436 131.5398,-141.493 116.1461,-143.5524"/>
<polygon fill="#4800ff" stroke="#4800ff" points="115.603,-140.0938 106.1554,-144.8889 116.5312,-147.0319 115.603,-140.0938"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M304.6952,-184.0013C289.1142,-188.2701 271.4087,-193.1209 255.1634,-197.5717"/>
<polygon fill="#ff00da" stroke="#ff00da" points="253.9889,-194.2644 245.2691,-200.2824 255.8386,-201.0156 253.9889,-194.2644"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff00da" stroke-dasharray="5,2" d="M301.3504,-168.8088C251.2662,-165.419 171.8115,-160.0414 116.3005,-156.2843"/>
<polygon fill="#ff00da" stroke="#ff00da" points="116.44,-152.7858 106.2265,-155.6025 115.9673,-159.7698 116.44,-152.7858"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M172.2464,-199.8581C149.2731,-190.638 117.4835,-177.8797 92.5041,-167.8545"/>
<polygon fill="#ff0000" stroke="#ff0000" points="93.5372,-164.4978 82.9531,-164.0213 90.9299,-170.9941 93.5372,-164.4978"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M321.3807,-99.4299C302.2726,-104.665 276.1116,-111.8324 253.1949,-118.111"/>
<polygon fill="#cbff00" stroke="#cbff00" points="251.9874,-114.8127 243.2677,-120.8308 253.8371,-121.564 251.9874,-114.8127"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M321.2576,-91.596C281.2574,-91.6509 204.597,-94.2323 142,-111 121.5322,-116.4827 99.9129,-126.3359 83.1079,-135.0089"/>
<polygon fill="#cbff00" stroke="#cbff00" points="81.0096,-132.1598 73.8147,-139.937 84.2891,-138.3441 81.0096,-132.1598"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M169.6146,-64.1041C160.4076,-68.0287 150.578,-72.7436 142,-78 116.2325,-93.7897 90.0248,-116.566 72.7869,-132.671"/>
<polygon fill="#00ff66" stroke="#00ff66" points="69.9291,-130.558 65.0864,-139.9813 74.7486,-135.6347 69.9291,-130.558"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0066ff" stroke-dasharray="5,2" d="M310.7415,-6.6467C267.1377,-2.3661 194.6627,-1.2527 142,-31 102.1624,-53.5028 75.1259,-101.997 62.0563,-130.2853"/>
<polygon fill="#0066ff" stroke="#0066ff" points="58.7322,-129.1474 57.8753,-139.7075 65.1306,-131.9866 58.7322,-129.1474"/>
</g>
</g>
</svg>
</div><script>var pansourcefilediag_part_and_fieldsf90EfferentGraph = svgPanZoom('#sourcefilediag_part_and_fieldsf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~diag_part_and_fields.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilediag_part_and_fieldsf90AfferentGraph" width="262pt" height="32pt"
 viewBox="0.00 0.00 262.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~diag_part_and_fields.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~diag_part_and_fields.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 258,-28 258,4 -4,4"/>
<!-- sourcefile~diag_part_and_fields.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~diag_part_and_fields.f90</title>
<polygon fill="none" stroke="#000000" points="142,-24 0,-24 0,0 142,0 142,-24"/>
<text text-anchor="middle" x="71" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">diag_part_and_fields.f90</text>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~diag_part_and_fields.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="254,-24 178,-24 178,0 254,0 254,-24"/>
<text text-anchor="middle" x="216" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~diag_part_and_fields.f90 -->
<g id="sourcefile~~diag_part_and_fields.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~diag_part_and_fields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M177.903,-12C169.9166,-12 161.2052,-12 152.3143,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="152.229,-8.5001 142.229,-12 152.2289,-15.5001 152.229,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/diag_part_and_fields.html">diag_part_and_fields</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/diag_part_and_fields.f90.html#src">diag_part_and_fields.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2020  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">diag_part_and_fields</span>
<a name="ln-23"></a>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">pstruct_data</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">fstruct_data</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">code_util</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">phys_param</span>
<a name="ln-28"></a>  <span class="k">use </span><span class="n">parallel</span>
<a name="ln-29"></a>  <span class="k">use </span><span class="n">grid_param</span>
<a name="ln-30"></a>  <span class="k">use </span><span class="n">control_bunch_input</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">reduced_charge</span><span class="p">,</span> <span class="n">bunch_charge</span><span class="p">,</span> <span class="n">epsy</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-31"></a>                                 <span class="n">epsz</span><span class="p">,</span> <span class="n">sxb</span><span class="p">,</span> <span class="n">syb</span><span class="p">,</span> <span class="n">gam</span><span class="p">,</span> <span class="n">dg</span>
<a name="ln-32"></a>
<a name="ln-33"></a>  <span class="k">implicit none</span>
<a name="ln-34"></a>
<a name="ln-35"></a><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tloc</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="n">tsp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1001</span><span class="p">),</span> <span class="n">eavg</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1001</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-36"></a>              <span class="n">eavg1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1001</span><span class="p">),</span> <span class="n">pavg</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">favg</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
<a name="ln-37"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ne</span> <span class="o">=</span> <span class="mi">100</span>
<a name="ln-38"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nde0</span><span class="p">(</span><span class="n">ne</span><span class="p">),</span> <span class="n">nde1</span><span class="p">(</span><span class="n">ne</span><span class="p">),</span> <span class="n">nde2</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-39"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nde</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">eksp_max</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">nde_sm</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-40"></a>              <span class="n">nde_sp</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-41"></a>  <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ionz_number</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">hgam_number</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">bunch_number</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-42"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ionz_bavg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">bunch_bavg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">tbunch</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-43"></a>              <span class="n">tionz</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">hgam_charge</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">ionz_charge</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span> <span class="n">bcharge</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-44"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hgam_bavg</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">tgam</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<a name="ln-45"></a>
<a name="ln-46"></a> <span class="k">contains</span>
<a name="ln-47"></a>
<a name="ln-48"></a><span class="k">  subroutine </span><span class="n">track_part_pdata_out</span><span class="p">(</span><span class="n">tk</span><span class="p">)</span>
<a name="ln-49"></a>
<a name="ln-50"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">tpart_name</span> <span class="o">=</span> <span class="s1">&#39;El_track_out&#39;</span>
<a name="ln-51"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span>
<a name="ln-52"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span>
<a name="ln-53"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk</span>
<a name="ln-54"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pdata</span><span class="p">(:)</span>
<a name="ln-55"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">tot_tpart</span>
<a name="ln-56"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-57"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span>
<a name="ln-58"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-59"></a>   <span class="c">!integer,parameter :: file_version = 4</span>
<a name="ln-60"></a>
<a name="ln-61"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-62"></a>
<a name="ln-63"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-64"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-65"></a><span class="k">    </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-66"></a>   <span class="k">else</span>
<a name="ln-67"></a><span class="k">    </span><span class="n">ip</span> <span class="o">=</span> <span class="n">loc_tpart</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-68"></a>   <span class="k">end if</span>
<a name="ln-69"></a>   <span class="c">!call intvec_distribute(ip,loc_tpart,npe)</span>
<a name="ln-70"></a>   <span class="c">!tot_tpart=0</span>
<a name="ln-71"></a>   <span class="c">!nptot_global_reduced=sum(ip_loc(1:npe))</span>
<a name="ln-72"></a>   <span class="c">!do ik=1,npe</span>
<a name="ln-73"></a>   <span class="n">tot_tpart</span> <span class="o">=</span> <span class="n">loc_tpart</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-74"></a>   <span class="c">!end do</span>
<a name="ln-75"></a>
<a name="ln-76"></a>   <span class="n">ip_max</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-77"></a>   <span class="c">!if(pe0)ip_max=maxval(loc_tpart(1:npe))</span>
<a name="ln-78"></a>   <span class="n">lenp</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">ip</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-79"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a12,i2.2)&#39;</span><span class="p">)</span> <span class="n">tpart_name</span><span class="p">,</span> <span class="n">iout</span> <span class="c">!serve sempre</span>
<a name="ln-80"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-81"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-82"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-83"></a><span class="k">    allocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">(</span><span class="n">lenp</span><span class="p">))</span>
<a name="ln-84"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-85"></a>    <span class="k">do </span><span class="n">it</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tk</span>
<a name="ln-86"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-87"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-88"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-89"></a>       <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">pdata_tracking</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
<a name="ln-90"></a>      <span class="k">end do</span>
<a name="ln-91"></a><span class="k">     end do</span>
<a name="ln-92"></a><span class="k">    end do</span>
<a name="ln-93"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tpart size&#39;</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">lenp</span>
<a name="ln-94"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-95"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-96"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time &#39;</span>
<a name="ln-97"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(e11.4)&#39;</span><span class="p">)</span> <span class="n">tnow</span>
<a name="ln-98"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time step size &#39;</span>
<a name="ln-99"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(e11.4)&#39;</span><span class="p">)</span> <span class="n">dt</span>
<a name="ln-100"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-101"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tot_nproc &#39;</span>
<a name="ln-102"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(i6)&#39;</span><span class="p">)</span> <span class="n">npe</span>
<a name="ln-103"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;phase dim &#39;</span>
<a name="ln-104"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(i6)&#39;</span><span class="p">)</span> <span class="n">ndv</span>
<a name="ln-105"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;space dim &#39;</span>
<a name="ln-106"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(i6)&#39;</span><span class="p">)</span> <span class="n">ndim</span>
<a name="ln-107"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time nstep &#39;</span>
<a name="ln-108"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(i6)&#39;</span><span class="p">)</span> <span class="n">tk</span>
<a name="ln-109"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;nstep inc  &#39;</span>
<a name="ln-110"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(i6)&#39;</span><span class="p">)</span> <span class="n">tkjump</span>
<a name="ln-111"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tot tkpart &#39;</span>
<a name="ln-112"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(3i8)&#39;</span><span class="p">)</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tot_tpart</span><span class="p">,</span> <span class="n">track_tot_part</span>
<a name="ln-113"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-114"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles param written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-115"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-116"></a>    <span class="c">!======================</span>
<a name="ln-117"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-118"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">pdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenp</span><span class="p">)</span> <span class="c">!(coordinates,pindex,time)=&gt;(coordinates,time,pind)</span>
<a name="ln-119"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-120"></a>
<a name="ln-121"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-122"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-123"></a>   <span class="k">end if</span>
<a name="ln-124"></a><span class="k">  end subroutine</span>
<a name="ln-125"></a>  <span class="c">!==============================================</span>
<a name="ln-126"></a>  <span class="k">subroutine </span><span class="n">energy_spect</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ekem</span><span class="p">,</span> <span class="n">gfield</span><span class="p">)</span>
<a name="ln-127"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np</span>
<a name="ln-128"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ekem</span>
<a name="ln-129"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gfield</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-130"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ix</span>
<a name="ln-131"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xx</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">wght</span>
<a name="ln-132"></a>   <span class="c">! activated only for np&gt;0</span>
<a name="ln-133"></a>
<a name="ln-134"></a>   <span class="n">de</span> <span class="o">=</span> <span class="n">ekem</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-135"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekem</span> <span class="o">&lt;</span> <span class="mf">1.e-06</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-136"></a><span class="k">   do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-137"></a>    <span class="n">xx</span> <span class="o">=</span> <span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">de</span> <span class="c">!0.5*mc^2*(gamma-1) energy in MeV</span>
<a name="ln-138"></a>    <span class="n">wght</span> <span class="o">=</span> <span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c">!weight &gt;0 to be multiplied by np_per_cell</span>
<a name="ln-139"></a>    <span class="n">ix</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
<a name="ln-140"></a>    <span class="n">ix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
<a name="ln-141"></a>    <span class="n">nde0</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde0</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="n">wght</span>
<a name="ln-142"></a>   <span class="k">end do</span>
<a name="ln-143"></a><span class="k">  end subroutine</span>
<a name="ln-144"></a>
<a name="ln-145"></a><span class="k">  subroutine </span><span class="n">select_energy_spect</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ekem</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">gfield</span><span class="p">)</span>
<a name="ln-146"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np</span>
<a name="ln-147"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ekem</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span>
<a name="ln-148"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gfield</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-149"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">p</span><span class="p">,</span> <span class="n">ix</span>
<a name="ln-150"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xx</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">wght</span>
<a name="ln-151"></a>   <span class="c">! activated only for np&gt;0</span>
<a name="ln-152"></a>
<a name="ln-153"></a>   <span class="n">de</span> <span class="o">=</span> <span class="n">ekem</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-154"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekem</span> <span class="o">&lt;</span> <span class="mf">1.e-06</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-155"></a><span class="k">   do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-156"></a>    <span class="n">xx</span> <span class="o">=</span> <span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">de</span> <span class="c">!0.5*mc^2*(gamma-1) energy in MeV</span>
<a name="ln-157"></a>    <span class="n">wght</span> <span class="o">=</span> <span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c">!weight &gt;0</span>
<a name="ln-158"></a>    <span class="n">ix</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
<a name="ln-159"></a>    <span class="n">ix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
<a name="ln-160"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xl</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-161"></a><span class="k">     </span><span class="n">nde0</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde0</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="n">wght</span>
<a name="ln-162"></a>    <span class="k">end if</span>
<a name="ln-163"></a><span class="k">    if</span> <span class="p">(</span><span class="n">gfield</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-164"></a><span class="k">     </span><span class="n">nde1</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde1</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="n">wght</span>
<a name="ln-165"></a>    <span class="k">end if</span>
<a name="ln-166"></a><span class="k">   end do</span>
<a name="ln-167"></a>
<a name="ln-168"></a><span class="k">  end subroutine</span>
<a name="ln-169"></a>
<a name="ln-170"></a>  <span class="c">!--------------------------</span>
<a name="ln-171"></a>
<a name="ln-172"></a>  <span class="k">subroutine </span><span class="n">energy_momenta</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">gfield</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ek</span><span class="p">,</span> <span class="n">ekmax</span><span class="p">)</span>
<a name="ln-173"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-174"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gfield</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-175"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np</span>
<a name="ln-176"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ek</span><span class="p">(:),</span> <span class="n">ekmax</span>
<a name="ln-177"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ik</span>
<a name="ln-178"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">gamm</span><span class="p">,</span> <span class="n">gam1</span>
<a name="ln-179"></a>
<a name="ln-180"></a>   <span class="n">ek</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-181"></a>   <span class="n">ekmax</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-182"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">curr_ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-183"></a><span class="k">    do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-184"></a>     <span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-185"></a>     <span class="n">gamm</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">vp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-186"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="p">(</span><span class="n">gamm</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
<a name="ln-187"></a>     <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-188"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-189"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-190"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-191"></a>     <span class="n">gam1</span> <span class="o">=</span> <span class="n">gamm</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-192"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_ndim</span>
<a name="ln-193"></a>      <span class="n">ek</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-194"></a>     <span class="k">end do</span>
<a name="ln-195"></a><span class="k">     </span><span class="n">ek</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="o">*</span><span class="n">wgh</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-196"></a>     <span class="n">ek</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="n">wgh</span><span class="o">*</span><span class="n">gam1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-197"></a>     <span class="n">ekmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ekmax</span><span class="p">,</span> <span class="n">gam1</span><span class="p">)</span>
<a name="ln-198"></a>    <span class="k">end do</span>
<a name="ln-199"></a><span class="k">   else</span>
<a name="ln-200"></a><span class="k">    do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-201"></a>     <span class="n">xp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-202"></a>     <span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-203"></a>     <span class="n">gamm</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">vp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">vp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-204"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="p">(</span><span class="n">gamm</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
<a name="ln-205"></a>     <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-206"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-207"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-208"></a>     <span class="n">gfield</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-209"></a>     <span class="n">gam1</span> <span class="o">=</span> <span class="n">gamm</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-210"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_ndim</span>
<a name="ln-211"></a>      <span class="n">ek</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">vp</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="c">!momenta</span>
<a name="ln-212"></a>     <span class="k">end do</span>
<a name="ln-213"></a><span class="k">     </span><span class="n">ek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="p">(</span><span class="n">xp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">xp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">vp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-214"></a>     <span class="n">ek</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="o">*</span><span class="n">wgh</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-215"></a>     <span class="n">ek</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="n">wgh</span><span class="o">*</span><span class="n">gam1</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-216"></a>     <span class="n">ekmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ekmax</span><span class="p">,</span> <span class="n">gam1</span><span class="p">)</span>
<a name="ln-217"></a>    <span class="k">end do</span>
<a name="ln-218"></a><span class="k">   end if</span>
<a name="ln-219"></a><span class="k">  end subroutine</span>
<a name="ln-220"></a>
<a name="ln-221"></a>  <span class="c">!--------------------------</span>
<a name="ln-222"></a>  <span class="k">subroutine </span><span class="n">laser_struct_data</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-223"></a>
<a name="ln-224"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-225"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">nb_tot</span>
<a name="ln-226"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span>
<a name="ln-227"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xm</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">xcm</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">eks</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">xcms</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-228"></a>
<a name="ln-229"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-230"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-231"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-232"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">nxp</span>
<a name="ln-233"></a>   <span class="n">xm</span> <span class="o">=</span> <span class="n">loc_xgrid</span><span class="p">(</span><span class="n">imodx</span><span class="p">)%</span><span class="n">gmin</span>
<a name="ln-234"></a>
<a name="ln-235"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-236"></a>   <span class="n">xcm</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-237"></a>   <span class="c">! !data on driver laser field</span>
<a name="ln-238"></a>   <span class="c">! CComputes the COM x- coordinates of nb_laser Ey fields (=&gt; group velocity)</span>
<a name="ln-239"></a>   <span class="c">!===================</span>
<a name="ln-240"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">3</span>
<a name="ln-241"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">ik</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-242"></a>   <span class="n">nb_tot</span> <span class="o">=</span> <span class="n">nb_laser</span>
<a name="ln-243"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="n">nb_tot</span> <span class="o">=</span> <span class="n">nb_laser</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-244"></a>   <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_tot</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-245"></a>   <span class="c">!================ field component selection</span>
<a name="ln-246"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb_laser</span>
<a name="ln-247"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lp_in</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-248"></a><span class="k">     do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-249"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-250"></a>       <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-251"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lp_in</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">lp_end</span><span class="p">(</span><span class="n">ic</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-252"></a><span class="k">         </span><span class="n">a2</span> <span class="o">=</span> <span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-253"></a>         <span class="n">xcm</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xcm</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">*</span><span class="n">a2</span>
<a name="ln-254"></a>         <span class="n">ekt</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span>
<a name="ln-255"></a>        <span class="k">end if</span>
<a name="ln-256"></a><span class="k">       end do</span>
<a name="ln-257"></a><span class="k">      end do</span>
<a name="ln-258"></a><span class="k">     end do</span>
<a name="ln-259"></a><span class="k">    end if</span>
<a name="ln-260"></a><span class="k">   end do</span>
<a name="ln-261"></a><span class="k">   if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-262"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lp_ionz_in</span> <span class="o">&gt;</span> <span class="n">xm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-263"></a><span class="k">     </span><span class="n">ic</span> <span class="o">=</span> <span class="n">nb_laser</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-264"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-265"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-266"></a>       <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-267"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lp_ionz_in</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">lp_ionz_end</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-268"></a><span class="k">         </span><span class="n">a2</span> <span class="o">=</span> <span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-269"></a>         <span class="n">xcm</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">xcm</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">*</span><span class="n">a2</span>
<a name="ln-270"></a>         <span class="n">ekt</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span>
<a name="ln-271"></a>        <span class="k">end if</span>
<a name="ln-272"></a><span class="k">       end do</span>
<a name="ln-273"></a><span class="k">      end do</span>
<a name="ln-274"></a><span class="k">     end do</span>
<a name="ln-275"></a><span class="k">    end if</span>
<a name="ln-276"></a><span class="k">   end if</span>
<a name="ln-277"></a><span class="k">   </span><span class="n">eks</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_tot</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_tot</span><span class="p">)</span>
<a name="ln-278"></a>   <span class="n">xcms</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_tot</span><span class="p">)</span> <span class="o">=</span> <span class="n">xcm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_tot</span><span class="p">)</span>
<a name="ln-279"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">eks</span><span class="p">,</span> <span class="n">nb_tot</span><span class="p">)</span>
<a name="ln-280"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">xcm</span><span class="p">,</span> <span class="n">xcms</span><span class="p">,</span> <span class="n">nb_tot</span><span class="p">)</span>
<a name="ln-281"></a>   <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb_tot</span>
<a name="ln-282"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">eks</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">eavg</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">xcms</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">eks</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!Sum(xE^2)/sum(E^2)</span>
<a name="ln-283"></a>   <span class="k">end do</span>
<a name="ln-284"></a>   <span class="c">!=================</span>
<a name="ln-285"></a>  <span class="k">end subroutine</span>
<a name="ln-286"></a>
<a name="ln-287"></a><span class="k">  subroutine </span><span class="n">envelope_struct_data</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-288"></a>
<a name="ln-289"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-290"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-291"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span><span class="p">,</span> <span class="n">i0_lp</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-292"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-293"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">dgvol</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span>
<a name="ln-294"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dar</span><span class="p">,</span> <span class="n">dai</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">aph1</span><span class="p">,</span> <span class="n">aph2</span>
<a name="ln-295"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">field_energy</span> <span class="o">=</span> <span class="mf">1.156e-06</span>
<a name="ln-296"></a>
<a name="ln-297"></a>   <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dz</span>
<a name="ln-298"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-299"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-300"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-301"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-302"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">nxp</span>
<a name="ln-303"></a>
<a name="ln-304"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-305"></a>
<a name="ln-306"></a>   <span class="c">! env(1)=Re[A], env(2)=Im[A] A in adimensional form</span>
<a name="ln-307"></a>   <span class="n">aph1</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dx_inv</span>
<a name="ln-308"></a>   <span class="n">aph2</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-309"></a>   <span class="n">i01</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-310"></a>   <span class="n">i02</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-311"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">der_ord</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-312"></a><span class="k">    </span><span class="n">aph1</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">dx_inv</span><span class="o">/</span><span class="mf">3.</span>
<a name="ln-313"></a>    <span class="n">aph2</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx_inv</span><span class="o">/</span><span class="mf">6.</span>
<a name="ln-314"></a>    <span class="n">i01</span> <span class="o">=</span> <span class="n">i01</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-315"></a>    <span class="n">i02</span> <span class="o">=</span> <span class="n">i02</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-316"></a>   <span class="k">end if</span>
<a name="ln-317"></a><span class="k">   </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-318"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-319"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-320"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-321"></a>      <span class="n">ik</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-322"></a>      <span class="n">dar</span> <span class="o">=</span> <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-323"></a>            <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-324"></a>      <span class="n">dai</span> <span class="o">=</span> <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-325"></a>            <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-326"></a>      <span class="n">a2</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-327"></a>           <span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-328"></a>
<a name="ln-329"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">a2</span> <span class="c">! Centroid</span>
<a name="ln-330"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span> <span class="c">! !A|^2</span>
<a name="ln-331"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">dai</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dar</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-332"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">oml</span><span class="o">*</span><span class="n">oml</span><span class="o">*</span><span class="n">a2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">oml</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">dar</span><span class="o">*</span><span class="n">dar</span> <span class="o">+</span> <span class="n">dai</span><span class="o">*</span><span class="n">dai</span>
<a name="ln-333"></a>      <span class="c">!|Z|^2=(Ey^2+Bz^2)/2= field energy</span>
<a name="ln-334"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">oml</span><span class="o">*</span><span class="n">a2</span> <span class="o">+</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">! Action</span>
<a name="ln-335"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">))</span> <span class="c">! Max |A|</span>
<a name="ln-336"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-337"></a>     <span class="k">end do</span>
<a name="ln-338"></a><span class="k">    end do</span>
<a name="ln-339"></a><span class="k">   end do</span>
<a name="ln-340"></a><span class="k">   </span><span class="n">dvol</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-341"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-342"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-343"></a><span class="k">    </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Centroid</span>
<a name="ln-344"></a>   <span class="k">end if</span>
<a name="ln-345"></a><span class="k">   </span><span class="n">eavg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!Centroid</span>
<a name="ln-346"></a>   <span class="n">eavg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">field_energy</span><span class="o">*</span><span class="n">dgvol</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">!Energy</span>
<a name="ln-347"></a>   <span class="n">eavg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">dvol</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">!Action</span>
<a name="ln-348"></a>   <span class="c">!===============</span>
<a name="ln-349"></a>   <span class="n">i0_lp</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-350"></a>   <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-351"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-352"></a>    <span class="n">zz</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-353"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">k1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-354"></a><span class="k">     </span><span class="n">k</span> <span class="o">=</span> <span class="n">iz</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-355"></a>     <span class="n">zz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-356"></a>    <span class="k">end if</span>
<a name="ln-357"></a><span class="k">    do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-358"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-359"></a>     <span class="n">yy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-360"></a>     <span class="n">rr</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">zz</span><span class="o">*</span><span class="n">zz</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span>
<a name="ln-361"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-362"></a>      <span class="n">a2</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-363"></a>           <span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">env</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-364"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">rr</span><span class="o">*</span><span class="n">a2</span>
<a name="ln-365"></a>     <span class="k">end do</span>
<a name="ln-366"></a><span class="k">    end do</span>
<a name="ln-367"></a><span class="k">   end do</span>
<a name="ln-368"></a><span class="k">   call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-369"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-370"></a><span class="k">    </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">! env radius</span>
<a name="ln-371"></a>   <span class="k">end if</span>
<a name="ln-372"></a><span class="k">   </span><span class="n">eavg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!radius</span>
<a name="ln-373"></a>   <span class="c">!===============</span>
<a name="ln-374"></a>   <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-375"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">giant_field</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-376"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; WARNING: Env field too big &#39;</span><span class="p">,</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-377"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a23,3i4)&#39;</span><span class="p">)</span> <span class="s1">&#39; At the mpi_task=&#39;</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-378"></a>   <span class="k">end if</span>
<a name="ln-379"></a><span class="k">   </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-380"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">prl</span><span class="p">)</span> <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">maxv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-381"></a>   <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-382"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-383"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-384"></a>    <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-385"></a>    <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-386"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-387"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-388"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-389"></a>       <span class="n">dar</span> <span class="o">=</span> <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-390"></a>             <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-391"></a>       <span class="n">dai</span> <span class="o">=</span> <span class="n">aph1</span><span class="o">*</span><span class="p">(</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-392"></a>             <span class="n">aph2</span><span class="o">*</span><span class="p">(</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-393"></a>       <span class="n">a2</span> <span class="o">=</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-394"></a>            <span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-395"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">a2</span> <span class="c">! Centroid</span>
<a name="ln-396"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span> <span class="c">! !A|^2</span>
<a name="ln-397"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">dai</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dar</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-398"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">om1</span><span class="o">*</span><span class="n">om1</span><span class="o">*</span><span class="n">a2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">om1</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">dar</span><span class="o">*</span><span class="n">dar</span> <span class="o">+</span> <span class="n">dai</span><span class="o">*</span><span class="n">dai</span>
<a name="ln-399"></a>       <span class="c">!|Z|^2=(Ey^2+Bz^2)/2= field energy</span>
<a name="ln-400"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">om1</span><span class="o">*</span><span class="n">a2</span> <span class="o">+</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">! Action</span>
<a name="ln-401"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">))</span> <span class="c">! Max |A|</span>
<a name="ln-402"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-403"></a>      <span class="k">end do</span>
<a name="ln-404"></a><span class="k">     end do</span>
<a name="ln-405"></a><span class="k">    end do</span>
<a name="ln-406"></a><span class="k">    </span><span class="n">dvol</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-407"></a>    <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-408"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-409"></a><span class="k">     </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">!Centroid</span>
<a name="ln-410"></a>    <span class="k">end if</span>
<a name="ln-411"></a><span class="k">    </span><span class="n">eavg1</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-412"></a>    <span class="n">eavg1</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">field_energy</span><span class="o">*</span><span class="n">dgvol</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">!Energy</span>
<a name="ln-413"></a>    <span class="n">eavg1</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">dvol</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">!Action</span>
<a name="ln-414"></a>    <span class="c">!===============</span>
<a name="ln-415"></a>    <span class="n">i0_lp</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">dx_inv</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-416"></a>    <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-417"></a>    <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-418"></a>     <span class="n">zz</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-419"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">k1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-420"></a><span class="k">      </span><span class="n">k</span> <span class="o">=</span> <span class="n">iz</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-421"></a>      <span class="n">zz</span> <span class="o">=</span> <span class="n">loc_zg</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-422"></a>     <span class="k">end if</span>
<a name="ln-423"></a><span class="k">     do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-424"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-425"></a>      <span class="n">yy</span> <span class="o">=</span> <span class="n">loc_yg</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-426"></a>      <span class="n">rr</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">zz</span><span class="o">*</span><span class="n">zz</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span>
<a name="ln-427"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i01</span><span class="p">,</span> <span class="n">i02</span>
<a name="ln-428"></a>       <span class="n">a2</span> <span class="o">=</span> <span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-429"></a>            <span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">env1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-430"></a>       <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">rr</span><span class="o">*</span><span class="n">a2</span>
<a name="ln-431"></a>      <span class="k">end do</span>
<a name="ln-432"></a><span class="k">     end do</span>
<a name="ln-433"></a><span class="k">    end do</span>
<a name="ln-434"></a><span class="k">    call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-435"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-436"></a><span class="k">     </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">! env radius</span>
<a name="ln-437"></a>    <span class="k">end if</span>
<a name="ln-438"></a><span class="k">    </span><span class="n">eavg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!radius</span>
<a name="ln-439"></a>    <span class="c">!===============</span>
<a name="ln-440"></a>    <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-441"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">giant_field</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-442"></a><span class="k">     write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; WARNING: Env1 field too big &#39;</span><span class="p">,</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-443"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a23,3i4)&#39;</span><span class="p">)</span> <span class="s1">&#39; At the mpi_task=&#39;</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-444"></a>    <span class="k">end if</span>
<a name="ln-445"></a><span class="k">    </span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-446"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">prl</span><span class="p">)</span> <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">maxv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-447"></a>    <span class="n">eavg1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-448"></a>   <span class="k">end if</span>
<a name="ln-449"></a><span class="k">  end subroutine</span>
<a name="ln-450"></a>  <span class="c">!===========================</span>
<a name="ln-451"></a>  <span class="k">subroutine </span><span class="n">fields_on_target</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-452"></a>
<a name="ln-453"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-454"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-455"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span>
<a name="ln-456"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-457"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dgvol</span>
<a name="ln-458"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">field_energy</span> <span class="o">=</span> <span class="mf">1.156e-06</span>
<a name="ln-459"></a>
<a name="ln-460"></a>   <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dz</span>
<a name="ln-461"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-462"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-463"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-464"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-465"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">nxp</span>
<a name="ln-466"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-467"></a>   <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-468"></a>    <span class="n">ii</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-469"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">targ_in</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-470"></a><span class="k">     do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-471"></a>      <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-472"></a>       <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-473"></a>        <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-474"></a>       <span class="k">end do</span>
<a name="ln-475"></a><span class="k">      end do</span>
<a name="ln-476"></a><span class="k">     end do</span>
<a name="ln-477"></a><span class="k">    end if</span>
<a name="ln-478"></a><span class="k">   end do</span>
<a name="ln-479"></a><span class="k">   </span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">dgvol</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">)</span>
<a name="ln-480"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span>
<a name="ln-481"></a>   <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">field_energy</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">)</span>
<a name="ln-482"></a>   <span class="c">!=======================</span>
<a name="ln-483"></a>  <span class="k">end subroutine</span>
<a name="ln-484"></a>
<a name="ln-485"></a><span class="k">  subroutine </span><span class="n">Envar</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-486"></a>
<a name="ln-487"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-488"></a>
<a name="ln-489"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">np</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-490"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span>
<a name="ln-491"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ek_max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ekmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-492"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">dgvol</span><span class="p">,</span> <span class="n">sgz</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">ef2</span>
<a name="ln-493"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">p_energy_norm</span>
<a name="ln-494"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">mev_to_joule</span> <span class="o">=</span> <span class="mf">1.602e-13</span>
<a name="ln-495"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">field_energy</span> <span class="o">=</span> <span class="mf">1.156e-06</span>
<a name="ln-496"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">zg_ind</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a name="ln-497"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">yg_ind</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<a name="ln-498"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">xg_ind</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<a name="ln-499"></a>   <span class="c">!================================================</span>
<a name="ln-500"></a>   <span class="c">! field_energy transforms the energy density u=E^2/2 in adimensional</span>
<a name="ln-501"></a>   <span class="c">! form to energy density in Joule/mu^3</span>
<a name="ln-502"></a>   <span class="c">! field_energy =epsilon_0*(E_0^2)/2 in SI or</span>
<a name="ln-503"></a>   <span class="c">!              =(E_0^2)/8pi         in cgs (Gaussian) units</span>
<a name="ln-504"></a>   <span class="c">!==================================================</span>
<a name="ln-505"></a>
<a name="ln-506"></a>   <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dz</span>
<a name="ln-507"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">dgvol</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-508"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-509"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-510"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-511"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-512"></a>   <span class="n">i2</span> <span class="o">=</span> <span class="n">nxp</span>
<a name="ln-513"></a>
<a name="ln-514"></a>   <span class="n">tloc</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">tnow</span>
<a name="ln-515"></a>   <span class="n">tsp</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">tnow</span>
<a name="ln-516"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nst</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-517"></a><span class="k">    </span><span class="n">pavg</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-518"></a>    <span class="n">favg</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-519"></a>    <span class="n">eavg</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-520"></a>    <span class="n">nde_sp</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-521"></a>    <span class="n">nde_sm</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-522"></a>    <span class="n">nde</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-523"></a>   <span class="k">end if</span>
<a name="ln-524"></a><span class="k">   </span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">nz</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-525"></a>   <span class="n">dvol</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-526"></a>
<a name="ln-527"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-528"></a><span class="k">    </span><span class="n">p_energy_norm</span> <span class="o">=</span> <span class="n">np_per_cell</span><span class="o">*</span><span class="n">mev_to_joule</span>
<a name="ln-529"></a>    <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-530"></a>     <span class="n">ekm</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-531"></a>     <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-532"></a>     <span class="n">ekmax</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-533"></a>     <span class="n">ek_max</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-534"></a>     <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-535"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-536"></a>     <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-537"></a>     <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-538"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-539"></a>     <span class="n">pmass</span> <span class="o">=</span> <span class="n">electron_mass</span><span class="o">*</span><span class="n">mass</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="c">!In MeV</span>
<a name="ln-540"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-541"></a>     <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-542"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-543"></a><span class="k">      call </span><span class="n">energy_momenta</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekmax</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-544"></a>      <span class="c">!  WARNING: total variables multipied by a weight = 1/nmacro_per cell</span>
<a name="ln-545"></a>      <span class="c">!  Momenta ekt(1:3) are averaged by the macroparticle total number</span>
<a name="ln-546"></a>      <span class="c">!==================================</span>
<a name="ln-547"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">!Total angular momentum (Mev/c^2)</span>
<a name="ln-548"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c">!the ic-species TOTAL energy (MeV)</span>
<a name="ln-549"></a>      <span class="n">ekmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="n">ekmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-550"></a>
<a name="ln-551"></a>     <span class="k">end if</span>
<a name="ln-552"></a><span class="k">     call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">maxv</span><span class="p">,</span> <span class="n">ekmax</span><span class="p">,</span> <span class="n">ek_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-553"></a>     <span class="c">!============= spectra section</span>
<a name="ln-554"></a>     <span class="n">nde0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-555"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">energy_spect</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ek_max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ebfp</span><span class="p">)</span>
<a name="ln-556"></a>     <span class="n">nde1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-557"></a>     <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">nde0</span><span class="p">,</span> <span class="n">nde1</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
<a name="ln-558"></a>     <span class="n">nde</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-559"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">solid_target</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-560"></a><span class="k">      </span><span class="n">nde0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-561"></a>      <span class="n">nde1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-562"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">select_energy_spect</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ek_max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">targ_in</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-563"></a>                                           <span class="n">targ_end</span><span class="p">,</span> <span class="n">ebfp</span><span class="p">)</span>
<a name="ln-564"></a>      <span class="n">nde2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-565"></a>      <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">nde0</span><span class="p">,</span> <span class="n">nde2</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
<a name="ln-566"></a>      <span class="n">nde_sm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-567"></a>      <span class="n">nde2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-568"></a>      <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">nde1</span><span class="p">,</span> <span class="n">nde2</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
<a name="ln-569"></a>      <span class="n">nde_sp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">nde2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">)</span>
<a name="ln-570"></a>     <span class="k">end if</span>
<a name="ln-571"></a>     <span class="c">!======================= end spectra section</span>
<a name="ln-572"></a>     <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-573"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_ndim</span>
<a name="ln-574"></a>      <span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">np_norm</span> <span class="c">!Average Momenta</span>
<a name="ln-575"></a>     <span class="k">end do</span>
<a name="ln-576"></a>     <span class="c">!======================= phase space integrated data for each species</span>
<a name="ln-577"></a>     <span class="n">eksp_max</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek_max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-578"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">p_energy_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c">!Total energy of ic species (Joule)</span>
<a name="ln-579"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ek_max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! Max energy (MeV)</span>
<a name="ln-580"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">mev_to_joule</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">!total angular Momenta</span>
<a name="ln-581"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmass</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="c">!averaged linear Momenta (MeV/c)</span>
<a name="ln-582"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">!Mean charge</span>
<a name="ln-583"></a>     <span class="n">pavg</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">dvol</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">!Charge per cell</span>
<a name="ln-584"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-585"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-586"></a><span class="k">      do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_ndim</span>
<a name="ln-587"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="n">curr_ndim</span>
<a name="ln-588"></a>       <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-589"></a>        <span class="n">sg</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span> <span class="o">-</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-590"></a>        <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">sg</span><span class="o">*</span><span class="n">sg</span> <span class="c">! &lt;[p -&lt;p&gt;]^2&gt;, p=gamma*v/c</span>
<a name="ln-591"></a>       <span class="k">end do</span>
<a name="ln-592"></a><span class="k">      end do</span>
<a name="ln-593"></a><span class="k">     end if</span>
<a name="ln-594"></a><span class="k">     call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-595"></a>     <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-596"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_ndim</span>
<a name="ln-597"></a>      <span class="n">pavg</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">ik</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.e+03</span><span class="o">*</span><span class="n">pmass</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="c">!</span>
<a name="ln-598"></a>      <span class="c">!sigma^2 of particle momenta (in KeV)</span>
<a name="ln-599"></a>     <span class="k">end do</span>
<a name="ln-600"></a><span class="k">    end do</span>
<a name="ln-601"></a><span class="k">   end if</span>
<a name="ln-602"></a>
<a name="ln-603"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ionization</span><span class="p">)</span> <span class="k">call </span><span class="n">enb_ionz</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">tnow</span><span class="p">,</span> <span class="n">gam_min</span><span class="p">)</span> <span class="c">!select ioniz.electrons with gamma &gt; gam_min</span>
<a name="ln-604"></a>
<a name="ln-605"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">high_gamma</span><span class="p">)</span> <span class="k">call </span><span class="n">enb_hgam</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">tnow</span><span class="p">,</span> <span class="n">gam_min</span><span class="p">)</span>
<a name="ln-606"></a>
<a name="ln-607"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">inject_beam</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-608"></a><span class="k">    </span><span class="n">bunch_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-609"></a>    <span class="n">tbunch</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">tnow</span>
<a name="ln-610"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsb</span>
<a name="ln-611"></a>     <span class="k">call </span><span class="n">enb_bunch</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-612"></a>    <span class="k">end do</span>
<a name="ln-613"></a><span class="k">   </span><span class="n">endif</span>
<a name="ln-614"></a>
<a name="ln-615"></a>   <span class="c">!   END PARTICLE SECTION</span>
<a name="ln-616"></a>   <span class="c">!======================== Field  section</span>
<a name="ln-617"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-618"></a>   <span class="n">ekm</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-619"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">stretch</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-620"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-621"></a><span class="k">     do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-622"></a>      <span class="n">k</span> <span class="o">=</span> <span class="n">zg_ind</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="c">!staggering of stretched grid cell</span>
<a name="ln-623"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">yg_ind</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-624"></a>      <span class="n">l</span> <span class="o">=</span> <span class="n">xg_ind</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-625"></a>      <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-626"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">iz</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-627"></a>       <span class="n">sgz</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">loc_zg</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">imodz</span><span class="p">)</span>
<a name="ln-628"></a>       <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-629"></a>        <span class="n">jj</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-630"></a>        <span class="n">sg</span> <span class="o">=</span> <span class="n">sgz</span><span class="o">/</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-631"></a>        <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-632"></a>         <span class="n">ii</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-633"></a>         <span class="n">dvol</span> <span class="o">=</span> <span class="n">sg</span><span class="o">/</span><span class="n">loc_xg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span>
<a name="ln-634"></a>         <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">dvol</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span> <span class="p">&amp;</span>
<a name="ln-635"></a>                                                          <span class="p">)</span>
<a name="ln-636"></a>        <span class="k">end do</span>
<a name="ln-637"></a><span class="k">       end do</span>
<a name="ln-638"></a><span class="k">      end do</span>
<a name="ln-639"></a><span class="k">     end do</span>
<a name="ln-640"></a><span class="k">    else</span>
<a name="ln-641"></a><span class="k">     do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-642"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">yg_ind</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-643"></a>      <span class="n">l</span> <span class="o">=</span> <span class="n">xg_ind</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-644"></a>      <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-645"></a>       <span class="n">sgz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-646"></a>       <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-647"></a>        <span class="n">jj</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-648"></a>        <span class="n">sg</span> <span class="o">=</span> <span class="n">sgz</span><span class="o">/</span><span class="n">loc_yg</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">imody</span><span class="p">)</span>
<a name="ln-649"></a>        <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-650"></a>         <span class="n">ii</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">2</span>
<a name="ln-651"></a>         <span class="n">dvol</span> <span class="o">=</span> <span class="n">sg</span><span class="o">/</span><span class="n">loc_xg</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span>
<a name="ln-652"></a>         <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">dvol</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span> <span class="p">&amp;</span>
<a name="ln-653"></a>                                                          <span class="p">)</span>
<a name="ln-654"></a>        <span class="k">end do</span>
<a name="ln-655"></a><span class="k">       end do</span>
<a name="ln-656"></a><span class="k">      end do</span>
<a name="ln-657"></a><span class="k">     end do</span>
<a name="ln-658"></a><span class="k">    end if</span>
<a name="ln-659"></a><span class="k">   else</span>
<a name="ln-660"></a><span class="k">    do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-661"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-662"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-663"></a>       <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-664"></a>        <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">+</span> <span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-665"></a>       <span class="k">end do</span>
<a name="ln-666"></a><span class="k">      end do</span>
<a name="ln-667"></a><span class="k">     end do</span>
<a name="ln-668"></a><span class="k">    end do</span>
<a name="ln-669"></a><span class="k">   end if</span>
<a name="ln-670"></a><span class="k">   </span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">)</span> <span class="o">=</span> <span class="n">dgvol</span><span class="o">*</span><span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfield</span><span class="p">)</span>
<a name="ln-671"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="n">nfield</span><span class="p">)</span>
<a name="ln-672"></a>   <span class="n">favg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">field_energy</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="c">!field itotal energy (in Joule)</span>
<a name="ln-673"></a>   <span class="n">favg</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">field_energy</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-674"></a>
<a name="ln-675"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-676"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-677"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-678"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-679"></a>      <span class="n">ef2</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">curr_ndim</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-680"></a>                        <span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">curr_ndim</span><span class="p">))</span>
<a name="ln-681"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ef2</span><span class="p">)</span>
<a name="ln-682"></a>     <span class="k">end do</span>
<a name="ln-683"></a><span class="k">    end do</span>
<a name="ln-684"></a><span class="k">   end do</span>
<a name="ln-685"></a><span class="k">   do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-686"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ebf</span><span class="p">(</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">:</span><span class="n">nyp</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span><span class="n">nzp</span><span class="p">,</span> <span class="n">ik</span><span class="p">)))</span>
<a name="ln-687"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">giant_field</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-688"></a><span class="k">     write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; WARNING: Ebf field too big at component=&#39;</span><span class="p">,</span> <span class="n">ik</span>
<a name="ln-689"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;max fields&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-690"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span>
<a name="ln-691"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span>
<a name="ln-692"></a>       <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
<a name="ln-693"></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ebf</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span> <span class="o">-</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ik</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">epsilon</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-694"></a><span class="k">         </span><span class="n">ii</span> <span class="o">=</span> <span class="n">ix</span>
<a name="ln-695"></a>         <span class="n">jj</span> <span class="o">=</span> <span class="n">iy</span>
<a name="ln-696"></a>         <span class="n">kk</span> <span class="o">=</span> <span class="n">iz</span>
<a name="ln-697"></a>        <span class="k">end if</span>
<a name="ln-698"></a><span class="k">       end do</span>
<a name="ln-699"></a><span class="k">      end do</span>
<a name="ln-700"></a><span class="k">     end do</span>
<a name="ln-701"></a><span class="k">     write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a23,3i4)&#39;</span><span class="p">)</span> <span class="s1">&#39; At the mpi_task=&#39;</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-702"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a19,3i6)&#39;</span><span class="p">)</span> <span class="s1">&#39; At the local grid=&#39;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-703"></a>    <span class="k">end if</span>
<a name="ln-704"></a><span class="k">   end do</span>
<a name="ln-705"></a><span class="k">   </span><span class="n">ekm</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! Max values</span>
<a name="ln-706"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">maxv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-707"></a>   <span class="n">favg</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">e0</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="c">!Max fields in TV/m</span>
<a name="ln-708"></a>   <span class="n">favg</span><span class="p">(</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">e0</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-709"></a>   <span class="c">!=====================================</span>
<a name="ln-710"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-711"></a><span class="k">    if</span> <span class="p">(</span><span class="n">envelope</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-712"></a><span class="k">     call </span><span class="n">envelope_struct_data</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-713"></a>     <span class="c">!else</span>
<a name="ln-714"></a>     <span class="c">! call laser_struct_data(nst)</span>
<a name="ln-715"></a>    <span class="k">end if</span>
<a name="ln-716"></a><span class="k">   end if</span>
<a name="ln-717"></a><span class="k">   if</span> <span class="p">(</span><span class="n">solid_target</span><span class="p">)</span> <span class="k">call </span><span class="n">fields_on_target</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-718"></a>
<a name="ln-719"></a>  <span class="k">end subroutine</span>
<a name="ln-720"></a>  <span class="c">!--------------------------</span>
<a name="ln-721"></a>  <span class="k">subroutine </span><span class="n">bunch_corr</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">np_loc</span><span class="p">,</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">)</span>
<a name="ln-722"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">bch</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-723"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_loc</span>
<a name="ln-724"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-725"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_norm</span>
<a name="ln-726"></a>
<a name="ln-727"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ndv</span>
<a name="ln-728"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gmb</span><span class="p">,</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">mu</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-729"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">emy</span><span class="p">,</span> <span class="n">emz</span><span class="p">,</span> <span class="n">dgam</span><span class="p">,</span> <span class="n">w_norm</span>
<a name="ln-730"></a>   <span class="c">!=====================</span>
<a name="ln-731"></a>   <span class="n">bcorr</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-732"></a>   <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-733"></a>   <span class="n">corr2</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-734"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">curr_ndim</span>
<a name="ln-735"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-736"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-737"></a><span class="k">    if</span> <span class="p">(</span><span class="n">curr_ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-738"></a><span class="k">     do </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_loc</span>
<a name="ln-739"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-740"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="c">! &lt;w*X&gt;  &lt;w*Y&gt;</span>
<a name="ln-741"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-742"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-743"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-744"></a>      <span class="n">gmb</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-745"></a>      <span class="n">ekt</span><span class="p">(</span><span class="n">ndv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ndv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">gmb</span>
<a name="ln-746"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-747"></a>     <span class="k">end do</span>
<a name="ln-748"></a><span class="k">     </span><span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="n">ndv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! &lt;w*gam&gt;</span>
<a name="ln-749"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! &lt;w*Pz&gt;</span>
<a name="ln-750"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">! &lt;w*Py&gt;</span>
<a name="ln-751"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">! &lt;w*Px&gt;</span>
<a name="ln-752"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! &lt;w*z&gt;</span>
<a name="ln-753"></a>    <span class="k">else</span>
<a name="ln-754"></a><span class="k">     do </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_loc</span>
<a name="ln-755"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-756"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="c">! weight*(X,Y,Z) coordinates</span>
<a name="ln-757"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-758"></a>      <span class="n">gmb</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-759"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-760"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">gmb</span>
<a name="ln-761"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-762"></a>     <span class="k">end do</span>
<a name="ln-763"></a><span class="k">    end if</span>
<a name="ln-764"></a><span class="k">   end if</span>
<a name="ln-765"></a><span class="k">   call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a name="ln-766"></a>   <span class="n">w_norm</span> <span class="o">=</span> <span class="n">np_norm</span>
<a name="ln-767"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">w_norm</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-768"></a>   <span class="c">!===================</span>
<a name="ln-769"></a>   <span class="n">mu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="c">!weighted averages &lt;(x,y,z)&gt;</span>
<a name="ln-770"></a>   <span class="n">mu</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="c">!weighted averages &lt;(Px,Py,Pz,gamma)&gt;</span>
<a name="ln-771"></a>   <span class="c">!=========== 2th moments</span>
<a name="ln-772"></a>   <span class="n">ekm</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-773"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-774"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-775"></a><span class="k">    if</span> <span class="p">(</span><span class="n">curr_ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-776"></a><span class="k">     do </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_loc</span>
<a name="ln-777"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-778"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-779"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-780"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-781"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! &lt;w*p*p&gt;</span>
<a name="ln-782"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-783"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c">! &lt;y*w*py&gt;</span>
<a name="ln-784"></a>      <span class="n">gmb</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-785"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">gmb</span> <span class="c">! &lt;w*gam**2&gt;</span>
<a name="ln-786"></a>     <span class="k">end do</span>
<a name="ln-787"></a><span class="k">     </span><span class="n">ekt</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! &lt;Pz*Pz&gt;</span>
<a name="ln-788"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! &lt;z*Pz)</span>
<a name="ln-789"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">! &lt;Py*Py&gt;</span>
<a name="ln-790"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">! &lt;Px*Px&gt;</span>
<a name="ln-791"></a>     <span class="n">ekt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c">! &lt;z*z&gt;</span>
<a name="ln-792"></a>    <span class="k">else</span>
<a name="ln-793"></a><span class="k">     do </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np_loc</span>
<a name="ln-794"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-795"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-796"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-797"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-798"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c">! &lt;y*w*py&gt;</span>
<a name="ln-799"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">bch</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c">! &lt;z*w*pz&gt;</span>
<a name="ln-800"></a>      <span class="n">gmb</span> <span class="o">=</span> <span class="n">wgh</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-801"></a>      <span class="n">ekt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="n">gmb</span> <span class="c">! &lt;(w*gam**2&gt;</span>
<a name="ln-802"></a>     <span class="k">end do</span>
<a name="ln-803"></a><span class="k">    end if</span>
<a name="ln-804"></a><span class="k">   end if</span>
<a name="ln-805"></a><span class="k">   call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<a name="ln-806"></a>   <span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_norm</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-807"></a>
<a name="ln-808"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span>
<a name="ln-809"></a>    <span class="n">corr2</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="c">! &lt;UU&gt;-&lt;U&gt;&lt;U&gt;   U[X,Y,Z,Px,Py,Pz]</span>
<a name="ln-810"></a>   <span class="k">end do</span>
<a name="ln-811"></a><span class="k">   </span><span class="n">corr2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-812"></a>   <span class="n">corr2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-813"></a>   <span class="c">!    emy^2= corr2_y*corr2_py -mixed</span>
<a name="ln-814"></a>   <span class="c">! &lt;yy&gt;&lt;p_yp_y&gt;-(&lt;yp_y&gt;-&lt;y&gt;&lt;p_y&gt;)^2</span>
<a name="ln-815"></a>   <span class="n">emy</span> <span class="o">=</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">corr2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">corr2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-816"></a>   <span class="n">emz</span> <span class="o">=</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">corr2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">corr2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-817"></a>   <span class="n">gmb</span> <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c">! &lt;gam&gt;&lt;gam&gt;</span>
<a name="ln-818"></a>   <span class="n">dgam</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-819"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">gmb</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">dgam</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">/</span><span class="n">gmb</span> <span class="o">-</span> <span class="mf">1.0</span>
<a name="ln-820"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dgam</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">dgam</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">dgam</span><span class="p">)</span> <span class="c">!Dgamm/gamma</span>
<a name="ln-821"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-822"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">corr2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-823"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">=</span> <span class="n">emy</span>
<a name="ln-824"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="n">emz</span>
<a name="ln-825"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-826"></a>   <span class="n">bcorr</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">dgam</span>
<a name="ln-827"></a>   <span class="c">!==========================</span>
<a name="ln-828"></a>  <span class="k">end subroutine</span>
<a name="ln-829"></a><span class="c">!===========================</span>
<a name="ln-830"></a>  <span class="k">subroutine </span><span class="n">enb_bunch</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-831"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">ib</span>
<a name="ln-832"></a>
<a name="ln-833"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-834"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-835"></a>
<a name="ln-836"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-837"></a>   <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-838"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-839"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-840"></a><span class="k">    select case</span> <span class="p">(</span><span class="n">curr_ndim</span><span class="p">)</span>
<a name="ln-841"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-842"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-843"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-844"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">==</span> <span class="n">ib</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-845"></a><span class="k">       </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-846"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-847"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-848"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-849"></a>       <span class="k">end do</span>
<a name="ln-850"></a><span class="k">      end if</span>
<a name="ln-851"></a><span class="k">     end do</span>
<a name="ln-852"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-853"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-854"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-855"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">==</span> <span class="n">ib</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-856"></a><span class="k">       </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-857"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-858"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-859"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-860"></a>       <span class="k">end do</span>
<a name="ln-861"></a><span class="k">      end if</span>
<a name="ln-862"></a><span class="k">     end do</span>
<a name="ln-863"></a><span class="k">    end select</span>
<a name="ln-864"></a><span class="k">   end if</span>
<a name="ln-865"></a>   <span class="c">!================================</span>
<a name="ln-866"></a>   <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-867"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-868"></a>   <span class="n">bunch_number</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-869"></a>   <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-870"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-871"></a>   <span class="k">call </span><span class="n">bunch_corr</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">)</span>
<a name="ln-872"></a>   <span class="n">bunch_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span> <span class="o">=</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-873"></a>   <span class="n">bcharge</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span> <span class="o">=</span> <span class="n">e_charge</span><span class="o">*</span><span class="n">np_per_cell</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-874"></a>  <span class="k">end subroutine</span>
<a name="ln-875"></a><span class="c">!============================================</span>
<a name="ln-876"></a>  <span class="k">subroutine </span><span class="n">enb_ionz</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">gmm</span><span class="p">)</span>
<a name="ln-877"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-878"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">gmm</span>
<a name="ln-879"></a>
<a name="ln-880"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-881"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-882"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nb">gamma</span>
<a name="ln-883"></a><span class="nb">   </span><span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ch_ion</span>
<a name="ln-884"></a>
<a name="ln-885"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-886"></a>   <span class="n">ch_ion</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">wgh_ion</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-887"></a>   <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-888"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-889"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-890"></a><span class="k">    select case</span> <span class="p">(</span><span class="n">curr_ndim</span><span class="p">)</span>
<a name="ln-891"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-892"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-893"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-894"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-895"></a>      <span class="nb">gamma</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-896"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-897"></a><span class="k">       if</span> <span class="p">(</span><span class="nb">gamma</span> <span class="o">&gt;</span> <span class="n">gmm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-898"></a><span class="k">        </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-899"></a>        <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-900"></a>        <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-901"></a>         <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-902"></a>        <span class="k">end do</span>
<a name="ln-903"></a><span class="k">       end if</span>
<a name="ln-904"></a><span class="k">      end if</span>
<a name="ln-905"></a><span class="k">     end do</span>
<a name="ln-906"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-907"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-908"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-909"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-910"></a>      <span class="nb">gamma</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-911"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-912"></a><span class="k">       if</span> <span class="p">(</span><span class="nb">gamma</span> <span class="o">&gt;</span> <span class="n">gmm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-913"></a><span class="k">        </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-914"></a>        <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-915"></a>        <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-916"></a>         <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-917"></a>        <span class="k">end do</span>
<a name="ln-918"></a><span class="k">       end if</span>
<a name="ln-919"></a><span class="k">      end if</span>
<a name="ln-920"></a><span class="k">     end do</span>
<a name="ln-921"></a><span class="k">    end select</span>
<a name="ln-922"></a><span class="k">   end if</span>
<a name="ln-923"></a><span class="k">   </span><span class="n">ionz_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-924"></a>   <span class="n">tionz</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_loc</span>
<a name="ln-925"></a>   <span class="c">!================================</span>
<a name="ln-926"></a>   <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-927"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-928"></a>   <span class="n">ionz_number</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-929"></a>   <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-930"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-931"></a>   <span class="k">call </span><span class="n">bunch_corr</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">)</span>
<a name="ln-932"></a>   <span class="n">ionz_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-933"></a>   <span class="n">ionz_charge</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">e_charge</span><span class="o">*</span><span class="n">np_per_cell</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-934"></a>  <span class="k">end subroutine</span>
<a name="ln-935"></a>  <span class="c">!============================</span>
<a name="ln-936"></a>  <span class="k">subroutine </span><span class="n">enb_hgam</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">gmm</span><span class="p">)</span>
<a name="ln-937"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span>
<a name="ln-938"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">gmm</span>
<a name="ln-939"></a>
<a name="ln-940"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-941"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-942"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nb">gamma</span>
<a name="ln-943"></a>
<a name="ln-944"></a><span class="nb">   </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-945"></a>   <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-946"></a>   <span class="n">ekt</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-947"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-948"></a><span class="k">    select case</span> <span class="p">(</span><span class="n">curr_ndim</span><span class="p">)</span>
<a name="ln-949"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-950"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-951"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-952"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-953"></a>      <span class="nb">gamma</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-954"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">gamma</span> <span class="o">&gt;</span> <span class="n">gmm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-955"></a><span class="k">       </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-956"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-957"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-958"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-959"></a>       <span class="k">end do</span>
<a name="ln-960"></a><span class="k">      end if</span>
<a name="ln-961"></a><span class="k">     end do</span>
<a name="ln-962"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-963"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-964"></a>      <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-965"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-966"></a>      <span class="nb">gamma</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-967"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">gamma</span> <span class="o">&gt;</span> <span class="n">gmm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-968"></a><span class="k">       </span><span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">wgh</span>
<a name="ln-969"></a>       <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-970"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-971"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-972"></a>       <span class="k">end do</span>
<a name="ln-973"></a><span class="k">      end if</span>
<a name="ln-974"></a><span class="k">     end do</span>
<a name="ln-975"></a><span class="k">    end select</span>
<a name="ln-976"></a><span class="k">   end if</span>
<a name="ln-977"></a><span class="k">   </span><span class="n">hgam_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-978"></a>   <span class="n">tgam</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">t_loc</span>
<a name="ln-979"></a>   <span class="c">!================================</span>
<a name="ln-980"></a>   <span class="n">ekt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-981"></a>   <span class="k">call </span><span class="n">allreduce_dpreal</span><span class="p">(</span><span class="n">sumv</span><span class="p">,</span> <span class="n">ekt</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-982"></a>   <span class="n">hgam_number</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-983"></a>   <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-984"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">np_norm</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">ekm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-985"></a>   <span class="k">call </span><span class="n">bunch_corr</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">np_norm</span><span class="p">,</span> <span class="n">bcorr</span><span class="p">)</span>
<a name="ln-986"></a>   <span class="n">hgam_bavg</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">bcorr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-987"></a>   <span class="n">hgam_charge</span><span class="p">(</span><span class="n">nst</span><span class="p">)</span> <span class="o">=</span> <span class="n">e_charge</span><span class="o">*</span><span class="n">np_per_cell</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-988"></a>   <span class="c">!==========================</span>
<a name="ln-989"></a>  <span class="k">end subroutine</span>
<a name="ln-990"></a>  <span class="c">!=====================================</span>
<a name="ln-991"></a>  <span class="c">!   WRITE envar  DATA SECTION</span>
<a name="ln-992"></a>  <span class="k">subroutine </span><span class="n">en_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-993"></a>
<a name="ln-994"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-995"></a>
<a name="ln-996"></a>   <span class="k">call </span><span class="n">general_en_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-997"></a>
<a name="ln-998"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ionization</span><span class="p">)</span> <span class="k">call </span><span class="n">en_ionz_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-999"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">high_gamma</span><span class="p">)</span> <span class="k">call </span><span class="n">en_high_gamma_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-1000"></a>
<a name="ln-1001"></a>  <span class="k">end subroutine</span>
<a name="ln-1002"></a>
<a name="ln-1003"></a><span class="k">  subroutine </span><span class="n">general_en_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-1004"></a>
<a name="ln-1005"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">itr</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-1006"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;      &#39;</span>
<a name="ln-1007"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">sp_type</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1008"></a>                                             <span class="s1">&#39;   Electrons  &#39;</span><span class="p">,</span> <span class="s1">&#39;  A1-Z1 Ions  &#39;</span><span class="p">,</span> <span class="s1">&#39;  A2-Z2 Ions  &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1009"></a>                                             <span class="s1">&#39;  A3-Z3 Ions  &#39;</span><span class="p">]</span>
<a name="ln-1010"></a>
<a name="ln-1011"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">pe</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; Tot Ek[J]    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1012"></a>                                                    <span class="s1">&#39; Ek_max[Mev]  &#39;</span><span class="p">,</span> <span class="s1">&#39; Jz ang-moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;px&gt;-momentum &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1013"></a>                                                    <span class="s1">&#39;&lt;py&gt;-momentum &#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;pz&gt;-momentum &#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_px[KeV] &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1014"></a>                                                    <span class="s1">&#39;sigma_py[KeV] &#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_pz[KeV] &#39;</span><span class="p">,</span> <span class="s1">&#39;Mean Charge   &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1015"></a>                                                    <span class="s1">&#39;Charge percell&#39;</span><span class="p">]</span>
<a name="ln-1016"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fe</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1017"></a>                                              <span class="s1">&#39;  Ex2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ez2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1018"></a>                                              <span class="s1">&#39;  Ex_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ez_max(TV/m)    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1019"></a>                                              <span class="s1">&#39;  Bx2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  By2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1020"></a>                                              <span class="s1">&#39;  Bx_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  By_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz_max(TV/m)    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1021"></a>                                              <span class="s1">&#39;  E2(x&lt;X_t)       &#39;</span><span class="p">,</span> <span class="s1">&#39;  B2(x&lt;X_t)       &#39;</span><span class="p">,</span> <span class="s1">&#39;  E2(x&gt;X_t)       &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1022"></a>                                              <span class="s1">&#39;  B2(x&gt;X_t)       &#39;</span><span class="p">]</span>
<a name="ln-1023"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fe2</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1024"></a>                                             <span class="s1">&#39;  Ex2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1025"></a>                                             <span class="s1">&#39;  Ex_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey_max(TV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz_max(TV/m)    &#39;</span><span class="p">]</span>
<a name="ln-1026"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">feb2</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1027"></a>                                             <span class="s1">&#39;  Ex2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1028"></a>                                             <span class="s1">&#39;  Ex_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz_max(GV/m)    &#39;</span><span class="p">]</span>
<a name="ln-1029"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">feb</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1030"></a>                                              <span class="s1">&#39;  Ex2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ez2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1031"></a>                                              <span class="s1">&#39;  Ex_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ey_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Ez_max(GV/m)    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1032"></a>                                              <span class="s1">&#39;  Bx2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  By2(J)          &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz2(J)          &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1033"></a>                                              <span class="s1">&#39;  Bx_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  By_max(GV/m)    &#39;</span><span class="p">,</span> <span class="s1">&#39;  Bz_max(GV/m)    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1034"></a>                                              <span class="s1">&#39;  E2(x&lt;X_t)       &#39;</span><span class="p">,</span> <span class="s1">&#39;  B2(x&lt;X_t)       &#39;</span><span class="p">,</span> <span class="s1">&#39;  E2(x&gt;X_t)       &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1035"></a>                                              <span class="s1">&#39;  B2(x&gt;X_t)       &#39;</span><span class="p">]</span>
<a name="ln-1036"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">lfenv</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1037"></a>                                             <span class="s1">&#39;  COM(1)      &#39;</span><span class="p">,</span> <span class="s1">&#39;   COM(2)     &#39;</span><span class="p">,</span> <span class="s1">&#39; COM(3)       &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1038"></a>                                             <span class="s1">&#39;  COM(4)      &#39;</span><span class="p">,</span> <span class="s1">&#39;  COM(5)      &#39;</span><span class="p">,</span> <span class="s1">&#39;   COM(6)     &#39;</span><span class="p">]</span>
<a name="ln-1039"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fenv</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1040"></a>                                             <span class="s1">&#39;  Env_max         &#39;</span><span class="p">,</span> <span class="s1">&#39;  Centroid        &#39;</span><span class="p">,</span> <span class="s1">&#39;  Env radius      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1041"></a>                                             <span class="s1">&#39;  Env_energy      &#39;</span><span class="p">,</span> <span class="s1">&#39;  Env_action      &#39;</span><span class="p">]</span>
<a name="ln-1042"></a>   <span class="c">!character(14),dimension(5), parameter:: flaser=(/&amp;</span>
<a name="ln-1043"></a>   <span class="c">! &#39;  Int_max     &#39;,&#39; Las_energy(J)&#39;,&#39;  &lt; X_c &gt;     &#39;,&#39;   &lt;W_y&gt;      &#39;,&amp;</span>
<a name="ln-1044"></a>   <span class="c">! &#39;   &lt; W_z &gt;    &#39;/)</span>
<a name="ln-1045"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">flt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ex2(J)        &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1046"></a>                                                    <span class="s1">&#39;Ey2(J)        &#39;</span><span class="p">,</span> <span class="s1">&#39;Ez2(J)        &#39;</span><span class="p">,</span> <span class="s1">&#39;Bx2(J)        &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1047"></a>                                                    <span class="s1">&#39;By2(J)        &#39;</span><span class="p">,</span> <span class="s1">&#39;Bz2(J)        &#39;</span><span class="p">]</span>
<a name="ln-1048"></a>
<a name="ln-1049"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">enspect</span> <span class="o">=</span> <span class="p">[</span> <span class="p">&amp;</span>
<a name="ln-1050"></a>                                             <span class="s1">&#39;Electron NdE&#39;</span><span class="p">,</span> <span class="s1">&#39; A1-ion NdE &#39;</span><span class="p">,</span> <span class="s1">&#39; A2-ion NdE &#39;</span><span class="p">,</span> <span class="s1">&#39; A3-ion NdE &#39;</span><span class="p">]</span>
<a name="ln-1051"></a>
<a name="ln-1052"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">nfv</span><span class="p">,</span> <span class="n">npv</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">color</span>
<a name="ln-1053"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1054"></a>
<a name="ln-1055"></a>   <span class="n">nfv</span> <span class="o">=</span> <span class="mi">6</span>
<a name="ln-1056"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">curr_ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">nfv</span> <span class="o">=</span> <span class="mi">12</span>
<a name="ln-1057"></a>   <span class="n">npv</span> <span class="o">=</span> <span class="mi">9</span>
<a name="ln-1058"></a>   <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1059"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1060"></a>
<a name="ln-1061"></a>   <span class="c">! if (iout&lt;100) write (fname,&#39;(a4,i2)&#39;) &#39;diag&#39; ,idata</span>
<a name="ln-1062"></a>   <span class="c">! if (iout&lt; 10) write (fname,&#39;(a5,i1)&#39;) &#39;diag0&#39;,idata</span>
<a name="ln-1063"></a>
<a name="ln-1064"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a4,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;diag&#39;</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-1065"></a>
<a name="ln-1066"></a>   <span class="k">open</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;diagnostics/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1067"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    mod_id, dmodel_id,    LP_ord,   der_ord, &amp;</span>
<a name="ln-1068"></a><span class="s1">     &amp;    ibeam,     color,   n_field&#39;</span>
<a name="ln-1069"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(7i11)&#39;</span><span class="p">)</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1070"></a>    <span class="n">color</span><span class="p">,</span> <span class="n">nfield</span>
<a name="ln-1071"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;        Part,        Beam,        Wake, Solid_Target&#39;</span>
<a name="ln-1072"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4L13)&#39;</span><span class="p">)</span> <span class="n">part</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">wake</span><span class="p">,</span> <span class="n">solid_target</span>
<a name="ln-1073"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Z1_i,  A1_i,   Z2_i,   A2_i,   iform,    str&#39;</span>
<a name="ln-1074"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1075"></a>    <span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iform</span><span class="p">,</span> <span class="n">str_flag</span>
<a name="ln-1076"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; xmax       xmin       ymax      ymin      &#39;</span>
<a name="ln-1077"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span>
<a name="ln-1078"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">model_id</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1079"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; lam0       w0x       w0y        energy&#39;</span>
<a name="ln-1080"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e11.4)&#39;</span><span class="p">)</span> <span class="n">lam0</span><span class="p">,</span> <span class="n">w0_x</span><span class="p">,</span> <span class="n">w0_y</span><span class="p">,</span> <span class="n">lp_energy</span>
<a name="ln-1081"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; a0        lp_int     lp_pow    energy_on_targ&#39;</span>
<a name="ln-1082"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span> <span class="n">lp_intensity</span><span class="p">,</span> <span class="n">lp_pow</span><span class="p">,</span> <span class="n">energy_in_targ</span>
<a name="ln-1083"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; targ_x1  targ_x2     n/nc       el_lp        &#39;</span>
<a name="ln-1084"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">targ_in</span><span class="p">,</span> <span class="n">targ_end</span><span class="p">,</span> <span class="n">n_over_nc</span><span class="p">,</span> <span class="n">el_lp</span>
<a name="ln-1085"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">dmodel_id</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1086"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;  lx2        lx3        lx4         dw         lw &#39;</span>
<a name="ln-1087"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e12.4)&#39;</span><span class="p">)</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">),</span> <span class="n">lpy</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1088"></a>    <span class="k">else</span>
<a name="ln-1089"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; lx1        lx2        lx3        lx4        lx5 &#39;</span>
<a name="ln-1090"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e12.4)&#39;</span><span class="p">)</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1091"></a>    <span class="k">end if</span>
<a name="ln-1092"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ompe2       nmacro       np_per_cell    &#39;</span>
<a name="ln-1093"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">ompe</span><span class="p">,</span> <span class="n">nmacro</span><span class="p">,</span> <span class="n">np_per_cell</span>
<a name="ln-1094"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    Nx      Ny      Nz    n_cell   Nsp  Nb_las&#39;</span>
<a name="ln-1095"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i8)&#39;</span><span class="p">)</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nb_laser</span>
<a name="ln-1096"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; iter, nst, nvar npvar&#39;</span>
<a name="ln-1097"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4i6)&#39;</span><span class="p">)</span> <span class="n">itr</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">nfv</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1098"></a>   <span class="k">end if</span>
<a name="ln-1099"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;========== Fields section=======&#39;</span>
<a name="ln-1100"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1101"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a18)&#39;</span><span class="p">)</span> <span class="n">fe2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1102"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1103"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e18.10)&#39;</span><span class="p">)</span> <span class="n">favg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1104"></a>    <span class="k">end do</span>
<a name="ln-1105"></a><span class="k">   else</span>
<a name="ln-1106"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a18)&#39;</span><span class="p">)</span> <span class="n">fe</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1107"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1108"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e18.10)&#39;</span><span class="p">)</span> <span class="n">favg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1109"></a>    <span class="k">end do</span>
<a name="ln-1110"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a18)&#39;</span><span class="p">)</span> <span class="n">fe</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1111"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1112"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e18.10)&#39;</span><span class="p">)</span> <span class="n">favg</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1113"></a>    <span class="k">end do</span>
<a name="ln-1114"></a><span class="k">   end if</span>
<a name="ln-1115"></a><span class="k">   if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1116"></a><span class="k">    if</span> <span class="p">(</span><span class="n">envelope</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1117"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;====  the leading pulse integrated variables&#39;</span>
<a name="ln-1118"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5a18)&#39;</span><span class="p">)</span> <span class="n">fenv</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1119"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1120"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e18.10)&#39;</span><span class="p">)</span> <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1121"></a>     <span class="k">end do</span>
<a name="ln-1122"></a><span class="k">     if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1123"></a><span class="k">      write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;====  the injection pulse integrated variables&#39;</span>
<a name="ln-1124"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5a18)&#39;</span><span class="p">)</span> <span class="n">fenv</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1125"></a>      <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1126"></a>       <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e18.10)&#39;</span><span class="p">)</span> <span class="n">eavg1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1127"></a>      <span class="k">end do</span>
<a name="ln-1128"></a><span class="k">     end if</span>
<a name="ln-1129"></a><span class="k">    end if</span>
<a name="ln-1130"></a><span class="k">   end if</span>
<a name="ln-1131"></a><span class="k">   if</span> <span class="p">(</span><span class="n">solid_target</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1132"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;====  Field energy on solid targets&#39;</span>
<a name="ln-1133"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1134"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a18)&#39;</span><span class="p">)</span> <span class="n">flt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1135"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1136"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e18.10)&#39;</span><span class="p">)</span> <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1137"></a>     <span class="k">end do</span>
<a name="ln-1138"></a><span class="k">    else</span>
<a name="ln-1139"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3a18)&#39;</span><span class="p">)</span> <span class="n">flt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1140"></a>     <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1141"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e18.10)&#39;</span><span class="p">)</span> <span class="n">eavg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1142"></a>     <span class="k">end do</span>
<a name="ln-1143"></a><span class="k">    end if</span>
<a name="ln-1144"></a><span class="k">   end if</span>
<a name="ln-1145"></a><span class="k">   close</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span>
<a name="ln-1146"></a>
<a name="ln-1147"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1148"></a>    <span class="c">! if (iout&lt;100) write (fname,&#39;(a4,i2)&#39;) &#39;spec&#39; ,idata</span>
<a name="ln-1149"></a>    <span class="c">! if (iout&lt; 10) write (fname,&#39;(a5,i1)&#39;) &#39;spec0&#39;,idata</span>
<a name="ln-1150"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a4,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-1151"></a>    <span class="k">open</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;diagnostics/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1152"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;mod_id,dmodel_id LP_ord,der_ord&#39;</span>
<a name="ln-1153"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4i8)&#39;</span><span class="p">)</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span>
<a name="ln-1154"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Z1_i,A1_i,Z2_i,A2_i,iform, str&#39;</span>
<a name="ln-1155"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i4)&#39;</span><span class="p">)</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1156"></a>     <span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iform</span><span class="p">,</span> <span class="n">str_flag</span>
<a name="ln-1157"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; xmax       xmin       ymax      ymin      &#39;</span>
<a name="ln-1158"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span>
<a name="ln-1159"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">model_id</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1160"></a><span class="k">     write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; lam0       w0x       w0y        tau&#39;</span>
<a name="ln-1161"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">lam0</span><span class="p">,</span> <span class="n">w0_x</span><span class="p">,</span> <span class="n">w0_y</span><span class="p">,</span> <span class="n">tau_fwhm</span>
<a name="ln-1162"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; a0        lp_int     lp_pow&#39;</span>
<a name="ln-1163"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span> <span class="n">lp_intensity</span><span class="p">,</span> <span class="n">lp_pow</span>
<a name="ln-1164"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; targ_x1  targ_x2     n/nc       el_lp        &#39;</span>
<a name="ln-1165"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">targ_in</span><span class="p">,</span> <span class="n">targ_end</span><span class="p">,</span> <span class="n">n_over_nc</span><span class="p">,</span> <span class="n">el_lp</span>
<a name="ln-1166"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1167"></a>      <span class="s1">&#39; lx1        lx2          lx3          lx4        lx5 &#39;</span>
<a name="ln-1168"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e12.4)&#39;</span><span class="p">)</span> <span class="n">lpx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1169"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ompe2       nmacro       np_per_cell    &#39;</span>
<a name="ln-1170"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">ompe</span><span class="p">,</span> <span class="n">nmacro</span><span class="p">,</span> <span class="n">np_per_cell</span>
<a name="ln-1171"></a>    <span class="k">end if</span>
<a name="ln-1172"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    Nx      Ny      Nz    n_cell   Nsp  Nsb&#39;</span>
<a name="ln-1173"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i8)&#39;</span><span class="p">)</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nsb</span>
<a name="ln-1174"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; iter, nst, nvar npvar&#39;</span>
<a name="ln-1175"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4i6)&#39;</span><span class="p">)</span> <span class="n">itr</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">nfv</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1176"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;             ENERGY SPECTRA            &#39;</span>
<a name="ln-1177"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(i4)&#39;</span><span class="p">)</span> <span class="n">ne</span>
<a name="ln-1178"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsp</span>
<a name="ln-1179"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="n">enspect</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1180"></a>     <span class="k">do </span><span class="n">nt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1181"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; time   emax&#39;</span>
<a name="ln-1182"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(2e13.5)&#39;</span><span class="p">)</span> <span class="n">tsp</span><span class="p">(</span><span class="n">nt</span><span class="p">),</span> <span class="n">eksp_max</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1183"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Global  spectral  data  &#39;</span>
<a name="ln-1184"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.5)&#39;</span><span class="p">)</span> <span class="n">nde</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1185"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">solid_target</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1186"></a><span class="k">       write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Front side  selected spectral  data  &#39;</span>
<a name="ln-1187"></a>       <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.5)&#39;</span><span class="p">)</span> <span class="n">nde_sm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1188"></a>       <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Rear side   selected spectral  data  &#39;</span>
<a name="ln-1189"></a>       <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.5)&#39;</span><span class="p">)</span> <span class="n">nde_sp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>
<a name="ln-1190"></a>      <span class="k">end if</span>
<a name="ln-1191"></a><span class="k">     end do</span>
<a name="ln-1192"></a><span class="k">    end do</span>
<a name="ln-1193"></a><span class="k">    close</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span>
<a name="ln-1194"></a>   <span class="k">end if</span>
<a name="ln-1195"></a><span class="k">  end subroutine</span>
<a name="ln-1196"></a>  <span class="c">!--------------------------</span>
<a name="ln-1197"></a>  <span class="k">subroutine </span><span class="n">en_bdata</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">idata</span><span class="p">)</span>
<a name="ln-1198"></a>
<a name="ln-1199"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-1200"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="kd">::</span> <span class="n">bfname</span> <span class="o">=</span> <span class="s1">&#39;       &#39;</span>
<a name="ln-1201"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;     &lt;X&gt;      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1202"></a>                                                    <span class="s1">&#39;     &lt;Y&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Z&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Px&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1203"></a>                                                    <span class="s1">&#39;     &lt;Py&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Pz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqX&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1204"></a>                                                    <span class="s1">&#39;   &lt;msqY&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqZ&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPx&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1205"></a>                                                    <span class="s1">&#39;  &lt;msqPy&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Emysq&gt;    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1206"></a>                                                    <span class="s1">&#39;   &lt;Emzsq&gt;    &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Gam&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;   DGam/Gam   &#39;</span><span class="p">]</span>
<a name="ln-1207"></a>
<a name="ln-1208"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ib</span><span class="p">,</span> <span class="n">nbvar</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">color</span>
<a name="ln-1209"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1210"></a>
<a name="ln-1211"></a>   <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1212"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1213"></a>
<a name="ln-1214"></a>   <span class="n">nbvar</span> <span class="o">=</span> <span class="mi">16</span>
<a name="ln-1215"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">bfname</span><span class="p">,</span> <span class="s1">&#39;(a5,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;bdiag&#39;</span><span class="p">,</span> <span class="n">idata</span>
<a name="ln-1216"></a>   <span class="k">open</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;diagnostics/&#39;</span><span class="o">//</span><span class="n">bfname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1217"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;mod_id,dmodel_id LP_ord,der_ord, ibeam,  color&#39;</span>
<a name="ln-1218"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1219"></a>    <span class="n">color</span>
<a name="ln-1220"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Z1_i,  A1_i,   Z2_i,   A2_i,   iform,    str&#39;</span>
<a name="ln-1221"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1222"></a>    <span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iform</span><span class="p">,</span> <span class="n">str_flag</span>
<a name="ln-1223"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; xmax       xmin       ymax      ymin      &#39;</span>
<a name="ln-1224"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span>
<a name="ln-1225"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ompe2       nmacro       np_per_cell    &#39;</span>
<a name="ln-1226"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">ompe</span><span class="p">,</span> <span class="n">nmacro</span><span class="p">,</span> <span class="n">np_per_cell</span>
<a name="ln-1227"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    Nx      Ny      Nz    n_cell   Nsp  Nbeam&#39;</span>
<a name="ln-1228"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i8)&#39;</span><span class="p">)</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nsb</span>
<a name="ln-1229"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; iter, nst, npvar&#39;</span>
<a name="ln-1230"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3i6)&#39;</span><span class="p">)</span> <span class="n">it</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">nbvar</span>
<a name="ln-1231"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;=====================================&#39;</span>
<a name="ln-1232"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time&#39;</span>
<a name="ln-1233"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">tbunch</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1234"></a>   <span class="k">do </span><span class="n">ib</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsb</span>
<a name="ln-1235"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; bunch numbers &#39;</span>
<a name="ln-1236"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i10)&#39;</span><span class="p">)</span> <span class="n">bunch_number</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-1237"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; bunch charge(pC)&#39;</span>
<a name="ln-1238"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">bcharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-1239"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1240"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1241"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">bunch_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-1242"></a>    <span class="k">end do</span>
<a name="ln-1243"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1244"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1245"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">bunch_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-1246"></a>    <span class="k">end do</span>
<a name="ln-1247"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1248"></a>    <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1249"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e13.4)&#39;</span><span class="p">)</span> <span class="n">bunch_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
<a name="ln-1250"></a>    <span class="k">end do</span>
<a name="ln-1251"></a><span class="k">   end do</span>
<a name="ln-1252"></a><span class="k">   close</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span>
<a name="ln-1253"></a>  <span class="k">end subroutine</span>
<a name="ln-1254"></a>
<a name="ln-1255"></a><span class="k">  subroutine </span><span class="n">en_ionz_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">data_id</span><span class="p">)</span>
<a name="ln-1256"></a>
<a name="ln-1257"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">data_id</span>
<a name="ln-1258"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;            &#39;</span>
<a name="ln-1259"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;     &lt;X&gt;      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1260"></a>                                                    <span class="s1">&#39;     &lt;Y&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Z&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Px&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1261"></a>                                                    <span class="s1">&#39;     &lt;Py&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Pz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqX&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1262"></a>                                                    <span class="s1">&#39;   &lt;msqY&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqZ&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPx&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1263"></a>                                                    <span class="s1">&#39;  &lt;msqPy&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Emysq&gt;    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1264"></a>                                                    <span class="s1">&#39;   &lt;Emzsq&gt;    &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Gam&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;   DGam/Gam   &#39;</span><span class="p">]</span>
<a name="ln-1265"></a>
<a name="ln-1266"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1267"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-1268"></a>
<a name="ln-1269"></a>   <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1270"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1271"></a>   <span class="n">npv</span> <span class="o">=</span> <span class="mi">16</span>
<a name="ln-1272"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a10,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;ionz_emitt&#39;</span><span class="p">,</span> <span class="n">data_id</span>
<a name="ln-1273"></a>   <span class="k">open</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;diagnostics/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1274"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;mod_id,dmodel_id LP_ord,der_ord, ibeam,  color&#39;</span>
<a name="ln-1275"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1276"></a>    <span class="n">color</span>
<a name="ln-1277"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Z1_i,  A1_i,   Z2_i,   A2_i,   iform,    str&#39;</span>
<a name="ln-1278"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1279"></a>    <span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iform</span><span class="p">,</span> <span class="n">str_flag</span>
<a name="ln-1280"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; xmax       xmin       ymax      ymin      &#39;</span>
<a name="ln-1281"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span>
<a name="ln-1282"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">model_id</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1283"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; lam0       w0x       w0y        energy&#39;</span>
<a name="ln-1284"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e11.4)&#39;</span><span class="p">)</span> <span class="n">lam0</span><span class="p">,</span> <span class="n">w0_x</span><span class="p">,</span> <span class="n">w0_y</span><span class="p">,</span> <span class="n">lp_energy</span>
<a name="ln-1285"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; a0        lp_int     lp_pow    energy_on_targ&#39;</span>
<a name="ln-1286"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span> <span class="n">lp_intensity</span><span class="p">,</span> <span class="n">lp_pow</span><span class="p">,</span> <span class="n">energy_in_targ</span>
<a name="ln-1287"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; targ_x1  targ_x2     n/nc       el_lp        &#39;</span>
<a name="ln-1288"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">targ_in</span><span class="p">,</span> <span class="n">targ_end</span><span class="p">,</span> <span class="n">n_over_nc</span><span class="p">,</span> <span class="n">el_lp</span>
<a name="ln-1289"></a>   <span class="k">end if</span>
<a name="ln-1290"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ompe2       nmacro       np_per_cell    &#39;</span>
<a name="ln-1291"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">ompe</span><span class="p">,</span> <span class="n">nmacro</span><span class="p">,</span> <span class="n">np_per_cell</span>
<a name="ln-1292"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    Nx      Ny      Nz    n_cell   Nsp  Nb_las&#39;</span>
<a name="ln-1293"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i8)&#39;</span><span class="p">)</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nb_laser</span>
<a name="ln-1294"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; iter, nst, npvar&#39;</span>
<a name="ln-1295"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3i6)&#39;</span><span class="p">)</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1296"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;=====================================&#39;</span>
<a name="ln-1297"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time&#39;</span>
<a name="ln-1298"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e11.4)&#39;</span><span class="p">)</span> <span class="n">tionz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1299"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ionization-hg numbers &#39;</span>
<a name="ln-1300"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i10)&#39;</span><span class="p">)</span> <span class="n">ionz_number</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1301"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ionization-hg charge(pC)&#39;</span>
<a name="ln-1302"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">ionz_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1303"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1304"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1305"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">ionz_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1306"></a>   <span class="k">end do</span>
<a name="ln-1307"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1308"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1309"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">ionz_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1310"></a>   <span class="k">end do</span>
<a name="ln-1311"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1312"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1313"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e13.4)&#39;</span><span class="p">)</span> <span class="n">ionz_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1314"></a>   <span class="k">end do</span>
<a name="ln-1315"></a><span class="k">   close</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span>
<a name="ln-1316"></a>  <span class="k">end subroutine</span>
<a name="ln-1317"></a>
<a name="ln-1318"></a><span class="k">  subroutine </span><span class="n">en_high_gamma_data</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">data_id</span><span class="p">)</span>
<a name="ln-1319"></a>
<a name="ln-1320"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nst</span><span class="p">,</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">data_id</span>
<a name="ln-1321"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;            &#39;</span>
<a name="ln-1322"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">fb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;     &lt;X&gt;      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1323"></a>                                                    <span class="s1">&#39;     &lt;Y&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Z&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Px&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1324"></a>                                                    <span class="s1">&#39;     &lt;Py&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;     &lt;Pz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqX&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1325"></a>                                                    <span class="s1">&#39;   &lt;msqY&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;msqZ&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPx&gt;     &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1326"></a>                                                    <span class="s1">&#39;  &lt;msqPy&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;  &lt;msqPz&gt;     &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Emysq&gt;    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1327"></a>                                                    <span class="s1">&#39;   &lt;Emzsq&gt;    &#39;</span><span class="p">,</span> <span class="s1">&#39;   &lt;Gam&gt;      &#39;</span><span class="p">,</span> <span class="s1">&#39;   DGam/Gam   &#39;</span><span class="p">]</span>
<a name="ln-1328"></a>
<a name="ln-1329"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1330"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1331"></a>
<a name="ln-1332"></a>   <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1333"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">Two_color</span><span class="p">)</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1334"></a>   <span class="n">npv</span> <span class="o">=</span> <span class="mi">16</span>
<a name="ln-1335"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a10,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;higm_emitt&#39;</span><span class="p">,</span> <span class="n">data_id</span>
<a name="ln-1336"></a>
<a name="ln-1337"></a>   <span class="k">open</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;diagnostics/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1338"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;mod_id,dmodel_id LP_ord,der_ord, ibeam,  color&#39;</span>
<a name="ln-1339"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1340"></a>    <span class="n">color</span>
<a name="ln-1341"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Z1_i,  A1_i,   Z2_i,   A2_i,   iform,    str&#39;</span>
<a name="ln-1342"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i6)&#39;</span><span class="p">)</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1343"></a>    <span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iform</span><span class="p">,</span> <span class="n">str_flag</span>
<a name="ln-1344"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; xmax       xmin       ymax      ymin      &#39;</span>
<a name="ln-1345"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span>
<a name="ln-1346"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">model_id</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1347"></a><span class="k">    write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; lam0       w0x       w0y        energy&#39;</span>
<a name="ln-1348"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e11.4)&#39;</span><span class="p">)</span> <span class="n">lam0</span><span class="p">,</span> <span class="n">w0_x</span><span class="p">,</span> <span class="n">w0_y</span><span class="p">,</span> <span class="n">lp_energy</span>
<a name="ln-1349"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; a0        lp_int     lp_pow    energy_on_targ&#39;</span>
<a name="ln-1350"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span> <span class="n">lp_intensity</span><span class="p">,</span> <span class="n">lp_pow</span><span class="p">,</span> <span class="n">energy_in_targ</span>
<a name="ln-1351"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; targ_x1  targ_x2     n/nc       el_lp        &#39;</span>
<a name="ln-1352"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e12.4)&#39;</span><span class="p">)</span> <span class="n">targ_in</span><span class="p">,</span> <span class="n">targ_end</span><span class="p">,</span> <span class="n">n_over_nc</span><span class="p">,</span> <span class="n">el_lp</span>
<a name="ln-1353"></a>   <span class="k">end if</span>
<a name="ln-1354"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ompe2       nmacro       np_per_cell    &#39;</span>
<a name="ln-1355"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3e12.4)&#39;</span><span class="p">)</span> <span class="n">ompe</span><span class="p">,</span> <span class="n">nmacro</span><span class="p">,</span> <span class="n">np_per_cell</span>
<a name="ln-1356"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;    Nx      Ny      Nz    n_cell   Nsp  Nb_las&#39;</span>
<a name="ln-1357"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6i8)&#39;</span><span class="p">)</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nb_laser</span>
<a name="ln-1358"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; iter, nst, npvar&#39;</span>
<a name="ln-1359"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(3i6)&#39;</span><span class="p">)</span> <span class="n">itrz</span><span class="p">,</span> <span class="n">nst</span><span class="p">,</span> <span class="n">npv</span>
<a name="ln-1360"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;=====================================&#39;</span>
<a name="ln-1361"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;time&#39;</span>
<a name="ln-1362"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5e11.4)&#39;</span><span class="p">)</span> <span class="n">tloc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1363"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; higamma numbers &#39;</span>
<a name="ln-1364"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5i8)&#39;</span><span class="p">)</span> <span class="n">hgam_number</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1365"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; higamma charge(pC) &#39;</span>
<a name="ln-1366"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(5E13.4)&#39;</span><span class="p">)</span> <span class="n">hgam_charge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nst</span><span class="p">)</span>
<a name="ln-1367"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1368"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1369"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">hgam_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1370"></a>   <span class="k">end do</span>
<a name="ln-1371"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1372"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1373"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(6e13.4)&#39;</span><span class="p">)</span> <span class="n">hgam_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1374"></a>   <span class="k">end do</span>
<a name="ln-1375"></a><span class="k">   write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4a14)&#39;</span><span class="p">)</span> <span class="n">fb</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1376"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nst</span>
<a name="ln-1377"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="s1">&#39;(4e13.4)&#39;</span><span class="p">)</span> <span class="n">hgam_bavg</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1378"></a>   <span class="k">end do</span>
<a name="ln-1379"></a><span class="k">   close</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span>
<a name="ln-1380"></a>  <span class="k">end subroutine</span>
<a name="ln-1381"></a>  <span class="c">!--------------------------</span>
<a name="ln-1382"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>