<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>pic_out.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>pic_out.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 6.1% of total for source files.">1499 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/pic_out.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">pic_out.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/pic_out.html">pic_out</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/pic_out.f90.html#src">pic_out.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~pic_out.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilepic_outf90EfferentGraph" width="631pt" height="279pt"
 viewBox="0.00 0.00 631.00 279.13" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~pic_out.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 275.1304)">
<title>sourcefile~~pic_out.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-275.1304 627,-275.1304 627,4 -4,4"/>
<!-- sourcefile~pic_out.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~pic_out.f90</title>
<polygon fill="none" stroke="#000000" points="623,-107.1304 552,-107.1304 552,-83.1304 623,-83.1304 623,-107.1304"/>
<text text-anchor="middle" x="587.5" y="-92.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">pic_out.f90</text>
</g>
<!-- sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~pstruct_data.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/pstruct_data.f90.html" xlink:title="pstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="373,-271.1304 274,-271.1304 274,-247.1304 373,-247.1304 373,-271.1304"/>
<text text-anchor="middle" x="323.5" y="-256.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~pstruct_data.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M468,-217.1304C440.8779,-228.5296 409.6556,-238.0272 383.1889,-245.0904"/>
<polygon fill="#ff0000" stroke="#ff0000" points="382.0858,-241.7611 373.2965,-247.6771 383.8567,-248.5334 382.0858,-241.7611"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="384,-187.1304 263,-187.1304 263,-163.1304 384,-163.1304 384,-187.1304"/>
<text text-anchor="middle" x="323.5" y="-172.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M580.4548,-107.1818C564.4308,-133.2303 522.3918,-194.27 468,-217.1304"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M468,-217.1304C463.3136,-219.1 410.8984,-203.145 370.5317,-190.3359"/>
<polygon fill="#ff0000" stroke="#ff0000" points="371.4165,-186.9445 360.8259,-187.2434 369.2914,-193.6141 371.4165,-186.9445"/>
</g>
<!-- sourcefile~parallel.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~parallel.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/parallel.f90.html" xlink:title="parallel.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="506,-127.1304 430,-127.1304 430,-103.1304 506,-103.1304 506,-127.1304"/>
<text text-anchor="middle" x="468" y="-112.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">parallel.F90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~parallel.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~parallel.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M551.9696,-101.0769C540.6822,-102.966 528.0067,-105.0874 515.9916,-107.0983"/>
<polygon fill="#ff0000" stroke="#ff0000" points="515.3843,-103.6512 506.0993,-108.7539 516.5399,-110.5552 515.3843,-103.6512"/>
</g>
<!-- sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~fstruct_data.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/fstruct_data.f90.html" xlink:title="fstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="516,-27.1304 420,-27.1304 420,-3.1304 516,-3.1304 516,-27.1304"/>
<text text-anchor="middle" x="468" y="-12.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~fstruct_data.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M572.9067,-83.0771C558.7783,-71.6597 536.5396,-54.3431 516,-41.1304 511.2176,-38.054 506.0403,-34.9914 500.9158,-32.1052"/>
<polygon fill="#ff0000" stroke="#ff0000" points="502.2973,-28.8713 491.8456,-27.1356 498.9337,-35.0102 502.2973,-28.8713"/>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="225,-68.1304 144,-68.1304 144,-44.1304 225,-44.1304 225,-68.1304"/>
<text text-anchor="middle" x="184.5" y="-53.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M551.8559,-91.3121C511.2395,-86.9937 442.862,-79.8227 384,-74.1304 333.37,-69.2342 275.469,-64.0568 235.1338,-60.518"/>
<polygon fill="#ff0000" stroke="#ff0000" points="235.2832,-57.0178 225.0161,-59.6324 234.6728,-63.9911 235.2832,-57.0178"/>
</g>
<!-- sourcefile~grid_param.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~grid_param.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/grid_param.f90.html" xlink:title="grid_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="370.5,-229.1304 276.5,-229.1304 276.5,-205.1304 370.5,-205.1304 370.5,-229.1304"/>
<text text-anchor="middle" x="323.5" y="-214.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">grid_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_out.f90&#45;&gt;sourcefile~grid_param.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~pic_out.f90&#45;&gt;sourcefile~grid_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M468,-217.1304C440.8278,-228.5506 408.1605,-229.4883 380.7653,-227.1598"/>
<polygon fill="#ff0000" stroke="#ff0000" points="380.8488,-223.6504 370.5464,-226.1225 380.1418,-230.6146 380.8488,-223.6504"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="227,-229.1304 142,-229.1304 142,-205.1304 227,-205.1304 227,-229.1304"/>
<text text-anchor="middle" x="184.5" y="-214.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M283.6682,-247.0949C268.2553,-242.4377 250.4459,-237.0565 234.2089,-232.1503"/>
<polygon fill="#ff0000" stroke="#ff0000" points="234.9226,-228.7098 224.3376,-229.1677 232.8978,-235.4106 234.9226,-228.7098"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-148.1304 0,-148.1304 0,-124.1304 106,-124.1304 106,-148.1304"/>
<text text-anchor="middle" x="53" y="-133.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M273.6815,-262.7874C235.528,-263.4372 182.7061,-259.544 142,-238.1304 106.9287,-219.681 79.4464,-181.2843 64.771,-157.2213"/>
<polygon fill="#ff0000" stroke="#ff0000" points="67.7095,-155.3138 59.616,-148.4766 61.6792,-158.8686 67.7095,-155.3138"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ffff00" stroke-dasharray="5,2" d="M262.6649,-181.456C238.1227,-182.4888 209.7046,-181.7427 184.5,-176.1304"/>
<path fill="none" stroke="#ffff00" stroke-dasharray="5,2" d="M184.5,-176.1304C154.9926,-169.5599 122.4868,-159.697 97.1761,-151.4092"/>
<polygon fill="#ffff00" stroke="#ffff00" points="98.0942,-148.0263 87.5009,-148.2034 95.8925,-154.6711 98.0942,-148.0263"/>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M438.7583,-127.2723C416.724,-136.4215 386.2989,-149.0547 362.241,-159.0442"/>
<polygon fill="#00ff00" stroke="#00ff00" points="360.5915,-155.9393 352.6982,-163.0065 363.2759,-162.4041 360.5915,-155.9393"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="222,-148.1304 147,-148.1304 147,-124.1304 222,-124.1304 222,-148.1304"/>
<text text-anchor="middle" x="184.5" y="-133.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M429.7659,-117.9625C378.6501,-121.7489 288.0468,-128.4603 232.4265,-132.5803"/>
<polygon fill="#00ff00" stroke="#00ff00" points="231.8424,-129.1139 222.1283,-133.3431 232.3596,-136.0947 231.8424,-129.1139"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~pic_out.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="350.5,-107.1304 296.5,-107.1304 296.5,-83.1304 350.5,-83.1304 350.5,-107.1304"/>
<text text-anchor="middle" x="323.5" y="-92.7304" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~parallel.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M429.656,-109.8233C408.2438,-106.8596 381.6932,-103.1848 360.5014,-100.2517"/>
<polygon fill="#00ff00" stroke="#00ff00" points="360.9601,-96.7819 350.5747,-98.8777 360.0004,-103.7158 360.9601,-96.7819"/>
</g>
<!-- sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M419.7834,-7.0711C353.4875,1.6456 232.16,8.965 142,-35.1304 106.4139,-52.5348 78.935,-91.1692 64.4281,-115.2906"/>
<polygon fill="#00ffff" stroke="#00ffff" points="61.3396,-113.6396 59.3481,-124.0456 67.3942,-117.1527 61.3396,-113.6396"/>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M164.528,-68.2807C142.3872,-81.7503 106.4977,-103.5843 81.4296,-118.8348"/>
<polygon fill="#0000ff" stroke="#0000ff" points="79.4533,-115.9403 72.7291,-124.1279 83.0915,-121.9206 79.4533,-115.9403"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#ff00ff" stroke-dasharray="5,2" d="M276.4409,-217.1304C263.8874,-217.1304 250.2396,-217.1304 237.3954,-217.1304"/>
<polygon fill="#ff00ff" stroke="#ff00ff" points="237.3033,-213.6305 227.3032,-217.1304 237.3032,-220.6305 237.3033,-213.6305"/>
</g>
<!-- sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~grid_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff00ff" stroke-dasharray="5,2" d="M287.5597,-205.0693C259.6988,-196.0766 219.9868,-184.0323 184.5,-176.1304"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M164.8131,-205.0039C142.7342,-191.4039 106.7287,-169.2256 81.5586,-153.7216"/>
<polygon fill="#ff0000" stroke="#ff0000" points="83.1715,-150.6044 72.8215,-148.3398 79.5002,-156.5645 83.1715,-150.6044"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M146.8174,-136.1304C137.3685,-136.1304 126.9676,-136.1304 116.6363,-136.1304"/>
<polygon fill="#7fff00" stroke="#7fff00" points="116.3661,-132.6305 106.3661,-136.1304 116.3661,-139.6305 116.3661,-132.6305"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M296.3694,-87.5182C278.9089,-82.6192 255.6789,-76.1015 234.9133,-70.2751"/>
<polygon fill="#00ffff" stroke="#00ffff" points="235.8391,-66.8998 225.2654,-67.5682 233.9481,-73.6395 235.8391,-66.8998"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~pic_out.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M296.2953,-97.0871C260.6716,-99.887 196.358,-105.7584 142,-115.1304 131.3395,-116.9684 120.0486,-119.3158 109.2181,-121.7711"/>
<polygon fill="#00ffff" stroke="#00ffff" points="108.3808,-118.3723 99.4325,-124.0449 109.9651,-125.1907 108.3808,-118.3723"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~pic_out.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilepic_outf90AfferentGraph" width="191pt" height="32pt"
 viewBox="0.00 0.00 191.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~pic_out.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~pic_out.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 187,-28 187,4 -4,4"/>
<!-- sourcefile~pic_out.f90 -->
<g id="sourcefile~~pic_out.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~pic_out.f90</title>
<polygon fill="none" stroke="#000000" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">pic_out.f90</text>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~pic_out.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~pic_out.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="183,-24 107,-24 107,0 183,0 183,-24"/>
<text text-anchor="middle" x="145" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_out.f90 -->
<g id="sourcefile~~pic_out.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_out.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M106.7022,-12C98.4592,-12 89.6677,-12 81.1758,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="81.0232,-8.5001 71.0231,-12 81.0231,-15.5001 81.0232,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/pic_out.html">pic_out</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/pic_out.f90.html#src">pic_out.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2020  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">pic_out</span>
<a name="ln-23"></a>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">pstruct_data</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">fstruct_data</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">code_util</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">common_param</span>
<a name="ln-28"></a>  <span class="k">use </span><span class="n">grid_param</span>
<a name="ln-29"></a>  <span class="k">use </span><span class="n">parallel</span>
<a name="ln-30"></a>
<a name="ln-31"></a>  <span class="k">implicit none</span>
<a name="ln-32"></a>
<a name="ln-33"></a><span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">par_dim</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-34"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">int_par</span><span class="p">(</span><span class="n">par_dim</span><span class="p">),</span> <span class="n">part_int_par</span><span class="p">(</span><span class="n">par_dim</span><span class="p">)</span>
<a name="ln-35"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">real_par</span><span class="p">(</span><span class="n">par_dim</span><span class="p">),</span> <span class="n">part_real_par</span><span class="p">(</span><span class="n">par_dim</span><span class="p">)</span>
<a name="ln-36"></a>
<a name="ln-37"></a>  <span class="kt">character</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">rpar</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; time =      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-38"></a>                                                              <span class="s1">&#39; xmin =      &#39;</span><span class="p">,</span> <span class="s1">&#39; xmax =      &#39;</span><span class="p">,</span> <span class="s1">&#39; ymin =      &#39;</span><span class="p">,</span> <span class="s1">&#39; ymax =      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-39"></a>                                                              <span class="s1">&#39; zmin =      &#39;</span><span class="p">,</span> <span class="s1">&#39; zmax =      &#39;</span><span class="p">,</span> <span class="s1">&#39; w0_x =      &#39;</span><span class="p">,</span> <span class="s1">&#39; w0_y =      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-40"></a>                                                              <span class="s1">&#39; a0 =        &#39;</span><span class="p">,</span> <span class="s1">&#39; lam0 =      &#39;</span><span class="p">,</span> <span class="s1">&#39; mc2(MeV) =  &#39;</span><span class="p">,</span> <span class="s1">&#39; n0(e18) =   &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-41"></a>                                                              <span class="s1">&#39; np/cell =   &#39;</span><span class="p">,</span> <span class="s1">&#39; weight =    &#39;</span><span class="p">,</span> <span class="s1">&#39; mass =      &#39;</span><span class="p">,</span> <span class="s1">&#39; xmin_out =  &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-42"></a>                                                              <span class="s1">&#39; xmax_out =  &#39;</span><span class="p">,</span> <span class="s1">&#39; ymax_out =  &#39;</span><span class="p">,</span> <span class="s1">&#39; gam_min =   &#39;</span><span class="p">]</span>
<a name="ln-43"></a>
<a name="ln-44"></a>  <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="k">parameter</span><span class="p">,</span> <span class="k">private</span> <span class="kd">::</span> <span class="n">ipar</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; npe =      &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-45"></a>                                                              <span class="s1">&#39; nx =       &#39;</span><span class="p">,</span> <span class="s1">&#39; ny =       &#39;</span><span class="p">,</span> <span class="s1">&#39; nz =       &#39;</span><span class="p">,</span> <span class="s1">&#39; model =    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-46"></a>                                                              <span class="s1">&#39; dmodel =   &#39;</span><span class="p">,</span> <span class="s1">&#39; nsp =      &#39;</span><span class="p">,</span> <span class="s1">&#39; curr_ndim =&#39;</span><span class="p">,</span> <span class="s1">&#39; mp/cell =  &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-47"></a>                                                              <span class="s1">&#39; ion_ch =   &#39;</span><span class="p">,</span> <span class="s1">&#39; tsch_ord = &#39;</span><span class="p">,</span> <span class="s1">&#39; der_ord =  &#39;</span><span class="p">,</span> <span class="s1">&#39; iform =    &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-48"></a>                                                              <span class="s1">&#39; ph_sp_nc = &#39;</span><span class="p">,</span> <span class="s1">&#39; f_version =&#39;</span><span class="p">,</span> <span class="s1">&#39; i_end =    &#39;</span><span class="p">,</span> <span class="s1">&#39; nx_loc =   &#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-49"></a>                                                              <span class="s1">&#39; ny_loc =   &#39;</span><span class="p">,</span> <span class="s1">&#39; nz_loc =   &#39;</span><span class="p">,</span> <span class="s1">&#39; pjump  =   &#39;</span><span class="p">]</span>
<a name="ln-50"></a>
<a name="ln-51"></a> <span class="k">contains</span>
<a name="ln-52"></a>
<a name="ln-53"></a><span class="k">  subroutine </span><span class="n">endian</span><span class="p">(</span><span class="n">iend</span><span class="p">)</span>
<a name="ln-54"></a>   <span class="k">implicit none</span>
<a name="ln-55"></a><span class="k">   </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iend</span>
<a name="ln-56"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ik1</span> <span class="o">=</span> <span class="nb">selected_int_kind</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-57"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ik4</span> <span class="o">=</span> <span class="nb">selected_int_kind</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-58"></a>
<a name="ln-59"></a>   <span class="n">iend</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-60"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">btest</span><span class="p">(</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">int</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ik1</span><span class="p">),</span> <span class="mi">1_ik4</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-61"></a><span class="k">    </span><span class="n">iend</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-62"></a>   <span class="k">else</span>
<a name="ln-63"></a><span class="k">    </span><span class="n">iend</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-64"></a>   <span class="k">end if</span>
<a name="ln-65"></a><span class="k">  end subroutine</span>
<a name="ln-66"></a>
<a name="ln-67"></a><span class="k">  subroutine </span><span class="n">fluid_den_mom_out</span><span class="p">(</span><span class="n">fvar</span><span class="p">,</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">flcomp</span><span class="p">)</span>
<a name="ln-68"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fvar</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-69"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">flcomp</span>
<a name="ln-70"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;         &#39;</span>
<a name="ln-71"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">flvar</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fdenout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-72"></a>                                                     <span class="s1">&#39;Flpxout&#39;</span><span class="p">,</span> <span class="s1">&#39;Flpyout&#39;</span><span class="p">,</span> <span class="s1">&#39;Flpzout&#39;</span><span class="p">]</span>
<a name="ln-73"></a>
<a name="ln-74"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-75"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-76"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">cmp_name</span>
<a name="ln-77"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span>
<a name="ln-78"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-79"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-80"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-81"></a>   <span class="c">!========================</span>
<a name="ln-82"></a>   <span class="c">! ns_index select ion species</span>
<a name="ln-83"></a>   <span class="c">! cmp select components (density, energy,..)</span>
<a name="ln-84"></a>   <span class="c">! cmp_loc is the index of output data:  jc(cmp_loc)</span>
<a name="ln-85"></a>
<a name="ln-86"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-87"></a>
<a name="ln-88"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-89"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-90"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-91"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-92"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-93"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-94"></a>
<a name="ln-95"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-96"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-97"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-98"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-99"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-100"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">fvar</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">cmp</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-101"></a>     <span class="k">end do</span>
<a name="ln-102"></a><span class="k">    end do</span>
<a name="ln-103"></a><span class="k">   end do</span>
<a name="ln-104"></a><span class="k">   if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="n">flcomp</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-105"></a><span class="k">    </span><span class="n">cmp_name</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-106"></a>   <span class="k">else</span>
<a name="ln-107"></a><span class="k">    </span><span class="n">cmp_name</span> <span class="o">=</span> <span class="n">cmp</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-108"></a>   <span class="k">end if</span>
<a name="ln-109"></a>
<a name="ln-110"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-111"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-112"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-113"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-114"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-115"></a>
<a name="ln-116"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-117"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-118"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-119"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-120"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-121"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-122"></a>
<a name="ln-123"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-124"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-125"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-126"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-127"></a>
<a name="ln-128"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">flvar</span><span class="p">(</span><span class="n">cmp_name</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-129"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-130"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-131"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-132"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-133"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-134"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-135"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-136"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-137"></a>
<a name="ln-138"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-139"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-140"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-141"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-142"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-143"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-144"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-145"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-146"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-147"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-148"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-149"></a>   <span class="k">end if</span>
<a name="ln-150"></a>
<a name="ln-151"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-152"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-153"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-154"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-155"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-156"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-157"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-158"></a>   <span class="k">else</span>
<a name="ln-159"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-160"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-161"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-162"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-163"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-164"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-165"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-166"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-167"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-168"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-169"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-170"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-171"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-172"></a>       <span class="k">end if</span>
<a name="ln-173"></a><span class="k">      end do</span>
<a name="ln-174"></a><span class="k">     end do</span>
<a name="ln-175"></a><span class="k">    end do</span>
<a name="ln-176"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-177"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-178"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-179"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-180"></a>    <span class="k">end do</span>
<a name="ln-181"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-182"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-183"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-184"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-185"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-186"></a>    <span class="k">end do</span>
<a name="ln-187"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-188"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-189"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-190"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-191"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-192"></a>    <span class="k">end do</span>
<a name="ln-193"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-194"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-195"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fluid density-momenta written on file: &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-196"></a>     <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-197"></a>   <span class="k">end if</span>
<a name="ln-198"></a><span class="k">  end subroutine</span>
<a name="ln-199"></a>  <span class="c">!==================================</span>
<a name="ln-200"></a>  <span class="k">subroutine </span><span class="n">den_energy_out</span><span class="p">(</span><span class="n">ns_ind</span><span class="p">,</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp_loc</span><span class="p">)</span>
<a name="ln-201"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ns_ind</span><span class="p">,</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp_loc</span>
<a name="ln-202"></a><span class="c">!================</span>
<a name="ln-203"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;         &#39;</span>
<a name="ln-204"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">bpot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Beampot&#39;</span><span class="p">]</span>
<a name="ln-205"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">el1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Edenout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-206"></a>                                                   <span class="s1">&#39;Elenout&#39;</span><span class="p">]</span>
<a name="ln-207"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">pr1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pdenout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-208"></a>                                                   <span class="s1">&#39;Prenout&#39;</span><span class="p">]</span>
<a name="ln-209"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">io1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H1dnout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-210"></a>                                                   <span class="s1">&#39;H1enout&#39;</span><span class="p">]</span>
<a name="ln-211"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">io2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2dnout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-212"></a>                                                   <span class="s1">&#39;H2enout&#39;</span><span class="p">]</span>
<a name="ln-213"></a>
<a name="ln-214"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-215"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-216"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">i_end</span>
<a name="ln-217"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span>
<a name="ln-218"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-219"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-220"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-221"></a>   <span class="c">!========================</span>
<a name="ln-222"></a>   <span class="c">! ns_index select ion species (electron,ions)</span>
<a name="ln-223"></a>   <span class="c">! cmp select components name in output script for each species</span>
<a name="ln-224"></a>   <span class="c">! [Eden,Elen],[H1dn,H1en].....</span>
<a name="ln-225"></a>   <span class="c">! cmp_loc is the index where output data are stored in jc(cmp_loc) array</span>
<a name="ln-226"></a>   <span class="c">!============================</span>
<a name="ln-227"></a>
<a name="ln-228"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-229"></a>
<a name="ln-230"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-231"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-232"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-233"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-234"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-235"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-236"></a>
<a name="ln-237"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-238"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-239"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-240"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-241"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-242"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">jc</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">cmp_loc</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-243"></a>     <span class="k">end do</span>
<a name="ln-244"></a><span class="k">    end do</span>
<a name="ln-245"></a><span class="k">   end do</span>
<a name="ln-246"></a>
<a name="ln-247"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-248"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-249"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-250"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-251"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-252"></a>
<a name="ln-253"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-254"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-255"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-256"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-257"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-258"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-259"></a>
<a name="ln-260"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-261"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-262"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-263"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-264"></a>
<a name="ln-265"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">ns_ind</span><span class="p">)</span>
<a name="ln-266"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-267"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">bpot</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-268"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-269"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">el1</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-270"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-271"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">atomic_number</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-272"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">pr1</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-273"></a>     <span class="k">else</span>
<a name="ln-274"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">io1</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-275"></a>     <span class="k">end if</span>
<a name="ln-276"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-277"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">atomic_number</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-278"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">pr1</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-279"></a>     <span class="k">else</span>
<a name="ln-280"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">io2</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-281"></a>     <span class="k">end if</span>
<a name="ln-282"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-283"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="n">io2</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span> <span class="n">iout</span>
<a name="ln-284"></a>    <span class="k">end select</span>
<a name="ln-285"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-286"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-287"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-288"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-289"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-290"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-291"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-292"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-293"></a>
<a name="ln-294"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-295"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-296"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-297"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-298"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-299"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-300"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-301"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-302"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-303"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-304"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-305"></a>   <span class="k">end if</span>
<a name="ln-306"></a>
<a name="ln-307"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-308"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-309"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-310"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-311"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-312"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-313"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-314"></a>   <span class="k">else</span>
<a name="ln-315"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-316"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-317"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-318"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-319"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-320"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-321"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-322"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-323"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-324"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-325"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-326"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-327"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-328"></a>       <span class="k">end if</span>
<a name="ln-329"></a><span class="k">      end do</span>
<a name="ln-330"></a><span class="k">     end do</span>
<a name="ln-331"></a><span class="k">    end do</span>
<a name="ln-332"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-333"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-334"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-335"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-336"></a>    <span class="k">end do</span>
<a name="ln-337"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-338"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-339"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-340"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-341"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-342"></a>    <span class="k">end do</span>
<a name="ln-343"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-344"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-345"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-346"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-347"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-348"></a>    <span class="k">end do</span>
<a name="ln-349"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-350"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-351"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Den_Energy_Momenta written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-352"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-353"></a>   <span class="k">end if</span>
<a name="ln-354"></a><span class="k">  end subroutine</span>
<a name="ln-355"></a>
<a name="ln-356"></a>  <span class="c">!============================</span>
<a name="ln-357"></a>  <span class="k">subroutine </span><span class="n">bden_energy_out</span><span class="p">(</span><span class="n">cmp_loc</span><span class="p">)</span>
<a name="ln-358"></a>
<a name="ln-359"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cmp_loc</span>
<a name="ln-360"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;         &#39;</span>
<a name="ln-361"></a>
<a name="ln-362"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-363"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-364"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span>
<a name="ln-365"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-366"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-367"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-368"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-369"></a>
<a name="ln-370"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-371"></a>
<a name="ln-372"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-373"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-374"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-375"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-376"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-377"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-378"></a>
<a name="ln-379"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-380"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-381"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-382"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-383"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-384"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">jc</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">cmp_loc</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-385"></a>     <span class="k">end do</span>
<a name="ln-386"></a><span class="k">    end do</span>
<a name="ln-387"></a><span class="k">   end do</span>
<a name="ln-388"></a>
<a name="ln-389"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-390"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-391"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-392"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-393"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-394"></a>
<a name="ln-395"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-396"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-397"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-398"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-399"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-400"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-401"></a>
<a name="ln-402"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-403"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-404"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-405"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-406"></a>
<a name="ln-407"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bdenout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-408"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-409"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-410"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-411"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-412"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-413"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-414"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-415"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-416"></a>
<a name="ln-417"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-418"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-419"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-420"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-421"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-422"></a>
<a name="ln-423"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span> <span class="c">!qui</span>
<a name="ln-424"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-425"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-426"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-427"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-428"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-429"></a>   <span class="k">end if</span>
<a name="ln-430"></a>
<a name="ln-431"></a><span class="k">   if</span> <span class="p">(</span><span class="n">prl</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-432"></a><span class="k">    if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-433"></a><span class="k">     </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-434"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-435"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-436"></a>     <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-437"></a>     <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-438"></a>     <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-439"></a>    <span class="k">else</span>
<a name="ln-440"></a><span class="k">     </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-441"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-442"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-443"></a>      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-444"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-445"></a>       <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-446"></a>        <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-447"></a>        <span class="n">ipe</span> <span class="o">=</span> <span class="n">iq</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">ip</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-448"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-449"></a><span class="k">         </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-450"></a>         <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-451"></a>         <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-452"></a>         <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-453"></a>        <span class="k">end if</span>
<a name="ln-454"></a><span class="k">       end do</span>
<a name="ln-455"></a><span class="k">      end do</span>
<a name="ln-456"></a><span class="k">     end do</span>
<a name="ln-457"></a><span class="k">    end if</span>
<a name="ln-458"></a><span class="k">   end if</span>
<a name="ln-459"></a>
<a name="ln-460"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-461"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-462"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-463"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-464"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-465"></a>    <span class="k">end do</span>
<a name="ln-466"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-467"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-468"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-469"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-470"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-471"></a>    <span class="k">end do</span>
<a name="ln-472"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-473"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-474"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-475"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-476"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-477"></a>    <span class="k">end do</span>
<a name="ln-478"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-479"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-480"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Den_Energy_Momenta written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-481"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-482"></a>   <span class="k">end if</span>
<a name="ln-483"></a><span class="k">  end subroutine</span>
<a name="ln-484"></a>  <span class="c">!==========================</span>
<a name="ln-485"></a>  <span class="k">subroutine </span><span class="n">ext_bfield_out</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span>
<a name="ln-486"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-487"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
<a name="ln-488"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span>
<a name="ln-489"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-490"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-491"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-492"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-493"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-494"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-495"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-496"></a>
<a name="ln-497"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-498"></a>
<a name="ln-499"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-500"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-501"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-502"></a>
<a name="ln-503"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-504"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-505"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-506"></a>
<a name="ln-507"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-508"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-509"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-510"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-511"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-512"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-513"></a>     <span class="k">end do</span>
<a name="ln-514"></a><span class="k">    end do</span>
<a name="ln-515"></a><span class="k">   end do</span>
<a name="ln-516"></a>
<a name="ln-517"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-518"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-519"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-520"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-521"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-522"></a>
<a name="ln-523"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-524"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-525"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-526"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-527"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-528"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-529"></a>
<a name="ln-530"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-531"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-532"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-533"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-534"></a>
<a name="ln-535"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">f_ind</span><span class="p">)</span>
<a name="ln-536"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-537"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bx0out&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-538"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-539"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;By0out&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-540"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-541"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bz0out&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-542"></a>    <span class="k">end select</span>
<a name="ln-543"></a>
<a name="ln-544"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-545"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-546"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i10)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-547"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-548"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-549"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-550"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-551"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-552"></a>
<a name="ln-553"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-554"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-555"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-556"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-557"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-558"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-559"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-560"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-561"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-562"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-563"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-564"></a>   <span class="k">end if</span>
<a name="ln-565"></a>
<a name="ln-566"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-567"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-568"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-569"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-570"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-571"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-572"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-573"></a>   <span class="k">else</span>
<a name="ln-574"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-575"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-576"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-577"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-578"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-579"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-580"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-581"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-582"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-583"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-584"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-585"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-586"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-587"></a>       <span class="k">end if</span>
<a name="ln-588"></a><span class="k">      end do</span>
<a name="ln-589"></a><span class="k">     end do</span>
<a name="ln-590"></a><span class="k">    end do</span>
<a name="ln-591"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-592"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-593"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-594"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-595"></a>    <span class="k">end do</span>
<a name="ln-596"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-597"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-598"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-599"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-600"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-601"></a>    <span class="k">end do</span>
<a name="ln-602"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-603"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-604"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-605"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-606"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-607"></a>    <span class="k">end do</span>
<a name="ln-608"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-609"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-610"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-611"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-612"></a>   <span class="k">end if</span>
<a name="ln-613"></a><span class="k">  end subroutine</span>
<a name="ln-614"></a>
<a name="ln-615"></a><span class="k">  subroutine </span><span class="n">fields_out</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">,</span> <span class="n">f_var</span><span class="p">)</span>
<a name="ln-616"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-617"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
<a name="ln-618"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span><span class="p">,</span> <span class="n">f_var</span>
<a name="ln-619"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-620"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-621"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-622"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-623"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-624"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-625"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-626"></a>
<a name="ln-627"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-628"></a>
<a name="ln-629"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-630"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-631"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-632"></a>
<a name="ln-633"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-634"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-635"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-636"></a>
<a name="ln-637"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-638"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-639"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-640"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-641"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-642"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-643"></a>     <span class="k">end do</span>
<a name="ln-644"></a><span class="k">    end do</span>
<a name="ln-645"></a><span class="k">   end do</span>
<a name="ln-646"></a>
<a name="ln-647"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-648"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-649"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-650"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-651"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-652"></a>
<a name="ln-653"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-654"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-655"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-656"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-657"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-658"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-659"></a>
<a name="ln-660"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-661"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-662"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-663"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-664"></a>
<a name="ln-665"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">f_var</span><span class="p">)</span>
<a name="ln-666"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-667"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Jxfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-668"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-669"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Exfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-670"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-671"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Eyfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-672"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-673"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-674"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-675"></a>     <span class="k">else</span>
<a name="ln-676"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ezfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-677"></a>     <span class="k">end if</span>
<a name="ln-678"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-679"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bxfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-680"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-681"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Byfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-682"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-683"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-684"></a>    <span class="k">end select</span>
<a name="ln-685"></a>
<a name="ln-686"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-687"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-688"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-689"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-690"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-691"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-692"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-693"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-694"></a>
<a name="ln-695"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-696"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-697"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-698"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-699"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-700"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-701"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-702"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-703"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-704"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-705"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-706"></a>   <span class="k">end if</span>
<a name="ln-707"></a>
<a name="ln-708"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-709"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-710"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-711"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-712"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-713"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-714"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-715"></a>   <span class="k">else</span>
<a name="ln-716"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-717"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-718"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-719"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-720"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-721"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-722"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-723"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-724"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-725"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-726"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-727"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-728"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-729"></a>       <span class="k">end if</span>
<a name="ln-730"></a><span class="k">      end do</span>
<a name="ln-731"></a><span class="k">     end do</span>
<a name="ln-732"></a><span class="k">    end do</span>
<a name="ln-733"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-734"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-735"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-736"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-737"></a>    <span class="k">end do</span>
<a name="ln-738"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-739"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-740"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-741"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-742"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-743"></a>    <span class="k">end do</span>
<a name="ln-744"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-745"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-746"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-747"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-748"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-749"></a>    <span class="k">end do</span>
<a name="ln-750"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-751"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-752"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-753"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-754"></a>   <span class="k">end if</span>
<a name="ln-755"></a><span class="k">  end subroutine</span>
<a name="ln-756"></a>
<a name="ln-757"></a>  <span class="c">!==========================</span>
<a name="ln-758"></a>
<a name="ln-759"></a>  <span class="k">subroutine </span><span class="n">fields_out_new</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">,</span> <span class="n">var_ind</span><span class="p">)</span>
<a name="ln-760"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-761"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
<a name="ln-762"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fnamel</span> <span class="o">=</span> <span class="s1">&#39;            &#39;</span>
<a name="ln-763"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span> <span class="o">=</span> <span class="s1">&#39;                 &#39;</span>
<a name="ln-764"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_outl</span> <span class="o">=</span> <span class="s1">&#39;                     &#39;</span>
<a name="ln-765"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span><span class="p">,</span> <span class="n">var_ind</span>
<a name="ln-766"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span>
<a name="ln-767"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-768"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-769"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span><span class="p">,</span> <span class="n">disp_col</span>
<a name="ln-770"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">num_header_int</span><span class="p">,</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">header</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-771"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">ascii_grid</span><span class="p">(:)</span>
<a name="ln-772"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gridsize_x</span><span class="p">,</span> <span class="n">gridsize_y</span><span class="p">,</span> <span class="n">gridsize_z</span>
<a name="ln-773"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-774"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-775"></a>
<a name="ln-776"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-777"></a>
<a name="ln-778"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-779"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-780"></a>   <span class="n">gr_dim</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-781"></a>
<a name="ln-782"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-783"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-784"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-785"></a>
<a name="ln-786"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-787"></a>
<a name="ln-788"></a>   <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-789"></a>    <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-790"></a>     <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-791"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-792"></a>      <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-793"></a>     <span class="k">end do</span>
<a name="ln-794"></a><span class="k">    end do</span>
<a name="ln-795"></a><span class="k">   end do</span>
<a name="ln-796"></a>   <span class="c">!================================</span>
<a name="ln-797"></a>   <span class="k">call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-798"></a>   <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-799"></a>   <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-800"></a>   <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-801"></a>
<a name="ln-802"></a>   <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-803"></a>                     <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-804"></a>                     <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-805"></a>                     <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-806"></a>                     <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-807"></a>                     <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-808"></a>
<a name="ln-809"></a>   <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-810"></a>                    <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">ibx</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-811"></a>                    <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-812"></a>
<a name="ln-813"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">var_ind</span><span class="p">)</span>
<a name="ln-814"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-815"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;dvEout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-816"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-817"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Exfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-818"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-819"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Eyfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-820"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-821"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-822"></a><span class="k">     write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-823"></a>    <span class="k">else</span>
<a name="ln-824"></a><span class="k">     write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ezfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-825"></a>    <span class="k">end if</span>
<a name="ln-826"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-827"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bxfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-828"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-829"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Byfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-830"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-831"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzfout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-832"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-833"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Exbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-834"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-835"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Eybout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-836"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-837"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-838"></a><span class="k">     write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-839"></a>    <span class="k">else</span>
<a name="ln-840"></a><span class="k">     write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ezbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-841"></a>    <span class="k">end if</span>
<a name="ln-842"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-843"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Jxbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-844"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a name="ln-845"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bybout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-846"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-847"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-848"></a>   <span class="k">end select</span>
<a name="ln-849"></a>
<a name="ln-850"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-851"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-852"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-853"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-854"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-855"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-856"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Coordinates&#39;</span>
<a name="ln-857"></a>
<a name="ln-858"></a>    <span class="n">gridsize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="n">jump</span><span class="p">)</span>
<a name="ln-859"></a>    <span class="n">gridsize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="n">jump</span><span class="p">)</span>
<a name="ln-860"></a>    <span class="n">gridsize_z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nz</span><span class="o">/</span><span class="n">jump</span><span class="p">)</span>
<a name="ln-861"></a>    <span class="k">allocate</span> <span class="p">(</span><span class="n">ascii_grid</span><span class="p">(</span><span class="n">gridsize_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-862"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-863"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-864"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-865"></a>     <span class="n">ascii_grid</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-866"></a>    <span class="k">end do</span>
<a name="ln-867"></a><span class="k">    do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-868"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(es14.5)&#39;</span><span class="p">,</span> <span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="n">ascii_grid</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-869"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;&#39;</span>
<a name="ln-870"></a>    <span class="k">end do</span>
<a name="ln-871"></a><span class="k">    deallocate</span> <span class="p">(</span><span class="n">ascii_grid</span><span class="p">)</span>
<a name="ln-872"></a>    <span class="k">allocate</span> <span class="p">(</span><span class="n">ascii_grid</span><span class="p">(</span><span class="n">gridsize_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-873"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-874"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-875"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-876"></a>     <span class="n">ascii_grid</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-877"></a>    <span class="k">end do</span>
<a name="ln-878"></a><span class="k">    do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-879"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(es14.5)&#39;</span><span class="p">,</span> <span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="n">ascii_grid</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-880"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;&#39;</span>
<a name="ln-881"></a>    <span class="k">end do</span>
<a name="ln-882"></a><span class="k">    deallocate</span> <span class="p">(</span><span class="n">ascii_grid</span><span class="p">)</span>
<a name="ln-883"></a>    <span class="k">allocate</span> <span class="p">(</span><span class="n">ascii_grid</span><span class="p">(</span><span class="n">gridsize_z</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-884"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-885"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-886"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-887"></a>     <span class="n">ascii_grid</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-888"></a>    <span class="k">end do</span>
<a name="ln-889"></a><span class="k">    do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kk</span>
<a name="ln-890"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(es14.5)&#39;</span><span class="p">,</span> <span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="n">ascii_grid</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<a name="ln-891"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">iq</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;&#39;</span>
<a name="ln-892"></a>    <span class="k">end do</span>
<a name="ln-893"></a><span class="k">    close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-894"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields parameters written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-895"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-896"></a>   <span class="k">end if</span>
<a name="ln-897"></a>
<a name="ln-898"></a><span class="k">   </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-899"></a>   <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-900"></a>   <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-901"></a>   <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-902"></a>
<a name="ln-903"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fnamel</span><span class="p">,</span> <span class="s1">&#39;(a8,a1,i3.3)&#39;</span><span class="p">)</span> <span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-904"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-905"></a>   <span class="n">fname_outl</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fnamel</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-906"></a>   <span class="n">num_header_int</span> <span class="o">=</span> <span class="mi">3</span>
<a name="ln-907"></a>   <span class="n">header</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-908"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mype</span><span class="o">*</span><span class="p">(</span><span class="n">num_header_int</span> <span class="o">+</span> <span class="n">lenw</span><span class="p">)</span> <span class="c">! da usare con mpi_write !assuming that all procs have the same grid size</span>
<a name="ln-909"></a>   <span class="n">disp_col</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">imody</span><span class="o">*</span><span class="p">(</span><span class="n">num_header_int</span> <span class="o">+</span> <span class="n">lenw</span><span class="p">)</span> <span class="c">! con mpi_write_col !assuming that all procs have the same grid size</span>
<a name="ln-910"></a>
<a name="ln-911"></a>   <span class="k">call </span><span class="n">mpi_write_field</span><span class="p">(</span><span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">num_header_int</span><span class="p">,</span> <span class="n">disp</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-912"></a>                        <span class="n">fname_out</span><span class="p">)</span>
<a name="ln-913"></a>
<a name="ln-914"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-915"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-916"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-917"></a>   <span class="k">end if</span>
<a name="ln-918"></a>
<a name="ln-919"></a><span class="k">  end subroutine</span>
<a name="ln-920"></a>
<a name="ln-921"></a>  <span class="c">!==========================</span>
<a name="ln-922"></a>
<a name="ln-923"></a>  <span class="k">subroutine </span><span class="n">bfields_out</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">ef1</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span>
<a name="ln-924"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">ef1</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-925"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
<a name="ln-926"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span>
<a name="ln-927"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-928"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lun</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-929"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-930"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-931"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-932"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-933"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-934"></a>
<a name="ln-935"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-936"></a>
<a name="ln-937"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-938"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-939"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-940"></a>
<a name="ln-941"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-942"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-943"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-944"></a>
<a name="ln-945"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-946"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">ibeam</span><span class="p">)</span>
<a name="ln-947"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-948"></a>    <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-949"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-950"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-951"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-952"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-953"></a>      <span class="k">end do</span>
<a name="ln-954"></a><span class="k">     end do</span>
<a name="ln-955"></a><span class="k">    end do</span>
<a name="ln-956"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-957"></a>    <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-958"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-959"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-960"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-961"></a>       <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span> <span class="o">+</span> <span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">d34</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-962"></a><span class="k">        write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Error :: overflow in file output&#39;</span>
<a name="ln-963"></a>        <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(A,4I4)&#39;</span><span class="p">)</span> <span class="s1">&#39;index:&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span>
<a name="ln-964"></a>       <span class="k">end if</span>
<a name="ln-965"></a><span class="k">       </span><span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span> <span class="o">+</span> <span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-966"></a>      <span class="k">end do</span>
<a name="ln-967"></a><span class="k">     end do</span>
<a name="ln-968"></a><span class="k">    end do</span>
<a name="ln-969"></a><span class="k">   end select</span>
<a name="ln-970"></a>
<a name="ln-971"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-972"></a><span class="k">    call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-973"></a>    <span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-974"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-975"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-976"></a>
<a name="ln-977"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-978"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-979"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-980"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-981"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-982"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-983"></a>
<a name="ln-984"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-985"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-986"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-987"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">]</span>
<a name="ln-988"></a>
<a name="ln-989"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">f_ind</span><span class="p">)</span>
<a name="ln-990"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-991"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Exbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-992"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-993"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Eybout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-994"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-995"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">nfield</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-996"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-997"></a>     <span class="k">else</span>
<a name="ln-998"></a><span class="k">      write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ezbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-999"></a>     <span class="k">end if</span>
<a name="ln-1000"></a><span class="k">    case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1001"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Jxbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1002"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1003"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bybout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1004"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1005"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Bzbout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1006"></a>    <span class="k">end select</span>
<a name="ln-1007"></a>
<a name="ln-1008"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1009"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-1010"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i14)&#39;</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-1011"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-1012"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4e14.5)&#39;</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-1013"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1014"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Field data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1015"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-1016"></a>
<a name="ln-1017"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1018"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1019"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1020"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1021"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1022"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-1023"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-1024"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-1025"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-1026"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1027"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1028"></a>   <span class="k">end if</span>
<a name="ln-1029"></a>
<a name="ln-1030"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1031"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1032"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1033"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1034"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1035"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-1036"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
<a name="ln-1037"></a>   <span class="k">else</span>
<a name="ln-1038"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-1039"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1040"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1041"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1042"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1043"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1044"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1045"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-1046"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1047"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1048"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
<a name="ln-1049"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1050"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1051"></a>       <span class="k">end if</span>
<a name="ln-1052"></a><span class="k">      end do</span>
<a name="ln-1053"></a><span class="k">     end do</span>
<a name="ln-1054"></a><span class="k">    end do</span>
<a name="ln-1055"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1056"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1057"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1058"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1059"></a>    <span class="k">end do</span>
<a name="ln-1060"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1061"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1062"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1063"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1064"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1065"></a>    <span class="k">end do</span>
<a name="ln-1066"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1067"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1068"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1069"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1070"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1071"></a>    <span class="k">end do</span>
<a name="ln-1072"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1073"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1074"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1075"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1076"></a>   <span class="k">end if</span>
<a name="ln-1077"></a><span class="k">  end subroutine</span>
<a name="ln-1078"></a>
<a name="ln-1079"></a>  <span class="c">!==========================</span>
<a name="ln-1080"></a>  <span class="k">subroutine </span><span class="n">env_two_fields_out</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">ef1</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span>
<a name="ln-1081"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">ef1</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1082"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;         &#39;</span>
<a name="ln-1083"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span>
<a name="ln-1084"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-1085"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-1086"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1087"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">lun</span>
<a name="ln-1088"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-1089"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a2</span><span class="p">,</span> <span class="n">avec</span>
<a name="ln-1090"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1091"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-1092"></a>
<a name="ln-1093"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1094"></a>
<a name="ln-1095"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1096"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1097"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1098"></a>
<a name="ln-1099"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-1100"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-1101"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-1102"></a>
<a name="ln-1103"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1104"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">f_ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1105"></a><span class="k">    do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1106"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1107"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1108"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1109"></a>       <span class="n">a2</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1110"></a>            <span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1111"></a>       <span class="n">avec</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<a name="ln-1112"></a>       <span class="n">a2</span> <span class="o">=</span> <span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1113"></a>            <span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1114"></a>       <span class="n">avec</span> <span class="o">=</span> <span class="n">avec</span> <span class="o">+</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<a name="ln-1115"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1116"></a>      <span class="k">end do</span>
<a name="ln-1117"></a><span class="k">     end do</span>
<a name="ln-1118"></a><span class="k">    end do</span>
<a name="ln-1119"></a><span class="k">   else</span>
<a name="ln-1120"></a><span class="k">    do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1121"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1122"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1123"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1124"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1125"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef1</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1126"></a>      <span class="k">end do</span>
<a name="ln-1127"></a><span class="k">     end do</span>
<a name="ln-1128"></a><span class="k">    end do</span>
<a name="ln-1129"></a><span class="k">   end if</span>
<a name="ln-1130"></a>
<a name="ln-1131"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1132"></a><span class="k">    </span><span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-1133"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-1134"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-1135"></a>
<a name="ln-1136"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1137"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1138"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1139"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1140"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1141"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1142"></a>
<a name="ln-1143"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1144"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1145"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1146"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">]</span>
<a name="ln-1147"></a>
<a name="ln-1148"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">f_ind</span><span class="p">)</span>
<a name="ln-1149"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1150"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Aenvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1151"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1152"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Renvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1153"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1154"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ienvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1155"></a>    <span class="k">end select</span>
<a name="ln-1156"></a>
<a name="ln-1157"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1158"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1159"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1160"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1161"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1162"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-1163"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-1164"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-1165"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-1166"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1167"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1168"></a>   <span class="k">end if</span>
<a name="ln-1169"></a>
<a name="ln-1170"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1171"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1172"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1173"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1174"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1175"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-1176"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-1177"></a>   <span class="k">else</span>
<a name="ln-1178"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-1179"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1180"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1181"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1182"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1183"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1184"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1185"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-1186"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1187"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1188"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-1189"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1190"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1191"></a>       <span class="k">end if</span>
<a name="ln-1192"></a><span class="k">      end do</span>
<a name="ln-1193"></a><span class="k">     end do</span>
<a name="ln-1194"></a><span class="k">    end do</span>
<a name="ln-1195"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1196"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1197"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1198"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1199"></a>    <span class="k">end do</span>
<a name="ln-1200"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1201"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1202"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1203"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1204"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1205"></a>    <span class="k">end do</span>
<a name="ln-1206"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1207"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1208"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1209"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1210"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1211"></a>    <span class="k">end do</span>
<a name="ln-1212"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1213"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1214"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1215"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1216"></a>   <span class="k">end if</span>
<a name="ln-1217"></a><span class="k">  end subroutine</span>
<a name="ln-1218"></a>
<a name="ln-1219"></a><span class="k">  subroutine </span><span class="n">env_fields_out</span><span class="p">(</span><span class="n">ef</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">)</span>
<a name="ln-1220"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-1221"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;         &#39;</span>
<a name="ln-1222"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">f_ind</span>
<a name="ln-1223"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">iq</span><span class="p">,</span> <span class="n">ipe</span>
<a name="ln-1224"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="n">nz1</span>
<a name="ln-1225"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1226"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">lun</span>
<a name="ln-1227"></a>   <span class="kt">logical</span> <span class="kd">::</span> <span class="n">sd</span>
<a name="ln-1228"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1229"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-1230"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a2</span><span class="p">,</span> <span class="n">avec</span>
<a name="ln-1231"></a>
<a name="ln-1232"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1233"></a>
<a name="ln-1234"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1235"></a>   <span class="n">real_par</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1236"></a>   <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1237"></a>
<a name="ln-1238"></a>   <span class="n">j1</span> <span class="o">=</span> <span class="n">jy1</span>
<a name="ln-1239"></a>   <span class="n">k1</span> <span class="o">=</span> <span class="n">kz1</span>
<a name="ln-1240"></a>   <span class="n">i1</span> <span class="o">=</span> <span class="n">ix1</span>
<a name="ln-1241"></a>
<a name="ln-1242"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1243"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">f_ind</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1244"></a><span class="k">    do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1245"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1246"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1247"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1248"></a>       <span class="n">a2</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1249"></a>            <span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1250"></a>       <span class="n">avec</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<a name="ln-1251"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">avec</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1252"></a>      <span class="k">end do</span>
<a name="ln-1253"></a><span class="k">     end do</span>
<a name="ln-1254"></a><span class="k">    end do</span>
<a name="ln-1255"></a><span class="k">   else</span>
<a name="ln-1256"></a><span class="k">    do </span><span class="n">iz</span> <span class="o">=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">nzp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1257"></a>     <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="n">j1</span><span class="p">,</span> <span class="n">nyp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1258"></a>      <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">nxp</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1259"></a>       <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1260"></a>       <span class="n">wdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ef</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">f_ind</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1261"></a>      <span class="k">end do</span>
<a name="ln-1262"></a><span class="k">     end do</span>
<a name="ln-1263"></a><span class="k">    end do</span>
<a name="ln-1264"></a><span class="k">   end if</span>
<a name="ln-1265"></a>
<a name="ln-1266"></a><span class="k">   if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1267"></a><span class="k">    </span><span class="n">nx1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_xloc</span><span class="p">))</span>
<a name="ln-1268"></a>    <span class="n">ny1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_yloc</span><span class="p">))</span>
<a name="ln-1269"></a>    <span class="n">nz1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe_zloc</span><span class="p">))</span>
<a name="ln-1270"></a>
<a name="ln-1271"></a>    <span class="n">real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">tnow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1272"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1273"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n_over_nc</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1274"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ompe</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">targ_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1275"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">targ_end</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">nb_over_np</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1276"></a>                      <span class="kt">real</span><span class="p">(</span><span class="n">b_charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">vbeam</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1277"></a>
<a name="ln-1278"></a>    <span class="n">int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe_yloc</span><span class="p">,</span> <span class="n">npe_zloc</span><span class="p">,</span> <span class="n">npe_xloc</span><span class="p">,</span> <span class="n">nx1</span><span class="p">,</span> <span class="n">ny1</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1279"></a>                     <span class="n">loc_nyc_max</span><span class="p">,</span> <span class="n">nz1</span><span class="p">,</span> <span class="n">loc_nzc_max</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">iby</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1280"></a>                     <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1281"></a>                     <span class="n">file_version</span><span class="p">,</span> <span class="n">ibeam</span><span class="p">]</span>
<a name="ln-1282"></a>
<a name="ln-1283"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">f_ind</span><span class="p">)</span>
<a name="ln-1284"></a>    <span class="k">case</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1285"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;aenvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1286"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1287"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Aenvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1288"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1289"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Renvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1290"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1291"></a>     <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a7,i2.2)&#39;</span><span class="p">)</span> <span class="s1">&#39;Ienvout&#39;</span><span class="p">,</span> <span class="n">iout</span>
<a name="ln-1292"></a>    <span class="k">end select</span>
<a name="ln-1293"></a>
<a name="ln-1294"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1295"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1296"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1297"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1298"></a>    <span class="n">lun</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-1299"></a>    <span class="k">open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-1300"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">par_dim</span>
<a name="ln-1301"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">int_par</span>
<a name="ln-1302"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">real_par</span>
<a name="ln-1303"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1304"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1305"></a>   <span class="k">end if</span>
<a name="ln-1306"></a>
<a name="ln-1307"></a><span class="k">   if</span> <span class="p">(</span><span class="n">mype</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1308"></a><span class="k">    </span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">imodx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1309"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">imody</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1310"></a>    <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">imodz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1311"></a>    <span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1312"></a>    <span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-1313"></a>    <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">pe_min</span><span class="p">,</span> <span class="n">mype</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-1314"></a>   <span class="k">else</span>
<a name="ln-1315"></a><span class="k">    </span><span class="n">sd</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-1316"></a>    <span class="k">do </span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_xloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1317"></a>     <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">nxh</span><span class="p">(</span><span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1318"></a>     <span class="k">do </span><span class="n">iz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_zloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1319"></a>      <span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">nzh</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1320"></a>      <span class="k">do </span><span class="n">iy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npe_yloc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-1321"></a>       <span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">nyh</span><span class="p">(</span><span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1322"></a>       <span class="n">ipe</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">+</span> <span class="n">npe_yloc</span><span class="o">*</span><span class="p">(</span><span class="n">iz</span> <span class="o">+</span> <span class="n">npe_zloc</span><span class="o">*</span><span class="n">ix</span><span class="p">)</span>
<a name="ln-1323"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1324"></a><span class="k">        </span><span class="n">lenw</span> <span class="o">=</span> <span class="n">gr_dim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">gr_dim</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1325"></a>        <span class="k">call </span><span class="n">exchange_pdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="n">lenw</span><span class="p">,</span> <span class="n">ipe</span><span class="p">,</span> <span class="n">ipe</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<a name="ln-1326"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">gr_dim</span>
<a name="ln-1327"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="n">wdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">lenw</span><span class="p">)</span>
<a name="ln-1328"></a>       <span class="k">end if</span>
<a name="ln-1329"></a><span class="k">      end do</span>
<a name="ln-1330"></a><span class="k">     end do</span>
<a name="ln-1331"></a><span class="k">    end do</span>
<a name="ln-1332"></a><span class="k">    </span><span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1333"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1334"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1335"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1336"></a>    <span class="k">end do</span>
<a name="ln-1337"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1338"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1339"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1340"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1341"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1342"></a>    <span class="k">end do</span>
<a name="ln-1343"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1344"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1345"></a>    <span class="k">do </span><span class="n">iq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">jump</span>
<a name="ln-1346"></a>     <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1347"></a>     <span class="n">gwdata</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">iq</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1348"></a>    <span class="k">end do</span>
<a name="ln-1349"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">gwdata</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kk</span><span class="p">)</span>
<a name="ln-1350"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1351"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Fields written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1352"></a>     <span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1353"></a>   <span class="k">end if</span>
<a name="ln-1354"></a><span class="k">  end subroutine</span>
<a name="ln-1355"></a>  <span class="c">!================================</span>
<a name="ln-1356"></a>  <span class="k">subroutine </span><span class="n">part_pdata_out</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">xmin_out</span><span class="p">,</span> <span class="n">xmax_out</span><span class="p">,</span> <span class="n">ymax_out</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1357"></a>                            <span class="n">jmp</span><span class="p">)</span>
<a name="ln-1358"></a>
<a name="ln-1359"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">part_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Elpout&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1360"></a>                                                          <span class="s1">&#39;H1pout&#39;</span><span class="p">,</span> <span class="s1">&#39;Prpout&#39;</span><span class="p">,</span> <span class="s1">&#39;H2pout&#39;</span><span class="p">]</span>
<a name="ln-1361"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span>
<a name="ln-1362"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span>
<a name="ln-1363"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fnamel</span>
<a name="ln-1364"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_outl</span>
<a name="ln-1365"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">timenow</span><span class="p">,</span> <span class="n">xmin_out</span><span class="p">,</span> <span class="n">xmax_out</span><span class="p">,</span> <span class="n">ymax_out</span>
<a name="ln-1366"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jmp</span>
<a name="ln-1367"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pdata</span><span class="p">(:)</span>
<a name="ln-1368"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1369"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">,</span> <span class="n">nptot</span>
<a name="ln-1370"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">npe</span><span class="p">),</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-1371"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span><span class="p">,</span> <span class="n">disp_col</span>
<a name="ln-1372"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span>
<a name="ln-1373"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1374"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-1375"></a>
<a name="ln-1376"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1377"></a>
<a name="ln-1378"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1379"></a>   <span class="n">np</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
<a name="ln-1380"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1381"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1382"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1383"></a><span class="k">     do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">jmp</span>
<a name="ln-1384"></a>      <span class="n">yy</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1385"></a>      <span class="n">zz</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-1386"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ymax_out</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ymax_out</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1387"></a><span class="k">       </span><span class="n">xx</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1388"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">xx</span> <span class="o">&gt;=</span> <span class="n">xmin_out</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xx</span> <span class="o">&lt;=</span> <span class="n">xmax_out</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1389"></a><span class="k">        </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1390"></a>        <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1391"></a>         <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1392"></a>        <span class="k">end do</span>
<a name="ln-1393"></a><span class="k">       end if</span>
<a name="ln-1394"></a><span class="k">      end if</span>
<a name="ln-1395"></a><span class="k">     end do</span>
<a name="ln-1396"></a><span class="k">    else</span>
<a name="ln-1397"></a><span class="k">     </span><span class="n">zz</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1398"></a>     <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">jmp</span>
<a name="ln-1399"></a>      <span class="n">yy</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-1400"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ymax_out</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1401"></a><span class="k">       </span><span class="n">xx</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1402"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">xx</span> <span class="o">&gt;=</span> <span class="n">xmin_out</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">xx</span> <span class="o">&lt;=</span> <span class="n">xmax_out</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1403"></a><span class="k">        </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1404"></a>        <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1405"></a>         <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">pid</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1406"></a>        <span class="k">end do</span>
<a name="ln-1407"></a><span class="k">       end if</span>
<a name="ln-1408"></a><span class="k">      end if</span>
<a name="ln-1409"></a><span class="k">     end do</span>
<a name="ln-1410"></a><span class="k">    end if</span>
<a name="ln-1411"></a><span class="k">   end if</span>
<a name="ln-1412"></a><span class="k">   </span><span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1413"></a>
<a name="ln-1414"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1415"></a>   <span class="k">call </span><span class="n">intvec_distribute</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">,</span> <span class="n">npe</span><span class="p">)</span>
<a name="ln-1416"></a>
<a name="ln-1417"></a>   <span class="c">! this differs from nptot_global since it represents just the reduced number of particles</span>
<a name="ln-1418"></a>   <span class="c">! that will be present in the output (should be equal to nptot_global for p_jump=1)!</span>
<a name="ln-1419"></a>   <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1420"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe</span>
<a name="ln-1421"></a>    <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="n">nptot_global_reduced</span> <span class="o">+</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1422"></a>   <span class="k">end do</span>
<a name="ln-1423"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nptot_global</span> <span class="o">&lt;</span> <span class="mf">1e9</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1424"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot_global_reduced</span><span class="p">)</span>
<a name="ln-1425"></a>   <span class="k">else</span>
<a name="ln-1426"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-1427"></a>   <span class="k">end if</span>
<a name="ln-1428"></a>
<a name="ln-1429"></a><span class="k">   </span><span class="n">ip_max</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1430"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="n">ip_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-1431"></a>   <span class="n">lenp</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1432"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">(</span><span class="n">lenp</span><span class="p">))</span>
<a name="ln-1433"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1434"></a>   <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1435"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span>
<a name="ln-1436"></a>     <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1437"></a>     <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1438"></a>    <span class="k">end do</span>
<a name="ln-1439"></a><span class="k">    </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1440"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1441"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-1442"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1443"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1444"></a>   <span class="k">end do</span>
<a name="ln-1445"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">/=</span> <span class="n">lenp</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a16,3i8)&#39;</span><span class="p">)</span> <span class="s1">&#39;wrong pdata size&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1446"></a>    <span class="n">ik</span>
<a name="ln-1447"></a>
<a name="ln-1448"></a>   <span class="k">call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-1449"></a>   <span class="n">part_real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1450"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1451"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1452"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n0_ref</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">np_per_cell</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1453"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">j0_norm</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">mass</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1454"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">xmax_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam_min</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1455"></a>
<a name="ln-1456"></a>   <span class="n">part_int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1457"></a>                         <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1458"></a>                         <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">nx_loc</span><span class="p">,</span> <span class="n">ny_loc</span><span class="p">,</span> <span class="n">nz_loc</span><span class="p">,</span> <span class="n">pjump</span><span class="p">]</span>
<a name="ln-1459"></a>
<a name="ln-1460"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2)&#39;</span><span class="p">)</span> <span class="n">part_files</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">iout</span> <span class="c">!serve sempre</span>
<a name="ln-1461"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fnamel</span><span class="p">,</span> <span class="s1">&#39;(a6,i2.2,a1,i3.3)&#39;</span><span class="p">)</span> <span class="n">part_files</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">iout</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">imodz</span> <span class="c">!usare con mpi_write_part_col</span>
<a name="ln-1462"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1463"></a>   <span class="n">fname_outl</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fnamel</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1464"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1465"></a>   <span class="n">disp_col</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1466"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1467"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1468"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-1469"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1470"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a13,e11.4)&#39;</span><span class="p">)</span> <span class="n">rpar</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">part_real_par</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-1471"></a>    <span class="k">end do</span>
<a name="ln-1472"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-1473"></a>    <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1474"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a12,i8)&#39;</span><span class="p">)</span> <span class="n">ipar</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">part_int_par</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-1475"></a>    <span class="k">end do</span>
<a name="ln-1476"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Number of particles in the output box&#39;</span>
<a name="ln-1477"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i20)&#39;</span><span class="p">)</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1478"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1479"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles param written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1480"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-1481"></a>   <span class="k">else</span>
<a name="ln-1482"></a><span class="k">    </span><span class="n">disp</span> <span class="o">=</span> <span class="n">mype</span> <span class="o">+</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mype</span><span class="p">))</span> <span class="c">! da usare con mpi_write_part</span>
<a name="ln-1483"></a>   <span class="k">end if</span>
<a name="ln-1484"></a>
<a name="ln-1485"></a><span class="k">   if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">mype</span><span class="p">,</span> <span class="n">npe_yloc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">disp_col</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="n">imodz</span><span class="o">*</span><span class="n">npe_yloc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="p">&amp;</span>
<a name="ln-1486"></a>                                                          <span class="n">mype</span><span class="p">))</span> <span class="c">! da usare con mpi_write_part_col</span>
<a name="ln-1487"></a>
<a name="ln-1488"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span><span class="o">*</span><span class="mi">4</span> <span class="c">! sia gli int che i float sono di 4 bytes</span>
<a name="ln-1489"></a>   <span class="n">disp_col</span> <span class="o">=</span> <span class="n">disp_col</span><span class="o">*</span><span class="mi">4</span>
<a name="ln-1490"></a>
<a name="ln-1491"></a>   <span class="k">call </span><span class="n">mpi_write_part</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">disp</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">fname_out</span><span class="p">)</span>
<a name="ln-1492"></a>
<a name="ln-1493"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pdata</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span>
<a name="ln-1494"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1495"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1496"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1497"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Output logical flag &#39;</span><span class="p">,</span> <span class="n">l_force_singlefile_output</span>
<a name="ln-1498"></a>   <span class="k">end if</span>
<a name="ln-1499"></a><span class="k">  end subroutine</span>
<a name="ln-1500"></a>
<a name="ln-1501"></a><span class="c">!==========================</span>
<a name="ln-1502"></a>  <span class="k">subroutine </span><span class="n">part_high_gamma_out</span><span class="p">(</span><span class="n">gam_in</span><span class="p">,</span> <span class="n">timenow</span><span class="p">)</span>
<a name="ln-1503"></a>
<a name="ln-1504"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">part_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E_hg_out&#39;</span><span class="p">]</span>
<a name="ln-1505"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span>
<a name="ln-1506"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span>
<a name="ln-1507"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gam_in</span><span class="p">,</span> <span class="n">timenow</span>
<a name="ln-1508"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pdata</span><span class="p">(:)</span>
<a name="ln-1509"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1510"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">id_ch</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">,</span> <span class="n">nptot</span>
<a name="ln-1511"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">jmp</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">npe</span><span class="p">),</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-1512"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span>
<a name="ln-1513"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gam</span><span class="p">,</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1514"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1515"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-1516"></a>
<a name="ln-1517"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1518"></a>   <span class="n">jmp</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1519"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1520"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1521"></a>   <span class="n">ne</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1522"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">nd2</span><span class="p">)</span>
<a name="ln-1523"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1524"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1525"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1526"></a><span class="k">     do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span>
<a name="ln-1527"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1528"></a>      <span class="n">gam</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1529"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">gam</span> <span class="o">&gt;</span> <span class="n">gam_in</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1530"></a><span class="k">       </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1531"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1532"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1533"></a>       <span class="k">end do</span>
<a name="ln-1534"></a><span class="k">      end if</span>
<a name="ln-1535"></a><span class="k">     end do</span>
<a name="ln-1536"></a><span class="k">    end if</span>
<a name="ln-1537"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1538"></a>    <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1539"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1540"></a><span class="k">     do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span>
<a name="ln-1541"></a>      <span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1542"></a>      <span class="n">gam</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pp</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1543"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">gam</span> <span class="o">&gt;</span> <span class="n">gam_in</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1544"></a><span class="k">       </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1545"></a>       <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1546"></a>        <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1547"></a>       <span class="k">end do</span>
<a name="ln-1548"></a><span class="k">      end if</span>
<a name="ln-1549"></a><span class="k">     end do</span>
<a name="ln-1550"></a><span class="k">    end if</span>
<a name="ln-1551"></a><span class="k">   end select</span>
<a name="ln-1552"></a><span class="k">   </span><span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1553"></a>
<a name="ln-1554"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1555"></a>   <span class="k">call </span><span class="n">intvec_distribute</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">,</span> <span class="n">npe</span><span class="p">)</span>
<a name="ln-1556"></a>   <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1557"></a>   <span class="c">!nptot_global_reduced=sum(ip_loc(1:npe))</span>
<a name="ln-1558"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe</span>
<a name="ln-1559"></a>    <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="n">nptot_global_reduced</span> <span class="o">+</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1560"></a>   <span class="k">end do</span>
<a name="ln-1561"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nptot_global</span> <span class="o">&lt;</span> <span class="mf">1e9</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1562"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot_global_reduced</span><span class="p">)</span>
<a name="ln-1563"></a>   <span class="k">else</span>
<a name="ln-1564"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-1565"></a>   <span class="k">end if</span>
<a name="ln-1566"></a><span class="k">   </span><span class="n">ip_max</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1567"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="n">ip_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-1568"></a>   <span class="n">lenp</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">ip</span>
<a name="ln-1569"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lenp</span><span class="p">)</span>
<a name="ln-1570"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">(</span><span class="n">lenp</span><span class="p">))</span>
<a name="ln-1571"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1572"></a>   <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-1573"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span>
<a name="ln-1574"></a>     <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1575"></a>     <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1576"></a>    <span class="k">end do</span>
<a name="ln-1577"></a><span class="k">    </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1578"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1579"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-1580"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1581"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1582"></a>   <span class="k">end do</span>
<a name="ln-1583"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">/=</span> <span class="n">lenp</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a16,3i8)&#39;</span><span class="p">)</span> <span class="s1">&#39;wrong pdata size&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1584"></a>    <span class="n">ik</span>
<a name="ln-1585"></a>
<a name="ln-1586"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1587"></a>   <span class="k">call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-1588"></a>
<a name="ln-1589"></a>   <span class="n">part_real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1590"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1591"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1592"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n0_ref</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">np_per_cell</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1593"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">wgh_ion</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">mass</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xp0_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1594"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">xp1_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">yp_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam_in</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1595"></a>
<a name="ln-1596"></a>   <span class="n">part_int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1597"></a>                         <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1598"></a>                         <span class="n">ndv</span><span class="p">,</span> <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">nx_loc</span><span class="p">,</span> <span class="n">ny_loc</span><span class="p">,</span> <span class="n">nz_loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a name="ln-1599"></a>
<a name="ln-1600"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a8,i2.2)&#39;</span><span class="p">)</span> <span class="n">part_files</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">iout</span> <span class="c">!serve sempre</span>
<a name="ln-1601"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1602"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1603"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1604"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1605"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-1606"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1607"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a13,e11.4)&#39;</span><span class="p">)</span> <span class="n">rpar</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">part_real_par</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-1608"></a>    <span class="k">end do</span>
<a name="ln-1609"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-1610"></a>    <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1611"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a12,i8)&#39;</span><span class="p">)</span> <span class="n">ipar</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">part_int_par</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-1612"></a>    <span class="k">end do</span>
<a name="ln-1613"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Number of particles in the output box&#39;</span>
<a name="ln-1614"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i20)&#39;</span><span class="p">)</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1615"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1616"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles param written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1617"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-1618"></a>   <span class="k">else</span>
<a name="ln-1619"></a><span class="k">    </span><span class="n">disp</span> <span class="o">=</span> <span class="n">mype</span> <span class="o">+</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mype</span><span class="p">))</span> <span class="c">! da usare con mpi_write_part</span>
<a name="ln-1620"></a>   <span class="k">end if</span>
<a name="ln-1621"></a>
<a name="ln-1622"></a><span class="k">   </span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span><span class="o">*</span><span class="mi">4</span> <span class="c">! sia gli int che i float sono di 4 bytes</span>
<a name="ln-1623"></a>   <span class="k">call </span><span class="n">mpi_write_part</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">disp</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">fname_out</span><span class="p">)</span>
<a name="ln-1624"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pdata</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span>
<a name="ln-1625"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1626"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1627"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1628"></a>   <span class="k">end if</span>
<a name="ln-1629"></a><span class="k">  end subroutine</span>
<a name="ln-1630"></a>
<a name="ln-1631"></a><span class="k">  subroutine </span><span class="n">part_bdata_out</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jmp</span><span class="p">)</span>
<a name="ln-1632"></a>
<a name="ln-1633"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">part_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;E_bunch_out&#39;</span><span class="p">]</span>
<a name="ln-1634"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span>
<a name="ln-1635"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span>
<a name="ln-1636"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">timenow</span>
<a name="ln-1637"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jmp</span>
<a name="ln-1638"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pdata</span><span class="p">(:)</span>
<a name="ln-1639"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1640"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">id_ch</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">,</span> <span class="n">nptot</span>
<a name="ln-1641"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ne</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">npe</span><span class="p">),</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-1642"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span>
<a name="ln-1643"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1644"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-1645"></a>
<a name="ln-1646"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1647"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1648"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1649"></a>   <span class="n">ne</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1650"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1651"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1652"></a><span class="k">    do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">jmp</span>
<a name="ln-1653"></a>     <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-1654"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1655"></a><span class="k">      </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1656"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1657"></a>       <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1658"></a>      <span class="k">end do</span>
<a name="ln-1659"></a><span class="k">     end if</span>
<a name="ln-1660"></a><span class="k">    end do</span>
<a name="ln-1661"></a><span class="k">   end if</span>
<a name="ln-1662"></a><span class="k">   </span><span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1663"></a>
<a name="ln-1664"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1665"></a>   <span class="k">call </span><span class="n">intvec_distribute</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">,</span> <span class="n">npe</span><span class="p">)</span>
<a name="ln-1666"></a>   <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1667"></a>   <span class="c">!nptot_global_reduced=sum(ip_loc(1:npe))</span>
<a name="ln-1668"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe</span>
<a name="ln-1669"></a>    <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="n">nptot_global_reduced</span> <span class="o">+</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1670"></a>   <span class="k">end do</span>
<a name="ln-1671"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nptot_global</span> <span class="o">&lt;</span> <span class="mf">1e9</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1672"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot_global_reduced</span><span class="p">)</span>
<a name="ln-1673"></a>   <span class="k">else</span>
<a name="ln-1674"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-1675"></a>   <span class="k">end if</span>
<a name="ln-1676"></a><span class="k">   </span><span class="n">ip_max</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1677"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="n">ip_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-1678"></a>   <span class="n">lenp</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">ip</span>
<a name="ln-1679"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lenp</span><span class="p">)</span>
<a name="ln-1680"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">(</span><span class="n">lenp</span><span class="p">))</span>
<a name="ln-1681"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1682"></a>   <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-1683"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span>
<a name="ln-1684"></a>     <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1685"></a>     <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1686"></a>    <span class="k">end do</span>
<a name="ln-1687"></a><span class="k">    </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1688"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1689"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-1690"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1691"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1692"></a>   <span class="k">end do</span>
<a name="ln-1693"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">/=</span> <span class="n">lenp</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a16,3i8)&#39;</span><span class="p">)</span> <span class="s1">&#39;wrong pdata size&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1694"></a>    <span class="n">ik</span>
<a name="ln-1695"></a>
<a name="ln-1696"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1697"></a>   <span class="k">call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-1698"></a>
<a name="ln-1699"></a>   <span class="n">part_real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1700"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1701"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1702"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n0_ref</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">np_per_cell</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1703"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">wgh_ion</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">mass</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xp0_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1704"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">xp1_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">yp_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam_min</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1705"></a>
<a name="ln-1706"></a>   <span class="n">part_int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1707"></a>                         <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="n">ndv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1708"></a>                         <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">nx_loc</span><span class="p">,</span> <span class="n">ny_loc</span><span class="p">,</span> <span class="n">nz_loc</span><span class="p">,</span> <span class="n">pjump</span><span class="p">]</span>
<a name="ln-1709"></a>
<a name="ln-1710"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a11,i2.2)&#39;</span><span class="p">)</span> <span class="n">part_files</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">iout</span> <span class="c">!serve sempre</span>
<a name="ln-1711"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1712"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1713"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1714"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1715"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-1716"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1717"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a13,e11.4)&#39;</span><span class="p">)</span> <span class="n">rpar</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">part_real_par</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-1718"></a>    <span class="k">end do</span>
<a name="ln-1719"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-1720"></a>    <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1721"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a12,i8)&#39;</span><span class="p">)</span> <span class="n">ipar</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">part_int_par</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-1722"></a>    <span class="k">end do</span>
<a name="ln-1723"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Number of particles in the output box&#39;</span>
<a name="ln-1724"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i20)&#39;</span><span class="p">)</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1725"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1726"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles param written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1727"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-1728"></a>   <span class="k">else</span>
<a name="ln-1729"></a><span class="k">    </span><span class="n">disp</span> <span class="o">=</span> <span class="n">mype</span> <span class="o">+</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mype</span><span class="p">))</span> <span class="c">! da usare con mpi_write_part</span>
<a name="ln-1730"></a>   <span class="k">end if</span>
<a name="ln-1731"></a>
<a name="ln-1732"></a><span class="k">   </span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span><span class="o">*</span><span class="mi">4</span> <span class="c">! sia gli int che i float sono di 4 bytes</span>
<a name="ln-1733"></a>   <span class="k">call </span><span class="n">mpi_write_part</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">disp</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">fname_out</span><span class="p">)</span>
<a name="ln-1734"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pdata</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span>
<a name="ln-1735"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1736"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1737"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1738"></a>   <span class="k">end if</span>
<a name="ln-1739"></a><span class="k">  end subroutine</span>
<a name="ln-1740"></a>  <span class="c">!==============================================</span>
<a name="ln-1741"></a>  <span class="k">subroutine </span><span class="n">part_ionz_out</span><span class="p">(</span><span class="n">timenow</span><span class="p">)</span>
<a name="ln-1742"></a>
<a name="ln-1743"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">part_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Eionzout&#39;</span><span class="p">]</span>
<a name="ln-1744"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span>
<a name="ln-1745"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname_out</span>
<a name="ln-1746"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">timenow</span>
<a name="ln-1747"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pdata</span><span class="p">(:)</span>
<a name="ln-1748"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1749"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">id_ch</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">,</span> <span class="n">nptot</span>
<a name="ln-1750"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">jmp</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">npe</span><span class="p">),</span> <span class="n">ndv</span><span class="p">,</span> <span class="n">i_end</span>
<a name="ln-1751"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">offset_kind</span><span class="p">)</span> <span class="kd">::</span> <span class="n">disp</span>
<a name="ln-1752"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ch_ion</span>
<a name="ln-1753"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">foldername</span>
<a name="ln-1754"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">file_version</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-1755"></a>
<a name="ln-1756"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">iout</span>
<a name="ln-1757"></a>   <span class="n">jmp</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1758"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1759"></a>   <span class="n">ndv</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-1760"></a>   <span class="n">ch_ion</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">wgh_ion</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1761"></a>   <span class="n">ne</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1762"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1763"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ne</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1764"></a><span class="k">    do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span>
<a name="ln-1765"></a>     <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-1766"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">part_ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1767"></a><span class="k">      </span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1768"></a>      <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1769"></a>       <span class="n">ebfp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<a name="ln-1770"></a>      <span class="k">end do</span>
<a name="ln-1771"></a><span class="k">     end if</span>
<a name="ln-1772"></a><span class="k">    end do</span>
<a name="ln-1773"></a><span class="k">   end if</span>
<a name="ln-1774"></a><span class="k">   </span><span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1775"></a>
<a name="ln-1776"></a>   <span class="n">ip</span> <span class="o">=</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">mype</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1777"></a>   <span class="k">call </span><span class="n">intvec_distribute</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip_loc</span><span class="p">,</span> <span class="n">npe</span><span class="p">)</span>
<a name="ln-1778"></a>   <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1779"></a>   <span class="c">!nptot_global_reduced=sum(ip_loc(1:npe))</span>
<a name="ln-1780"></a>   <span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npe</span>
<a name="ln-1781"></a>    <span class="n">nptot_global_reduced</span> <span class="o">=</span> <span class="n">nptot_global_reduced</span> <span class="o">+</span> <span class="n">ip_loc</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1782"></a>   <span class="k">end do</span>
<a name="ln-1783"></a><span class="k">   if</span> <span class="p">(</span><span class="n">nptot_global</span> <span class="o">&lt;</span> <span class="mf">1e9</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1784"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nptot_global_reduced</span><span class="p">)</span>
<a name="ln-1785"></a>   <span class="k">else</span>
<a name="ln-1786"></a><span class="k">    </span><span class="n">nptot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-1787"></a>   <span class="k">end if</span>
<a name="ln-1788"></a><span class="k">   </span><span class="n">ip_max</span> <span class="o">=</span> <span class="n">ip</span>
<a name="ln-1789"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="n">ip_max</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">npe</span><span class="p">))</span>
<a name="ln-1790"></a>   <span class="n">lenp</span> <span class="o">=</span> <span class="n">ndv</span><span class="o">*</span><span class="n">ip</span>
<a name="ln-1791"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lenp</span><span class="p">)</span>
<a name="ln-1792"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">(</span><span class="n">lenp</span><span class="p">))</span>
<a name="ln-1793"></a>   <span class="n">ik</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1794"></a>   <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-1795"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd2</span>
<a name="ln-1796"></a>     <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1797"></a>     <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1798"></a>    <span class="k">end do</span>
<a name="ln-1799"></a><span class="k">    </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">ebfp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1800"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1801"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh</span>
<a name="ln-1802"></a>    <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1803"></a>    <span class="n">pdata</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
<a name="ln-1804"></a>   <span class="k">end do</span>
<a name="ln-1805"></a><span class="k">   if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">/=</span> <span class="n">lenp</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a16,3i8)&#39;</span><span class="p">)</span> <span class="s1">&#39;wrong pdata size&#39;</span><span class="p">,</span> <span class="n">mype</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1806"></a>    <span class="n">ik</span>
<a name="ln-1807"></a>
<a name="ln-1808"></a>   <span class="n">int_par</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1809"></a>   <span class="k">call </span><span class="n">endian</span><span class="p">(</span><span class="n">i_end</span><span class="p">)</span>
<a name="ln-1810"></a>
<a name="ln-1811"></a>   <span class="n">part_real_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="kt">real</span><span class="p">(</span><span class="n">timenow</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1812"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1813"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">w0_x</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">w0_y</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">lam0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1814"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">n0_ref</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">np_per_cell</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1815"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">wgh_ion</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">mass</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">xp0_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1816"></a>                          <span class="kt">real</span><span class="p">(</span><span class="n">xp1_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">yp_out</span><span class="p">,</span> <span class="n">sp</span><span class="p">),</span> <span class="kt">real</span><span class="p">(</span><span class="n">gam_min</span><span class="p">,</span> <span class="n">sp</span><span class="p">)]</span>
<a name="ln-1817"></a>
<a name="ln-1818"></a>   <span class="n">part_int_par</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">npe</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">dmodel_id</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1819"></a>                         <span class="n">curr_ndim</span><span class="p">,</span> <span class="n">mp_per_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ion_min</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">lpf_ord</span><span class="p">,</span> <span class="n">der_ord</span><span class="p">,</span> <span class="n">iform</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1820"></a>                         <span class="n">ndv</span><span class="p">,</span> <span class="n">file_version</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="n">nx_loc</span><span class="p">,</span> <span class="n">ny_loc</span><span class="p">,</span> <span class="n">nz_loc</span><span class="p">,</span> <span class="n">pjump</span><span class="p">]</span>
<a name="ln-1821"></a>
<a name="ln-1822"></a>   <span class="k">write</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;(a8,i2.2)&#39;</span><span class="p">)</span> <span class="n">part_files</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">iout</span> <span class="c">!serve sempre</span>
<a name="ln-1823"></a>   <span class="n">fname_out</span> <span class="o">=</span> <span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1824"></a>   <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1825"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1826"></a><span class="k">    open</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="n">foldername</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">)</span>
<a name="ln-1827"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Real parameters&#39;</span>
<a name="ln-1828"></a>    <span class="k">do </span><span class="n">q</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1829"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a13,e11.4)&#39;</span><span class="p">)</span> <span class="n">rpar</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">part_real_par</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a name="ln-1830"></a>    <span class="k">end do</span>
<a name="ln-1831"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Integer parameters&#39;</span>
<a name="ln-1832"></a>    <span class="k">do </span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span>
<a name="ln-1833"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(a12,i8)&#39;</span><span class="p">)</span> <span class="n">ipar</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">part_int_par</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-1834"></a>    <span class="k">end do</span>
<a name="ln-1835"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39; Number of particles in the output box&#39;</span>
<a name="ln-1836"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;(4i20)&#39;</span><span class="p">)</span> <span class="n">nptot_global_reduced</span>
<a name="ln-1837"></a>    <span class="k">close</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1838"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles param written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1839"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.dat&#39;</span>
<a name="ln-1840"></a>   <span class="k">else</span>
<a name="ln-1841"></a><span class="k">    </span><span class="n">disp</span> <span class="o">=</span> <span class="n">mype</span> <span class="o">+</span> <span class="n">ndv</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ip_loc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mype</span><span class="p">))</span> <span class="c">! da usare con mpi_write_part</span>
<a name="ln-1842"></a>   <span class="k">end if</span>
<a name="ln-1843"></a>
<a name="ln-1844"></a><span class="k">   </span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span><span class="o">*</span><span class="mi">4</span> <span class="c">! sia gli int che i float sono di 4 bytes</span>
<a name="ln-1845"></a>   <span class="k">call </span><span class="n">mpi_write_part</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">disp</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">fname_out</span><span class="p">)</span>
<a name="ln-1846"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pdata</span><span class="p">))</span> <span class="k">deallocate</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span>
<a name="ln-1847"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">pe0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1848"></a><span class="k">    write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Particles data written on file: &#39;</span><span class="o">//</span><span class="n">foldername</span><span class="o">//</span> <span class="p">&amp;</span>
<a name="ln-1849"></a>     <span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">fname</span><span class="o">//</span><span class="s1">&#39;.bin&#39;</span>
<a name="ln-1850"></a>   <span class="k">end if</span>
<a name="ln-1851"></a><span class="k">  end subroutine</span>
<a name="ln-1852"></a>  <span class="c">!================================</span>
<a name="ln-1853"></a>
<a name="ln-1854"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>