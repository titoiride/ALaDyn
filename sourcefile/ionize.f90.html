<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A High-Accuracy PIC Code for the Maxwell-Vlasov Equations">
    
    <meta name="author" content="The ALaDyn Collaboration" >
    <link rel="icon" href="../favicon.png">

    <title>ionize.f90 &ndash; ALaDyn</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ALaDyn <small>3.0.1</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Guide</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/aladyn.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/aladyn.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>ionize.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 1.7% of total for source files.">421 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/ionize.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">ionize.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/ionize.html">ionize</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/ionize.f90.html#src">ionize.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~ionize.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefileionizef90EfferentGraph" width="627pt" height="245pt"
 viewBox="0.00 0.00 627.00 244.79" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~ionize.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 240.7857)">
<title>sourcefile~~ionize.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-240.7857 623,-240.7857 623,4 -4,4"/>
<!-- sourcefile~ionize.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~ionize.f90</title>
<polygon fill="none" stroke="#000000" points="619,-87 555,-87 555,-63 619,-63 619,-87"/>
<text text-anchor="middle" x="587" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">ionize.f90</text>
</g>
<!-- sourcefile~ionz_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~ionz_data.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/ionz_data.f90.html" xlink:title="ionz_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="226.5,-230 142.5,-230 142.5,-206 226.5,-206 226.5,-230"/>
<text text-anchor="middle" x="184.5" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ionz_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~ionize.f90&#45;&gt;sourcefile~ionz_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~ionize.f90&#45;&gt;sourcefile~ionz_data.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M458.5,-218C385.3382,-244.8146 293.6213,-237.3139 237.0488,-228.4335"/>
<polygon fill="#ff0000" stroke="#ff0000" points="237.3421,-224.9349 226.9069,-226.7673 236.2072,-231.8422 237.3421,-224.9349"/>
</g>
<!-- sourcefile~util.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~util.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/util.f90.html" xlink:title="util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="339.5,-190 285.5,-190 285.5,-166 339.5,-166 339.5,-190"/>
<text text-anchor="middle" x="312.5" y="-175.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~ionize.f90&#45;&gt;sourcefile~util.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~ionize.f90&#45;&gt;sourcefile~util.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M581.1616,-87.4032C566.0707,-117.6746 522.431,-194.5686 458.5,-218"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M458.5,-218C438.5097,-225.3267 385.3415,-207.357 348.9991,-193.1761"/>
<polygon fill="#ff0000" stroke="#ff0000" points="350.2809,-189.9194 339.695,-189.486 347.7001,-196.4263 350.2809,-189.9194"/>
</g>
<!-- sourcefile~array_alloc.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~array_alloc.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/array_alloc.f90.html" xlink:title="array_alloc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="504.5,-108 412.5,-108 412.5,-84 504.5,-84 504.5,-108"/>
<text text-anchor="middle" x="458.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">array_alloc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~ionize.f90&#45;&gt;sourcefile~array_alloc.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~ionize.f90&#45;&gt;sourcefile~array_alloc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M554.9055,-80.245C542.7025,-82.2393 528.4145,-84.5743 514.6328,-86.8266"/>
<polygon fill="#ff0000" stroke="#ff0000" points="514.0286,-83.3788 504.7241,-88.4459 515.1577,-90.2871 514.0286,-83.3788"/>
</g>
<!-- sourcefile~common_param.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~common_param.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/common_param.f90.html" xlink:title="common_param.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="519,-66 398,-66 398,-42 519,-42 519,-66"/>
<text text-anchor="middle" x="458.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">common_param.f90</text>
</a>
</g>
</g>
<!-- sourcefile~ionize.f90&#45;&gt;sourcefile~common_param.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~ionize.f90&#45;&gt;sourcefile~common_param.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M554.9055,-69.755C547.0199,-68.4663 538.2636,-67.0353 529.336,-65.5763"/>
<polygon fill="#ff0000" stroke="#ff0000" points="529.6544,-62.082 519.2208,-63.9232 528.5253,-68.9903 529.6544,-62.082"/>
</g>
<!-- sourcefile~mpi_var.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~mpi_var.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/mpi_var.f90.html" xlink:title="mpi_var.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="496,-24 421,-24 421,0 496,0 496,-24"/>
<text text-anchor="middle" x="458.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">mpi_var.f90</text>
</a>
</g>
</g>
<!-- sourcefile~ionize.f90&#45;&gt;sourcefile~mpi_var.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~ionize.f90&#45;&gt;sourcefile~mpi_var.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M569.7044,-62.8424C556.3063,-53.7944 537.0465,-41.5775 519,-33 514.7072,-30.9596 510.161,-29.0151 505.5657,-27.1913"/>
<polygon fill="#ff0000" stroke="#ff0000" points="506.7215,-23.8865 496.1299,-23.6252 504.2468,-30.4345 506.7215,-23.8865"/>
</g>
<!-- sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~precision_def.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/precision_def.f90.html" xlink:title="precision_def.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="106,-148 0,-148 0,-124 106,-124 106,-148"/>
<text text-anchor="middle" x="53" y="-133.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">precision_def.F90</text>
</a>
</g>
</g>
<!-- sourcefile~ionz_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~ionz_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M158.5687,-205.9172C153.0232,-203.1316 147.255,-200.0783 142,-197 119.5645,-183.8579 95.2934,-167.034 77.7731,-154.3845"/>
<polygon fill="#ff0000" stroke="#ff0000" points="79.4155,-151.2508 69.2719,-148.1918 75.2939,-156.9088 79.4155,-151.2508"/>
</g>
<!-- sourcefile~code_util.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~code_util.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/code_util.f90.html" xlink:title="code_util.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="225,-188 144,-188 144,-164 225,-164 225,-188"/>
<text text-anchor="middle" x="184.5" y="-173.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">code_util.f90</text>
</a>
</g>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~code_util.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M285.3545,-177.5759C270.8907,-177.3499 252.6174,-177.0643 235.6108,-176.7986"/>
<polygon fill="#cbff00" stroke="#cbff00" points="235.2844,-173.2932 225.2309,-176.6364 235.1749,-180.2923 235.2844,-173.2932"/>
</g>
<!-- sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M285.3234,-166.855C254.0086,-154.4123 204.3213,-136 184.5,-136"/>
</g>
<!-- sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~fstruct_data.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/fstruct_data.f90.html" xlink:title="fstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="360.5,-148 264.5,-148 264.5,-124 360.5,-124 360.5,-148"/>
<text text-anchor="middle" x="312.5" y="-133.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">fstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~fstruct_data.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M414.6952,-108.0013C399.462,-112.1748 382.1981,-116.9046 366.2534,-121.273"/>
<polygon fill="#00ff66" stroke="#00ff66" points="365.2458,-117.92 356.526,-123.9381 367.0955,-124.6713 365.2458,-117.92"/>
</g>
<!-- sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~pstruct_data.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/pstruct_data.f90.html" xlink:title="pstruct_data.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="362,-106 263,-106 263,-82 362,-82 362,-106"/>
<text text-anchor="middle" x="312.5" y="-91.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pstruct_data.f90</text>
</a>
</g>
</g>
<!-- sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~array_alloc.f90&#45;&gt;sourcefile~pstruct_data.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M412.3047,-95.3672C399.5894,-95.193 385.6141,-95.0016 372.2515,-94.8185"/>
<polygon fill="#00ff66" stroke="#00ff66" points="372.2307,-91.318 362.1836,-94.6806 372.1347,-98.3173 372.2307,-91.318"/>
</g>
<!-- sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~common_param.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#0066ff" stroke-dasharray="5,2" d="M397.6965,-52.0629C371.4586,-51.7278 340.4373,-52.0011 312.5,-54"/>
</g>
<!-- sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~mpi_var.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#cc00ff" stroke-dasharray="5,2" d="M422.8531,-24.1033C386.9413,-35.9599 333.8752,-52.4706 312.5,-54"/>
<path fill="none" stroke="#cc00ff" stroke-dasharray="5,2" d="M312.5,-54C236.3972,-59.4451 213.3359,-46.9358 142,-74 116.1267,-83.8161 90.6308,-102.7926 73.6047,-117.1782"/>
<polygon fill="#cc00ff" stroke="#cc00ff" points="71.2204,-114.6132 65.9623,-123.8112 75.8087,-119.8998 71.2204,-114.6132"/>
</g>
<!-- sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~fstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M264.4816,-136C240.462,-136 210.9444,-136 184.5,-136"/>
</g>
<!-- sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~code_util.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M145.0457,-163.9987C131.7745,-159.9618 116.7922,-155.4045 102.8291,-151.1571"/>
<polygon fill="#7fff00" stroke="#7fff00" points="103.4668,-147.6928 92.881,-148.1311 101.4296,-154.3899 103.4668,-147.6928"/>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M283.0764,-106.0355C251.6801,-118.4464 203.8535,-136 184.5,-136"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M184.5,-136C162.2293,-136 137.837,-136 116.1738,-136"/>
<polygon fill="#00ffff" stroke="#00ffff" points="116.106,-132.5001 106.1059,-136 116.1059,-139.5001 116.106,-132.5001"/>
</g>
<!-- sourcefile~struct_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~struct_def.f90</title>
<g id="a_sourcefile~~ionize.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/struct_def.f90.html" xlink:title="struct_def.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="227,-107 142,-107 142,-83 227,-83 227,-107"/>
<text text-anchor="middle" x="184.5" y="-92.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">struct_def.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~pstruct_data.f90&#45;&gt;sourcefile~struct_def.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M262.6453,-94.3895C254.3611,-94.4542 245.7441,-94.5215 237.3878,-94.5868"/>
<polygon fill="#00ffff" stroke="#00ffff" points="237.3364,-91.087 227.3641,-94.6651 237.3912,-98.0868 237.3364,-91.087"/>
</g>
<!-- sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90 -->
<g id="sourcefile~~ionize.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~struct_def.f90&#45;&gt;sourcefile~precision_def.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M145.7569,-107.0796C131.9685,-111.3786 116.2623,-116.2756 101.7439,-120.8023"/>
<polygon fill="#ff0000" stroke="#ff0000" points="100.4255,-117.5471 91.9206,-123.8651 102.5092,-124.2298 100.4255,-117.5471"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~ionize.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefileionizef90AfferentGraph" width="357pt" height="116pt"
 viewBox="0.00 0.00 357.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~ionize.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<title>sourcefile~~ionize.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-112 353,-112 353,4 -4,4"/>
<!-- sourcefile~ionize.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~ionize.f90</title>
<polygon fill="none" stroke="#000000" points="64,-66 0,-66 0,-42 64,-42 64,-66"/>
<text text-anchor="middle" x="32" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">ionize.f90</text>
</g>
<!-- sourcefile~start_all.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~start_all.f90</title>
<g id="a_sourcefile~~ionize.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/start_all.f90.html" xlink:title="start_all.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="207,-108 130,-108 130,-84 207,-84 207,-108"/>
<text text-anchor="middle" x="168.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">start_all.F90</text>
</a>
</g>
</g>
<!-- sourcefile~start_all.f90&#45;&gt;sourcefile~ionize.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~start_all.f90&#45;&gt;sourcefile~ionize.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M129.7335,-84.1306C120.0234,-81.1534 109.6298,-77.963 100,-75 91.5056,-72.3863 82.4162,-69.5835 73.7368,-66.9042"/>
<polygon fill="#ff0000" stroke="#ff0000" points="74.7528,-63.5549 64.1653,-63.9483 72.6873,-70.2432 74.7528,-63.5549"/>
</g>
<!-- sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~pic_evolve_in_time.f90</title>
<g id="a_sourcefile~~ionize.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/pic_evolve_in_time.f90.html" xlink:title="pic_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="235,-66 102,-66 102,-42 235,-42 235,-66"/>
<text text-anchor="middle" x="168.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">pic_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~ionize.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~pic_evolve_in_time.f90&#45;&gt;sourcefile~ionize.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M101.8495,-54C92.5156,-54 83.1418,-54 74.4269,-54"/>
<polygon fill="#ff0000" stroke="#ff0000" points="74.1704,-50.5001 64.1703,-54 74.1703,-57.5001 74.1704,-50.5001"/>
</g>
<!-- sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~env_evolve_in_time.f90</title>
<g id="a_sourcefile~~ionize.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/env_evolve_in_time.f90.html" xlink:title="env_evolve_in_time.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="237,-24 100,-24 100,0 237,0 237,-24"/>
<text text-anchor="middle" x="168.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">env_evolve_in_time.f90</text>
</a>
</g>
</g>
<!-- sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~ionize.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~env_evolve_in_time.f90&#45;&gt;sourcefile~ionize.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M129.013,-24.0903C119.5106,-27.004 109.392,-30.1101 100,-33 91.5056,-35.6137 82.4162,-38.4165 73.7368,-41.0958"/>
<polygon fill="#ff0000" stroke="#ff0000" points="72.6873,-37.7568 64.1653,-44.0517 74.7528,-44.4451 72.6873,-37.7568"/>
</g>
<!-- sourcefile~aladyn.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~aladyn.f90</title>
<g id="a_sourcefile~~ionize.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/aladyn.f90.html" xlink:title="ALaDyn.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="349,-66 273,-66 273,-42 349,-42 349,-66"/>
<text text-anchor="middle" x="311" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ALaDyn.F90</text>
</a>
</g>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~start_all.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M272.8126,-65.2552C255.7008,-70.2987 235.3198,-76.3058 217.1324,-81.6662"/>
<polygon fill="#ff0000" stroke="#ff0000" points="215.8913,-78.3831 207.2887,-84.5675 217.8703,-85.0975 215.8913,-78.3831"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~pic_evolve_in_time.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M272.8126,-54C264.1852,-54 254.7268,-54 245.1375,-54"/>
<polygon fill="#00ff00" stroke="#00ff00" points="245.1264,-50.5001 235.1264,-54 245.1263,-57.5001 245.1264,-50.5001"/>
</g>
<!-- sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90 -->
<g id="sourcefile~~ionize.f90~~AfferentGraph_edge6" class="edge">
<title>sourcefile~aladyn.f90&#45;&gt;sourcefile~env_evolve_in_time.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M272.8126,-42.7448C256.2573,-37.8653 236.6419,-32.0839 218.9136,-26.8587"/>
<polygon fill="#0000ff" stroke="#0000ff" points="219.8716,-23.4923 209.2901,-24.0223 217.8926,-30.2068 219.8716,-23.4923"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/ionize.html">ionize</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/ionize.f90.html#src">ionize.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-2"></a><span class="c">!                            Copyright 2008-2020  The ALaDyn Collaboration                            !</span>
<a name="ln-3"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-6"></a><span class="c">!  This file is part of ALaDyn.                                                                       !</span>
<a name="ln-7"></a><span class="c">!                                                                                                     !</span>
<a name="ln-8"></a><span class="c">!  ALaDyn is free software: you can redistribute it and/or modify                                     !</span>
<a name="ln-9"></a><span class="c">!  it under the terms of the GNU General Public License as published by                               !</span>
<a name="ln-10"></a><span class="c">!  the Free Software Foundation, either version 3 of the License, or                                  !</span>
<a name="ln-11"></a><span class="c">!  (at your option) any later version.                                                                !</span>
<a name="ln-12"></a><span class="c">!                                                                                                     !</span>
<a name="ln-13"></a><span class="c">!  ALaDyn is distributed in the hope that it will be useful,                                          !</span>
<a name="ln-14"></a><span class="c">!  but WITHOUT ANY WARRANTY; without even the implied warranty of                                     !</span>
<a name="ln-15"></a><span class="c">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                      !</span>
<a name="ln-16"></a><span class="c">!  GNU General Public License for more details.                                                       !</span>
<a name="ln-17"></a><span class="c">!                                                                                                     !</span>
<a name="ln-18"></a><span class="c">!  You should have received a copy of the GNU General Public License                                  !</span>
<a name="ln-19"></a><span class="c">!  along with ALaDyn.  If not, see &lt;http://www.gnu.org/licenses/&gt;.                                    !</span>
<a name="ln-20"></a><span class="c">!*****************************************************************************************************!</span>
<a name="ln-21"></a>
<a name="ln-22"></a> <span class="k">module </span><span class="n">ionize</span>
<a name="ln-23"></a>  <span class="k">use </span><span class="n">ionz_data</span>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">common_param</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">array_alloc</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">mpi_var</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">util</span>
<a name="ln-28"></a>
<a name="ln-29"></a>  <span class="k">implicit none</span>
<a name="ln-30"></a><span class="k">  private</span>
<a name="ln-31"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">ionization_cycle</span><span class="p">,</span> <span class="n">set_field_ioniz_wfunction</span><span class="p">,</span> <span class="n">de_inv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-32"></a>            <span class="n">deb_inv</span>
<a name="ln-33"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">el_ionz_count</span><span class="p">(:)</span>
<a name="ln-34"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">efp_aux</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-35"></a> <span class="k">contains</span>
<a name="ln-36"></a>
<a name="ln-37"></a>  <span class="c">!================================</span>
<a name="ln-38"></a>  <span class="k">subroutine </span><span class="n">set_field_ioniz_wfunction</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">zm</span><span class="p">,</span> <span class="n">loc_ion</span><span class="p">,</span> <span class="n">nz_lev</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-39"></a>                                       <span class="n">nz_model</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">dt_in</span><span class="p">)</span>
<a name="ln-40"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">z0</span><span class="p">,</span> <span class="n">zm</span><span class="p">,</span> <span class="n">loc_ion</span><span class="p">,</span> <span class="n">nz_lev</span><span class="p">,</span> <span class="n">nz_model</span>
<a name="ln-41"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">e_max</span>
<a name="ln-42"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">zk</span><span class="p">,</span> <span class="n">zm_loc</span><span class="p">,</span> <span class="n">ll</span>
<a name="ln-43"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ei</span><span class="p">,</span> <span class="n">w_bsi</span><span class="p">,</span> <span class="n">w_adk</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">fact1</span><span class="p">,</span> <span class="n">fact2</span><span class="p">,</span> <span class="n">dt_temp</span>
<a name="ln-44"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">aw</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-45"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p2</span><span class="p">,</span> <span class="n">efact</span><span class="p">,</span> <span class="n">avg_fact</span>
<a name="ln-46"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">dt_in</span>
<a name="ln-47"></a>   <span class="c">!=============================</span>
<a name="ln-48"></a>   <span class="c">! uses stored coefficients nstar(z,ic), vfact(z,ic),C_nstar(z,ic)</span>
<a name="ln-49"></a>   <span class="c">! ionz_model, ionz_lev,nsp_ionz z0=z_ion(), zmax=atn() in common</span>
<a name="ln-50"></a>   <span class="c">!===============================</span>
<a name="ln-51"></a>   <span class="n">wi</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-52"></a>   <span class="n">dge</span> <span class="o">=</span> <span class="n">e_max</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">n_ge</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-53"></a>   <span class="n">d2ge</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="n">dge</span>
<a name="ln-54"></a>   <span class="n">de_inv</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dge</span>
<a name="ln-55"></a>   <span class="n">deb_inv</span> <span class="o">=</span> <span class="n">de_inv</span><span class="o">/</span><span class="mi">51</span><span class="mf">4.</span> <span class="c">!For fields in GV/m unit</span>
<a name="ln-56"></a>   <span class="n">ic</span> <span class="o">=</span> <span class="n">loc_ion</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-57"></a>   <span class="n">dt_temp</span> <span class="o">=</span> <span class="n">dt_loc</span>
<a name="ln-58"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">dt_in</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-59"></a><span class="k">    </span><span class="n">dt_temp</span> <span class="o">=</span> <span class="n">dt_in</span>
<a name="ln-60"></a>   <span class="k">end if</span>
<a name="ln-61"></a><span class="k">   select case</span> <span class="p">(</span><span class="n">nz_model</span><span class="p">)</span>
<a name="ln-62"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">!Only ADK: W_DC in chen et al (2013)</span>
<a name="ln-63"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm</span> <span class="c">!V(k,ic) to ionize ion(ic) A(k-1)=&gt; A(k),</span>
<a name="ln-64"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-65"></a>     <span class="n">ns</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-66"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-67"></a>      <span class="n">ei</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="c">!The gridded field intensity</span>
<a name="ln-68"></a>      <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span> <span class="c">!Vfact= (V/V_H)^{3/2}</span>
<a name="ln-69"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-70"></a>      <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-71"></a>      <span class="c">!=============</span>
<a name="ln-72"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_adk</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_adk</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-73"></a>      <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_adk</span> <span class="c">!Wi(Ei,j,ic)  for j=1,zm-z0</span>
<a name="ln-74"></a>     <span class="k">end do</span>
<a name="ln-75"></a><span class="k">    end do</span>
<a name="ln-76"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c">! W_AC = &lt;W_DC&gt; in chen et al. (2013)</span>
<a name="ln-77"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm</span>
<a name="ln-78"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-79"></a>     <span class="n">ns</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-80"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-81"></a>      <span class="n">ei</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="c">!The field intensity on grid</span>
<a name="ln-82"></a>      <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span>
<a name="ln-83"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-84"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">ei</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-85"></a>      <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-86"></a>      <span class="c">!=============</span>
<a name="ln-87"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_adk</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_adk</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-88"></a>      <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_adk</span>
<a name="ln-89"></a>     <span class="k">end do</span>
<a name="ln-90"></a><span class="k">    end do</span>
<a name="ln-91"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">!BSI +adk(AC) (Posthumus)</span>
<a name="ln-92"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm</span>
<a name="ln-93"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-94"></a>     <span class="n">ns</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-95"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-96"></a>      <span class="n">ei</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<a name="ln-97"></a>      <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span>
<a name="ln-98"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-99"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">ei</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-100"></a>      <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-101"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_adk</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_adk</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-102"></a>      <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_adk</span>
<a name="ln-103"></a>      <span class="c">!=============</span>
<a name="ln-104"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ei</span> <span class="o">&gt;</span> <span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="k">then</span> <span class="c">!w_adk(Ei=Ec)</span>
<a name="ln-105"></a>       <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-106"></a>       <span class="n">fact1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-107"></a>       <span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-108"></a>       <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-109"></a>       <span class="n">w_bsi</span> <span class="o">=</span> <span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pig</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dp</span><span class="p">))</span>
<a name="ln-110"></a>       <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_bsi</span> <span class="o">+</span> <span class="n">w_adk</span>
<a name="ln-111"></a>      <span class="k">end if</span>
<a name="ln-112"></a><span class="k">     end do</span>
<a name="ln-113"></a><span class="k">    end do</span>
<a name="ln-114"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c">! Epoch version Min(adk-BSI) with adk = adk&lt;m&gt;</span>
<a name="ln-115"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm</span>
<a name="ln-116"></a>     <span class="n">ll</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_fact</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-117"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-118"></a>     <span class="n">ns</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-119"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-120"></a>      <span class="n">ei</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="c">!The field intensity on grid</span>
<a name="ln-121"></a>      <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span>
<a name="ln-122"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-123"></a>      <span class="n">avg_fact</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-124"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">l_fact</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-125"></a><span class="k">       do </span><span class="n">ll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">l_fact</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-126"></a>        <span class="n">avg_fact</span> <span class="o">=</span> <span class="n">avg_fact</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ll</span>
<a name="ln-127"></a>       <span class="k">end do</span>
<a name="ln-128"></a><span class="k">       </span><span class="n">avg_fact</span> <span class="o">=</span> <span class="n">avg_fact</span><span class="o">/</span><span class="n">l_fact</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-129"></a>       <span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">*</span><span class="n">avg_fact</span>
<a name="ln-130"></a>      <span class="k">end if</span>
<a name="ln-131"></a><span class="k">      </span><span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">ei</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span>
<a name="ln-132"></a>      <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-133"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_adk</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_adk</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-134"></a>      <span class="c">!=============</span>
<a name="ln-135"></a>      <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_adk</span>
<a name="ln-136"></a>      <span class="n">efact</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span>
<a name="ln-137"></a>      <span class="n">w_bsi</span> <span class="o">=</span> <span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">efact</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pig</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dp</span><span class="p">))</span>
<a name="ln-138"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_bsi</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_bsi</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-139"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ei</span> <span class="o">&gt;</span> <span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w_bsi</span><span class="p">,</span> <span class="n">w_adk</span><span class="p">)</span>
<a name="ln-140"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ei</span> <span class="o">&gt;</span> <span class="n">e_b</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_bsi</span>
<a name="ln-141"></a>     <span class="k">end do</span>
<a name="ln-142"></a><span class="k">    end do</span>
<a name="ln-143"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">!cycle averaged BSI +adk (Posthumus)</span>
<a name="ln-144"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm</span>
<a name="ln-145"></a>     <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-146"></a>     <span class="n">ns</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
<a name="ln-147"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-148"></a>      <span class="n">ei</span> <span class="o">=</span> <span class="n">dge</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span> <span class="c">!The gridded field intensity</span>
<a name="ln-149"></a>      <span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span>
<a name="ln-150"></a>      <span class="n">fact1</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">ei</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-151"></a>      <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-152"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">w_adk</span> <span class="o">&lt;</span> <span class="nb">tiny</span><span class="p">)</span> <span class="n">w_adk</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-153"></a>      <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_adk</span>
<a name="ln-154"></a>      <span class="c">!=============</span>
<a name="ln-155"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ei</span> <span class="o">&gt;</span> <span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-156"></a><span class="k">       </span><span class="n">fact2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-157"></a>       <span class="n">fact1</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pig</span><span class="o">*</span><span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">fact2</span><span class="p">)</span><span class="o">**</span><span class="n">ns</span>
<a name="ln-158"></a>       <span class="n">w_adk</span> <span class="o">=</span> <span class="n">c_nstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fact2</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-159"></a>       <span class="n">w_bsi</span> <span class="o">=</span> <span class="n">vfact</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">ei</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pig</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dp</span><span class="p">))</span>
<a name="ln-160"></a>       <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">w_bsi</span> <span class="o">+</span> <span class="n">w_adk</span>
<a name="ln-161"></a>      <span class="k">end if</span>
<a name="ln-162"></a><span class="k">     end do</span>
<a name="ln-163"></a><span class="k">    end do</span>
<a name="ln-164"></a><span class="k">   end select</span>
<a name="ln-165"></a>   <span class="c">!=================== ordering================</span>
<a name="ln-166"></a>   <span class="c">! k=0</span>
<a name="ln-167"></a>   <span class="c">!V(z0+1) for n[z0]=&gt; n[z0+1] transition with probability W[1]</span>
<a name="ln-168"></a>   <span class="c">! k=1,2,...</span>
<a name="ln-169"></a>   <span class="c">!V(z0+k+1) for n[z0+k]=&gt; n[z0+k+1] transition with probability W(k+1)</span>
<a name="ln-170"></a>   <span class="c">! k=zmax-z0-1</span>
<a name="ln-171"></a>   <span class="c">!V(zmax) for n[zmax-1]=&gt; n[zmax] transition with probability W[zmax-z0]</span>
<a name="ln-172"></a>   <span class="c">!===============================================</span>
<a name="ln-173"></a>   <span class="c">! dt in unit l0/c= 10/3. fs  dt_fs in fs unit</span>
<a name="ln-174"></a>   <span class="n">dt_fs</span> <span class="o">=</span> <span class="mi">1</span><span class="mf">0.</span><span class="o">*</span><span class="n">dt_temp</span><span class="o">/</span><span class="mf">3.</span>
<a name="ln-175"></a>   <span class="n">wi</span> <span class="o">=</span> <span class="n">omega_a</span><span class="o">*</span><span class="n">wi</span>
<a name="ln-176"></a>   <span class="n">zm_loc</span> <span class="o">=</span> <span class="n">zm</span> <span class="o">-</span> <span class="n">z0</span>
<a name="ln-177"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">nz_lev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! one level ionization</span>
<a name="ln-178"></a>    <span class="c">!W_one_level(Ef,k=z0:zm,ic) P(k.k+1) ionization</span>
<a name="ln-179"></a>    <span class="c">!Wi(Ef,zk=1,zm-z0,ic) Rate of ionization zk+z0-1=&gt; zk+z0</span>
<a name="ln-180"></a>    <span class="n">w_one_lev</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">n_ge</span><span class="p">,</span> <span class="n">zm</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">zero_dp</span>
<a name="ln-181"></a>    <span class="k">do </span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-182"></a>     <span class="n">zk</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-183"></a>     <span class="n">k</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span>
<a name="ln-184"></a>     <span class="c">!z0 is the initial ion charge status</span>
<a name="ln-185"></a>     <span class="c">!k=z0,z0+1,..,zm-1  zk=k-z0+1</span>
<a name="ln-186"></a>     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-187"></a>      <span class="n">w_one_lev</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-188"></a>     <span class="k">end do</span>
<a name="ln-189"></a><span class="k">    end do</span>
<a name="ln-190"></a><span class="k">    return</span>
<a name="ln-191"></a><span class="k">   end if</span>
<a name="ln-192"></a>   <span class="c">!===================</span>
<a name="ln-193"></a>   <span class="k">allocate</span> <span class="p">(</span><span class="n">aw</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">zm_loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">zm_loc</span><span class="p">))</span>
<a name="ln-194"></a>   <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_ge</span>
<a name="ln-195"></a>    <span class="k">do </span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-196"></a>     <span class="n">zk</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-197"></a>     <span class="c">!z is the initial ion charge status</span>
<a name="ln-198"></a>     <span class="c">!z=z0,z0+1,..,zmax-1</span>
<a name="ln-199"></a>     <span class="c">!for fixed z0=0,   zmax-1</span>
<a name="ln-200"></a>     <span class="c">!with inization potential v(1),...,V(zmax)</span>
<a name="ln-201"></a>     <span class="n">aw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_dp</span>
<a name="ln-202"></a>     <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-203"></a>     <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">aw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-204"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-205"></a><span class="k">      if</span> <span class="p">(</span><span class="n">zk</span> <span class="o">&lt;</span> <span class="n">zm_loc</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-206"></a><span class="k">       do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">-</span> <span class="n">zk</span>
<a name="ln-207"></a>        <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-208"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-209"></a><span class="k">         </span><span class="n">p2</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-210"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-211"></a>          <span class="n">fact1</span> <span class="o">=</span> <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-212"></a>          <span class="n">fact2</span> <span class="o">=</span> <span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-213"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">fact2</span><span class="p">)</span>
<a name="ln-214"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-215"></a>          <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-216"></a>         <span class="k">end do</span>
<a name="ln-217"></a><span class="k">         </span><span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">zk</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-218"></a>        <span class="k">else</span>
<a name="ln-219"></a><span class="k">         </span><span class="n">p2</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-220"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-221"></a><span class="k">          </span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-222"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-223"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-224"></a>          <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-225"></a>         <span class="k">end if</span>
<a name="ln-226"></a><span class="k">         if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-227"></a><span class="k">          </span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-228"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span><span class="o">/</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-229"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-230"></a>          <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-231"></a>          <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-232"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-233"></a>          <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-234"></a>          <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt_fs</span><span class="o">*</span><span class="n">wi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zk</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">ic</span><span class="p">))</span>
<a name="ln-235"></a>         <span class="k">end if</span>
<a name="ln-236"></a><span class="k">         </span><span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aw</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-237"></a>        <span class="k">end if</span>
<a name="ln-238"></a><span class="k">       end do</span>
<a name="ln-239"></a><span class="k">       do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">-</span> <span class="n">zk</span>
<a name="ln-240"></a>        <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-241"></a>                                <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-242"></a>       <span class="k">end do</span>
<a name="ln-243"></a><span class="k">      end if</span>
<a name="ln-244"></a><span class="k">     else</span>
<a name="ln-245"></a><span class="k">      do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">-</span> <span class="n">zk</span>
<a name="ln-246"></a>       <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
<a name="ln-247"></a>      <span class="k">end do</span>
<a name="ln-248"></a><span class="k">     end if</span>
<a name="ln-249"></a><span class="k">     </span><span class="n">wsp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">zm_loc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">zk</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">z0</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-250"></a>    <span class="k">end do</span>
<a name="ln-251"></a><span class="k">   end do</span>
<a name="ln-252"></a>   <span class="c">!============================</span>
<a name="ln-253"></a>   <span class="c">! EXIT the cumulative DF F_j= u_0, u_0+u_1,.., u_0+u_1+ u_zmax-1</span>
<a name="ln-254"></a>   <span class="c">! ndexed with j=1,2,1</span>
<a name="ln-255"></a>  <span class="k">end subroutine</span>
<a name="ln-256"></a>
<a name="ln-257"></a>  <span class="c">!========================================</span>
<a name="ln-258"></a>  <span class="k">subroutine </span><span class="n">ionization_electrons_inject</span><span class="p">(</span><span class="n">ion_ch_inc</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np_el</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-259"></a>                                         <span class="n">new_np_el</span><span class="p">)</span>
<a name="ln-260"></a>
<a name="ln-261"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ion_ch_inc</span><span class="p">(:)</span>
<a name="ln-262"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">new_np_el</span>
<a name="ln-263"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_el</span>
<a name="ln-264"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inc</span><span class="p">,</span> <span class="n">id_ch</span>
<a name="ln-265"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u</span><span class="p">,</span> <span class="n">temp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-266"></a>
<a name="ln-267"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-268"></a>   <span class="c">!========== Enter sp_field(n,1)= the rms momenta Delta*a (n) for env model</span>
<a name="ln-269"></a>   <span class="c">!                 inc=ion_ch_inc(n) the number of ionization electrons</span>
<a name="ln-270"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-271"></a>   <span class="n">ii</span> <span class="o">=</span> <span class="n">np_el</span>
<a name="ln-272"></a>   <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-273"></a>   <span class="n">temp</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-274"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a33,2I6)&#39;</span><span class="p">)</span> <span class="s1">&#39;warning, no electrons before ionz&#39;</span> <span class="p">&amp;</span>
<a name="ln-275"></a>    <span class="p">,</span> <span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-276"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">curr_ndim</span><span class="p">)</span>
<a name="ln-277"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-278"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-279"></a>     <span class="n">inc</span> <span class="o">=</span> <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-280"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-281"></a><span class="k">      </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-282"></a>      <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-283"></a>      <span class="n">part_ind</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-284"></a>      <span class="n">wgh</span> <span class="o">=</span> <span class="n">wgh</span><span class="o">*</span><span class="n">n_mol_atoms</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-285"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inc</span>
<a name="ln-286"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-287"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-288"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-289"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-290"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-291"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-292"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-293"></a>      <span class="k">end do</span>
<a name="ln-294"></a><span class="k">      </span><span class="n">np_el</span> <span class="o">=</span> <span class="n">np_el</span> <span class="o">+</span> <span class="n">inc</span>
<a name="ln-295"></a>     <span class="k">end if</span>
<a name="ln-296"></a><span class="k">    end do</span>
<a name="ln-297"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-298"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-299"></a>     <span class="n">inc</span> <span class="o">=</span> <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-300"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-301"></a><span class="k">      </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-302"></a>      <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-303"></a>      <span class="n">part_ind</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-304"></a>      <span class="n">wgh</span> <span class="o">=</span> <span class="n">wgh</span><span class="o">*</span><span class="n">n_mol_atoms</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-305"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inc</span>
<a name="ln-306"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-307"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-308"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-309"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-310"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-311"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-312"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-313"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-314"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-315"></a>      <span class="k">end do</span>
<a name="ln-316"></a><span class="k">      </span><span class="n">np_el</span> <span class="o">=</span> <span class="n">np_el</span> <span class="o">+</span> <span class="n">inc</span>
<a name="ln-317"></a>     <span class="k">end if</span>
<a name="ln-318"></a><span class="k">    end do</span>
<a name="ln-319"></a><span class="k">   end select</span>
<a name="ln-320"></a><span class="k">   </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_el</span>
<a name="ln-321"></a>   <span class="c">!============ Now create new_np_el electrons</span>
<a name="ln-322"></a>  <span class="k">end subroutine</span>
<a name="ln-323"></a>  <span class="c">!=======================================</span>
<a name="ln-324"></a>  <span class="k">subroutine </span><span class="n">env_ionization_electrons_inject</span><span class="p">(</span><span class="n">sp_field</span><span class="p">,</span> <span class="n">ion_ch_inc</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-325"></a>                                             <span class="n">np</span><span class="p">,</span> <span class="n">np_el</span><span class="p">,</span> <span class="n">new_np_el</span><span class="p">)</span>
<a name="ln-326"></a>
<a name="ln-327"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_field</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-328"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ion_ch_inc</span><span class="p">(:)</span>
<a name="ln-329"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">new_np_el</span>
<a name="ln-330"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np_el</span>
<a name="ln-331"></a>   <span class="kt">integer</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inc</span><span class="p">,</span> <span class="n">id_ch</span>
<a name="ln-332"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u</span><span class="p">,</span> <span class="n">temp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">a_symm</span>
<a name="ln-333"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-334"></a>   <span class="c">!========== Enter sp_field(n,1)= the rms momenta Delta*a (n) for env model</span>
<a name="ln-335"></a>   <span class="c">!                 inc=ion_ch_inc(n) the number of ionization electrons</span>
<a name="ln-336"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-337"></a>
<a name="ln-338"></a>   <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0_pl</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-339"></a>   <span class="n">temp</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-340"></a>   <span class="n">ii</span> <span class="o">=</span> <span class="n">np_el</span>
<a name="ln-341"></a>   <span class="c">!if(ii==0)write(6,&#39;(a33,2I6)&#39;)&#39;warning, no electrons before ionz&#39;,imody,imodz</span>
<a name="ln-342"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">curr_ndim</span><span class="p">)</span>
<a name="ln-343"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-344"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-345"></a>     <span class="n">inc</span> <span class="o">=</span> <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-346"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-347"></a><span class="k">      </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-348"></a>      <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-349"></a>      <span class="n">part_ind</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-350"></a>      <span class="n">wgh</span> <span class="o">=</span> <span class="n">wgh</span><span class="o">*</span><span class="n">n_mol_atoms</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-351"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inc</span>
<a name="ln-352"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-353"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-354"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-355"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-356"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-357"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_field</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-358"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-359"></a>      <span class="k">end do</span>
<a name="ln-360"></a><span class="k">      </span><span class="n">np_el</span> <span class="o">=</span> <span class="n">np_el</span> <span class="o">+</span> <span class="n">inc</span>
<a name="ln-361"></a>     <span class="k">end if</span>
<a name="ln-362"></a><span class="k">    end do</span>
<a name="ln-363"></a><span class="k">   case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-364"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-365"></a>     <span class="n">inc</span> <span class="o">=</span> <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-366"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-367"></a><span class="k">      </span><span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-368"></a>      <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-369"></a>      <span class="n">part_ind</span> <span class="o">=</span> <span class="o">-</span><span class="n">one_int_hp</span>
<a name="ln-370"></a>      <span class="n">wgh</span> <span class="o">=</span> <span class="n">wgh</span><span class="o">*</span><span class="n">n_mol_atoms</span><span class="p">(</span><span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-371"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inc</span>
<a name="ln-372"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-373"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="n">ic</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-374"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-375"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-376"></a>       <span class="k">call </span><span class="n">gasdev</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-377"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_field</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">u</span>
<a name="ln-378"></a>       <span class="n">a_symm</span> <span class="o">=</span> <span class="n">sp_field</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<a name="ln-379"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">pig</span><span class="o">*</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">a_symm</span>
<a name="ln-380"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span>
<a name="ln-381"></a>      <span class="k">end do</span>
<a name="ln-382"></a><span class="k">      </span><span class="n">np_el</span> <span class="o">=</span> <span class="n">np_el</span> <span class="o">+</span> <span class="n">inc</span>
<a name="ln-383"></a>     <span class="k">end if</span>
<a name="ln-384"></a><span class="k">    end do</span>
<a name="ln-385"></a><span class="k">   end select</span>
<a name="ln-386"></a><span class="k">   </span><span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">np_el</span>
<a name="ln-387"></a>   <span class="c">!============ Now create new_np_el electrons</span>
<a name="ln-388"></a>  <span class="k">end subroutine</span>
<a name="ln-389"></a>  <span class="c">!===============================</span>
<a name="ln-390"></a>  <span class="k">subroutine </span><span class="n">part_ionize</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">amp_aux</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">new_np_el</span><span class="p">,</span> <span class="n">ion_ch_inc</span><span class="p">)</span>
<a name="ln-391"></a>
<a name="ln-392"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-393"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">amp_aux</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-394"></a>
<a name="ln-395"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np</span><span class="p">,</span> <span class="n">ic</span>
<a name="ln-396"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">new_np_el</span>
<a name="ln-397"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ion_ch_inc</span><span class="p">(:)</span>
<a name="ln-398"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span>
<a name="ln-399"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">z0</span>
<a name="ln-400"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">kf</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">,</span> <span class="n">sp_ion</span>
<a name="ln-401"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef_ion</span>
<a name="ln-402"></a>   <span class="c">!=====================</span>
<a name="ln-403"></a>   <span class="c">! Units Ef_ion is in unit mc^2/e=2 MV/m</span>
<a name="ln-404"></a>   <span class="c">! Hence E0*Ef_ion, E0=0.51 is the electric field in MV/m</span>
<a name="ln-405"></a>   <span class="c">! The reference value in ADK formula is Ea= 1a.u. 0.514 MV/m,</span>
<a name="ln-406"></a>   <span class="c">! then Ef_ion/Ea= Ef_approximates the field in code units.</span>
<a name="ln-407"></a>   <span class="c">! Vfact(z,ic)=(V/V_H)^(3/2) where V_H is the Hydrogen ionization energy</span>
<a name="ln-408"></a>   <span class="c">!              V(z,ic) is the potential  to ionize ion(ic) z-1 =&gt; z</span>
<a name="ln-409"></a>   <span class="c">!===============================</span>
<a name="ln-410"></a>   <span class="c">! enters nk=ion_ch_inc(n) the index of field modulus on ion n=1,np</span>
<a name="ln-411"></a>   <span class="c">! exit  ion_ch_inc(n)= the number(0,1, ionz_lev) of ionization electrons of ion n=1,np</span>
<a name="ln-412"></a>   <span class="c">! exit sp_aux(n,id_ch)=Delta*a= sqrt(1.5*Ef/Vfact(Z,ic))*a_n for envelope model</span>
<a name="ln-413"></a>   <span class="c">!=======================</span>
<a name="ln-414"></a>
<a name="ln-415"></a>   <span class="c">!energy_norm=1./energy_unit</span>
<a name="ln-416"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-417"></a>   <span class="n">kf</span> <span class="o">=</span> <span class="n">curr_ndim</span>
<a name="ln-418"></a>   <span class="n">sp_ion</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-419"></a>   <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-420"></a>   <span class="c">!===========================</span>
<a name="ln-421"></a>   <span class="k">select case</span> <span class="p">(</span><span class="n">ionz_lev</span><span class="p">)</span>
<a name="ln-422"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-423"></a>    <span class="c">!========= Only one level ionization usining  adk model</span>
<a name="ln-424"></a>    <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-425"></a>     <span class="n">nk</span> <span class="o">=</span> <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c">!the ioniz field grid value on the n-th ion E_f=nk*dge</span>
<a name="ln-426"></a>     <span class="n">wgh_cmp</span> <span class="o">=</span> <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-427"></a>     <span class="n">z0</span> <span class="o">=</span> <span class="n">charge</span> <span class="c">!the current ion Z charge, charge is short_int</span>
<a name="ln-428"></a>     <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-429"></a>     <span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-430"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">w_one_lev</span><span class="p">(</span><span class="n">nk</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">sp_ion</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-431"></a><span class="k">      </span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span> <span class="o">+</span> <span class="n">one_int_hp</span>
<a name="ln-432"></a>      <span class="n">ion_ch_inc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">!the ionization electron count</span>
<a name="ln-433"></a>      <span class="n">z0</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-434"></a>      <span class="n">sp_loc</span><span class="p">%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">wgh_cmp</span> <span class="c">!the new ion (id,z-chargei,wgh)</span>
<a name="ln-435"></a>      <span class="n">ef_ion</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">amp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">vfact</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">sp_ion</span><span class="p">)</span>
<a name="ln-436"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ef_ion</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="n">amp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">ef_ion</span><span class="p">)</span><span class="o">*</span><span class="n">amp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c">!Delta*|A| on ion(n,ic)</span>
<a name="ln-437"></a>      <span class="n">kk</span> <span class="o">=</span> <span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-438"></a>     <span class="k">end if</span>
<a name="ln-439"></a>     <span class="c">!ion_ch_inc(n)=0 or 1</span>
<a name="ln-440"></a>    <span class="k">end do</span>
<a name="ln-441"></a><span class="k">    </span><span class="n">new_np_el</span> <span class="o">=</span> <span class="n">kk</span>
<a name="ln-442"></a>    <span class="c">!============= old ion charge stored in ebfp(id_ch)</span>
<a name="ln-443"></a>   <span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-444"></a>    <span class="n">new_np_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-445"></a>    <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;WARNING :    two-step ionization no yet activated&#39;</span>
<a name="ln-446"></a>    <span class="k">return</span>
<a name="ln-447"></a><span class="k">   end select</span>
<a name="ln-448"></a>   <span class="c">!============= old ion charge stored in ebfp(id_ch)</span>
<a name="ln-449"></a>   <span class="c">!================= Exit</span>
<a name="ln-450"></a>  <span class="k">end subroutine</span>
<a name="ln-451"></a>  <span class="c">!====================</span>
<a name="ln-452"></a>  <span class="k">subroutine </span><span class="n">ionization_cycle</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">sp_aux</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">itloc</span><span class="p">,</span> <span class="n">mom_id</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-453"></a>                              <span class="n">def_inv</span><span class="p">)</span>
<a name="ln-454"></a>   <span class="k">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_loc</span>
<a name="ln-455"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sp_aux</span><span class="p">(:,</span> <span class="p">:)</span>
<a name="ln-456"></a>   <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">np</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">itloc</span><span class="p">,</span> <span class="n">mom_id</span>
<a name="ln-457"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">def_inv</span>
<a name="ln-458"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">id_ch</span><span class="p">,</span> <span class="n">old_np_el</span><span class="p">,</span> <span class="n">new_np_el</span><span class="p">,</span> <span class="n">new_np_alloc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nk</span>
<a name="ln-459"></a>   <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ef2_ion</span><span class="p">,</span> <span class="n">ef_ion</span>
<a name="ln-460"></a>
<a name="ln-461"></a>   <span class="n">new_np_el</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-462"></a>   <span class="n">id_ch</span> <span class="o">=</span> <span class="n">nd2</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-463"></a>   <span class="c">!==================</span>
<a name="ln-464"></a>   <span class="c">! In sp_aux(id_ch) enters the |E|^2 env field assigned  to each ion</span>
<a name="ln-465"></a>   <span class="c">! np is the number of ions</span>
<a name="ln-466"></a>   <span class="c">!==================</span>
<a name="ln-467"></a>   <span class="c">! sp_loc(np,1:id_ch) is the array structure of ions coordinates, charge and weight</span>
<a name="ln-468"></a>   <span class="c">!==========================</span>
<a name="ln-469"></a>   <span class="c">!mom_id=1  select ionization procedure for envelope</span>
<a name="ln-470"></a>   <span class="c">!mom_id=0 for other models</span>
<a name="ln-471"></a>   <span class="c">!==============================</span>
<a name="ln-472"></a>   <span class="c">!======== First check memory for auxiliary arrays=============</span>
<a name="ln-473"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">el_ionz_count</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-474"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">el_ionz_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-475"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">el_ionz_count</span><span class="p">)</span>
<a name="ln-476"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">el_ionz_count</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="mi">100</span><span class="p">))</span>
<a name="ln-477"></a>    <span class="k">end if</span>
<a name="ln-478"></a><span class="k">   else</span>
<a name="ln-479"></a><span class="k">    allocate</span> <span class="p">(</span><span class="n">el_ionz_count</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="mi">100</span><span class="p">))</span>
<a name="ln-480"></a>   <span class="k">end if</span>
<a name="ln-481"></a><span class="k">   </span><span class="n">el_ionz_count</span><span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-482"></a>   <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">efp_aux</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-483"></a><span class="k">    if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">efp_aux</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-484"></a><span class="k">     deallocate</span> <span class="p">(</span><span class="n">efp_aux</span><span class="p">)</span>
<a name="ln-485"></a>     <span class="k">allocate</span> <span class="p">(</span><span class="n">efp_aux</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-486"></a>    <span class="k">end if</span>
<a name="ln-487"></a><span class="k">   else</span>
<a name="ln-488"></a><span class="k">    allocate</span> <span class="p">(</span><span class="n">efp_aux</span><span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-489"></a>   <span class="k">end if</span>
<a name="ln-490"></a><span class="k">   </span><span class="n">efp_aux</span><span class="p">(:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-491"></a>   <span class="n">efp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-492"></a>   <span class="n">efp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">sp_aux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">np</span><span class="p">,</span> <span class="n">id_ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-493"></a>   <span class="c">!=========================</span>
<a name="ln-494"></a>   <span class="c">! In efp_aux(n,1) is the ionizing field squared |E|^2 on ions n=1,np</span>
<a name="ln-495"></a>   <span class="c">! For envelope model : in efp_aux(n,2) is the env |A| value on ions n=1,np</span>
<a name="ln-496"></a>   <span class="c">!=========================</span>
<a name="ln-497"></a>
<a name="ln-498"></a>   <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span>
<a name="ln-499"></a>    <span class="n">ef2_ion</span> <span class="o">=</span> <span class="n">efp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">!the interpolated E^2 field</span>
<a name="ln-500"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ef2_ion</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-501"></a><span class="k">     </span><span class="n">ef_ion</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">ef2_ion</span><span class="p">)</span>
<a name="ln-502"></a>     <span class="n">nk</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">def_inv</span><span class="o">*</span><span class="n">ef_ion</span><span class="p">)</span>
<a name="ln-503"></a>     <span class="n">efp_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ef_ion</span>
<a name="ln-504"></a>     <span class="n">el_ionz_count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">nk</span>
<a name="ln-505"></a>     <span class="c">!for each ion index n nk(n) is the ionizing fiels grid index</span>
<a name="ln-506"></a>    <span class="k">end if</span>
<a name="ln-507"></a><span class="k">   end do</span>
<a name="ln-508"></a>   <span class="c">!=====================</span>
<a name="ln-509"></a>   <span class="c">! The ionizing field ef_ion=|E| discretized to a grid.</span>
<a name="ln-510"></a>   <span class="c">!            Ef(n)=nk*DE=nk*dge=nk/def_inv</span>
<a name="ln-511"></a>   <span class="c">! Grid index nk stored in el_ionz_count(n)</span>
<a name="ln-512"></a>   <span class="c">!====================</span>
<a name="ln-513"></a>   <span class="k">call </span><span class="n">part_ionize</span><span class="p">(</span><span class="n">sp_loc</span><span class="p">,</span> <span class="n">efp_aux</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">new_np_el</span><span class="p">,</span> <span class="n">el_ionz_count</span><span class="p">)</span>
<a name="ln-514"></a>   <span class="c">!======= In part_ionize:</span>
<a name="ln-515"></a>   <span class="c">! The transition probality from ion charge z_0 =&gt; z_0 +1 is evaluated using</span>
<a name="ln-516"></a>   <span class="c">! the probability table W_one_lev(nk,z0,sp_ion)</span>
<a name="ln-517"></a>   <span class="c">!=====================</span>
<a name="ln-518"></a>   <span class="c">!EXIT in el_ionz_count(n) the numeber of ionization electrons (=0 or =1) on each ion(n)</span>
<a name="ln-519"></a>   <span class="c">! For envelope model in efp_aux(n,1)=sqrt(1.5*E_f/Vfact(z1))*|A|</span>
<a name="ln-520"></a>   <span class="c">! To modelize the rms P_y moment of ionization electron</span>
<a name="ln-521"></a>   <span class="c">!==========================</span>
<a name="ln-522"></a>   <span class="c">!=========== CHECK FOR MEMORYof electron struct array ================</span>
<a name="ln-523"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">new_np_el</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-524"></a><span class="k">    </span><span class="n">old_np_el</span> <span class="o">=</span> <span class="n">loc_npart</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-525"></a>    <span class="n">new_np_alloc</span> <span class="o">=</span> <span class="n">old_np_el</span> <span class="o">+</span> <span class="n">new_np_el</span>
<a name="ln-526"></a>    <span class="n">loc_ne_ionz</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span> <span class="o">=</span> <span class="n">loc_ne_ionz</span><span class="p">(</span><span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span><span class="p">,</span> <span class="n">imodx</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-527"></a>                                       <span class="o">+</span> <span class="n">new_np_el</span>
<a name="ln-528"></a>    <span class="c">!==========</span>
<a name="ln-529"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-530"></a><span class="k">     if</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">new_np_alloc</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-531"></a><span class="k">      do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">old_np_el</span>
<a name="ln-532"></a>       <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">id_ch</span><span class="p">)</span>
<a name="ln-533"></a>      <span class="k">end do</span>
<a name="ln-534"></a><span class="k">      deallocate</span> <span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">)</span>
<a name="ln-535"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">new_np_alloc</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">))</span>
<a name="ln-536"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">old_np_el</span>
<a name="ln-537"></a>       <span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">id_ch</span><span class="p">)</span> <span class="o">=</span> <span class="n">ebfp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">id_ch</span><span class="p">)</span>
<a name="ln-538"></a>      <span class="k">end do</span>
<a name="ln-539"></a><span class="k">     end if</span>
<a name="ln-540"></a><span class="k">    else</span>
<a name="ln-541"></a><span class="k">     allocate</span> <span class="p">(</span><span class="n">spec</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">part</span><span class="p">(</span><span class="n">new_np_alloc</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">))</span>
<a name="ln-542"></a>     <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;(a37,2I6)&#39;</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-543"></a>      <span class="s1">&#39;warning, electron array not previously allocated&#39;</span><span class="p">,</span> <span class="n">imody</span><span class="p">,</span> <span class="n">imodz</span>
<a name="ln-544"></a>    <span class="k">end if</span>
<a name="ln-545"></a><span class="k">    call </span><span class="n">v_realloc</span><span class="p">(</span><span class="n">ebfp</span><span class="p">,</span> <span class="n">new_np_alloc</span><span class="p">,</span> <span class="n">id_ch</span><span class="p">)</span>
<a name="ln-546"></a>    <span class="c">!=========== and then Inject new electrons================</span>
<a name="ln-547"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">mom_id</span><span class="p">)</span>
<a name="ln-548"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-549"></a>     <span class="k">call </span><span class="n">ionization_electrons_inject</span><span class="p">(</span><span class="n">el_ionz_count</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">old_np_el</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-550"></a>                                      <span class="n">new_np_el</span><span class="p">)</span>
<a name="ln-551"></a>    <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-552"></a>     <span class="k">call </span><span class="n">env_ionization_electrons_inject</span><span class="p">(</span><span class="n">efp_aux</span><span class="p">,</span> <span class="n">el_ionz_count</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-553"></a>                                          <span class="n">np</span><span class="p">,</span> <span class="n">old_np_el</span><span class="p">,</span> <span class="n">new_np_el</span><span class="p">)</span>
<a name="ln-554"></a>    <span class="k">end select</span>
<a name="ln-555"></a><span class="k">   end if</span>
<a name="ln-556"></a>   <span class="c">!Ionization energy to be added to the plasma particles current</span>
<a name="ln-557"></a>  <span class="k">end subroutine</span>
<a name="ln-558"></a>  <span class="c">!=======================================</span>
<a name="ln-559"></a> <span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2020 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-07-30 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ALaDyn was developed by The ALaDyn Collaboration</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>